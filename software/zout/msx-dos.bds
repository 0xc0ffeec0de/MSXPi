binary-debuggable-source
0000 0000 f ./ROM/src/MSX-DOS/msx-dos.mac
0000 0000 s ;|===========================================================================|
0000 0000 s ;|                                                                           |
0000 0000 s ;| MSXPi Interface                                                           |
0000 0000 s ;|                                                                           |
0000 0000 s ;| Version : 0.8                                                             |
0000 0000 s ;|                                                                           |
0000 0000 s ;| Copyright (c) 2015-2016 Ronivon Candido Costa (ronivon@outlook.com)       |
0000 0000 s ;|                                                                           |
0000 0000 s ;| All rights reserved                                                       |
0000 0000 s ;|                                                                           |
0000 0000 s ;| Redistribution and use in source and compiled forms, with or without      |
0000 0000 s ;| modification, are permitted under GPL license.                            |
0000 0000 s ;|                                                                           |
0000 0000 s ;|===========================================================================|
0000 0000 s ;|                                                                           |
0000 0000 s ;| This file is part of MSXPi Interface project.                             |
0000 0000 s ;|                                                                           |
0000 0000 s ;| MSX PI Interface is free software: you can redistribute it and/or modify  |
0000 0000 s ;| it under the terms of the GNU General Public License as published by      |
0000 0000 s ;| the Free Software Foundation, either version 3 of the License, or         |
0000 0000 s ;| (at your option) any later version.                                       |
0000 0000 s ;|                                                                           |
0000 0000 s ;| MSX PI Interface is distributed in the hope that it will be useful,       |
0000 0000 s ;| but WITHOUT ANY WARRANTY; without even the implied warranty of            |
0000 0000 s ;| MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             |
0000 0000 s ;| GNU General Public License for more details.                              |
0000 0000 s ;|                                                                           |
0000 0000 s ;| You should have received a copy of the GNU General Public License         |
0000 0000 s ;| along with MSX PI Interface.  If not, see <http://www.gnu.org/licenses/>. |
0000 0000 s ;|===========================================================================|
0000 0000 s ;
0000 0000 s ; MSXPi Driver v0.8.1 (2017,2018);
0000 0000 s ;
0000 0000 s ; DOS 1.x kernel
0000 0000 s ;
0000 0000 s ; Source re-created by Z80DIS 2.2
0000 0000 s ; Z80DIS was written by Kenneth Gielow, Palo Alto, CA
0000 0000 s ;
0000 0000 s ; Code Copyrighted by ASCII and maybe others
0000 0000 s ; Source comments and updates by Arjen Zeilemaker
0000 0000 s ;
0000 0000 s ; Sourcecode supplied for STUDY ONLY
0000 0000 s ; Recreation NOT permitted without authorisation of the copyrightholders
0000 0000 s ;
0000 0000 s 
0000 0000 s 
0000 0000 s 
0000 0000 s 	.Z80
0000 0000 s 	ASEG
4000 4000 s 	ORG	04000H
4000 4000 s 
4000 4000 s ; Changes made:
4000 4000 s ; 1) Bugfixes of version 1.1 of diskrom
4000 4000 s ; 2) Own changes:
4000 4000 s ; - routine at 05A11H simpified.
4000 4000 s ; - routine at 05E52H simpified, does not support RAM other than 64 Kb
4000 4000 s ; - routine at 06306H simpified.
4000 4000 s ; extra room used to:
4000 4000 s ; - bugfix memory switching routines (CALSLT/CALLF/ENASLT)
4000 4000 s ; - boot from any drive at system startup
4000 4000 s ; - boot from default drive with _SYSTEM
4000 4000 s 
4000 4000 s 
4000 4000 s 
4000 4000 s ; symbols which must be defined by the diskdriver
4000 4000 s ;
4000 4000 s ;	EXTRN	INIHRD
4000 4000 s ;	EXTRN	DRIVES
4000 4000 s ;	EXTRN	INIENV
4000 4000 s ;	EXTRN	DSKIO
4000 4000 s ;	EXTRN	DSKCHG
4000 4000 s ;	EXTRN	GETDPB
4000 4000 s ;	EXTRN	CHOICE
4000 4000 s ;	EXTRN	DSKFMT
4000 4000 s ;	EXTRN	MTOFF
4000 4000 s ;	EXTRN	OEMSTA
4000 4000 s ;	EXTRN	MYSIZE
4000 4000 s ;	EXTRN	SECLEN
4000 4000 s ;	EXTRN	DEFDPB
4000 4000 s 
4000 4000 s ; symbols of routines which can be used by the diskdriver
4000 4000 s ;
4000 4000 s ;	PUBLIC	PROMPT
4000 4000 s ;	PUBLIC	SETINT
4000 4000 s ;	PUBLIC	PRVINT
4000 4000 s ;	PUBLIC	GETSLT
4000 4000 s ;	PUBLIC	GETWRK
4000 4000 s ;	PUBLIC	DIV16
4000 4000 s ;	PUBLIC	ENASLT
4000 4000 s ;	PUBLIC	XFER
4000 4000 s 
4000 4000 s 
4000 4000 s WBOOT	equ	00000H
4000 4000 s RDSLT	equ	0000CH
4000 4000 s WRSLT	equ	00014H
4000 4000 s CALSLT	equ	0001CH
4000 4000 s ENASLT	equ	00024H
4000 4000 s IDBYT0	equ	0002BH
4000 4000 s CALLF	equ	00030H
4000 4000 s KEYINT	equ	00038H
4000 4000 s LDIRMV	equ	00059H
4000 4000 s LDIRVM	equ	0005CH
4000 4000 s CHSNS	equ	0009CH
4000 4000 s CHGET	equ	0009FH
4000 4000 s CHPUT	equ	000A2H
4000 4000 s LPTOUT	equ	000A5H
4000 4000 s BREAKX	equ	000B7H
4000 4000 s CKCNTC	equ	000BDH
4000 4000 s ERAFNK	equ	000CCH
4000 4000 s TOTEXT	equ	000D2H
4000 4000 s SNSMAT	equ	00141H
4000 4000 s PHYDIO	equ	00144H
4000 4000 s KILBUF	equ	00156H
4000 4000 s CALBAS	equ	00159H
4000 4000 s 
4000 4000 s X003B	equ	0003BH			; helper routine in DOS memoryspace: save and change secundairy slotregister
4000 4000 s X0046	equ	00046H			; helper routine in DOS memoryspace: restore secundairy slotregister (RDSLT/WRSLT)
4000 4000 s X004B	equ	0004BH			; helper routine in DOS memoryspace: restore secundairy slotregister (CALSLT/CALLF)
4000 4000 s 
4000 4000 s YC000	equ	0C000H			; bootsector transferadres
4000 4000 s 
4000 4000 s XF1C9	equ	0F1C9H			; output string (BDOS 9), also start of fixed diskvars
4000 4000 s XF1D9	equ	0F1D9H			; XFER, transfer to DOS memory
4000 4000 s XF1E2	equ	0F1E2H			; WBOOT, warm boot DOS system
4000 4000 s XF1E8	equ	0F1E8H			; start handler in DOS memory
4000 4000 s XF1F4	equ	0F1F4H			; validate FCB filename
4000 4000 s YF1F7	equ	0F1F7H			; reserved devicenames
4000 4000 s YF20B	equ	0F20BH			; ´direntry´ for devices
4000 4000 s YF22B	equ	0F22BH			; days in month table
4000 4000 s YF237	equ	0F237H			; BDOS console output columnpos
4000 4000 s YF238	equ	0F238H			; console columnpos at start of lineinput
4000 4000 s YF239	equ	0F239H			; lineinput insert flag
4000 4000 s YF23A	equ	0F23AH			; lineinput secret message flag
4000 4000 s YF23B	equ	0F23BH			; console output to printer flag
4000 4000 s YF23C	equ	0F23CH			; directory buffer changed flag
4000 4000 s YF23D	equ	0F23DH			; transferadres
4000 4000 s YF23F	equ	0F23FH			; sectornumber in data buffer
4000 4000 s YF241	equ	0F241H			; driveid of sector in data buffer
4000 4000 s YF242	equ	0F242H			; data buffer changed flag
4000 4000 s YF243	equ	0F243H			; DPB pointer current operation
4000 4000 s YF245	equ	0F245H			; sectornumber (offset) in directory buffer
4000 4000 s YF246	equ	0F246H			; driveid of sector in directory buffer
4000 4000 s YF247	equ	0F247H			; default driveid
4000 4000 s YF248	equ	0F248H			; current day (1..31)
4000 4000 s YF249	equ	0F249H			; current month (1..12)
4000 4000 s YF24A	equ	0F24AH			; current year (offset to 1980)
4000 4000 s YF24C	equ	0F24CH			; current days since 1-1-1980
4000 4000 s YF24E	equ	0F24EH			; current day of week (0=sunday)
4000 4000 s XF24F	equ	0F24FH			; prompt for disk hook
4000 4000 s XF252	equ	0F252H			; get fat entry content hook
4000 4000 s XF255	equ	0F255H			; check if devicename hook
4000 4000 s XF258	equ	0F258H			; try next direntry hook
4000 4000 s XF25B	equ	0F25BH			; get next direntry hook
4000 4000 s XF25E	equ	0F25EH			; next direntry hook
4000 4000 s XF261	equ	0F261H			; validate FCB drive and filename hook
4000 4000 s XF264	equ	0F264H			; fcb open hook
4000 4000 s XF267	equ	0F267H			; get latest FAT hook
4000 4000 s XF26A	equ	0F26AH			; get pointer to DPB of current drive hook
4000 4000 s XF26D	equ	0F26DH			; write FAT hook
4000 4000 s XF270	equ	0F270H			; read sector hook
4000 4000 s XF273	equ	0F273H			; diskerror hook
4000 4000 s XF276	equ	0F276H			; write dirsector hook
4000 4000 s XF279	equ	0F279H			; write sector hook
4000 4000 s XF27C	equ	0F27CH			; multiply hook
4000 4000 s XF27F	equ	0F27FH			; divide hook
4000 4000 s XF282	equ	0F282H			; get absolute cluster hook
4000 4000 s XF285	equ	0F285H			; get next absolute cluster hook
4000 4000 s XF288	equ	0F288H			; partical sector read hook
4000 4000 s XF28B	equ	0F28BH			; partical sector write hook
4000 4000 s XF28E	equ	0F28EH			; start read recordoperation from disk hook
4000 4000 s XF291	equ	0F291H			; finish read recordoperation from disk hook
4000 4000 s XF294	equ	0F294H			; end read recordoperation from disk hook
4000 4000 s XF297	equ	0F297H			; record operation error at start hook
4000 4000 s XF29A	equ	0F29AH			; start write recordoperation to disk hook
4000 4000 s XF29D	equ	0F29DH			; finish write recordoperation to disk hook
4000 4000 s XF2A0	equ	0F2A0H			; calculate sequencial sectors hook
4000 4000 s XF2A3	equ	0F2A3H			; get sectornumber of cluster hook
4000 4000 s XF2A6	equ	0F2A6H			; allocate FAT chain hook
4000 4000 s XF2A9	equ	0F2A9H			; release FAT chain hook
4000 4000 s XF2AC	equ	0F2ACH			; lineinput headloop hook
4000 4000 s XF2AF	equ	0F2AFH			; console output hook
4000 4000 s XF2B2	equ	0F2B2H			; get time and date for direntry hook
4000 4000 s XF2B5	equ	0F2B5H			; setup days in februari hook
4000 4000 s YF2B8	equ	0F2B8H			; current direntry number
4000 4000 s YF2B9	equ	0F2B9H			; filename1
4000 4000 s YF2C4	equ	0F2C4H			; original DR byte FCB
4000 4000 s YF2C5	equ	0F2C5H			; filename2 (rename)
4000 4000 s YF2D0	equ	0F2D0H			; temporary save for F2B9 and F2C4 (rename)
4000 4000 s YF2DC	equ	0F2DCH			; flag ignore fileattributes
4000 4000 s YF2DD	equ	0F2DDH			; current relative sector in cluster
4000 4000 s YF2DE	equ	0F2DEH			; result of recordoperation
4000 4000 s YF2DF	equ	0F2DFH			; flag increase current relative sector in cluster (0 means not)
4000 4000 s YF2E0	equ	0F2E0H			; flag flake read (0 means real read)
4000 4000 s YF2E1	equ	0F2E1H			; current driveid
4000 4000 s YF2E2	equ	0F2E2H			; transferadres for recordoperation
4000 4000 s YF2E4	equ	0F2E4H			; start record (32 bit) for recordoperation
4000 4000 s YF2E8	equ	0F2E8H			; number of records for recordoperation
4000 4000 s YF2EA	equ	0F2EAH			; current relative cluster of file
4000 4000 s YF2EC	equ	0F2ECH			; current cluster of file
4000 4000 s YF2EE	equ	0F2EEH			; start relative sector for recordoperation
4000 4000 s YF2F0	equ	0F2F0H			; relative cluster after fileend for write recordoperation
4000 4000 s YF2F2	equ	0F2F2H			; start offset in sector for recordoperation
4000 4000 s YF2F4	equ	0F2F4H			; start fileposition (32 bit) for recordoperation
4000 4000 s YF2F8	equ	0F2F8H			; partical sector transfer at start
4000 4000 s YF2FA	equ	0F2FAH			; partical sector transfer at end
4000 4000 s YF2FC	equ	0F2FCH			; number of complete sectors to transfer
4000 4000 s YF2FE	equ	0F2FEH			; first free direntry (0FFH if none found)
4000 4000 s YF2FF	equ	0F2FFH			; flag diskoperation (0 if read, 1 if write)
4000 4000 s YF300	equ	0F300H			; pointer to remaining lineinput from CON read record operation
4000 4000 s YF302	equ	0F302H			; temporary store for maximium cluster
4000 4000 s 					; looks like F304-F305 are unused!
4000 4000 s YF306	equ	0F306H			; flag CP/M compatible BDOS call (0 means no CP/M, HL has value, <>0 means CP/M, HL is compatible filled)
4000 4000 s YF307	equ	0F307H			; saved pointer to FCB search first, used for search next
4000 4000 s YF309	equ	0F309H			; saved pointer to DPB search first, used for search next
4000 4000 s YF30B	equ	0F30BH			; saved current direntry number search first/next (FFh means invalid)
4000 4000 s YF30C	equ	0F30CH			; original EX byte FCB
4000 4000 s RAWFLG	equ	0F30DH			; read after write (verify) flag
4000 4000 s YF30E	equ	0F30EH			; date format (0 japanese, 1 european, 2 american)
4000 4000 s YF30F	equ	0F30FH			; double byte header char table
4000 4000 s 					; looks like F313-F322 are unused
4000 4000 s YF323	equ	0F323H			; diskerror handler pointer
4000 4000 s YF325	equ	0F325H			; abort handler pointer
4000 4000 s XF327	equ	0F327H			; AUX input hook (MSXHOOK style), default returns CTRL-Z in register A
4000 4000 s XF32C	equ	0F32CH			; AUX output hook (MSXHOOK style), default does nothing
4000 4000 s XF331	equ	0F331H			; BDOS hook (MSXHOOK style)
4000 4000 s YF336	equ	0F336H			; flag saved input available (0 = none available)
4000 4000 s YF337	equ	0F337H			; save input
4000 4000 s YF338	equ	0F338H			; use clockchip flag
4000 4000 s YF339	equ	0F339H			; saved stackpointer format routine
4000 4000 s YF33B	equ	0F33BH			; days since 1-1-1980, used when no clockchip
4000 4000 s YF33D	equ	0F33DH			; recordsize GET/PUT recordoperations
4000 4000 s YF33F	equ	0F33FH			; at systeminit: CTRL key flag, later: saved driveid driveroperation (0=A:)
4000 4000 s YF340	equ	0F340H			; flag kernel cold boot (0 = cold, <>0 = warm)
4000 4000 s RAMAD0	equ	0F341H			; slotid DOS ram page 0
4000 4000 s RAMAD1	equ	0F342H			; slotid DOS ram page 1
4000 4000 s RAMAD2	equ	0F343H			; slotid DOS ram page 2
4000 4000 s RAMAD3	equ	0F344H			; slotid DOS ram page 3
4000 4000 s YF345	equ	0F345H			; maximum number of diskbasic FCB's
4000 4000 s YF346	equ	0F346H			; flag MSXDOS has been running (0 = no MSXDOS yet)
4000 4000 s YF347	equ	0F347H			; number of drives in disksystem
4000 4000 s YF348	equ	0F348H			; slotid disksytem rom
4000 4000 s YF349	equ	0F349H			; disksystem bottom (lowest adres used by the disksystem)
4000 4000 s YF34B	equ	0F34BH			; msxdos system bottom
4000 4000 s $SECBUF equ	0F34DH			; pointer to sectorbuffer, can be used by the diskdriver
4000 4000 s YF34F	equ	0F34FH			; pointer to datasectorbuffer
4000 4000 s YF351	equ	0F351H			; pointer to directorysectorbuffer
4000 4000 s YF353	equ	0F353H			; pointer to the diskbasic FCB's
4000 4000 s YF355	equ	0F355H			; DPB table for 8 drives
4000 4000 s XF365	equ	0F365H			; routine read primary slotregister
4000 4000 s XF368	equ	0F368H			; routine enable disksystem rom on page 1
4000 4000 s XF36B	equ	0F36BH			; routine enable dos ram on page 1
4000 4000 s XFER	equ	0F36EH			; routine transfer to/from dos ram
4000 4000 s XF371	equ	0F371H			; auxiliary input routine
4000 4000 s XF374	equ	0F374H			; auxiliary output routine
4000 4000 s XF377	equ	0F377H			; routine diskbasic BLOAD
4000 4000 s XF37A	equ	0F37AH			; routine diskbasic BSAVE
4000 4000 s XF37D	equ	0F37DH			; BDOS entry point
4000 4000 s 
4000 4000 s YFB21	equ	0FB21H			; diskdriver table
4000 4000 s YFB29	equ	0FB29H			; diskdriver interrupt table
4000 4000 s 
4000 4000 s RDPRIM	equ	0F380H
4000 4000 s WRPRIM	equ	0F385H
4000 4000 s CLPRIM	equ	0F38CH
4000 4000 s CLPRM1	equ	0F398H
4000 4000 s LINLEN	equ	0F3B0H
4000 4000 s CNSDFG	equ	0F3DEH
4000 4000 s LPTPOS	equ	0F415H
4000 4000 s PRTFLG	equ	0F416H
4000 4000 s CURLIN	equ	0F41CH
4000 4000 s KBUF	equ	0F41FH
4000 4000 s BUF	equ	0F55EH
4000 4000 s TTYPOS	equ	0F661H
4000 4000 s VALTYP	equ	0F663H
4000 4000 s MEMSIZ	equ	0F672H
4000 4000 s STKTOP	equ	0F674H
4000 4000 s TXTTAB	equ	0F676H
4000 4000 s TEMPPT	equ	0F678H
4000 4000 s TEMPST	equ	0F67AH
4000 4000 s DSCTMP	equ	0F698H
4000 4000 s FRETOP	equ	0F69BH
4000 4000 s AUTLIN	equ	0F6ABH
4000 4000 s SAVSTK	equ	0F6B1H
4000 4000 s VARTAB	equ	0F6C2H
4000 4000 s STREND	equ	0F6C6H
4000 4000 s DAC	equ	0F7F6H
4000 4000 s ARG	equ	0F847H
4000 4000 s MAXFIL	equ	0F85FH
4000 4000 s FILTAB	equ	0F860H
4000 4000 s NULBUF	equ	0F862H
4000 4000 s PTRFIL	equ	0F864H
4000 4000 s FILNAM	equ	0F866H
4000 4000 s NLONLY	equ	0F87CH
4000 4000 s SAVEND	equ	0F87DH
4000 4000 s HOKVLD	equ	0FB20H
4000 4000 s BOTTOM	equ	0FC48H
4000 4000 s HIMEM	equ	0FC4AH
4000 4000 s FLBMEM	equ	0FCAEH
4000 4000 s RUNBNF	equ	0FCBEH
4000 4000 s SAVENT	equ	0FCBFH
4000 4000 s EXPTBL	equ	0FCC1H
4000 4000 s SLTTBL	equ	0FCC5H
4000 4000 s SLTATR	equ	0FCC9H
4000 4000 s SLTWRK	equ	0FD09H
4000 4000 s PROCNM	equ	0FD89H
4000 4000 s DEVICE	equ	0FD99H
4000 4000 s 
4000 4000 s H.TIMI	equ	0FD9FH
4000 4000 s H.DSKO	equ	0FDEFH
4000 4000 s H.NAME	equ	0FDF9H
4000 4000 s H.KILL	equ	0FDFEH
4000 4000 s H.COPY	equ	0FE08H
4000 4000 s H.DSKF	equ	0FE12H
4000 4000 s H.DSKI	equ	0FE17H
4000 4000 s H.LSET	equ	0FE21H
4000 4000 s H.RSET	equ	0FE26H
4000 4000 s H.FIEL	equ	0FE2BH
4000 4000 s H.MKI$	equ	0FE30H
4000 4000 s H.MKS$	equ	0FE35H
4000 4000 s H.MKD$	equ	0FE3AH
4000 4000 s H.CVI	equ	0FE3FH
4000 4000 s H.CVS	equ	0FE44H
4000 4000 s H.CVD	equ	0FE49H
4000 4000 s H.GETP	equ	0FE4EH
4000 4000 s H.NOFO	equ	0FE58H
4000 4000 s H.NULO	equ	0FE5DH
4000 4000 s H.NTFL	equ	0FE62H
4000 4000 s H.BINS	equ	0FE71H
4000 4000 s H.BINL	equ	0FE76H
4000 4000 s H.FILE	equ	0FE7BH
4000 4000 s H.DGET	equ	0FE80H
4000 4000 s H.FILO	equ	0FE85H
4000 4000 s H.INDS	equ	0FE8AH
4000 4000 s H.LOC	equ	0FE99H
4000 4000 s H.LOF	equ	0FE9EH
4000 4000 s H.EOF	equ	0FEA3H
4000 4000 s H.BAKU	equ	0FEADH
4000 4000 s H.PARD	equ	0FEB2H
4000 4000 s H.NODE	equ	0FEB7H
4000 4000 s H.POSD	equ	0FEBCH
4000 4000 s H.RUNC	equ	0FECBH
4000 4000 s H.CLEA	equ	0FED0H
4000 4000 s H.LOPD	equ	0FED5H
4000 4000 s H.STKE	equ	0FEDAH
4000 4000 s H.ERRP	equ	0FEFDH
4000 4000 s H.PHYD	equ	0FFA7H
4000 4000 s H.FORM	equ	0FFACH
4000 4000 s EXTBIO	equ	0FFCAH
4000 4000 s DISINT	equ	0FFCFH
4000 4000 s ENAINT	equ	0FFD4H
4000 4000 s 
4000 4000 s YFFFF	equ	0FFFFH
4000 4000 s 
4000 4000 s ; Basic routines
4000 4000 s 
4000 4000 s M.4173	equ	04173H		; return to after statement
4000 4000 s DECSUB	equ	0268CH		; dbl subtract
4000 4000 s DECADD	equ	0269AH		; dbl add
4000 4000 s DECDIV	equ	0289FH		; dbl divide
4000 4000 s VMOVE	equ	02EF3H		; copy variable
4000 4000 s VMOVFM	equ	02F08H		; copy variable
4000 4000 s M.2F10	equ	02F10H		; copy variable
4000 4000 s M.2F99	equ	02F99H		; integer to DAC
4000 4000 s M.3042	equ	03042H		; convert sgn to dbl
4000 4000 s M.30D1	equ	030D1H		; dbl to integer
4000 4000 s M.325C	equ	0325CH		; sgn multiply
4000 4000 s ACLOSE	equ	06C1CH		; close all channels
4000 4000 s EXECLP	equ	04601H		; execution loop
4000 4000 s BADRES	equ	06F0BH		; evaluate adres operand
4000 4000 s GETVAR	equ	05EA4H		; get variable pointer
4000 4000 s GETYPR	equ	05597H		; get operand type
4000 4000 s FRETMP	equ	067D0H		; free temporary string
4000 4000 s EVFSPC	equ	06A0EH		; evaluate filespec
4000 4000 s EVADR	equ	0542FH		; evaluate adres operand
4000 4000 s CNVADR	equ	05432H		; convert to adres
4000 4000 s EVWORD	equ	04756H		; evaluate word operand
4000 4000 s NEVBYT	equ	0521BH		; evaluate next byte operand
4000 4000 s EVBYTE	equ	0521CH		; evaluate byte operand
4000 4000 s CNVBYT	equ	0521FH		; convert to byte
4000 4000 s OUTNL	equ	07328H		; newline to OUTDO
4000 4000 s PTOLN	equ	054F7H		; convert pointers to linenumbers
4000 4000 s CLOCHN	equ	06B24H		; close channel
4000 4000 s MKPTRS	equ	04253H		; recalc linepointers
4000 4000 s OPNCHN	equ	06AFAH		; open channel
4000 4000 s SCROUT	equ	04AFFH		; output back to screen
4000 4000 s EVEXPR	equ	04C64H		; evaluate expression
4000 4000 s GTCHNP	equ	06A6DH		; get channel pointer
4000 4000 s EVLEXP	equ	04C5FH		; evaluate =expression
4000 4000 s ALSSPC	equ	0668EH		; allocate stringspace
4000 4000 s ALTSTR	equ	06627H		; allocate temp string
4000 4000 s CNVDAC	equ	0517AH		; convert DAC to other type
4000 4000 s CSNG	equ	046FFH		; convert to SNG
4000 4000 s COUTNL	equ	07323H		; newline to OUTDO if not at start of line
4000 4000 s ERROR	equ	0406FH		; error
4000 4000 s CHRGTR	equ	04666H		; CHRGTR
4000 4000 s EXEBAS	equ	0409BH		; restart BASIC
4000 4000 s QUITLD	equ	0739AH		; quit loading & start (headloop/executing)
4000 4000 s SKPCHK	equ	06F1DH		; skip strong cassette devicecheck
4000 4000 s M.6E41	equ	06E41H		; resume character putback routine
4000 4000 s 
4000 4000 s BASSCR	equ	07D2FH		; adres init screen for BASIC
4000 4000 s SKPROM	equ	07D17H		; start MSX-BASIC
4000 4000 s RSTCLR	equ	07E14H		; start MSX-BASIC program in ROM
4000 4000 s TXTINI	equ	07D31H		; BASIC initscreen (without INITXT & CNSDFG)
4000 4000 s 
4000 4000 s CALBSV	equ	06E92H		; start of BSAVE routine
4000 4000 s CALBLD	equ	06EC6H		; start of BLOAD routine
4000 4000 s EXEBLD	equ	06EF4H		; finish BLOAD
4000 4000 s 
4000 4000 s RETRTN	equ	0F38BH		; adres with a RET instruction, allways available
4000 4000 s 
4000 4000 s 
4000 4000 s ; FCB structure
4000 4000 s 
4000 4000 s ; off	name	cp/m function		msx function
4000 4000 s 
4000 4000 s ; +0	DR	drive			drive
4000 4000 s ; +1,8	F1-F8	filename		filename
4000 4000 s ; +9,3	T1-T3	filetype		filetype
4000 4000 s ; +12	EX	extent			extent
4000 4000 s ; +13	S1	reserved		fileattribute
4000 4000 s ; +14	S2	reserved		extent high byte / recordsize low byte (block)
4000 4000 s ; +15	RC	record count in extent	record count in extent / recordsize high byte (block)
4000 4000 s ; +16	AL	allocation		Filesize
4000 4000 s ; +20	AL	allocation		Date
4000 4000 s ; +22	AL	allocation		Time
4000 4000 s ; +24	AL	allocation		Devicecode
4000 4000 s ; +25	AL	allocation		Directoryentry Number
4000 4000 s ; +26	AL	allocation		Start Cluster
4000 4000 s ; +28	AL	allocation		Current Cluster
4000 4000 s ; +30	AL	allocation		Current Relative Cluster
4000 4000 s ; +32	CR	record in extent	record in extent
4000 4000 s ; +33,3	R0-R2	random access record	random access record
4000 4000 s ; +36	R3	not used		random access record when recordsize <64
4000 4000 s 
4000 4000 s 
4000 4000 s 
4000 4000 d 4142
4000 4000 s 	defb	"AB"
4002 4002 d 6f57
4002 4002 s 	defw	A576F
4004 4004 d 8b65
4004 4004 s 	defw	A6576
4006 4006 d 0000
4006 4006 s 	defw	0
4008 4008 d 0000
4008 4008 s 	defw	0
400a 400a s 	defs	6
4010 4010 s 
4010 4010 s ; diskdriver entries
4010 4010 s 
4010 4010 d c3a574
4010 4010 s T4010:	jp	DSKIO			; DSKIO entrypoint
4013 4013 d c34375
4013 4013 s T4013:	jp	DSKCHG			; DSKCHG entrypoint
4016 4016 d c34875
4016 4016 s T4016:	jp	GETDPB			; GETDPB entrypoint
4019 4019 d c36d75
4019 4019 s T4019:	jp	CHOICE			; CHOICE entrypoint
401c 401c d c3a475
401c 401c s T401C:	jp	DSKFMT			; DSKFMT entrypoint
401f 401f d c3ef75
401f 401f s T401F:	jp	MTOFF			; MTOFF entrypoint
4022 4022 s 
4022 4022 s ; kernel entries
4022 4022 s 
4022 4022 d c33a5b
4022 4022 s A4022:	jp	A5B3A			; start DiskBasic entrypoint
4025 4025 d 37
4025 4025 s A4025:	scf				; format disk entrypoint (workarea must be supplied)
4026 4026 d c3c660
4026 4026 s 	jp	A60B1
4029 4029 d c32262
4029 4029 s A4029:	jp	A620D			; stop all disks entry point
402c 402c s 
402c 402c s ; Unused code ??
402c 402c s ;
402c 402c d 00
402c 402c s 	nop
402d 402d s 
402d 402d d c3c85f
402d 402d s A402D:	jp	A5FB3			; get slotid entrypoint
4030 4030 s 
4030 4030 s ;	  Subroutine get MSX-DOS system bottom
4030 4030 s ;	     Inputs  -
4030 4030 s ;	     Outputs HL = lowest adres used by the base MSX-DOS system
4030 4030 s 
4030 4030 d 2a4bf3
4030 4030 s A4030:	ld	hl,(YF34B)
4033 4033 d c9
4033 4033 s 	ret
4034 4034 s 
4034 4034 s ;	  Subroutine check if keyboardinput available
4034 4034 s ;	     Inputs  -
4034 4034 s ;	     Outputs Zx set if no input, Zx reset if input, A = input
4034 4034 s 
4034 4034 s 
4034 4034 d dde5
4034 4034 s A4034:	push	ix
4036 4036 d dd21b700
4036 4036 s 	ld	ix,BREAKX
403a 403a d cdab40
403a 403a s 	call	A40AB			; BREAKX BIOS call
403d 403d d dde1
403d 403d s 	pop	ix			; CTRL-STOP pressed ?
403f 403f d 300a
403f 403f s 	jr	nc,A404B		; nope,
4041 4041 d 3e03
4041 4041 s 	ld	a,003H
4043 4043 d 3236f3
4043 4043 s 	ld	(YF336),a		; saved input available
4046 4046 d 3237f3
4046 4046 s 	ld	(YF337),a		; CTRL-C
4049 4049 d a7
4049 4049 s 	and	a			; flag NZ
404a 404a d c9
404a 404a s 	ret
404b 404b s ;
404b 404b d 3a36f3
404b 404b s A404B:	ld	a,(YF336)
404e 404e d a7
404e 404e s 	and	a			; saved input available ?
404f 404f d 3a37f3
404f 404f s 	ld	a,(YF337)
4052 4052 d c0
4052 4052 s 	ret	nz			; yep, return it (flag NZ)
4053 4053 d dde5
4053 4053 s 	push	ix
4055 4055 d dd219c00
4055 4055 s 	ld	ix,CHSNS
4059 4059 d cdab40
4059 4059 s 	call	A40AB			; CHSNS BIOS call
405c 405c d dde1
405c 405c s 	pop	ix			; any chars in the keyboard buffer ?
405e 405e d c8
405e 405e s 	ret	z			; nope, quit (flag Z)
405f 405f d 3eff
405f 405f s 	ld	a,0FFH
4061 4061 d 3236f3
4061 4061 s 	ld	(YF336),a		; flag saved input available
4064 4064 d dde5
4064 4064 s 	push	ix
4066 4066 d dd219f00
4066 4066 s 	ld	ix,CHGET
406a 406a d cdab40
406a 406a s 	call	A40AB			; CHGET BIOS call
406d 406d d dde1
406d 406d s 	pop	ix			; get char from keyboard buffer
406f 406f d 3237f3
406f 406f s 	ld	(YF337),a		; save char
4072 4072 d c5
4072 4072 s 	push	bc
4073 4073 d 0600
4073 4073 s 	ld	b,000H
4075 4075 d 04
4075 4075 s 	inc	b
4076 4076 d c1
4076 4076 s 	pop	bc			; flag NZ
4077 4077 d c9
4077 4077 s 	ret
4078 4078 s 
4078 4078 s ;	  Subroutine get keyboardinput
4078 4078 s ;	     Inputs  -
4078 4078 s ;	     Outputs A = input
4078 4078 s 
4078 4078 d e5
4078 4078 s A4078:	push	hl
4079 4079 d 2136f3
4079 4079 s 	ld	hl,YF336
407c 407c d af
407c 407c s 	xor	a
407d 407d d be
407d 407d s 	cp	(hl)			; saved input available ?
407e 407e d 77
407e 407e s 	ld	(hl),a			; not anymore!
407f 407f d 23
407f 407f s 	inc	hl
4080 4080 d 7e
4080 4080 s 	ld	a,(hl)
4081 4081 d e1
4081 4081 s 	pop	hl
4082 4082 d c0
4082 4082 s 	ret	nz			; yep, return it
4083 4083 d dde5
4083 4083 s 	push	ix
4085 4085 d dd219f00
4085 4085 s 	ld	ix,CHGET
4089 4089 d cdab40
4089 4089 s 	call	A40AB			; CHGET BIOS call
408c 408c d dde1
408c 408c s 	pop	ix			; get char
408e 408e d c9
408e 408e s 	ret
408f 408f s 
408f 408f s ;	  Subroutine output to screen
408f 408f s ;	     Inputs  A = output
408f 408f s ;	     Outputs -
408f 408f s 
408f 408f d dde5
408f 408f s A408F:	push	ix
4091 4091 d dd21a200
4091 4091 s 	ld	ix,CHPUT
4095 4095 d cdab40
4095 4095 s 	call	A40AB			; CHPUT BIOS call
4098 4098 d dde1
4098 4098 s 	pop	ix
409a 409a d c9
409a 409a s 	ret
409b 409b s ;	  Subroutine output to printer
409b 409b s ;	     Inputs  A = output
409b 409b s ;	     Outputs -
409b 409b s 
409b 409b d dde5
409b 409b s A409B:	push	ix
409d 409d d dd21a500
409d 409d s 	ld	ix,LPTOUT
40a1 40a1 d cdab40
40a1 40a1 s 	call	A40AB			; LPTOUT BIOS call
40a4 40a4 d dde1
40a4 40a4 s 	pop	ix
40a6 40a6 d c9
40a6 40a6 s 	ret
40a7 40a7 s 
40a7 40a7 s ;	  Subroutine BDOS 00 (system reset)
40a7 40a7 s ;	     Inputs  
40a7 40a7 s ;	     Outputs ________________________ 
40a7 40a7 s 
40a7 40a7 d dd219b40
40a7 40a7 s A40A7:	ld	ix,EXEBAS
40ab 40ab s 
40ab 40ab s ;	  Subroutine MSX-BIOS call
40ab 40ab s ;	     Inputs  IX = bios call, others depends on the bios call
40ab 40ab s ;	     Outputs depends on the bios call
40ab 40ab s 
40ab 40ab d fde5
40ab 40ab s A40AB:	push	iy
40ad 40ad d fd2ac0fc
40ad 40ad s 	ld	iy,(EXPTBL-1+0)
40b1 40b1 d cd1c00
40b1 40b1 s 	call	CALSLT
40b4 40b4 d fb
40b4 40b4 s 	ei
40b5 40b5 d fde1
40b5 40b5 s 	pop	iy
40b7 40b7 d c9
40b7 40b7 s 	ret
40b8 40b8 s 
40b8 40b8 s ;	  Subroutine check for and initialize clockchip
40b8 40b8 s ;	     Inputs  -
40b8 40b8 s ;	     Outputs -
40b8 40b8 s 
40b8 40b8 d 3e0d
40b8 40b8 s A40B8:	ld	a,13
40ba 40ba d d3b4
40ba 40ba s 	out	(0B4H),a
40bc 40bc d 3e0a
40bc 40bc s 	ld	a,00AH
40be 40be d d3b5
40be 40be s 	out	(0B5H),a		; alarm off, clock running, bank 2
40c0 40c0 d af
40c0 40c0 s 	xor	a
40c1 40c1 d d3b4
40c1 40c1 s 	out	(0B4H),a		; pos 0
40c3 40c3 d 060f
40c3 40c3 s 	ld	b,00FH
40c5 40c5 d dbb5
40c5 40c5 s A40C5:	in	a,(0B5H)		; read data
40c7 40c7 d e60f
40c7 40c7 s 	and	00FH
40c9 40c9 d a8
40c9 40c9 s 	xor	b
40ca 40ca d d3b5
40ca 40ca s 	out	(0B5H),a		; change it and write back
40cc 40cc d 4f
40cc 40cc s 	ld	c,a
40cd 40cd d 00
40cd 40cd s 	nop				; wait or patched code ??
40ce 40ce d dbb5
40ce 40ce s 	in	a,(0B5H)
40d0 40d0 d e60f
40d0 40d0 s 	and	00FH
40d2 40d2 d b9
40d2 40d2 s 	cp	c			; correctly readback ?
40d3 40d3 d c0
40d3 40d3 s 	ret	nz			; nope, no clockchip!
40d4 40d4 d a8
40d4 40d4 s 	xor	b
40d5 40d5 d d3b5
40d5 40d5 s 	out	(0B5H),a		; restore orginal data
40d7 40d7 d 10ec
40d7 40d7 s 	djnz	A40C5			; try all values
40d9 40d9 d 3eff
40d9 40d9 s 	ld	a,0FFH
40db 40db d 3238f3
40db 40db s 	ld	(YF338),a		; flag use clockchip
40de 40de d 3e0d
40de 40de s 	ld	a,13
40e0 40e0 d d3b4
40e0 40e0 s 	out	(0B4H),a
40e2 40e2 d 3e09
40e2 40e2 s 	ld	a,009H
40e4 40e4 d d3b5
40e4 40e4 s 	out	(0B5H),a		; alarm off, clock running, bank 1
40e6 40e6 d 3e0a
40e6 40e6 s 	ld	a,10
40e8 40e8 d d3b4
40e8 40e8 s 	out	(0B4H),a		; pos 10
40ea 40ea d 3e01
40ea 40ea s 	ld	a,1
40ec 40ec d d3b5
40ec 40ec s 	out	(0B5H),a		; 24 hour system
40ee 40ee d 3e0d
40ee 40ee s 	ld	a,13
40f0 40f0 d d3b4
40f0 40f0 s 	out	(0B4H),a
40f2 40f2 d af
40f2 40f2 s 	xor	a
40f3 40f3 d d3b5
40f3 40f3 s 	out	(0B5H),a		; alarm off, clock paused, bank 0
40f5 40f5 d 01000d
40f5 40f5 s 	ld	bc,00D00H
40f8 40f8 d 79
40f8 40f8 s A40F8:	ld	a,c
40f9 40f9 d d3b4
40f9 40f9 s 	out	(0B4H),a
40fb 40fb d dbb5
40fb 40fb s 	in	a,(0B5H)
40fd 40fd d f5
40fd 40fd s 	push	af
40fe 40fe d 0c
40fe 40fe s 	inc	c
40ff 40ff d 10f7
40ff 40ff s 	djnz	A40F8			; save time registers
4101 4101 d 3e0e
4101 4101 s 	ld	a,14
4103 4103 d d3b4
4103 4103 s 	out	(0B4H),a
4105 4105 d af
4105 4105 s 	xor	a
4106 4106 d d3b5
4106 4106 s 	out	(0B5H),a		; clear testbits
4108 4108 d 060d
4108 4108 s 	ld	b,00DH
410a 410a d 0d
410a 410a s A410A:	dec	c
410b 410b d 79
410b 410b s 	ld	a,c
410c 410c d d3b4
410c 410c s 	out	(0B4H),a
410e 410e d f1
410e 410e s 	pop	af
410f 410f d d3b5
410f 410f s 	out	(0B5H),a
4111 4111 d 10f7
4111 4111 s 	djnz	A410A			; restore time registers
4113 4113 d 1839
4113 4113 s 	jr	A414E			; put clock in running mode
4115 4115 s 
4115 4115 s ;	  Subroutine store date
4115 4115 s ;	     Inputs  
4115 4115 s ;	     Outputs -
4115 4115 s 
4115 4115 d 223bf3
4115 4115 s A4115:	ld	(YF33B),hl
4118 4118 d 3a38f3
4118 4118 s 	ld	a,(YF338)
411b 411b d a7
411b 411b s 	and	a			; use clockchip ?
411c 411c d c8
411c 411c s 	ret	z			; no, quit
411d 411d d 3a4af2
411d 411d s 	ld	a,(YF24A)
4120 4120 d 47
4120 4120 s 	ld	b,a
4121 4121 d 3a49f2
4121 4121 s 	ld	a,(YF249)
4124 4124 d 4f
4124 4124 s 	ld	c,a
4125 4125 d 3a48f2
4125 4125 s 	ld	a,(YF248)
4128 4128 d 57
4128 4128 s 	ld	d,a			; current day
4129 4129 d 1e07
4129 4129 s 	ld	e,007H			; nibble 7 (date)
412b 412b d cd5941
412b 412b s 	call	A4159			; pause clock, select bank 0
412e 412e d 1812
412e 412e s 	jr	A4142
4130 4130 s 
4130 4130 s ;	  Subroutine store time
4130 4130 s ;	     Inputs  
4130 4130 s ;	     Outputs -
4130 4130 s 
4130 4130 d 3a38f3
4130 4130 s A4130:	ld	a,(YF338)
4133 4133 d a7
4133 4133 s 	and	a			; use clockchip ?
4134 4134 d c8
4134 4134 s 	ret	z			; no, quit
4135 4135 d 1e00
4135 4135 s 	ld	e,000H			; nibble 0 (time)
4137 4137 d cd5941
4137 4137 s 	call	A4159			; pause clock, select bank 0
413a 413a d 3e0f
413a 413a s 	ld	a,00FH
413c 413c d d3b4
413c 413c s 	out	(0B4H),a
413e 413e d 3e02
413e 413e s 	ld	a,002H
4140 4140 d d3b5
4140 4140 s 	out	(0B5H),a		; time reset
4142 4142 d 62
4142 4142 s A4142:	ld	h,d
4143 4143 d cd6041
4143 4143 s 	call	A4160			; write clockchip byte
4146 4146 d 61
4146 4146 s 	ld	h,c
4147 4147 d cd6041
4147 4147 s 	call	A4160			; write clockchip byte
414a 414a d 60
414a 414a s 	ld	h,b
414b 414b d cd6041
414b 414b s 	call	A4160			; write clockchip byte
414e 414e s 
414e 414e s ;	  Subroutine put clockchip in running mode
414e 414e s ;	     Inputs  -
414e 414e s ;	     Outputs -
414e 414e s 
414e 414e d 3e0d
414e 414e s A414E:	ld	a,13
4150 4150 d d3b4
4150 4150 s 	out	(0B4H),a
4152 4152 d dbb5
4152 4152 s 	in	a,(0B5H)
4154 4154 d f608
4154 4154 s 	or	008H
4156 4156 d d3b5
4156 4156 s A4156:	out	(0B5H),a
4158 4158 d c9
4158 4158 s 	ret
4159 4159 s 
4159 4159 s ;	  Subroutine pause clockchip and select bank 0
4159 4159 s ;	     Inputs  -
4159 4159 s ;	     Outputs -
4159 4159 s 
4159 4159 d cd4e41
4159 4159 s A4159:	call	A414E			; clock in running mode
415c 415c d e604
415c 415c s 	and	004H
415e 415e d 18f6
415e 415e s 	jr	A4156			; clock paused, select bank 0
4160 4160 s 
4160 4160 s ;	  Subroutine write byte to clockchip
4160 4160 s ;	     Inputs  H = data, E = nibblenumber
4160 4160 s ;	     Outputs E = updated nibblenumber (+2)
4160 4160 s 
4160 4160 d af
4160 4160 s A4160:	xor	a
4161 4161 d 2e08
4161 4161 s 	ld	l,8
4163 4163 d cb04
4163 4163 s A4163:	rlc	h
4165 4165 d 8f
4165 4165 s 	adc	a,a
4166 4166 d 27
4166 4166 s 	daa
4167 4167 d 2d
4167 4167 s 	dec	l
4168 4168 d 20f9
4168 4168 s 	jr	nz,A4163		; convert to BCD
416a 416a d cd7141
416a 416a s 	call	A4171
416d 416d d 0f
416d 416d s 	rrca
416e 416e d 0f
416e 416e s 	rrca
416f 416f d 0f
416f 416f s 	rrca
4170 4170 d 0f
4170 4170 s 	rrca
4171 4171 d f5
4171 4171 s A4171:	push	af
4172 4172 d 7b
4172 4172 s 	ld	a,e
4173 4173 d 1c
4173 4173 s 	inc	e
4174 4174 d d3b4
4174 4174 s 	out	(0B4H),a
4176 4176 d f1
4176 4176 s 	pop	af
4177 4177 d 18dd
4177 4177 s 	jr	A4156
4179 4179 s 
4179 4179 s ;	  Subroutine get date and time
4179 4179 s ;	     Inputs  
4179 4179 s ;	     Outputs Cx set if from clockchip,
4179 4179 s 
4179 4179 d 3a38f3
4179 4179 s A4179:	ld	a,(YF338)
417c 417c d a7
417c 417c s 	and	a			; use clockchip ?
417d 417d d 47
417d 417d s 	ld	b,a
417e 417e d 4f
417e 417e s 	ld	c,a
417f 417f d 57
417f 417f s 	ld	d,a
4180 4180 d 5f
4180 4180 s 	ld	e,a			; 00:00:00
4181 4181 d 2a3bf3
4181 4181 s 	ld	hl,(YF33B)		; days since 1-1-1980
4184 4184 d c8
4184 4184 s 	ret	z			; no clockchip, quit
4185 4185 d cd5941
4185 4185 s 	call	A4159			; clock paused, select bank 0
4188 4188 d 1e0d
4188 4188 s 	ld	e,12+1
418a 418a d cdad41
418a 418a s 	call	A41AD			; read byte from clockchip
418d 418d d cd2355
418d 418d s 	call	A5523			; setup days in februari
4190 4190 d cdad41
4190 4190 s 	call	A41AD			; read byte from clockchip
4193 4193 d 3249f2
4193 4193 s 	ld	(YF249),a		; current month
4196 4196 d cdad41
4196 4196 s 	call	A41AD			; read byte from clockchip
4199 4199 d 3248f2
4199 4199 s 	ld	(YF248),a		; current day
419c 419c d 1d
419c 419c s 	dec	e			; nibble 5
419d 419d d cdad41
419d 419d s 	call	A41AD			; read byte from clockchip
41a0 41a0 d 47
41a0 41a0 s 	ld	b,a
41a1 41a1 d cdad41
41a1 41a1 s 	call	A41AD			; read byte from clockchip
41a4 41a4 d 4f
41a4 41a4 s 	ld	c,a
41a5 41a5 d cdad41
41a5 41a5 s 	call	A41AD			; read byte from clockchip
41a8 41a8 d cd4e41
41a8 41a8 s 	call	A414E			; clock in running mode
41ab 41ab d 37
41ab 41ab s 	scf
41ac 41ac d c9
41ac 41ac s 	ret
41ad 41ad s 
41ad 41ad s ;	  Subroutine read byte from clockchip
41ad 41ad s ;	     Inputs  E = nibblenumber+1
41ad 41ad s ;	     Outputs E = updated nibblenumber (-2), A = data
41ad 41ad s 
41ad 41ad d af
41ad 41ad s A41AD:	xor	a
41ae 41ae d cdb541
41ae 41ae s 	call	A41B5
41b1 41b1 d 87
41b1 41b1 s 	add	a,a
41b2 41b2 d 87
41b2 41b2 s 	add	a,a
41b3 41b3 d 82
41b3 41b3 s 	add	a,d
41b4 41b4 d 87
41b4 41b4 s 	add	a,a
41b5 41b5 d 57
41b5 41b5 s A41B5:	ld	d,a
41b6 41b6 d 1d
41b6 41b6 s 	dec	e
41b7 41b7 d 7b
41b7 41b7 s 	ld	a,e
41b8 41b8 d d3b4
41b8 41b8 s 	out	(0B4H),a
41ba 41ba d dbb5
41ba 41ba s 	in	a,(0B5H)
41bc 41bc d e60f
41bc 41bc s 	and	00FH
41be 41be d 82
41be 41be s 	add	a,d
41bf 41bf d 57
41bf 41bf s 	ld	d,a
41c0 41c0 d c9
41c0 41c0 s 	ret
41c1 41c1 s 
41c1 41c1 s ;
41c1 41c1 s ; Identification string (not used)
41c1 41c1 s ;
41c1 41c1 s 
41c1 41c1 d 204d53582d444f53207665722e20322e3220436f707972696768742031393834206279204d6963726f736f667420
41c1 41c1 s 	defb	" MSX-DOS ver. 2.2 Copyright 1984 by Microsoft "
41ef 41ef s 
41ef 41ef s ;	  Subroutine BDOS 0C (return version number)
41ef 41ef s ;	     Inputs  
41ef 41ef s ;	     Outputs ________________________ 
41ef 41ef s 
41ef 41ef d 0600
41ef 41ef s A41EF:	ld	b,000H
41f1 41f1 d 3e22
41f1 41f1 s 	ld	a,022H			; CP/M version 2.2
41f3 41f3 d c9
41f3 41f3 s 	ret
41f4 41f4 s 
41f4 41f4 s ;	  Subroutine get FAT entry content
41f4 41f4 s ;	     Inputs  HL = clusternumber, IX = pointer to DPB
41f4 41f4 s ;	     Outputs HL = clusterentry content, Zx set if entry is free, DE = pointer to FAT buffer
41f4 41f4 s 
41f4 41f4 d dd5e13
41f4 41f4 s A41F4:	ld	e,(ix+013H)
41f7 41f7 d dd5614
41f7 41f7 s 	ld	d,(ix+014H)		; pointer to FAT buffer of drive
41fa 41fa d cd52f2
41fa 41fa s A41FA:	call	XF252
41fd 41fd d d5
41fd 41fd s 	push	de
41fe 41fe d 5d
41fe 41fe s 	ld	e,l
41ff 41ff d 54
41ff 41ff s 	ld	d,h
4200 4200 d cb3c
4200 4200 s 	srl	h
4202 4202 d cb1d
4202 4202 s 	rr	l
4204 4204 d 1f
4204 4204 s 	rra
4205 4205 d 19
4205 4205 s 	add	hl,de
4206 4206 d d1
4206 4206 s 	pop	de
4207 4207 d 19
4207 4207 s 	add	hl,de
4208 4208 d 17
4208 4208 s 	rla
4209 4209 d 7e
4209 4209 s 	ld	a,(hl)
420a 420a d 23
420a 420a s 	inc	hl
420b 420b d 66
420b 420b s 	ld	h,(hl)
420c 420c d 300c
420c 420c s 	jr	nc,A421A
420e 420e d cb3c
420e 420e s 	srl	h
4210 4210 d 1f
4210 4210 s 	rra
4211 4211 d cb3c
4211 4211 s 	srl	h
4213 4213 d 1f
4213 4213 s 	rra
4214 4214 d cb3c
4214 4214 s 	srl	h
4216 4216 d 1f
4216 4216 s 	rra
4217 4217 d cb3c
4217 4217 s 	srl	h
4219 4219 d 1f
4219 4219 s 	rra
421a 421a d 6f
421a 421a s A421A:	ld	l,a
421b 421b d 7c
421b 421b s 	ld	a,h
421c 421c d e60f
421c 421c s 	and	00FH
421e 421e d 67
421e 421e s 	ld	h,a
421f 421f d b5
421f 421f s 	or	l
4220 4220 d c9
4220 4220 s 	ret
4221 4221 s 
4221 4221 s ;	  Subroutine set FAT entry content
4221 4221 s ;	     Inputs  HL = clusternumber, DE = pointer to FAT buffer, BC = clusterentry content
4221 4221 s ;	     Outputs -
4221 4221 s 
4221 4221 d d5
4221 4221 s A4221:	push	de
4222 4222 d 5d
4222 4222 s 	ld	e,l
4223 4223 d 54
4223 4223 s 	ld	d,h
4224 4224 d cb3c
4224 4224 s 	srl	h
4226 4226 d cb1d
4226 4226 s 	rr	l
4228 4228 d 1f
4228 4228 s 	rra
4229 4229 d 19
4229 4229 s 	add	hl,de
422a 422a d d1
422a 422a s 	pop	de
422b 422b d 19
422b 422b s 	add	hl,de
422c 422c d 17
422c 422c s 	rla
422d 422d d 3018
422d 422d s 	jr	nc,A4247
422f 422f d cb21
422f 422f s 	sla	c
4231 4231 d cb10
4231 4231 s 	rl	b
4233 4233 d cb21
4233 4233 s 	sla	c
4235 4235 d cb10
4235 4235 s 	rl	b
4237 4237 d cb21
4237 4237 s 	sla	c
4239 4239 d cb10
4239 4239 s 	rl	b
423b 423b d cb21
423b 423b s 	sla	c
423d 423d d cb10
423d 423d s 	rl	b
423f 423f d 7e
423f 423f s 	ld	a,(hl)
4240 4240 d e60f
4240 4240 s 	and	00FH
4242 4242 d b1
4242 4242 s 	or	c
4243 4243 d 77
4243 4243 s 	ld	(hl),a
4244 4244 d 23
4244 4244 s 	inc	hl
4245 4245 d 70
4245 4245 s 	ld	(hl),b
4246 4246 d c9
4246 4246 s 	ret
4247 4247 s 
4247 4247 d 71
4247 4247 s A4247:	ld	(hl),c
4248 4248 d 23
4248 4248 s 	inc	hl
4249 4249 d 7e
4249 4249 s 	ld	a,(hl)
424a 424a d e6f0
424a 424a s 	and	0F0H
424c 424c d b0
424c 424c s 	or	b
424d 424d d 77
424d 424d s 	ld	(hl),a
424e 424e d c9
424e 424e s 	ret
424f 424f s 
424f 424f s ;	  Subroutine compare with filename1
424f 424f s ;	     Inputs  HL = pointer to buffer, B = size
424f 424f s ;	     Outputs Zx set if equal
424f 424f s 
424f 424f d 11b9f2
424f 424f s A424F:	ld	de,YF2B9
4252 4252 s 
4252 4252 s ;	  Subroutine compare
4252 4252 s ;	     Inputs  DE = pointer to buffer1, HL = pointer to buffer2, B = size
4252 4252 s ;	     Outputs Zx set if equal
4252 4252 s 
4252 4252 d 1a
4252 4252 s A4252:	ld	a,(de)
4253 4253 d be
4253 4253 s 	cp	(hl)
4254 4254 d 23
4254 4254 s 	inc	hl
4255 4255 d 13
4255 4255 s 	inc	de
4256 4256 d c0
4256 4256 s 	ret	nz
4257 4257 d 10f9
4257 4257 s 	djnz	A4252
4259 4259 d c9
4259 4259 s 	ret
425a 425a s 
425a 425a s ;	  Subroutine check if devicename
425a 425a s ;	     Inputs  
425a 425a s ;	     Outputs ________________________ 
425a 425a s 
425a 425a d cd55f2
425a 425a s A425A:	call	XF255
425d 425d d 21f7f1
425d 425d s 	ld	hl,YF1F7		; table with devicenames
4260 4260 d 0e05
4260 4260 s 	ld	c,5			; 5 devices
4262 4262 d 0604
4262 4262 s A4262:	ld	b,4			; only check 4 bytes (because devicenames are only 4 chars long)
4264 4264 d cd4f42
4264 4264 s 	call	A424F			; compare with filename1
4267 4267 d 202f
4267 4267 s 	jr	nz,A4298		; not this device, try the next
4269 4269 d 0604
4269 4269 s 	ld	b,4
426b 426b d 1a
426b 426b s A426B:	ld	a,(de)
426c 426c d 13
426c 426c s 	inc	de
426d 426d d fe20
426d 426d s 	cp	" "
426f 426f d 2032
426f 426f s 	jr	nz,A42A3		; last 4 bytes of filename not spaces, not a device
4271 4271 d 10f8
4271 4271 s 	djnz	A426B
4273 4273 d 79
4273 4273 s 	ld	a,c
4274 4274 d ed44
4274 4274 s 	neg
4276 4276 d 3216f2
4276 4276 s 	ld	(YF20B+11),a		; devicecode
4279 4279 d 21b9f2
4279 4279 s 	ld	hl,YF2B9
427c 427c d 110bf2
427c 427c s 	ld	de,YF20B
427f 427f d 010400
427f 427f s 	ld	bc,4
4282 4282 d edb0
4282 4282 s 	ldir				; copy of devicename
4284 4284 d cd9654
4284 4284 s 	call	A5496			; get time and date (dirformat)
4287 4287 d ed4323f2
4287 4287 s 	ld	(YF20B+24),bc
428b 428b d ed5321f2
428b 428b s 	ld	(YF20B+22),de
428f 428f d 210bf2
428f 428f s 	ld	hl,YF20B
4292 4292 d e5
4292 4292 s 	push	hl
4293 4293 d fde1
4293 4293 s 	pop	iy
4295 4295 d f601
4295 4295 s 	or	001H			; Cx reset, Zx reset
4297 4297 d c9
4297 4297 s 	ret
4298 4298 s 
4298 4298 d 05
4298 4298 s A4298:	dec	b
4299 4299 d 7d
4299 4299 s 	ld	a,l
429a 429a d 80
429a 429a s 	add	a,b
429b 429b d 6f
429b 429b s 	ld	l,a
429c 429c d 7c
429c 429c s 	ld	a,h
429d 429d d ce00
429d 429d s 	adc	a,000H
429f 429f d 67
429f 429f s 	ld	h,a
42a0 42a0 d 0d
42a0 42a0 s 	dec	c
42a1 42a1 d 20bf
42a1 42a1 s 	jr	nz,A4262
42a3 42a3 s 					; Zx set
42a3 42a3 d 37
42a3 42a3 s A42A3:	scf
42a4 42a4 d c9
42a4 42a4 s 	ret
42a5 42a5 s 
42a5 42a5 s ;	  Subroutine validate FCB, clear S2 and find direntry
42a5 42a5 s ;	     Inputs  
42a5 42a5 s ;	     Outputs ________________________ 
42a5 42a5 s 
42a5 42a5 d d5
42a5 42a5 s A42A5:	push	de
42a6 42a6 d 210e00
42a6 42a6 s 	ld	hl,0000EH
42a9 42a9 d 19
42a9 42a9 s 	add	hl,de
42aa 42aa d 3600
42aa 42aa s 	ld	(hl),0			; FCB S2 (extent high byte)
42ac 42ac d cdb142
42ac 42ac s 	call	A42B1			; validate FCB drive and filename and find direntry
42af 42af d d1
42af 42af s 	pop	de
42b0 42b0 d c9
42b0 42b0 s 	ret
42b1 42b1 s ;
42b1 42b1 d cd0e44
42b1 42b1 s A42B1:	call	A440E			; validate FCB drive and filename
42b4 42b4 d d8
42b4 42b4 s 	ret	c			; invalid, quit
42b5 42b5 s 
42b5 42b5 s ;	  Subroutine find first directoryentry
42b5 42b5 s ;	     Inputs  
42b5 42b5 s ;	     Outputs ________________________ 
42b5 42b5 s 
42b5 42b5 d cd5a42
42b5 42b5 s A42B5:	call	A425A			; check if devicename
42b8 42b8 d d0
42b8 42b8 s 	ret	nc			; yep, quit with pointer to fake device direntry
42b9 42b9 d cdd344
42b9 42b9 s 	call	A44D3			; reset direntry search and get latest FAT
42bc 42bc s 
42bc 42bc s ;	  Subroutine find next directoryentry
42bc 42bc s ;	     Inputs  
42bc 42bc s ;	     Outputs ________________________ 
42bc 42bc s 
42bc 42bc d cd58f2
42bc 42bc s A42BC:	call	XF258
42bf 42bf d cd0e43
42bf 42bf s 	call	A430E			; get next direntry
42c2 42c2 d d8
42c2 42c2 s 	ret	c			; no more, quit
42c3 42c3 d 7e
42c3 42c3 s A42C3:	ld	a,(hl)
42c4 42c4 d b7
42c4 42c4 s 	or	a
42c5 42c5 d 2835
42c5 42c5 s 	jr	z,A42FC			; unused entry,
42c7 42c7 d fee5
42c7 42c7 s 	cp	0E5H
42c9 42c9 d 2831
42c9 42c9 s 	jr	z,A42FC			; deleted entry,
42cb 42cb d e5
42cb 42cb s 	push	hl
42cc 42cc d 060b
42cc 42cc s 	ld	b,11
42ce 42ce d 11b9f2
42ce 42ce s 	ld	de,YF2B9
42d1 42d1 d cd5242
42d1 42d1 s A42D1:	call	A4252			; compare with fcb filename
42d4 42d4 d 2806
42d4 42d4 s 	jr	z,A42DC			; equal, found!
42d6 42d6 d fe3f
42d6 42d6 s 	cp	"?"
42d8 42d8 d 201b
42d8 42d8 s 	jr	nz,A42F5		; on difference no wildcard, try next
42da 42da d 10f5
42da 42da s 	djnz	A42D1			; wildcard pos ignored, check rest
42dc 42dc d e1
42dc 42dc s A42DC:	pop	hl
42dd 42dd d e5
42dd 42dd s 	push	hl
42de 42de d fde1
42de 42de s 	pop	iy
42e0 42e0 d 3ac4f2
42e0 42e0 s 	ld	a,(YF2C4)
42e3 42e3 d ee80
42e3 42e3 s 	xor	080H
42e5 42e5 d cb7f
42e5 42e5 s 	bit	7,a
42e7 42e7 d c8
42e7 42e7 s 	ret	z			; orginal FCB DR byte had b7 set, ignore direntryattribute
42e8 42e8 d fd7e0b
42e8 42e8 s 	ld	a,(iy+00BH)
42eb 42eb d e61e
42eb 42eb s 	and	01EH
42ed 42ed d c8
42ed 42ed s 	ret	z			; files with archive or read-only bit set are ok, quit
42ee 42ee d 3adcf2
42ee 42ee s 	ld	a,(YF2DC)
42f1 42f1 d b7
42f1 42f1 s 	or	a			; include special fileattribute flag set ?
42f2 42f2 d c0
42f2 42f2 s 	ret	nz			; yep, every direntry is ok, quit
42f3 42f3 d 1801
42f3 42f3 s 	jr	A42F6
42f5 42f5 s 
42f5 42f5 d e1
42f5 42f5 s A42F5:	pop	hl
42f6 42f6 d cd4843
42f6 42f6 s A42F6:	call	A4348			; get next direntry (while searching)
42f9 42f9 d 30c8
42f9 42f9 s 	jr	nc,A42C3		; ok, check it
42fb 42fb d c9
42fb 42fb s 	ret
42fc 42fc s 
42fc 42fc d 3afef2
42fc 42fc s A42FC:	ld	a,(YF2FE)
42ff 42ff d 3c
42ff 42ff s 	inc	a			; already found a free direntry ?
4300 4300 d 2006
4300 4300 s 	jr	nz,A4308
4302 4302 d 3ab8f2
4302 4302 s 	ld	a,(YF2B8)
4305 4305 d 32fef2
4305 4305 s 	ld	(YF2FE),a		; nope, register it
4308 4308 d 7e
4308 4308 s A4308:	ld	a,(hl)
4309 4309 d b7
4309 4309 s 	or	a			; unused direntry ?
430a 430a d 20ea
430a 430a s 	jr	nz,A42F6		; nope, the search goes on!
430c 430c d 37
430c 430c s 	scf
430d 430d d c9
430d 430d s 	ret
430e 430e s 
430e 430e s ;	  Subroutine get next direntry (at start of search)
430e 430e s ;	     Inputs  
430e 430e s ;	     Outputs ________________________ 
430e 430e s 
430e 430e d 3ab8f2
430e 430e s A430E:	ld	a,(YF2B8)
4311 4311 d 3c
4311 4311 s 	inc	a
4312 4312 d ddbe0b
4312 4312 s 	cp	(ix+00BH)		; last direntry ?
4315 4315 d 3050
4315 4315 s 	jr	nc,A4367		; yep, update directory of disk when needed and quit
4317 4317 s 
4317 4317 s ;	  Subroutine get direntry
4317 4317 s ;	     Inputs  
4317 4317 s ;	     Outputs ________________________ 
4317 4317 s 
4317 4317 d cd5bf2
4317 4317 s A4317:	call	XF25B
431a 431a d 32b8f2
431a 431a s 	ld	(YF2B8),a
431d 431d d 4f
431d 431d s 	ld	c,a
431e 431e d dda604
431e 431e s 	and	(ix+004H)		; dirmask
4321 4321 d 6f
4321 4321 s 	ld	l,a
4322 4322 d 2600
4322 4322 s 	ld	h,000H
4324 4324 d 29
4324 4324 s 	add	hl,hl
4325 4325 d 29
4325 4325 s 	add	hl,hl
4326 4326 d 29
4326 4326 s 	add	hl,hl
4327 4327 d 29
4327 4327 s 	add	hl,hl
4328 4328 d 29
4328 4328 s 	add	hl,hl
4329 4329 d ed5b51f3
4329 4329 s 	ld	de,(YF351)		; dirsector buffer
432d 432d d 19
432d 432d s 	add	hl,de
432e 432e d dd4605
432e 432e s 	ld	b,(ix+005H)		; dirshift
4331 4331 d cb39
4331 4331 s A4331:	srl	c
4333 4333 d 10fc
4333 4333 s 	djnz	A4331
4335 4335 d 3a45f2
4335 4335 s 	ld	a,(YF245)
4338 4338 d b9
4338 4338 s 	cp	c			; same as dirsector currently in buffer ?
4339 4339 d 2007
4339 4339 s 	jr	nz,A4342		; nope, go get it
433b 433b d 3a46f2
433b 433b s 	ld	a,(YF246)
433e 433e d ddbe00
433e 433e s 	cp	(ix+000H)		; same driveid as dirsector buffer owner ?
4341 4341 d c8
4341 4341 s 	ret	z			; yep, do nothing
4342 4342 d e5
4342 4342 s A4342:	push	hl
4343 4343 d cda446
4343 4343 s 	call	A46A4			; read dirsector
4346 4346 d e1
4346 4346 s 	pop	hl
4347 4347 d c9
4347 4347 s 	ret
4348 4348 s 
4348 4348 s ;	  Subroutine get next direntry (while searching)
4348 4348 s ;	     Inputs  
4348 4348 s ;	     Outputs ________________________ 
4348 4348 s 
4348 4348 d cd5ef2
4348 4348 s A4348:	call	XF25E
434b 434b d 3ab8f2
434b 434b s 	ld	a,(YF2B8)
434e 434e d 3c
434e 434e s 	inc	a
434f 434f d ddbe0b
434f 434f s 	cp	(ix+00BH)		; last direntry ?
4352 4352 d 3013
4352 4352 s 	jr	nc,A4367		; yep, update directory of disk when needed and quit
4354 4354 d 32b8f2
4354 4354 s 	ld	(YF2B8),a
4357 4357 d 112000
4357 4357 s 	ld	de,00020H
435a 435a d 19
435a 435a s 	add	hl,de
435b 435b d dda604
435b 435b s 	and	(ix+004H)		; dirmask
435e 435e d c0
435e 435e s 	ret	nz
435f 435f d 0c
435f 435f s 	inc	c
4360 4360 d cda446
4360 4360 s 	call	A46A4			; read dirsector
4363 4363 d 2a51f3
4363 4363 s 	ld	hl,(YF351)		; dirsector buffer
4366 4366 d c9
4366 4366 s 	ret
4367 4367 s 
4367 4367 s ;	  Subroutine at end of directory
4367 4367 s ;	     Inputs  
4367 4367 s ;	     Outputs ________________________ 
4367 4367 s 
4367 4367 d cd4347
4367 4367 s A4367:	call	A4743			; update directory of disk when needed
436a 436a d 37
436a 436a s 	scf
436b 436b d c9
436b 436b s 	ret
436c 436c s 
436c 436c s ;	  Subroutine BDOS 13 (delete file)
436c 436c s ;	     Inputs  
436c 436c s ;	     Outputs ________________________ 
436c 436c s 
436c 436c d cd0e44
436c 436c s A436C:	call	A440E			; validate FCB drive and filename
436f 436f d d4b542
436f 436f s 	call	nc,A42B5		; valid, find first directoryentry
4372 4372 d 3eff
4372 4372 s 	ld	a,0FFH
4374 4374 d d8
4374 4374 s 	ret	c			; invalid or not found, quit with error
4375 4375 d c0
4375 4375 s 	ret	nz			; device, quit with error
4376 4376 d 3ee5
4376 4376 s A4376:	ld	a,0E5H
4378 4378 d 323cf2
4378 4378 s 	ld	(YF23C),a		; flag directory buffer changed
437b 437b d 77
437b 437b s 	ld	(hl),a			; deleted direntry
437c 437c d fd6e1a
437c 437c s 	ld	l,(iy+01AH)
437f 437f d fd661b
437f 437f s 	ld	h,(iy+01BH)
4382 4382 d 7c
4382 4382 s 	ld	a,h			; file has start cluster ?
4383 4383 d b5
4383 4383 s 	or	l
4384 4384 d c49b4f
4384 4384 s 	call	nz,A4F9B		; yep, release chain
4387 4387 d cdbc42
4387 4387 s 	call	A42BC			; find next directoryentry
438a 438a d 30ea
438a 438a s 	jr	nc,A4376		; found, delete next file
438c 438c d cd0344
438c 438c s 	call	A4403			; update directory of disk (SHOULD BE: CALL A4748)
438f 438f d c3cf45
438f 438f s 	jp	A45CF			; write FAT (SHOULD BE: JP A45C4, write FAT when needed)
4392 4392 s 
4392 4392 s ;	  Subroutine BDOS 17 (rename file)
4392 4392 s ;	     Inputs  
4392 4392 s ;	     Outputs ________________________ 
4392 4392 s 
4392 4392 d cd0e44
4392 4392 s A4392:	call	A440E			; validate FCB drive and filename
4395 4395 d 3874
4395 4395 s 	jr	c,A440B			; invalid, quit with error
4397 4397 d 110500
4397 4397 s 	ld	de,00005H
439a 439a d 19
439a 439a s 	add	hl,de			; to new filename
439b 439b d 11c5f2
439b 439b s 	ld	de,YF2C5		; new filenamebuffer
439e 439e d cdf4f1
439e 439e s 	call	XF1F4			; validate FCB filename (new filename)
43a1 43a1 d d4b542
43a1 43a1 s 	call	nc,A42B5		; new filename valid, find first directoryentry
43a4 43a4 d 3865
43a4 43a4 s 	jr	c,A440B			; invalid or not found, quit with error
43a6 43a6 d 2063
43a6 43a6 s 	jr	nz,A440B
43a8 43a8 d 21b9f2
43a8 43a8 s 	ld	hl,YF2B9
43ab 43ab d 11d0f2
43ab 43ab s 	ld	de,YF2D0
43ae 43ae d 010c00
43ae 43ae s 	ld	bc,11+1
43b1 43b1 d edb0
43b1 43b1 s 	ldir				; save filename (search specifier) + orginal DR byte
43b3 43b3 d 21c5f2
43b3 43b3 s A43B3:	ld	hl,YF2C5		; new filename
43b6 43b6 d 11b9f2
43b6 43b6 s 	ld	de,YF2B9
43b9 43b9 d 060b
43b9 43b9 s 	ld	b,11
43bb 43bb d 7e
43bb 43bb s A43BB:	ld	a,(hl)
43bc 43bc d fe3f
43bc 43bc s 	cp	"?"			; wildcard char ?
43be 43be d 2003
43be 43be s 	jr	nz,A43C3		; nope, use the char of the new filename
43c0 43c0 d fd7e00
43c0 43c0 s 	ld	a,(iy+000H)		; yep, use the char of the orginal filename
43c3 43c3 d 12
43c3 43c3 s A43C3:	ld	(de),a
43c4 43c4 d 23
43c4 43c4 s 	inc	hl
43c5 43c5 d 13
43c5 43c5 s 	inc	de
43c6 43c6 d fd23
43c6 43c6 s 	inc	iy
43c8 43c8 d 10f1
43c8 43c8 s 	djnz	A43BB
43ca 43ca d 3e80
43ca 43ca s 	ld	a,080H
43cc 43cc d 12
43cc 43cc s 	ld	(de),a			; ´orginal DR byte´ b7 set (ignore fileattribute)
43cd 43cd d cd5a42
43cd 43cd s 	call	A425A			; check if devicename
43d0 43d0 d 3036
43d0 43d0 s 	jr	nc,A4408		; yep, end rename with error
43d2 43d2 d 3ab8f2
43d2 43d2 s 	ld	a,(YF2B8)
43d5 43d5 d f5
43d5 43d5 s 	push	af
43d6 43d6 d 3eff
43d6 43d6 s 	ld	a,0FFH
43d8 43d8 d 32b8f2
43d8 43d8 s 	ld	(YF2B8),a		; flag direntry search start at the begin
43db 43db d cdbc42
43db 43db s 	call	A42BC			; find next directoryentry
43de 43de d c1
43de 43de s 	pop	bc
43df 43df d 3027
43df 43df s 	jr	nc,A4408		; found, so resulting filename does already exist. end rename with error
43e1 43e1 d 78
43e1 43e1 s 	ld	a,b
43e2 43e2 d cd1743
43e2 43e2 s 	call	A4317			; get direntry which get renamed
43e5 43e5 d eb
43e5 43e5 s 	ex	de,hl
43e6 43e6 d 21b9f2
43e6 43e6 s 	ld	hl,YF2B9
43e9 43e9 d 010b00
43e9 43e9 s 	ld	bc,11
43ec 43ec d edb0
43ec 43ec s 	ldir				; replace filename with new one
43ee 43ee d 3eff
43ee 43ee s 	ld	a,0FFH
43f0 43f0 d 323cf2
43f0 43f0 s 	ld	(YF23C),a		; flag directory buffer changed
43f3 43f3 d 21d0f2
43f3 43f3 s 	ld	hl,YF2D0
43f6 43f6 d 11b9f2
43f6 43f6 s 	ld	de,YF2B9
43f9 43f9 d 010c00
43f9 43f9 s 	ld	bc,11+1
43fc 43fc d edb0
43fc 43fc s 	ldir				; restore filename (search specifier) + orginal DR byte
43fe 43fe d cdbc42
43fe 43fe s 	call	A42BC			; find next directoryentry
4401 4401 d 30b0
4401 4401 s 	jr	nc,A43B3		; found, rename next file
4403 4403 d cd4347
4403 4403 s A4403:	call	A4743			; update directory of disk when needed 
4406 4406 d af
4406 4406 s 	xor	a			; no error
4407 4407 d c9
4407 4407 s 	ret
4408 4408 s ;
4408 4408 d cd4347
4408 4408 s A4408:	call	A4743			; update directory of disk when needed
440b 440b d 3eff
440b 440b s A440B:	ld	a,0FFH			; error
440d 440d d c9
440d 440d s 	ret
440e 440e s 
440e 440e s ;	  Subroutine validate FCB drive and filename
440e 440e s ;	     Inputs  
440e 440e s ;	     Outputs ________________________ 
440e 440e s 
440e 440e d cd61f2
440e 440e s A440E:	call	XF261
4411 4411 d af
4411 4411 s 	xor	a
4412 4412 d 32dcf2
4412 4412 s 	ld	(YF2DC),a		; do not include special fileattributes
4415 4415 d eb
4415 4415 s 	ex	de,hl
4416 4416 d 7e
4416 4416 s 	ld	a,(hl)
4417 4417 d 23
4417 4417 s 	inc	hl
4418 4418 d 32c4f2
4418 4418 s 	ld	(YF2C4),a		; save FCB DR byte
441b 441b d e60f
441b 441b s 	and	00FH			; only use b3-b0 for drive
441d 441d d cd2744
441d 441d s 	call	A4427			; validate fcb driveid
4420 4420 d d8
4420 4420 s 	ret	c
4421 4421 d 11b9f2
4421 4421 s 	ld	de,YF2B9
4424 4424 d c3f4f1
4424 4424 s 	jp	XF1F4			; validate FCB filename
4427 4427 s 
4427 4427 s ;	  Subroutine Validate driveid (FCB style)
4427 4427 s ;	     Inputs  A = driveid
4427 4427 s ;	     Outputs ________________________ 
4427 4427 s 
4427 4427 d 4f
4427 4427 s A4427:	ld	c,a
4428 4428 d 3a47f3
4428 4428 s 	ld	a,(YF347)
442b 442b d b9
442b 442b s 	cp	c
442c 442c d d8
442c 442c s 	ret	c
442d 442d d 79
442d 442d s 	ld	a,c
442e 442e d 3d
442e 442e s 	dec	a
442f 442f d f23544
442f 442f s 	jp	p,A4435
4432 4432 d 3a47f2
4432 4432 s 	ld	a,(YF247)		; default driveid
4435 4435 d 32e1f2
4435 4435 s A4435:	ld	(YF2E1),a		; set current driveid
4438 4438 d c9
4438 4438 s 	ret
4439 4439 s 
4439 4439 s ;	  Subroutine get max record and extent
4439 4439 s ;	     Inputs  
4439 4439 s ;	     Outputs ________________________ 
4439 4439 s 
4439 4439 d fd7e1f
4439 4439 s A4439:	ld	a,(iy+01FH)
443c 443c d b7
443c 443c s 	or	a
443d 443d d 201f
443d 443d s 	jr	nz,A445E		; filesize > 16777215, use max value
443f 443f d fd7e1c
443f 443f s 	ld	a,(iy+01CH)
4442 4442 d fd4e1d
4442 4442 s 	ld	c,(iy+01DH)
4445 4445 d fd461e
4445 4445 s 	ld	b,(iy+01EH)
4448 4448 d 87
4448 4448 s 	add	a,a
4449 4449 d cb11
4449 4449 s 	rl	c
444b 444b d cb10
444b 444b s 	rl	b			; number of records (128 bytes)
444d 444d d 380f
444d 444d s 	jr	c,A445E			; >65535, use max value
444f 444f d b7
444f 444f s 	or	a			; is filesize a multiply of 128 ?
4450 4450 d 2805
4450 4450 s 	jr	z,A4457
4452 4452 d 03
4452 4452 s 	inc	bc			; nope, increase the recordnumber
4453 4453 d 78
4453 4453 s 	ld	a,b
4454 4454 d b1
4454 4454 s 	or	c			; does that fit ?
4455 4455 d 2807
4455 4455 s 	jr	z,A445E			; nope, use max value
4457 4457 d 79
4457 4457 s A4457:	ld	a,c
4458 4458 d cbb9
4458 4458 s 	res	7,c			; c = max recordnumber (0-127)
445a 445a d 87
445a 445a s 	add	a,a
445b 445b d cb10
445b 445b s 	rl	b			; b = max extent
445d 445d d d0
445d 445d s 	ret	nc			; does fit, quit
445e 445e d 017fff
445e 445e s A445E:	ld	bc,0FF7FH		; extent 255, record 127
4461 4461 d c9
4461 4461 s 	ret
4462 4462 s 
4462 4462 s ;	  Subroutine BDOS 0F (open file)
4462 4462 s ;	     Inputs  
4462 4462 s ;	     Outputs ________________________ 
4462 4462 s 
4462 4462 d cda542
4462 4462 s A4462:	call	A42A5			; validate FCB, clear S2 and find direntry
4465 4465 d 38a4
4465 4465 s 	jr	c,A440B			; error, quit with error
4467 4467 d cd3944
4467 4467 s 	call	A4439			; get max record and extent
446a 446a d 3a0cf3
446a 446a s 	ld	a,(YF30C)		; original FCB EX byte
446d 446d d 04
446d 446d s 	inc	b			; ?? correct for large files (filesize > 4177919 where extend is 0FFH)
446e 446e d b8
446e 446e s 	cp	b			; is extent of file big enough ?
446f 446f d 309a
446f 446f s 	jr	nc,A440B		; nope, quit with error
4471 4471 d cd64f2
4471 4471 s A4471:	call	XF264
4474 4474 d eb
4474 4474 s 	ex	de,hl
4475 4475 d 010f00
4475 4475 s 	ld	bc,0000FH
4478 4478 d 09
4478 4478 s 	add	hl,bc
4479 4479 d cd3944
4479 4479 s 	call	A4439			; get max record and extent
447c 447c d 3a0cf3
447c 447c s 	ld	a,(YF30C)
447f 447f d b8
447f 447f s 	cp	b			; orginal FCB EX byte same as max extent ?
4480 4480 d 2806
4480 4480 s 	jr	z,A4488			; same, use RC=max recordnumber (means extent is not full)
4482 4482 d 0e80
4482 4482 s 	ld	c,080H
4484 4484 d 3802
4484 4484 s 	jr	c,A4488			; smaller, use RC=128 (means extend is full)
4486 4486 d 0e00
4486 4486 s 	ld	c,000H			; bigger, use RC=0 (means extend is empty)
4488 4488 d 71
4488 4488 s A4488:	ld	(hl),c			; RC
4489 4489 d 23
4489 4489 s 	inc	hl
448a 448a d eb
448a 448a s 	ex	de,hl
448b 448b d 011c00
448b 448b s 	ld	bc,0001CH
448e 448e d 09
448e 448e s 	add	hl,bc
448f 448f d 0e04
448f 448f s 	ld	c,004H
4491 4491 d edb0
4491 4491 s 	ldir				; copy filesize
4493 4493 d 01f8ff
4493 4493 s 	ld	bc,0FFF8H
4496 4496 d 09
4496 4496 s 	add	hl,bc
4497 4497 d eda0
4497 4497 s 	ldi
4499 4499 d eda0
4499 4499 s 	ldi				; creation date
449b 449b d 0efc
449b 449b s 	ld	c,0FCH
449d 449d d 09
449d 449d s 	add	hl,bc
449e 449e d eda0
449e 449e s 	ldi
44a0 44a0 d eda0
44a0 44a0 s 	ldi				; creation time
44a2 44a2 d fd7e0b
44a2 44a2 s 	ld	a,(iy+00BH)
44a5 44a5 d cb7f
44a5 44a5 s 	bit	7,a
44a7 44a7 d 2005
44a7 44a7 s 	jr	nz,A44AE		; device,
44a9 44a9 d dd7e00
44a9 44a9 s 	ld	a,(ix+000H)		; driveid
44ac 44ac d f640
44ac 44ac s 	or	040H			; flag diskfile unchanged
44ae 44ae d 12
44ae 44ae s A44AE:	ld	(de),a			; devicecode
44af 44af d 13
44af 44af s 	inc	de
44b0 44b0 d 3ab8f2
44b0 44b0 s 	ld	a,(YF2B8)
44b3 44b3 d 12
44b3 44b3 s 	ld	(de),a			; direntry number
44b4 44b4 d 13
44b4 44b4 s 	inc	de
44b5 44b5 d fd7e1a
44b5 44b5 s 	ld	a,(iy+01AH)
44b8 44b8 d 12
44b8 44b8 s 	ld	(de),a
44b9 44b9 d 13
44b9 44b9 s 	inc	de
44ba 44ba d 13
44ba 44ba s 	inc	de
44bb 44bb d 12
44bb 44bb s 	ld	(de),a
44bc 44bc d 1b
44bc 44bc s 	dec	de
44bd 44bd d fd7e1b
44bd 44bd s 	ld	a,(iy+01BH)
44c0 44c0 d 12
44c0 44c0 s 	ld	(de),a
44c1 44c1 d 13
44c1 44c1 s 	inc	de
44c2 44c2 d 13
44c2 44c2 s 	inc	de
44c3 44c3 d 12
44c3 44c3 s 	ld	(de),a			; start cluster and last cluster accessed
44c4 44c4 d 13
44c4 44c4 s 	inc	de
44c5 44c5 d af
44c5 44c5 s 	xor	a
44c6 44c6 d 12
44c6 44c6 s 	ld	(de),a
44c7 44c7 d 13
44c7 44c7 s 	inc	de
44c8 44c8 d 12
44c8 44c8 s 	ld	(de),a			; last cluster accessed, relative
44c9 44c9 d c9
44c9 44c9 s 	ret
44ca 44ca s 
44ca 44ca s ;	  Subroutine handle DSKCHG error
44ca 44ca s ;	     Inputs  
44ca 44ca s ;	     Outputs ________________________ 
44ca 44ca s 
44ca 44ca d 4f
44ca 44ca s A44CA:	ld	c,a
44cb 44cb d 3ae1f2
44cb 44cb s 	ld	a,(YF2E1)		; current driveid
44ce 44ce d cd0a47
44ce 44ce s 	call	A470A			; start diskerror handler
44d1 44d1 d 1808
44d1 44d1 s 	jr	A44DB			; get latest FAT (try again)
44d3 44d3 s 
44d3 44d3 s ;	  Subroutine reset direntry search and get latest FAT
44d3 44d3 s ;	     Inputs  
44d3 44d3 s ;	     Outputs ________________________ 
44d3 44d3 s 
44d3 44d3 d 3eff
44d3 44d3 s A44D3:	ld	a,0FFH
44d5 44d5 d 32b8f2
44d5 44d5 s 	ld	(YF2B8),a		; invalid latest direntry (search from the begin)
44d8 44d8 d 32fef2
44d8 44d8 s 	ld	(YF2FE),a		; not found a free direntry
44db 44db s 
44db 44db s ;	  Subroutine get latest FAT
44db 44db s ;	     Inputs  
44db 44db s ;	     Outputs ________________________ 
44db 44db s 
44db 44db d cd67f2
44db 44db s A44DB:	call	XF267
44de 44de d cd5545
44de 44de s 	call	A4555			; get pointer to DPB of current drive
44e1 44e1 d 3ae1f2
44e1 44e1 s 	ld	a,(YF2E1)		; current driveid
44e4 44e4 d dd4e01
44e4 44e4 s 	ld	c,(ix+001H)		; mediadesciptor
44e7 44e7 d 0600
44e7 44e7 s 	ld	b,0
44e9 44e9 d b7
44e9 44e9 s 	or	a
44ea 44ea d cd7c60
44ea 44ea s 	call	A6067			; DSKCHG
44ed 44ed d 38db
44ed 44ed s 	jr	c,A44CA			; error,
44ef 44ef d cd3345
44ef 44ef s 	call	A4536			; update DPBTBL entry current drive
44f2 44f2 d dd6e13
44f2 44f2 s 	ld	l,(ix+013H)
44f5 44f5 d dd6614
44f5 44f5 s 	ld	h,(ix+014H)
44f8 44f8 d 2b
44f8 44f8 s 	dec	hl
44f9 44f9 d 78
44f9 44f9 s 	ld	a,b			; DSKCHG status
44fa 44fa d b6
44fa 44fa s 	or	(hl)			; combined with the FAT buffer status
44fb 44fb d 3ae1f2
44fb 44fb s 	ld	a,(YF2E1)		; current driveid
44fe 44fe d 2a41f2
44fe 44fe s 	ld	hl,(YF241)
4501 4501 d fa0a45
4501 4501 s 	jp	m,A450A			; FAT buffer invalid OR diskchange unknown, read the FAT
4504 4504 d c0
4504 4504 s 	ret	nz			; FAT buffer changed OR disk unchanged, do not read the FAT and quit
4505 4505 d bd
4505 4505 s 	cp	l			; current drive same as datasector buffer owner ?
4506 4506 d 200b
4506 4506 s 	jr	nz,A4516		; nope, read the FAT
4508 4508 d 25
4508 4508 s 	dec	h			; datasector buffer changed ?
4509 4509 d c8
4509 4509 s 	ret	z			; yep, do not read the FAT and quit
450a 450a d 95
450a 450a s A450A:	sub	l			; current drive same as datasector buffer owner ?
450b 450b d 2006
450b 450b s 	jr	nz,A4516		; nope, leave the datasector buffer alone
450d 450d d 6f
450d 450d s 	ld	l,a
450e 450e d 67
450e 450e s 	ld	h,a
450f 450f s 
450f 450f s ; VERSION 1.1 CHANGE
450f 450f s ;
450f 450f s ; ld (YF23F),hl is removed, because it is not explicit needed
450f 450f s ; room is used later on to fix the FAT reading bug when one of the other FAT copies is used (when first FAT read generates a error)
450f 450f s ;
450f 450f s 
450f 450f d 2d
450f 450f s 	dec	l
4510 4510 d 2241f2
4510 4510 s 	ld	(YF241),hl		; invalid datasector buffer
4513 4513 d 3eff
4513 4513 s A4516:	ld	a,0FFH
4515 4515 d 3246f2
4515 4515 s 	ld	(YF246),a		; invalid dirsector buffer
4518 4518 d cdfa45
4518 4518 s 	call	A45FA			; get FAT parameters
451b 451b d 2b
451b 451b s 	dec	hl
451c 451c d 3600
451c 451c s 	ld	(hl),0			; FAT buffer unchanged
451e 451e d 23
451e 451e s 	inc	hl
451f 451f d f5
451f 451f s A4522:	push	af
4520 4520 d cdd746
4520 4520 s 	call	A46D7			; read FAT sectors
4523 4523 d 3819
4523 4523 s 	jr	c,A4541			; error, try the next FAT copy
4525 4525 d f1
4525 4525 s 	pop	af
4526 4526 d 46
4526 4526 s A4529:	ld	b,(hl)			; mediabyte of FAT sector
4527 4527 d 3ae1f2
4527 4527 s 	ld	a,(YF2E1)		; current driveid
452a 452a d dd4e01
452a 452a s 	ld	c,(ix+001H)		; mediadescriptor
452d 452d d dde5
452d 452d s 	push	ix
452f 452f d e1
452f 452f s 	pop	hl
4530 4530 d cd8460
4530 4530 s 	call	A606F			; GETDPB
4533 4533 d e5
4533 4533 s A4536:	push	hl
4534 4534 d dde1
4534 4534 s 	pop	ix
4536 4536 d eb
4536 4536 s 	ex	de,hl
4537 4537 d cd6345
4537 4537 s 	call	A4563			; get DPBTBL entry of current drive
453a 453a d 73
453a 453a s 	ld	(hl),e
453b 453b d 23
453b 453b s 	inc	hl
453c 453c d 72
453c 453c s 	ld	(hl),d
453d 453d d c9
453d 453d s 	ret
453e 453e s ;
453e 453e d 7b
453e 453e s A4541:	ld	a,e
453f 453f d 81
453f 453f s 	add	a,c
4540 4540 d 5f
4540 4540 s 	ld	e,a
4541 4541 d 3001
4541 4541 s 	jr	nc,A4547
4543 4543 d 14
4543 4543 s 	inc	d
4544 4544 d f1
4544 4544 s A4547:	pop	af			; adjust first FAT sector to the first FAT sector of the next FAT copy
4545 4545 s 
4545 4545 s ; VERSION 1.1 BUGFIX
4545 4545 s ;
4545 4545 s ; Begin of change
4545 4545 s ;
4545 4545 s 
4545 4545 d 41
4545 4545 s 	ld	b,c			; restore sectors per FAT (B is destroyed by the DSKIO)
4546 4546 s 
4546 4546 s ; End of change
4546 4546 s  
4546 4546 d 3d
4546 4546 s 	dec	a
4547 4547 d 20d6
4547 4547 s 	jr	nz,A4522		; there is a other FAT copy, try that one
4549 4549 d cdfa45
4549 4549 s 	call	A45FA			; get FAT parameters (so the first FAT copy is used)
454c 454c d e5
454c 454c s 	push	hl
454d 454d d cdc546
454d 454d s 	call	A46C5			; read FAT sectors with DOS error handling
4550 4550 d e1
4550 4550 s 	pop	hl
4551 4551 d 18d3
4551 4551 s 	jr	A4529			; use FAT buffer
4553 4553 s ;
4553 4553 s ; CHANGED, TO KEEP ROUTINES ALIGNED WITH PREVIOUS VERSION
4553 4553 s ;
4553 4553 s 	defs	04555H-044CAH-($-A44CA),0
4553 4553 d 0000
4555 4555 s 
4555 4555 s ;	  Subroutine get pointer to DPB of current drive
4555 4555 s ;	     Inputs  
4555 4555 s ;	     Outputs HL = IX = pointer to DPB
4555 4555 s 
4555 4555 d cd6af2
4555 4555 s A4555:	call	XF26A
4558 4558 d cd6345
4558 4558 s 	call	A4563			; get DPBTBL entry of current drive
455b 455b d 7e
455b 455b s 	ld	a,(hl)
455c 455c d 23
455c 455c s 	inc	hl
455d 455d d 66
455d 455d s 	ld	h,(hl)
455e 455e d 6f
455e 455e s 	ld	l,a
455f 455f d e5
455f 455f s 	push	hl
4560 4560 d dde1
4560 4560 s 	pop	ix
4562 4562 d c9
4562 4562 s 	ret
4563 4563 s 
4563 4563 s ;	  Subroutine get DPBTBL entry of current drive
4563 4563 s ;	     Inputs  HL = adres of pointer
4563 4563 s ;	     Outputs ________________________ 
4563 4563 s 
4563 4563 d 3ae1f2
4563 4563 s A4563:	ld	a,(YF2E1)		; current driveid
4566 4566 d 2155f3
4566 4566 s 	ld	hl,YF355
4569 4569 d 87
4569 4569 s 	add	a,a
456a 456a d 85
456a 456a s 	add	a,l
456b 456b d 6f
456b 456b s 	ld	l,a
456c 456c d d0
456c 456c s 	ret	nc
456d 456d d 24
456d 456d s 	inc	h
456e 456e d c9
456e 456e s 	ret
456f 456f s 
456f 456f s ;	  Subroutine BDOS 10 (close file)
456f 456f s ;	     Inputs  
456f 456f s ;	     Outputs ________________________ 
456f 456f s 
456f 456f d d5
456f 456f s A456F:	push	de
4570 4570 d fde1
4570 4570 s 	pop	iy
4572 4572 d cd0e44
4572 4572 s 	call	A440E			; validate FCB drive and filename
4575 4575 d 3eff
4575 4575 s 	ld	a,0FFH
4577 4577 d d8
4577 4577 s 	ret	c			; invalid, quit with error
4578 4578 d fd7e18
4578 4578 s 	ld	a,(iy+018H)
457b 457b d e6c0
457b 457b s 	and	0C0H
457d 457d d 3e00
457d 457d s 	ld	a,0			; ok
457f 457f d c0
457f 457f s 	ret	nz			; device OR unchanged diskfile, quit
4580 4580 d 3ae1f2
4580 4580 s 	ld	a,(YF2E1)		; current driveid
4583 4583 d 2a41f2
4583 4583 s 	ld	hl,(YF241)
4586 4586 d bd
4586 4586 s 	cp	l			; same drive as owner datasector buffer ?
4587 4587 d cc2d47
4587 4587 s 	call	z,A472D			; yep, write datasector buffer when needed
458a 458a d cd5545
458a 458a s 	call	A4555			; get pointer to DPB of current drive
458d 458d d fd7e19
458d 458d s 	ld	a,(iy+019H)		; direntrynumber
4590 4590 d cd1743
4590 4590 s 	call	A4317			; get direntry
4593 4593 d 060b
4593 4593 s 	ld	b,11
4595 4595 d cd4f42
4595 4595 s 	call	A424F			; compare with filename1
4598 4598 d 2054
4598 4598 s 	jr	nz,A45EE		; not the same, make FAT buffer unchanged and quit with error
459a 459a d fde5
459a 459a s 	push	iy
459c 459c d d1
459c 459c s 	pop	de
459d 459d d 0e0b
459d 459d s 	ld	c,00BH
459f 459f d 09
459f 459f s 	add	hl,bc
45a0 45a0 d eb
45a0 45a0 s 	ex	de,hl
45a1 45a1 d 0e16
45a1 45a1 s 	ld	c,016H
45a3 45a3 d 09
45a3 45a3 s 	add	hl,bc
45a4 45a4 d eda0
45a4 45a4 s 	ldi
45a6 45a6 d eda0
45a6 45a6 s 	ldi
45a8 45a8 d 01fcff
45a8 45a8 s 	ld	bc,0FFFCH
45ab 45ab d 09
45ab 45ab s 	add	hl,bc
45ac 45ac d eda0
45ac 45ac s 	ldi
45ae 45ae d eda0
45ae 45ae s 	ldi
45b0 45b0 d 010400
45b0 45b0 s 	ld	bc,00004H
45b3 45b3 d 09
45b3 45b3 s 	add	hl,bc
45b4 45b4 d eda0
45b4 45b4 s 	ldi
45b6 45b6 d eda0
45b6 45b6 s 	ldi
45b8 45b8 d 01f4ff
45b8 45b8 s 	ld	bc,0FFF4H
45bb 45bb d 09
45bb 45bb s 	add	hl,bc
45bc 45bc d 010400
45bc 45bc s 	ld	bc,00004H
45bf 45bf d edb0
45bf 45bf s 	ldir
45c1 45c1 d cd4847
45c1 45c1 s 	call	A4748			; update directory of disk
45c4 45c4 s 
45c4 45c4 s ;	  Subroutine write FAT when needed
45c4 45c4 s ;	     Inputs  
45c4 45c4 s ;	     Outputs ________________________ 
45c4 45c4 s 
45c4 45c4 d dd6e13
45c4 45c4 s A45C4:	ld	l,(ix+013H)
45c7 45c7 d dd6614
45c7 45c7 s 	ld	h,(ix+014H)
45ca 45ca d 2b
45ca 45ca s 	dec	hl
45cb 45cb d 7e
45cb 45cb s 	ld	a,(hl)
45cc 45cc d fe01
45cc 45cc s 	cp	1			; FAT buffer changed ?
45ce 45ce d c0
45ce 45ce s 	ret	nz			; nope, quit (?? return error if FAT buffer invalid)
45cf 45cf s 
45cf 45cf s ;	  Subroutine write FAT
45cf 45cf s ;	     Inputs  
45cf 45cf s ;	     Outputs ________________________ 
45cf 45cf s 
45cf 45cf d cd6df2
45cf 45cf s A45CF:	call	XF26D
45d2 45d2 d cdfa45
45d2 45d2 s 	call	A45FA			; get FAT parameters
45d5 45d5 d 2b
45d5 45d5 s 	dec	hl
45d6 45d6 d 3600
45d6 45d6 s 	ld	(hl),0			; FAT buffer unchanged
45d8 45d8 d 23
45d8 45d8 s 	inc	hl
45d9 45d9 d f5
45d9 45d9 s A45D9:	push	af
45da 45da d d5
45da 45da s 	push	de
45db 45db d c5
45db 45db s 	push	bc
45dc 45dc d e5
45dc 45dc s 	push	hl
45dd 45dd d cd5547
45dd 45dd s 	call	A4755			; write FAT sectors with DOS error handling
45e0 45e0 d e1
45e0 45e0 s 	pop	hl
45e1 45e1 d c1
45e1 45e1 s 	pop	bc
45e2 45e2 d d1
45e2 45e2 s 	pop	de
45e3 45e3 d 7b
45e3 45e3 s 	ld	a,e
45e4 45e4 d 80
45e4 45e4 s 	add	a,b
45e5 45e5 d 5f
45e5 45e5 s 	ld	e,a
45e6 45e6 d 3001
45e6 45e6 s 	jr	nc,A45E9
45e8 45e8 d 14
45e8 45e8 s 	inc	d			; to start sector of the next FAT
45e9 45e9 d f1
45e9 45e9 s A45E9:	pop	af
45ea 45ea d 3d
45ea 45ea s 	dec	a
45eb 45eb d 20ec
45eb 45eb s 	jr	nz,A45D9		; write next FAT
45ed 45ed d c9
45ed 45ed s 	ret
45ee 45ee s 
45ee 45ee s ;	  Subroutine make FAT buffer unchanged and quit with error
45ee 45ee s ;	     Inputs  
45ee 45ee s ;	     Outputs ________________________ 
45ee 45ee s 
45ee 45ee d dd6e13
45ee 45ee s A45EE:	ld	l,(ix+013H)
45f1 45f1 d dd6614
45f1 45f1 s 	ld	h,(ix+014H)
45f4 45f4 d 2b
45f4 45f4 s 	dec	hl
45f5 45f5 d 3600
45f5 45f5 s 	ld	(hl),0			; FAT buffer unchanged
45f7 45f7 d 3eff
45f7 45f7 s 	ld	a,0FFH			; error
45f9 45f9 d c9
45f9 45f9 s 	ret
45fa 45fa s 
45fa 45fa s ;	  Subroutine get FAT parameters
45fa 45fa s ;	     Inputs  IX = pointer to DPB
45fa 45fa s ;	     Outputs A = number of FATs, DE = first FAT sector, B = number sectors per FAT, HL = pointer to FAT buffer
45fa 45fa s 
45fa 45fa d dd7e0a
45fa 45fa s A45FA:	ld	a,(ix+00AH)		; number of FATs
45fd 45fd d dd6e13
45fd 45fd s 	ld	l,(ix+013H)
4600 4600 d dd6614
4600 4600 s 	ld	h,(ix+014H)		; pointer to FAT buffer
4603 4603 d dd4610
4603 4603 s 	ld	b,(ix+010H)		; number of sectors per FAT
4606 4606 d dd5e08
4606 4606 s 	ld	e,(ix+008H)
4609 4609 d dd5609
4609 4609 s 	ld	d,(ix+009H)		; first FAT sector
460c 460c d c9
460c 460c s 	ret
460d 460d s 
460d 460d s ;	  Subroutine get dir parameters
460d 460d s ;	     Inputs  IX = pointer to DPB, A = relative dirsector, DE = first dirsector
460d 460d s ;	     Outputs DE = dirsector, B = 1, HL = pointer to dirsector buffer
460d 460d s 
460d 460d d dd8611
460d 460d s A460D:	add	a,(ix+011H)
4610 4610 d 5f
4610 4610 s 	ld	e,a
4611 4611 d dd5612
4611 4611 s 	ld	d,(ix+012H)
4614 4614 d 3001
4614 4614 s 	jr	nc,A4617
4616 4616 d 14
4616 4616 s 	inc	d			; + first dir sector
4617 4617 d 2a51f3
4617 4617 s A4617:	ld	hl,(YF351)		; dirsector buffer
461a 461a d 0601
461a 461a s 	ld	b,1			; 1 sector
461c 461c d c9
461c 461c s 	ret
461d 461d s 
461d 461d s ;	  Subroutine BDOS 16 (create file)
461d 461d s ;	     Inputs  
461d 461d s ;	     Outputs ________________________ 
461d 461d s 
461d 461d d d5
461d 461d s A461D:	push	de
461e 461e d cd0e44
461e 461e s T461E:	call	A440E			; validate FCB drive and filename
4621 4621 d 382a
4621 4621 s 	jr	c,A464D			; invalid, quit with error
4623 4623 d 23
4623 4623 s 	inc	hl
4624 4624 d 23
4624 4624 s 	inc	hl
4625 4625 d 3600
4625 4625 s 	ld	(hl),0			; clear S2 byte
4627 4627 d 21b9f2
4627 4627 s 	ld	hl,YF2B9
462a 462a d 3e3f
462a 462a s 	ld	a,"?"
462c 462c d 010b00
462c 462c s 	ld	bc,11
462f 462f d edb1
462f 462f s 	cpir				; wildcard char in filename ?
4631 4631 d 281a
4631 4631 s 	jr	z,A464D			; yep, quit with error
4633 4633 d cdb542
4633 4633 s 	call	A42B5			; find first directoryentry
4636 4636 d 3019
4636 4636 s 	jr	nc,A4651		; found, special actions for existing file/device
4638 4638 d 3afef2
4638 4638 s 	ld	a,(YF2FE)
463b 463b d feff
463b 463b s 	cp	0FFH			; found free direntry ?
463d 463d d 280e
463d 463d s 	jr	z,A464D			; nope, quit with error (directory is full)
463f 463f d cd1743
463f 463f s 	call	A4317			; get direntry
4642 4642 d e5
4642 4642 s 	push	hl
4643 4643 d fde1
4643 4643 s 	pop	iy
4645 4645 d 1822
4645 4645 s 	jr	A4669			; setup direntry
4647 4647 s ;
4647 4647 d fdcb0b7e
4647 4647 s A4647:	bit	7,(iy+00BH)
464b 464b d 2050
464b 464b s 	jr	nz,A469D		; device, treat as open file
464d 464d s 					; file with special fileattribute, quit with error
464d 464d d d1
464d 464d s A464D:	pop	de
464e 464e d 3eff
464e 464e s 	ld	a,0FFH
4650 4650 d c9
4650 4650 s 	ret
4651 4651 s 
4651 4651 d 20f4
4651 4651 s A4651:	jr	nz,A4647		; device or file with special fileattribute,
4653 4653 d 3a0cf3
4653 4653 s 	ld	a,(YF30C)		; orginal FCB EX byte
4656 4656 d b7
4656 4656 s 	or	a
4657 4657 d 2044
4657 4657 s 	jr	nz,A469D		; is not zero, just open the file
4659 4659 d fd6e1a
4659 4659 s 	ld	l,(iy+01AH)
465c 465c d fd661b
465c 465c s 	ld	h,(iy+01BH)
465f 465f d 7c
465f 465f s 	ld	a,h
4660 4660 d b5
4660 4660 s 	or	l			; has start cluster ?
4661 4661 d 2806
4661 4661 s 	jr	z,A4669			; nop,
4663 4663 d cd9b4f
4663 4663 s 	call	A4F9B			; release chain
4666 4666 d cdcf45
4666 4666 s 	call	A45CF			; write FAT
4669 4669 d fde5
4669 4669 s A4669:	push	iy
466b 466b d d1
466b 466b s 	pop	de
466c 466c d 21b9f2
466c 466c s 	ld	hl,YF2B9
466f 466f d 010b00
466f 466f s 	ld	bc,11
4672 4672 d edb0
4672 4672 s 	ldir				; copy filename in FCB to direntry
4674 4674 d 7e
4674 4674 s 	ld	a,(hl)
4675 4675 d 17
4675 4675 s 	rla
4676 4676 d 3e00
4676 4676 s 	ld	a,000H
4678 4678 d 3002
4678 4678 s 	jr	nc,A467C		; b7 DR byte reset, ordinary file
467a 467a d 3e06
467a 467a s 	ld	a,006H			; b7 DR byte set, hidden system file
467c 467c d 12
467c 467c s A467C:	ld	(de),a
467d 467d d 13
467d 467d s 	inc	de
467e 467e d eb
467e 467e s 	ex	de,hl
467f 467f d 060a
467f 467f s 	ld	b,10
4681 4681 d af
4681 4681 s 	xor	a
4682 4682 d 77
4682 4682 s A4682:	ld	(hl),a
4683 4683 d 23
4683 4683 s 	inc	hl
4684 4684 d 10fc
4684 4684 s 	djnz	A4682			; clear unused bytes direntry
4686 4686 d e5
4686 4686 s 	push	hl
4687 4687 d cd9654
4687 4687 s 	call	A5496			; get time and date (dirformat)
468a 468a d e1
468a 468a s 	pop	hl
468b 468b d 73
468b 468b s 	ld	(hl),e
468c 468c d 23
468c 468c s 	inc	hl
468d 468d d 72
468d 468d s 	ld	(hl),d
468e 468e d 23
468e 468e s 	inc	hl
468f 468f d 71
468f 468f s 	ld	(hl),c
4690 4690 d 23
4690 4690 s 	inc	hl
4691 4691 d 70
4691 4691 s 	ld	(hl),b
4692 4692 d 23
4692 4692 s 	inc	hl			; fill in time and date in direntry
4693 4693 d af
4693 4693 s 	xor	a
4694 4694 d 0606
4694 4694 s 	ld	b,2+4
4696 4696 d 77
4696 4696 s A4696:	ld	(hl),a
4697 4697 d 23
4697 4697 s 	inc	hl
4698 4698 d 10fc
4698 4698 s 	djnz	A4696			; fill in no first cluster, filesize 0 in direntry
469a 469a d cd4847
469a 469a s 	call	A4748			; update directory of disk
469d 469d s 
469d 469d d fde5
469d 469d s A469D:	push	iy
469f 469f d e1
469f 469f s 	pop	hl
46a0 46a0 d d1
46a0 46a0 s 	pop	de
46a1 46a1 d c37144
46a1 46a1 s 	jp	A4471			; continue with open file
46a4 46a4 s 
46a4 46a4 s ;	  Subroutine read dirsector
46a4 46a4 s ;	     Inputs  C = relative dir sector
46a4 46a4 s ;	     Outputs ________________________ 
46a4 46a4 s 
46a4 46a4 d c5
46a4 46a4 s A46A4:	push	bc
46a5 46a5 d cd4347
46a5 46a5 s 	call	A4743			; update directory of disk when needed
46a8 46a8 d c1
46a8 46a8 s 	pop	bc
46a9 46a9 d dd4600
46a9 46a9 s 	ld	b,(ix+000H)		; driveid
46ac 46ac d ed4345f2
46ac 46ac s 	ld	(YF246-1),bc		; set driveid and sector dirsector buffer
46b0 46b0 d c5
46b0 46b0 s 	push	bc
46b1 46b1 d 79
46b1 46b1 s 	ld	a,c			; relative dirsector
46b2 46b2 d cd0d46
46b2 46b2 s 	call	A460D			; setup dirsector parameters
46b5 46b5 d cdc546
46b5 46b5 s 	call	A46C5			; read dirsector with DOS error handling
46b8 46b8 d c1
46b8 46b8 s 	pop	bc
46b9 46b9 d c9
46b9 46b9 s 	ret
46ba 46ba s 
46ba 46ba s ;	  Subroutine BDOS 2F (read logical sector)
46ba 46ba s ;	     Inputs  
46ba 46ba s ;	     Outputs ________________________ 
46ba 46ba s 
46ba 46ba d 44
46ba 46ba s A46BA:	ld	b,h
46bb 46bb d 7d
46bb 46bb s 	ld	a,l
46bc 46bc d 32e1f2
46bc 46bc s 	ld	(YF2E1),a		; set current driveid
46bf 46bf d cd5545
46bf 46bf s 	call	A4555			; get pointer to DPB of current drive
46c2 46c2 d 2a3df2
46c2 46c2 s 	ld	hl,(YF23D)		; transferadres
46c5 46c5 s 
46c5 46c5 s ;	  Subroutine read sectors with DOS error handling
46c5 46c5 s ;	     Inputs  
46c5 46c5 s ;	     Outputs ________________________ 
46c5 46c5 s 
46c5 46c5 d cd70f2
46c5 46c5 s A46C5:	call	XF270
46c8 46c8 d af
46c8 46c8 s 	xor	a
46c9 46c9 d 32fff2
46c9 46c9 s 	ld	(YF2FF),a		; flag read disk operation
46cc 46cc d cdd746
46cc 46cc s 	call	A46D7			; read sector
46cf 46cf d d0
46cf 46cf s 	ret	nc			; no error, quit
46d0 46d0 d cde846
46d0 46d0 s 	call	A46E8			; adjust parameters to restart at error sector and start diskerror handler
46d3 46d3 d 3d
46d3 46d3 s 	dec	a
46d4 46d4 d 28ef
46d4 46d4 s 	jr	z,A46C5			; RETRY, try again
46d6 46d6 d c9
46d6 46d6 s 	ret				; IGNORE, quit
46d7 46d7 s 
46d7 46d7 s ;	  Subroutine read sectors
46d7 46d7 s ;	     Inputs  
46d7 46d7 s ;	     Outputs ________________________ 
46d7 46d7 s 
46d7 46d7 d dd7e00
46d7 46d7 s A46D7:	ld	a,(ix+000H)		; driveid
46da 46da d dd4e01
46da 46da s 	ld	c,(ix+001H)		; mediadescriptor
46dd 46dd d e5
46dd 46dd s 	push	hl
46de 46de d d5
46de 46de s 	push	de
46df 46df d c5
46df 46df s 	push	bc
46e0 46e0 d cd6760
46e0 46e0 s 	call	A6052			; read disksector
46e3 46e3 d d1
46e3 46e3 s 	pop	de
46e4 46e4 d 4a
46e4 46e4 s 	ld	c,d
46e5 46e5 d d1
46e5 46e5 s 	pop	de
46e6 46e6 d e1
46e6 46e6 s 	pop	hl
46e7 46e7 d c9
46e7 46e7 s 	ret
46e8 46e8 s 
46e8 46e8 s ;	  Subroutine adjust parameters to restart at error sector and start diskerror handler
46e8 46e8 s ;	     Inputs  
46e8 46e8 s ;	     Outputs ________________________ 
46e8 46e8 s 
46e8 46e8 d f5
46e8 46e8 s A46E8:	push	af
46e9 46e9 d 79
46e9 46e9 s 	ld	a,c
46ea 46ea d 90
46ea 46ea s 	sub	b
46eb 46eb d 4f
46eb 46eb s 	ld	c,a
46ec 46ec d c5
46ec 46ec s 	push	bc
46ed 46ed d 0600
46ed 46ed s 	ld	b,000H
46ef 46ef d eb
46ef 46ef s 	ex	de,hl
46f0 46f0 d 09
46f0 46f0 s 	add	hl,bc
46f1 46f1 d e5
46f1 46f1 s 	push	hl
46f2 46f2 d d5
46f2 46f2 s 	push	de
46f3 46f3 d dd5e02
46f3 46f3 s 	ld	e,(ix+002H)
46f6 46f6 d dd5603
46f6 46f6 s 	ld	d,(ix+003H)		; sectorsize
46f9 46f9 d cd1649
46f9 46f9 s 	call	A4916			; multiply
46fc 46fc d e1
46fc 46fc s 	pop	hl
46fd 46fd d d1
46fd 46fd s 	pop	de
46fe 46fe d 09
46fe 46fe s 	add	hl,bc
46ff 46ff d c1
46ff 46ff s 	pop	bc
4700 4700 d f1
4700 4700 s 	pop	af
4701 4701 d 4f
4701 4701 s 	ld	c,a
4702 4702 d 3afff2
4702 4702 s 	ld	a,(YF2FF)		; type of diskoperation
4705 4705 d b1
4705 4705 s 	or	c
4706 4706 d 4f
4706 4706 s 	ld	c,a
4707 4707 d dd7e00
4707 4707 s 	ld	a,(ix+000H)		; driveid
470a 470a s 
470a 470a s ;	  Subroutine start diskerror handler
470a 470a s ;	     Inputs  
470a 470a s ;	     Outputs ________________________ 
470a 470a s 
470a 470a d cd73f2
470a 470a s A470A:	call	XF273
470d 470d d c5
470d 470d s 	push	bc
470e 470e d d5
470e 470e s 	push	de
470f 470f d e5
470f 470f s 	push	hl
4710 4710 d 2a23f3
4710 4710 s 	ld	hl,(YF323)
4713 4713 d cde8f1
4713 4713 s 	call	XF1E8			; start diskerror handler in DOS memory
4716 4716 d 79
4716 4716 s 	ld	a,c			; requested action
4717 4717 d e1
4717 4717 s 	pop	hl
4718 4718 d d1
4718 4718 s 	pop	de
4719 4719 d c1
4719 4719 s 	pop	bc
471a 471a d fe02
471a 471a s 	cp	2
471c 471c d c0
471c 471c s 	ret	nz
471d 471d d c3e2f1
471d 471d s 	jp	XF1E2			; Warm boot
4720 4720 s 
4720 4720 s ;	  Subroutine BDOS 30 (write logical sector)
4720 4720 s ;	     Inputs  
4720 4720 s ;	     Outputs ________________________ 
4720 4720 s 
4720 4720 d 44
4720 4720 s A4720:	ld	b,h
4721 4721 d 7d
4721 4721 s 	ld	a,l
4722 4722 d 32e1f2
4722 4722 s 	ld	(YF2E1),a		; set current driveid
4725 4725 d cd5545
4725 4725 s 	call	A4555			; get pointer to DPB of current drive
4728 4728 d 2a3df2
4728 4728 s 	ld	hl,(YF23D)		; transferadres
472b 472b d 1828
472b 472b s 	jr	A4755			; write sectors with DOS error handling
472d 472d s 
472d 472d s ;	  Subroutine write datasector buffer when needed
472d 472d s ;	     Inputs  
472d 472d s ;	     Outputs ________________________ 
472d 472d s 
472d 472d d 2142f2
472d 472d s A472D:	ld	hl,YF242
4730 4730 d af
4730 4730 s 	xor	a
4731 4731 d be
4731 4731 s 	cp	(hl)			; datasector buffer changed ?
4732 4732 d 77
4732 4732 s 	ld	(hl),a			; now it is unchanged
4733 4733 d c8
4733 4733 s 	ret	z			; nope, quit
4734 4734 d dd2a43f2
4734 4734 s 	ld	ix,(YF243)		; saved DPB pointer
4738 4738 d 2a4ff3
4738 4738 s 	ld	hl,(YF34F)		; datasector buffer
473b 473b d 0601
473b 473b s 	ld	b,1			; 1 sector
473d 473d d ed5b3ff2
473d 473d s 	ld	de,(YF23F)		; sectornumber of datasector buffer
4741 4741 d 1812
4741 4741 s 	jr	A4755			; write sector with DOS error handling
4743 4743 s 
4743 4743 s ;	  Subroutine write dirsector buffer when needed
4743 4743 s ;	     Inputs  
4743 4743 s ;	     Outputs ________________________ 
4743 4743 s 
4743 4743 d 3a3cf2
4743 4743 s A4743:	ld	a,(YF23C)
4746 4746 d b7
4746 4746 s 	or	a			; directory buffer changed ?
4747 4747 d c8
4747 4747 s 	ret	z			; nope, quit
4748 4748 s 
4748 4748 s ;	  Subroutine write dirsector buffer
4748 4748 s ;	     Inputs  
4748 4748 s ;	     Outputs ________________________ 
4748 4748 s 
4748 4748 d cd76f2
4748 4748 s A4748:	call	XF276
474b 474b d af
474b 474b s 	xor	a
474c 474c d 323cf2
474c 474c s 	ld	(YF23C),a		; directory buffer unchanged
474f 474f d 3a45f2
474f 474f s 	ld	a,(YF245)		; current dirsector (offset)
4752 4752 d cd0d46
4752 4752 s 	call	A460D			; setup dirsector parameters
4755 4755 s 
4755 4755 s ;	  Subroutine write sectors with DOS error handling
4755 4755 s ;	     Inputs  
4755 4755 s ;	     Outputs ________________________ 
4755 4755 s 
4755 4755 d cd79f2
4755 4755 s A4755:	call	XF279
4758 4758 d 3e01
4758 4758 s 	ld	a,1
475a 475a d 32fff2
475a 475a s 	ld	(YF2FF),a		; flag write disk operation
475d 475d d dd7e00
475d 475d s 	ld	a,(ix+000H)		; driveid
4760 4760 d dd4e01
4760 4760 s 	ld	c,(ix+001H)		; mediadescriptor
4763 4763 d e5
4763 4763 s 	push	hl
4764 4764 d d5
4764 4764 s 	push	de
4765 4765 d c5
4765 4765 s 	push	bc
4766 4766 d cd6960
4766 4766 s 	call	A6054			; write disksector
4769 4769 d d1
4769 4769 s 	pop	de
476a 476a d 4a
476a 476a s 	ld	c,d
476b 476b d d1
476b 476b s 	pop	de
476c 476c d e1
476c 476c s 	pop	hl
476d 476d d d0
476d 476d s 	ret	nc			; no error, quit
476e 476e d cde846
476e 476e s 	call	A46E8			; adjust parameters to restart at error sector and start diskerror handler
4771 4771 d 3d
4771 4771 s 	dec	a
4772 4772 d 28e1
4772 4772 s 	jr	z,A4755			; RETRY, try again
4774 4774 d c9
4774 4774 s 	ret				; IGNORE, quit
4775 4775 s 
4775 4775 s ;	  Subroutine BDOS 14 (read next record)
4775 4775 s ;	     Inputs  
4775 4775 s ;	     Outputs ________________________ 
4775 4775 s 
4775 4775 d cdf84e
4775 4775 s A4775:	call	A4EF8			; get recordnumber from CR,EX and S2 fields
4778 4778 d cd234b
4778 4778 s 	call	A4B23			; read record
477b 477b d 1806
477b 477b s 	jr	A4783			; update sequencial fields
477d 477d s 
477d 477d s ;	  Subroutine BDOS 15 (write next record)
477d 477d s ;	     Inputs  
477d 477d s ;	     Outputs ________________________ 
477d 477d s 
477d 477d d cdf84e
477d 477d s A477D:	call	A4EF8			; get recordnumber from CR,EX and S2 fields
4780 4780 d cda34c
4780 4780 s 	call	A4CA3			; write record
4783 4783 d cd6a48
4783 4783 s A4783:	call	A486A			; increase recordnumber if something was read/written
4786 4786 d 1814
4786 4786 s 	jr	A479C			; update CR,EX and S2 field
4788 4788 s 
4788 4788 s ;	  Subroutine BDOS 21 (random access read record)
4788 4788 s ;	     Inputs  
4788 4788 s ;	     Outputs ________________________ 
4788 4788 s 
4788 4788 d cd5748
4788 4788 s A4788:	call	A4857			; get recordnumber from Rx fields, 1 record
478b 478b d cd234b
478b 478b s 	call	A4B23			; read record
478e 478e d 1809
478e 478e s 	jr	A4799			; update Rx, CR,EX and S2 field
4790 4790 s ;
4790 4790 d fde5
4790 4790 s A4790:	push	iy
4792 4792 d d1
4792 4792 s 	pop	de
4793 4793 s 
4793 4793 s ;	  Subroutine BDOS 22 (random access write record)
4793 4793 s ;	     Inputs  
4793 4793 s ;	     Outputs ________________________ 
4793 4793 s 
4793 4793 d cd5748
4793 4793 s A4793:	call	A4857			; get recordnumber from Rx fields, 1 record
4796 4796 d cda34c
4796 4796 s 	call	A4CA3			; write record
4799 4799 d cd4448
4799 4799 s A4799:	call	A4844			; update Rx fields
479c 479c s 
479c 479c d 7d
479c 479c s A479C:	ld	a,l
479d 479d d e67f
479d 479d s 	and	07FH
479f 479f d fd7720
479f 479f s 	ld	(iy+020H),a		; CR
47a2 47a2 d cb25
47a2 47a2 s 	sla	l
47a4 47a4 d cb14
47a4 47a4 s 	rl	h
47a6 47a6 d fd740c
47a6 47a6 s 	ld	(iy+00CH),h		; S2
47a9 47a9 d cb13
47a9 47a9 s 	rl	e
47ab 47ab d fd730e
47ab 47ab s 	ld	(iy+00EH),e		; EX
47ae 47ae d 3adef2
47ae 47ae s 	ld	a,(YF2DE)		; result recordoperation
47b1 47b1 d c9
47b1 47b1 s 	ret
47b2 47b2 s 
47b2 47b2 s ;	  Subroutine BDOS 27 (random block read)
47b2 47b2 s ;	     Inputs  
47b2 47b2 s ;	     Outputs ________________________ 
47b2 47b2 s 
47b2 47b2 d af
47b2 47b2 s A47B2:	xor	a
47b3 47b3 d 3206f3
47b3 47b3 s 	ld	(YF306),a		; no CP/M call
47b6 47b6 d cd5a48
47b6 47b6 s 	call	A485A			; get random record number
47b9 47b9 d cd234b
47b9 47b9 s 	call	A4B23			; read record(s)
47bc 47bc d 180a
47bc 47bc s 	jr	A47C8
47be 47be s 
47be 47be s ;	  Subroutine BDOS 26 (random block write)
47be 47be s ;	     Inputs  
47be 47be s ;	     Outputs ________________________ 
47be 47be s 
47be 47be d af
47be 47be s A47BE:	xor	a
47bf 47bf d 3206f3
47bf 47bf s 	ld	(YF306),a		; no CP/M call
47c2 47c2 d cd5a48
47c2 47c2 s 	call	A485A			; get random record number
47c5 47c5 d cda34c
47c5 47c5 s 	call	A4CA3			; write record(s)
47c8 47c8 d cd6a48
47c8 47c8 s A47C8:	call	A486A			; increase recordnumber if something was read/written
47cb 47cb d cd4448
47cb 47cb s 	call	A4844			; update Rx fields
47ce 47ce d 69
47ce 47ce s 	ld	l,c
47cf 47cf d 60
47cf 47cf s 	ld	h,b
47d0 47d0 d c9
47d0 47d0 s 	ret
47d1 47d1 s 
47d1 47d1 s ;	  Subroutine BDOS 28 (write random with zero fill)
47d1 47d1 s ;	     Inputs  
47d1 47d1 s ;	     Outputs ________________________ 
47d1 47d1 s 
47d1 47d1 d d5
47d1 47d1 s A47D1:	push	de
47d2 47d2 d fde1
47d2 47d2 s 	pop	iy
47d4 47d4 d fd7e10
47d4 47d4 s 	ld	a,(iy+010H)
47d7 47d7 d fd4e11
47d7 47d7 s 	ld	c,(iy+011H)
47da 47da d fd4612
47da 47da s 	ld	b,(iy+012H)
47dd 47dd d fd5e13
47dd 47dd s 	ld	e,(iy+013H)
47e0 47e0 d 87
47e0 47e0 s 	add	a,a
47e1 47e1 d cb11
47e1 47e1 s 	rl	c
47e3 47e3 d cb10
47e3 47e3 s 	rl	b
47e5 47e5 d cb13
47e5 47e5 s 	rl	e
47e7 47e7 d b7
47e7 47e7 s 	or	a
47e8 47e8 d 2806
47e8 47e8 s 	jr	z,A47F0
47ea 47ea d 03
47ea 47ea s 	inc	bc
47eb 47eb d 78
47eb 47eb s 	ld	a,b
47ec 47ec d b1
47ec 47ec s 	or	c
47ed 47ed d 2001
47ed 47ed s 	jr	nz,A47F0
47ef 47ef d 1c
47ef 47ef s 	inc	e
47f0 47f0 d fd6e21
47f0 47f0 s A47F0:	ld	l,(iy+021H)
47f3 47f3 d fd6622
47f3 47f3 s 	ld	h,(iy+022H)
47f6 47f6 d ed42
47f6 47f6 s 	sbc	hl,bc
47f8 47f8 d 2896
47f8 47f8 s 	jr	z,A4790
47fa 47fa d fd7e23
47fa 47fa s 	ld	a,(iy+023H)
47fd 47fd d 9b
47fd 47fd s 	sbc	a,e
47fe 47fe d 3890
47fe 47fe s 	jr	c,A4790
4800 4800 d e5
4800 4800 s 	push	hl
4801 4801 d cd9047
4801 4801 s 	call	A4790
4804 4804 d d1
4804 4804 s 	pop	de
4805 4805 d b7
4805 4805 s 	or	a
4806 4806 d c0
4806 4806 s 	ret	nz
4807 4807 d 2a3df2
4807 4807 s 	ld	hl,(YF23D)		; transferadres
480a 480a d e5
480a 480a s 	push	hl
480b 480b d 2a51f3
480b 480b s 	ld	hl,(YF351)
480e 480e d 223df2
480e 480e s 	ld	(YF23D),hl		; tempory use dirsector buffer
4811 4811 d 0680
4811 4811 s 	ld	b,080H
4813 4813 d 77
4813 4813 s A4813:	ld	(hl),a
4814 4814 d 23
4814 4814 s 	inc	hl
4815 4815 d 10fc
4815 4815 s 	djnz	A4813
4817 4817 d 3d
4817 4817 s 	dec	a
4818 4818 d 3246f2
4818 4818 s 	ld	(YF246),a		; invalid dirsector buffer
481b 481b d fd6e21
481b 481b s 	ld	l,(iy+021H)
481e 481e d fd6622
481e 481e s 	ld	h,(iy+022H)
4821 4821 d ed52
4821 4821 s 	sbc	hl,de
4823 4823 d 4d
4823 4823 s 	ld	c,l
4824 4824 d 44
4824 4824 s 	ld	b,h
4825 4825 d eb
4825 4825 s 	ex	de,hl
4826 4826 d 1600
4826 4826 s 	ld	d,000H
4828 4828 d fd7e23
4828 4828 s 	ld	a,(iy+023H)
482b 482b d 9a
482b 482b s 	sbc	a,d
482c 482c d 5f
482c 482c s 	ld	e,a
482d 482d d e5
482d 482d s A482D:	push	hl
482e 482e d 210100
482e 482e s 	ld	hl,00001H
4831 4831 d cda34c
4831 4831 s 	call	A4CA3			; write record
4834 4834 d cd6a48
4834 4834 s 	call	A486A			; increase recordnumber if something was writen
4837 4837 d 4d
4837 4837 s 	ld	c,l
4838 4838 d 44
4838 4838 s 	ld	b,h
4839 4839 d e1
4839 4839 s 	pop	hl
483a 483a d 2b
483a 483a s 	dec	hl
483b 483b d 7c
483b 483b s 	ld	a,h
483c 483c d b5
483c 483c s 	or	l
483d 483d d 20ee
483d 483d s 	jr	nz,A482D
483f 483f d e1
483f 483f s 	pop	hl
4840 4840 d 223df2
4840 4840 s 	ld	(YF23D),hl		; restore transferadres
4843 4843 d c9
4843 4843 s 	ret
4844 4844 s ;
4844 4844 d 3adef2
4844 4844 s A4844:	ld	a,(YF2DE)		; result recordoperation
4847 4847 d fd7521
4847 4847 s 	ld	(iy+021H),l
484a 484a d fd7422
484a 484a s 	ld	(iy+022H),h
484d 484d d fd7323
484d 484d s 	ld	(iy+023H),e
4850 4850 d 14
4850 4850 s 	inc	d
4851 4851 d 15
4851 4851 s 	dec	d
4852 4852 d c8
4852 4852 s 	ret	z
4853 4853 d fd7224
4853 4853 s 	ld	(iy+024H),d
4856 4856 d c9
4856 4856 s 	ret
4857 4857 s ;
4857 4857 d 210100
4857 4857 s A4857:	ld	hl,1			; 1 record
485a 485a d d5
485a 485a s A485A:	push	de
485b 485b d fde1
485b 485b s 	pop	iy
485d 485d d fd4e21
485d 485d s 	ld	c,(iy+021H)		; R0
4860 4860 d fd4622
4860 4860 s 	ld	b,(iy+022H)		; R1
4863 4863 d fd5e23
4863 4863 s 	ld	e,(iy+023H)		; R2
4866 4866 d fd5624
4866 4866 s 	ld	d,(iy+024H)		; R3
4869 4869 d c9
4869 4869 s 	ret
486a 486a s ;
486a 486a d c8
486a 486a s A486A:	ret	z
486b 486b d 23
486b 486b s 	inc	hl
486c 486c d 7c
486c 486c s 	ld	a,h
486d 486d d b5
486d 486d s 	or	l
486e 486e d c0
486e 486e s 	ret	nz
486f 486f d 13
486f 486f s 	inc	de
4870 4870 d c9
4870 4870 s 	ret
4871 4871 s ;
4871 4871 d e1
4871 4871 s A4871:	pop	hl
4872 4872 d 69
4872 4872 s 	ld	l,c
4873 4873 d 60
4873 4873 s 	ld	h,b
4874 4874 d 3e01
4874 4874 s 	ld	a,1
4876 4876 d 32def2
4876 4876 s 	ld	(YF2DE),a		; error in recordoperation
4879 4879 d af
4879 4879 s 	xor	a
487a 487a d 4f
487a 487a s 	ld	c,a
487b 487b d 47
487b 487b s 	ld	b,a
487c 487c d c9
487c 487c s 	ret
487d 487d s ;
487d 487d d 22e8f2
487d 487d s A487D:	ld	(YF2E8),hl		; number of records requested
4880 4880 d ed43e4f2
4880 4880 s 	ld	(YF2E4+0),bc
4884 4884 d ed53e6f2
4884 4884 s 	ld	(YF2E4+2),de		; startrecord
4888 4888 d fd7e00
4888 4888 s 	ld	a,(iy+000H)
488b 488b d cd2744
488b 488b s 	call	A4427			; validate fcb driveid
488e 488e d 38e1
488e 488e s 	jr	c,A4871
4890 4890 d 118000
4890 4890 s 	ld	de,00080H
4893 4893 d 3a06f3
4893 4893 s 	ld	a,(YF306)
4896 4896 d b7
4896 4896 s 	or	a			; Random Block ?
4897 4897 d 200f
4897 4897 s 	jr	nz,A48A8
4899 4899 d fd7e0e
4899 4899 s 	ld	a,(iy+00EH)
489c 489c d fd560f
489c 489c s 	ld	d,(iy+00FH)		; yep, use user set recordsize
489f 489f d 5f
489f 489f s 	ld	e,a
48a0 48a0 d b2
48a0 48a0 s 	or	d			; zero recordsize ?
48a1 48a1 d 2005
48a1 48a1 s 	jr	nz,A48A8
48a3 48a3 d 1e80
48a3 48a3 s 	ld	e,080H
48a5 48a5 d fd730e
48a5 48a5 s 	ld	(iy+00EH),e		; yep, use 128 bytes default
48a8 48a8 d 14
48a8 48a8 s A48A8:	inc	d
48a9 48a9 d 15
48a9 48a9 s 	dec	d
48aa 48aa d 2005
48aa 48aa s 	jr	nz,A48B1
48ac 48ac d 7b
48ac 48ac s 	ld	a,e
48ad 48ad d fe40
48ad 48ad s 	cp	040H
48af 48af d 3804
48af 48af s 	jr	c,A48B5
48b1 48b1 d af
48b1 48b1 s A48B1:	xor	a
48b2 48b2 d 32e7f2
48b2 48b2 s 	ld	(YF2E4+3),a		; make sure it's a valid record
48b5 48b5 d 2a3df2
48b5 48b5 s A48B5:	ld	hl,(YF23D)
48b8 48b8 d 22e2f2
48b8 48b8 s 	ld	(YF2E2),hl		; current transferadres
48bb 48bb d af
48bb 48bb s 	xor	a
48bc 48bc d 32def2
48bc 48bc s 	ld	(YF2DE),a		; no error in recordoperation
48bf 48bf d 32dff2
48bf 48bf s 	ld	(YF2DF),a		; flag do not increase sector
48c2 48c2 d ed4be8f2
48c2 48c2 s 	ld	bc,(YF2E8)		; number of records requested
48c6 48c6 d cd1649
48c6 48c6 s 	call	A4916			; * recordsize
48c9 48c9 d fd7e18
48c9 48c9 s 	ld	a,(iy+018H)
48cc 48cc d b7
48cc 48cc s 	or	a
48cd 48cd d f8
48cd 48cd s 	ret	m			; DOS device, quit
48ce 48ce d c5
48ce 48ce s 	push	bc
48cf 48cf d cd5545
48cf 48cf s 	call	A4555			; get pointer to DPB of current drive
48d2 48d2 d ed4be4f2
48d2 48d2 s 	ld	bc,(YF2E4+0)
48d6 48d6 d cd1649
48d6 48d6 s 	call	A4916
48d9 48d9 d ed43f4f2
48d9 48d9 s 	ld	(YF2F4+0),bc
48dd 48dd d c5
48dd 48dd s 	push	bc
48de 48de d ed4be6f2
48de 48de s 	ld	bc,(YF2E4+2)
48e2 48e2 d cd1c49
48e2 48e2 s 	call	A491C
48e5 48e5 d ed43f6f2
48e5 48e5 s 	ld	(YF2F4+2),bc		; startbyte = startrecord * recordsize
48e9 48e9 d 60
48e9 48e9 s 	ld	h,b
48ea 48ea d 69
48ea 48ea s 	ld	l,c
48eb 48eb d c1
48eb 48eb s 	pop	bc			; BCHL = startbyte
48ec 48ec d dd5e02
48ec 48ec s 	ld	e,(ix+002H)
48ef 48ef d dd5603
48ef 48ef s 	ld	d,(ix+003H)
48f2 48f2 d cd3249
48f2 48f2 s 	call	A4932			; / sectorsize
48f5 48f5 d 22f2f2
48f5 48f5 s 	ld	(YF2F2),hl		; offset in sector of startbyte
48f8 48f8 d ed43eef2
48f8 48f8 s 	ld	(YF2EE),bc		; relative sector of startbyte
48fc 48fc d dd7e06
48fc 48fc s 	ld	a,(ix+006H)
48ff 48ff d a1
48ff 48ff s 	and	c			; clustermask
4900 4900 d 32ddf2
4900 4900 s 	ld	(YF2DD),a		; current relative sector in cluster (of startbyte)
4903 4903 d dd7e07
4903 4903 s 	ld	a,(ix+007H)		; clustershift
4906 4906 d 3d
4906 4906 s A4906:	dec	a
4907 4907 d 2806
4907 4907 s 	jr	z,A490F
4909 4909 d cb38
4909 4909 s 	srl	b
490b 490b d cb19
490b 490b s 	rr	c
490d 490d d 18f7
490d 490d s 	jr	A4906
490f 490f s ;
490f 490f d ed43ecf2
490f 490f s A490F:	ld	(YF2EC),bc		; relative cluster of startbyte
4913 4913 d c1
4913 4913 s 	pop	bc
4914 4914 d af
4914 4914 s 	xor	a
4915 4915 d c9
4915 4915 s 	ret
4916 4916 s ;
4916 4916 d cd7cf2
4916 4916 s A4916:	call	XF27C
4919 4919 d 210000
4919 4919 s 	ld	hl,00000H
491c 491c d 78
491c 491c s A491C:	ld	a,b
491d 491d d 0611
491d 491d s 	ld	b,011H
491f 491f d 1807
491f 491f s 	jr	A4928
4921 4921 s ;
4921 4921 d 3001
4921 4921 s A4921:	jr	nc,A4924
4923 4923 d 19
4923 4923 s 	add	hl,de
4924 4924 d cb1c
4924 4924 s A4924:	rr	h
4926 4926 d cb1d
4926 4926 s 	rr	l
4928 4928 d 1f
4928 4928 s A4928:	rra
4929 4929 d cb19
4929 4929 s 	rr	c
492b 492b d 10f4
492b 492b s 	djnz	A4921
492d 492d d 47
492d 492d s 	ld	b,a
492e 492e d c9
492e 492e s 	ret
492f 492f s ;
492f 492f s DIV16:
492f 492f d 210000
492f 492f s A492F:	ld	hl,00000H
4932 4932 d cd7ff2
4932 4932 s A4932:	call	XF27F
4935 4935 d 78
4935 4935 s 	ld	a,b
4936 4936 d 0610
4936 4936 s 	ld	b,010H
4938 4938 d cb11
4938 4938 s 	rl	c
493a 493a d 17
493a 493a s 	rla
493b 493b d cb15
493b 493b s A493B:	rl	l
493d 493d d cb14
493d 493d s 	rl	h
493f 493f d 380d
493f 493f s 	jr	c,A494E
4941 4941 d ed52
4941 4941 s 	sbc	hl,de
4943 4943 d 3001
4943 4943 s 	jr	nc,A4946
4945 4945 d 19
4945 4945 s 	add	hl,de
4946 4946 d 3f
4946 4946 s A4946:	ccf
4947 4947 d cb11
4947 4947 s A4947:	rl	c
4949 4949 d 17
4949 4949 s 	rla
494a 494a d 10ef
494a 494a s 	djnz	A493B
494c 494c d 47
494c 494c s 	ld	b,a
494d 494d d c9
494d 494d s 	ret
494e 494e s ;
494e 494e d b7
494e 494e s A494E:	or	a
494f 494f d ed52
494f 494f s 	sbc	hl,de
4951 4951 d 18f4
4951 4951 s 	jr	A4947
4953 4953 s ;
4953 4953 d 60
4953 4953 s A4953:	ld	h,b
4954 4954 d 69
4954 4954 s 	ld	l,c			; bytes to transfer
4955 4955 d ed4bf2f2
4955 4955 s 	ld	bc,(YF2F2)		; offset in sector startbyte
4959 4959 d 78
4959 4959 s 	ld	a,b
495a 495a d b1
495a 495a s 	or	c
495b 495b d 5f
495b 495b s 	ld	e,a
495c 495c d 57
495c 495c s 	ld	d,a
495d 495d d 2813
495d 495d s 	jr	z,A4972			; at start sector, no partial start
495f 495f d dd5e02
495f 495f s 	ld	e,(ix+002H)
4962 4962 d dd5603
4962 4962 s 	ld	d,(ix+003H)
4965 4965 d eb
4965 4965 s 	ex	de,hl			; sectorsize
4966 4966 d ed42
4966 4966 s 	sbc	hl,bc
4968 4968 d eb
4968 4968 s 	ex	de,hl			; bytes left in sector
4969 4969 d ed52
4969 4969 s 	sbc	hl,de			; enough ?
496b 496b d 3005
496b 496b s 	jr	nc,A4972		; nop, get what you can
496d 496d d 19
496d 496d s 	add	hl,de
496e 496e d eb
496e 496e s 	ex	de,hl
496f 496f d 210000
496f 496f s 	ld	hl,00000H
4972 4972 d ed53f8f2
4972 4972 s A4972:	ld	(YF2F8),de		; bytes to transfer from partial sector
4976 4976 d 4d
4976 4976 s 	ld	c,l
4977 4977 d 44
4977 4977 s 	ld	b,h			; bytes left after partial sector transfer
4978 4978 d dd5e02
4978 4978 s 	ld	e,(ix+002H)
497b 497b d dd5603
497b 497b s 	ld	d,(ix+003H)
497e 497e d cd2f49
497e 497e s 	call	A492F			; / sectorsize
4981 4981 d 22faf2
4981 4981 s 	ld	(YF2FA),hl		; partial bytes in endsector
4984 4984 d ed43fcf2
4984 4984 s 	ld	(YF2FC),bc		; hole sectors of transfer
4988 4988 d c9
4988 4988 s 	ret
4989 4989 s ;
4989 4989 d cd82f2
4989 4989 s A4989:	call	XF282
498c 498c d fd6e1c
498c 498c s 	ld	l,(iy+01CH)
498f 498f d fd661d
498f 498f s 	ld	h,(iy+01DH)		; current cluster of file
4992 4992 d fd5e1e
4992 4992 s 	ld	e,(iy+01EH)
4995 4995 d fd561f
4995 4995 s 	ld	d,(iy+01FH)		; current relative cluster of file
4998 4998 d 7d
4998 4998 s 	ld	a,l
4999 4999 d b4
4999 4999 s 	or	h
499a 499a d 2833
499a 499a s 	jr	z,A49CF			; file has no start cluster,
499c 499c d c5
499c 499c s 	push	bc
499d 499d d 79
499d 499d s 	ld	a,c
499e 499e d 93
499e 499e s 	sub	e
499f 499f d 4f
499f 499f s 	ld	c,a
49a0 49a0 d 78
49a0 49a0 s 	ld	a,b
49a1 49a1 d 9a
49a1 49a1 s 	sbc	a,d
49a2 49a2 d 47
49a2 49a2 s 	ld	b,a
49a3 49a3 d 300b
49a3 49a3 s 	jr	nc,A49B0		; requested cluster behind current, search from current cluster
49a5 49a5 d c1
49a5 49a5 s 	pop	bc
49a6 49a6 d 110000
49a6 49a6 s 	ld	de,0			; relative cluster 0
49a9 49a9 d fd6e1a
49a9 49a9 s 	ld	l,(iy+01AH)
49ac 49ac d fd661b
49ac 49ac s 	ld	h,(iy+01BH)		; start cluster of file
49af 49af d f5
49af 49af s 	push	af
49b0 49b0 d f1
49b0 49b0 s A49B0:	pop	af
49b1 49b1 d cd85f2
49b1 49b1 s A49B1:	call	XF285
49b4 49b4 d 78
49b4 49b4 s 	ld	a,b
49b5 49b5 d b1
49b5 49b5 s 	or	c
49b6 49b6 d c8
49b6 49b6 s 	ret	z
49b7 49b7 d d5
49b7 49b7 s 	push	de
49b8 49b8 d e5
49b8 49b8 s 	push	hl
49b9 49b9 d cdf441
49b9 49b9 s 	call	A41F4			; get FAT entry content
49bc 49bc d d1
49bc 49bc s 	pop	de
49bd 49bd d 7c
49bd 49bd s 	ld	a,h
49be 49be d fe0f
49be 49be s 	cp	00FH
49c0 49c0 d 3805
49c0 49c0 s 	jr	c,A49C7
49c2 49c2 d 7d
49c2 49c2 s 	ld	a,l
49c3 49c3 d fef8
49c3 49c3 s 	cp	0F8H
49c5 49c5 d 3005
49c5 49c5 s 	jr	nc,A49CC		; end cluster
49c7 49c7 d d1
49c7 49c7 s A49C7:	pop	de
49c8 49c8 d 13
49c8 49c8 s 	inc	de
49c9 49c9 d 0b
49c9 49c9 s 	dec	bc
49ca 49ca d 18e5
49ca 49ca s 	jr	A49B1
49cc 49cc s ;
49cc 49cc d eb
49cc 49cc s A49CC:	ex	de,hl
49cd 49cd d d1
49cd 49cd s 	pop	de
49ce 49ce d c9
49ce 49ce s 	ret
49cf 49cf s ;
49cf 49cf d 03
49cf 49cf s A49CF:	inc	bc			; BC<>0 (means not found)
49d0 49d0 d 1b
49d0 49d0 s 	dec	de
49d1 49d1 d c9
49d1 49d1 s 	ret
49d2 49d2 s ;
49d2 49d2 d 32e0f2
49d2 49d2 s A49D2:	ld	(YF2E0),a
49d5 49d5 d 2aecf2
49d5 49d5 s 	ld	hl,(YF2EC)		; relative cluster
49d8 49d8 d 3addf2
49d8 49d8 s 	ld	a,(YF2DD)		; current relative sector in cluster
49db 49db d cddb4e
49db 49db s 	call	A4EDB			; get sectornumber of cluster
49de 49de d eb
49de 49de s 	ex	de,hl
49df 49df d 2a3ff2
49df 49df s 	ld	hl,(YF23F)
49e2 49e2 d ed52
49e2 49e2 s 	sbc	hl,de			; is it currently in the datasector buffer ?
49e4 49e4 d 200a
49e4 49e4 s 	jr	nz,A49F0		; nope, get it
49e6 49e6 d 3ae1f2
49e6 49e6 s 	ld	a,(YF2E1)		; current driveid
49e9 49e9 d 6f
49e9 49e9 s 	ld	l,a
49ea 49ea d 3a41f2
49ea 49ea s 	ld	a,(YF241)
49ed 49ed d bd
49ed 49ed s 	cp	l			; same drive as owner datasector buffer ?
49ee 49ee d 282b
49ee 49ee s 	jr	z,A4A1B			; yep,
49f0 49f0 d d5
49f0 49f0 s A49F0:	push	de
49f1 49f1 d dde5
49f1 49f1 s 	push	ix
49f3 49f3 d cd2d47
49f3 49f3 s 	call	A472D			; write datasector buffer when needed
49f6 49f6 d dde1
49f6 49f6 s 	pop	ix
49f8 49f8 d d1
49f8 49f8 s 	pop	de
49f9 49f9 d 3ae0f2
49f9 49f9 s 	ld	a,(YF2E0)
49fc 49fc d b7
49fc 49fc s 	or	a			; real or fake read ?
49fd 49fd d 200e
49fd 49fd s 	jr	nz,A4A0D		; fake read
49ff 49ff d 3d
49ff 49ff s 	dec	a
4a00 4a00 d 3241f2
4a00 4a00 s 	ld	(YF241),a
4a03 4a03 d 2a4ff3
4a03 4a03 s 	ld	hl,(YF34F)		; datasector buffer
4a06 4a06 d 0601
4a06 4a06 s 	ld	b,1			; 1 sector
4a08 4a08 d d5
4a08 4a08 s 	push	de
4a09 4a09 d cdc546
4a09 4a09 s 	call	A46C5			; read sector with DOS error handling
4a0c 4a0c d d1
4a0c 4a0c s 	pop	de
4a0d 4a0d d ed533ff2
4a0d 4a0d s A4A0D:	ld	(YF23F),de		; current datasector
4a11 4a11 d 3ae1f2
4a11 4a11 s 	ld	a,(YF2E1)		; current driveid
4a14 4a14 d 3241f2
4a14 4a14 s 	ld	(YF241),a		; set owner datasector buffer
4a17 4a17 d dd2243f2
4a17 4a17 s 	ld	(YF243),ix		; save DPB pointer
4a1b 4a1b d 3e01
4a1b 4a1b s A4A1B:	ld	a,1
4a1d 4a1d d 32dff2
4a1d 4a1d s 	ld	(YF2DF),a		; flag do increase sector
4a20 4a20 d 2ae2f2
4a20 4a20 s 	ld	hl,(YF2E2)
4a23 4a23 d e5
4a23 4a23 s 	push	hl
4a24 4a24 d ed4bf8f2
4a24 4a24 s 	ld	bc,(YF2F8)
4a28 4a28 d 09
4a28 4a28 s 	add	hl,bc
4a29 4a29 d 22e2f2
4a29 4a29 s 	ld	(YF2E2),hl		; update current transferadres
4a2c 4a2c d 2a4ff3
4a2c 4a2c s 	ld	hl,(YF34F)		; datasector buffer
4a2f 4a2f d ed5bf2f2
4a2f 4a2f s 	ld	de,(YF2F2)
4a33 4a33 d 19
4a33 4a33 s 	add	hl,de
4a34 4a34 d d1
4a34 4a34 s 	pop	de
4a35 4a35 d c9
4a35 4a35 s 	ret
4a36 4a36 s ;
4a36 4a36 d cd88f2
4a36 4a36 s A4A36:	call	XF288
4a39 4a39 d 2af8f2
4a39 4a39 s 	ld	hl,(YF2F8)
4a3c 4a3c d 7c
4a3c 4a3c s 	ld	a,h
4a3d 4a3d d b5
4a3d 4a3d s 	or	l			; partial sector read
4a3e 4a3e d c8
4a3e 4a3e s 	ret	z			; nope, quit
4a3f 4a3f d af
4a3f 4a3f s 	xor	a			; real read
4a40 4a40 d cdd249
4a40 4a40 s 	call	A49D2			; read datasector
4a43 4a43 d c3d9f1
4a43 4a43 s 	jp	XF1D9			; transfer to DOS memory
4a46 4a46 s ;
4a46 4a46 d cd8bf2
4a46 4a46 s A4A46:	call	XF28B
4a49 4a49 d 2af8f2
4a49 4a49 s 	ld	hl,(YF2F8)
4a4c 4a4c d 7c
4a4c 4a4c s 	ld	a,h
4a4d 4a4d d b5
4a4d 4a4d s 	or	l			; partial start ?
4a4e 4a4e d c8
4a4e 4a4e s 	ret	z			; nop, quit
4a4f 4a4f d 2aeef2
4a4f 4a4f s 	ld	hl,(YF2EE)
4a52 4a52 d 23
4a52 4a52 s 	inc	hl
4a53 4a53 d 22eef2
4a53 4a53 s 	ld	(YF2EE),hl		; update relative sector of startbyte
4a56 4a56 d af
4a56 4a56 s 	xor	a
4a57 4a57 d eb
4a57 4a57 s 	ex	de,hl
4a58 4a58 d 2af0f2
4a58 4a58 s 	ld	hl,(YF2F0)
4a5b 4a5b d ed52
4a5b 4a5b s 	sbc	hl,de			; sector behind end of file ?
4a5d 4a5d d 1f
4a5d 4a5d s 	rra				; if yes, fake read
4a5e 4a5e d cdd249
4a5e 4a5e s 	call	A49D2			; read datasector
4a61 4a61 d eb
4a61 4a61 s 	ex	de,hl
4a62 4a62 d cdd9f1
4a62 4a62 s 	call	XF1D9			; transfer from DOS memory
4a65 4a65 d 3e01
4a65 4a65 s 	ld	a,1
4a67 4a67 d 3242f2
4a67 4a67 s 	ld	(YF242),a		; flag datasector changed
4a6a 4a6a d c9
4a6a 4a6a s 	ret
4a6b 4a6b s ;
4a6b 4a6b d 210000
4a6b 4a6b s A4A6B:	ld	hl,0
4a6e 4a6e d 22f2f2
4a6e 4a6e s 	ld	(YF2F2),hl
4a71 4a71 d 2afaf2
4a71 4a71 s 	ld	hl,(YF2FA)
4a74 4a74 d 22f8f2
4a74 4a74 s 	ld	(YF2F8),hl
4a77 4a77 d 7c
4a77 4a77 s 	ld	a,h
4a78 4a78 d b5
4a78 4a78 s 	or	l
4a79 4a79 d 37
4a79 4a79 s 	scf
4a7a 4a7a d c8
4a7a 4a7a s 	ret	z
4a7b 4a7b s 
4a7b 4a7b d 3adff2
4a7b 4a7b s A4A7B:	ld	a,(YF2DF)
4a7e 4a7e d b7
4a7e 4a7e s 	or	a			; flag do not increase
4a7f 4a7f d c8
4a7f 4a7f s 	ret	z			; yep, quit
4a80 4a80 d 3addf2
4a80 4a80 s 	ld	a,(YF2DD)
4a83 4a83 d ddbe06
4a83 4a83 s 	cp	(ix+006H)		; clustermask
4a86 4a86 d 381a
4a86 4a86 s 	jr	c,A4AA2			; still sectors left in this cluster, increase relative sector in cluster
4a88 4a88 d ed5becf2
4a88 4a88 s 	ld	de,(YF2EC)		; current cluster of file
4a8c 4a8c d 21f70f
4a8c 4a8c s 	ld	hl,00FF7H
4a8f 4a8f d ed52
4a8f 4a8f s 	sbc	hl,de
4a91 4a91 d d8
4a91 4a91 s 	ret	c			; is the end cluster, quit
4a92 4a92 d eb
4a92 4a92 s 	ex	de,hl
4a93 4a93 d cdf441
4a93 4a93 s 	call	A41F4			; get FAT entry content
4a96 4a96 d 22ecf2
4a96 4a96 s 	ld	(YF2EC),hl		; new current cluster of file
4a99 4a99 d 2aeaf2
4a99 4a99 s 	ld	hl,(YF2EA)
4a9c 4a9c d 23
4a9c 4a9c s 	inc	hl
4a9d 4a9d d 22eaf2
4a9d 4a9d s 	ld	(YF2EA),hl		; new current relative cluster of file
4aa0 4aa0 d 3eff
4aa0 4aa0 s 	ld	a,0FFH			; relative sector in cluster 0
4aa2 4aa2 d 3c
4aa2 4aa2 s A4AA2:	inc	a
4aa3 4aa3 d 32ddf2
4aa3 4aa3 s 	ld	(YF2DD),a
4aa6 4aa6 d b7
4aa6 4aa6 s 	or	a
4aa7 4aa7 d c9
4aa7 4aa7 s 	ret
4aa8 4aa8 s ;
4aa8 4aa8 d 7e
4aa8 4aa8 s A4AA8:	ld	a,(hl)
4aa9 4aa9 d eda0
4aa9 4aa9 s 	ldi
4aab 4aab d fe0d
4aab 4aab s 	cp	00DH
4aad 4aad d 2002
4aad 4aad s 	jr	nz,A4AB1
4aaf 4aaf d 360a
4aaf 4aaf s 	ld	(hl),00AH
4ab1 4ab1 d fe0a
4ab1 4ab1 s A4AB1:	cp	00AH
4ab3 4ab3 d 2815
4ab3 4ab3 s 	jr	z,A4ACA
4ab5 4ab5 d 78
4ab5 4ab5 s 	ld	a,b
4ab6 4ab6 d b1
4ab6 4ab6 s 	or	c
4ab7 4ab7 d 20ef
4ab7 4ab7 s 	jr	nz,A4AA8
4ab9 4ab9 d 2200f3
4ab9 4ab9 s A4AB9:	ld	(YF300),hl
4abc 4abc d ed53e2f2
4abc 4abc s A4ABC:	ld	(YF2E2),de		; update current transferadres
4ac0 4ac0 d c2e24b
4ac0 4ac0 s 	jp	nz,A4BE2
4ac3 4ac3 d fdcb18b6
4ac3 4ac3 s 	res	6,(iy+018H)
4ac7 4ac7 d c3e24b
4ac7 4ac7 s 	jp	A4BE2
4aca 4aca s ;
4aca 4aca d cda853
4aca 4aca s A4ACA:	call	A53A8			; console output
4acd 4acd d 210000
4acd 4acd s 	ld	hl,00000H
4ad0 4ad0 d 79
4ad0 4ad0 s 	ld	a,c
4ad1 4ad1 d b0
4ad1 4ad1 s 	or	b
4ad2 4ad2 d 2025
4ad2 4ad2 s 	jr	nz,A4AF9
4ad4 4ad4 d 3c
4ad4 4ad4 s 	inc	a
4ad5 4ad5 d 18e2
4ad5 4ad5 s 	jr	A4AB9
4ad7 4ad7 s 
4ad7 4ad7 s ;	  Subroutine read record for dos devices
4ad7 4ad7 s ;	     Inputs  
4ad7 4ad7 s ;	     Outputs ________________________ 
4ad7 4ad7 s 
4ad7 4ad7 d ed5be2f2
4ad7 4ad7 s A4AD7:	ld	de,(YF2E2)		; current transferadres
4adb 4adb d 3c
4adb 4adb s 	inc	a
4adc 4adc d 2814
4adc 4adc s 	jr	z,A4AF2			; CON, handle
4ade 4ade d 3c
4ade 4ade s 	inc	a
4adf 4adf d 20db
4adf 4adf s 	jr	nz,A4ABC		; PRN, quit
4ae1 4ae1 s 
4ae1 4ae1 s ; read record AUX
4ae1 4ae1 s 
4ae1 4ae1 d cd6e54
4ae1 4ae1 s A4AE1:	call	A546E			; auxiliary input
4ae4 4ae4 d 12
4ae4 4ae4 s 	ld	(de),a
4ae5 4ae5 d 13
4ae5 4ae5 s 	inc	de
4ae6 4ae6 d fe1a
4ae6 4ae6 s 	cp	01AH
4ae8 4ae8 d 28d2
4ae8 4ae8 s 	jr	z,A4ABC			; CTRL-Z, 
4aea 4aea d 0b
4aea 4aea s 	dec	bc
4aeb 4aeb d 78
4aeb 4aeb s 	ld	a,b
4aec 4aec d b1
4aec 4aec s 	or	c			; all bytes done ?
4aed 4aed d 20f2
4aed 4aed s 	jr	nz,A4AE1		; nope, next byte
4aef 4aef d 3c
4aef 4aef s 	inc	a
4af0 4af0 d 18ca
4af0 4af0 s 	jr	A4ABC
4af2 4af2 s 
4af2 4af2 s ; read record CON
4af2 4af2 s 
4af2 4af2 d 2a00f3
4af2 4af2 s A4AF2:	ld	hl,(YF300)
4af5 4af5 d 7c
4af5 4af5 s 	ld	a,h
4af6 4af6 d b5
4af6 4af6 s 	or	l
4af7 4af7 d 20af
4af7 4af7 s 	jr	nz,A4AA8
4af9 4af9 s 
4af9 4af9 s ; VERSION 1.1 CHANGE
4af9 4af9 s ;
4af9 4af9 s ; CHANGED, BUGFIX
4af9 4af9 s ; ld hl,00080H
4af9 4af9 s ;
4af9 4af9 s 
4af9 4af9 d 217f00
4af9 4af9 s A4AF9:	ld	hl,0007FH
4afc 4afc d 3ad9f4
4afc 4afc s 	ld	a,(KBUF+186)
4aff 4aff d bd
4aff 4aff s 	cp	l
4b00 4b00 d 2803
4b00 4b00 s 	jr	z,A4B05
4b02 4b02 d 22d9f4
4b02 4b02 s 	ld	(KBUF+186),hl
4b05 4b05 d c5
4b05 4b05 s A4B05:	push	bc
4b06 4b06 d d5
4b06 4b06 s 	push	de
4b07 4b07 d 11d9f4
4b07 4b07 s 	ld	de,KBUF+186
4b0a 4b0a d cde050
4b0a 4b0a s 	call	A50E0			; BDOS 0A (buffered console input)
4b0d 4b0d d d1
4b0d 4b0d s 	pop	de
4b0e 4b0e d c1
4b0e 4b0e s 	pop	bc
4b0f 4b0f d 21dbf4
4b0f 4b0f s 	ld	hl,KBUF+186+2
4b12 4b12 d 7e
4b12 4b12 s 	ld	a,(hl)
4b13 4b13 d fe1a
4b13 4b13 s 	cp	01AH
4b15 4b15 d 2091
4b15 4b15 s 	jr	nz,A4AA8
4b17 4b17 d 12
4b17 4b17 s 	ld	(de),a
4b18 4b18 d 13
4b18 4b18 s 	inc	de
4b19 4b19 d 3e0a
4b19 4b19 s 	ld	a,00AH			; LF
4b1b 4b1b d cda853
4b1b 4b1b s 	call	A53A8			; console output
4b1e 4b1e d af
4b1e 4b1e s 	xor	a
4b1f 4b1f d 67
4b1f 4b1f s 	ld	h,a
4b20 4b20 d 6f
4b20 4b20 s 	ld	l,a
4b21 4b21 d 1896
4b21 4b21 s 	jr	A4AB9
4b23 4b23 s 
4b23 4b23 s ;	  Subroutine read record
4b23 4b23 s ;	     Inputs  DEBC = recordnumber, HL = number of records
4b23 4b23 s ;	     Outputs DEHL = last record done, BC = number of records done
4b23 4b23 s 
4b23 4b23 d cd7d48
4b23 4b23 s A4B23:	call	A487D			; initialize record info
4b26 4b26 d fad74a
4b26 4b26 s 	jp	m,A4AD7			; dos device, special action
4b29 4b29 d fd6e10
4b29 4b29 s 	ld	l,(iy+010H)
4b2c 4b2c d fd6611
4b2c 4b2c s 	ld	h,(iy+011H)
4b2f 4b2f d ed5bf4f2
4b2f 4b2f s 	ld	de,(YF2F4+0)
4b33 4b33 d b7
4b33 4b33 s 	or	a
4b34 4b34 d ed52
4b34 4b34 s 	sbc	hl,de
4b36 4b36 d e5
4b36 4b36 s 	push	hl
4b37 4b37 d fd6e12
4b37 4b37 s 	ld	l,(iy+012H)
4b3a 4b3a d fd6613
4b3a 4b3a s 	ld	h,(iy+013H)
4b3d 4b3d d ed5bf6f2
4b3d 4b3d s 	ld	de,(YF2F4+2)
4b41 4b41 d ed52
4b41 4b41 s 	sbc	hl,de
4b43 4b43 d e1
4b43 4b43 s 	pop	hl
4b44 4b44 d da974c
4b44 4b44 s 	jp	c,A4C97			; startbyte behind end of file, quit with nothing done
4b47 4b47 d 200d
4b47 4b47 s 	jr	nz,A4B56		; startbyte at least 65536 bytes from the end of file, go get it
4b49 4b49 d 7c
4b49 4b49 s 	ld	a,h
4b4a 4b4a d b5
4b4a 4b4a s 	or	l
4b4b 4b4b d ca974c
4b4b 4b4b s 	jp	z,A4C97			; startbyte is at end of file, quit with nothing done
4b4e 4b4e d e5
4b4e 4b4e s 	push	hl
4b4f 4b4f d ed42
4b4f 4b4f s 	sbc	hl,bc			; requested number of bytes past file ?
4b51 4b51 d e1
4b51 4b51 s 	pop	hl
4b52 4b52 d 3002
4b52 4b52 s 	jr	nc,A4B56		; nope, go get it
4b54 4b54 d 44
4b54 4b54 s 	ld	b,h
4b55 4b55 d 4d
4b55 4b55 s 	ld	c,l			; only read number of bytes until the end of file
4b56 4b56 d cd8ef2
4b56 4b56 s A4B56:	call	XF28E
4b59 4b59 d cd5349
4b59 4b59 s 	call	A4953			; calculate partial sector transfers
4b5c 4b5c d ed4becf2
4b5c 4b5c s 	ld	bc,(YF2EC)		; relative cluster
4b60 4b60 d cd8949
4b60 4b60 s 	call	A4989			; get absolute cluster
4b63 4b63 d 78
4b63 4b63 s 	ld	a,b
4b64 4b64 d b1
4b64 4b64 s 	or	c			; found ?
4b65 4b65 d c2974c
4b65 4b65 s 	jp	nz,A4C97		; nope, quit with nothing done
4b68 4b68 d 22ecf2
4b68 4b68 s 	ld	(YF2EC),hl		; current cluster = cluster of startbyte
4b6b 4b6b d ed53eaf2
4b6b 4b6b s 	ld	(YF2EA),de		; current relative cluster = relative cluster of startbyte
4b6f 4b6f d cd364a
4b6f 4b6f s 	call	A4A36			; do partical sector read if needed
4b72 4b72 d 2afcf2
4b72 4b72 s 	ld	hl,(YF2FC)
4b75 4b75 d 7c
4b75 4b75 s 	ld	a,h
4b76 4b76 d b5
4b76 4b76 s 	or	l
4b77 4b77 d cadc4b
4b77 4b77 s 	jp	z,A4BDC			; not any whole sectors to transfer, to partical end
4b7a 4b7a d cd7b4a
4b7a 4b7a s 	call	A4A7B			; to next sector (only when partical read was done)
4b7d 4b7d d 3863
4b7d 4b7d s 	jr	c,A4BE2			; there is no next,
4b7f 4b7f d 3e01
4b7f 4b7f s 	ld	a,1
4b81 4b81 d 32dff2
4b81 4b81 s 	ld	(YF2DF),a		; flag do increase sector
4b84 4b84 d 3addf2
4b84 4b84 s 	ld	a,(YF2DD)		; current relative sector in cluster
4b87 4b87 d ed4bfcf2
4b87 4b87 s 	ld	bc,(YF2FC)
4b8b 4b8b d 2aecf2
4b8b 4b8b s 	ld	hl,(YF2EC)		; current cluster of file
4b8e 4b8e d c5
4b8e 4b8e s A4B8E:	push	bc
4b8f 4b8f d cd484e
4b8f 4b8f s 	call	A4E48			; calculate sequential sectors
4b92 4b92 d c5
4b92 4b92 s 	push	bc
4b93 4b93 d f5
4b93 4b93 s 	push	af
4b94 4b94 d 47
4b94 4b94 s 	ld	b,a
4b95 4b95 d cdc546
4b95 4b95 s 	call	A46C5			; read sectors with DOS error handling
4b98 4b98 d f1
4b98 4b98 s 	pop	af
4b99 4b99 d 4f
4b99 4b99 s 	ld	c,a
4b9a 4b9a d 0600
4b9a 4b9a s 	ld	b,000H			; number of sectors read
4b9c 4b9c d 3823
4b9c 4b9c s 	jr	c,A4BC1			; sectors read does not include the sector in the datasector buffer
4b9e 4b9e d 3a42f2
4b9e 4b9e s 	ld	a,(YF242)
4ba1 4ba1 d b7
4ba1 4ba1 s 	or	a			; datasector buffer changed ?
4ba2 4ba2 d 281d
4ba2 4ba2 s 	jr	z,A4BC1			; nope, then no need to transfer the datasector buffer
4ba4 4ba4 d c5
4ba4 4ba4 s 	push	bc
4ba5 4ba5 d dd4e02
4ba5 4ba5 s 	ld	c,(ix+002H)
4ba8 4ba8 d dd4603
4ba8 4ba8 s 	ld	b,(ix+003H)		; sectorsize
4bab 4bab d c5
4bab 4bab s 	push	bc
4bac 4bac d e5
4bac 4bac s 	push	hl
4bad 4bad d 2a3ff2
4bad 4bad s 	ld	hl,(YF23F)		; sectornumber of datasector buffer
4bb0 4bb0 d ed52
4bb0 4bb0 s 	sbc	hl,de
4bb2 4bb2 d eb
4bb2 4bb2 s 	ex	de,hl
4bb3 4bb3 d cd1649
4bb3 4bb3 s 	call	A4916			; multiply
4bb6 4bb6 d e1
4bb6 4bb6 s 	pop	hl
4bb7 4bb7 d 09
4bb7 4bb7 s 	add	hl,bc
4bb8 4bb8 d c1
4bb8 4bb8 s 	pop	bc
4bb9 4bb9 d eb
4bb9 4bb9 s 	ex	de,hl
4bba 4bba d 2a4ff3
4bba 4bba s 	ld	hl,(YF34F)		; datasector buffer
4bbd 4bbd d cdd9f1
4bbd 4bbd s 	call	XF1D9			; transfer to DOS memory
4bc0 4bc0 d c1
4bc0 4bc0 s 	pop	bc
4bc1 4bc1 d d1
4bc1 4bc1 s A4BC1:	pop	de
4bc2 4bc2 d e1
4bc2 4bc2 s 	pop	hl
4bc3 4bc3 d b7
4bc3 4bc3 s 	or	a
4bc4 4bc4 d ed42
4bc4 4bc4 s 	sbc	hl,bc			; done all whole sectors ?
4bc6 4bc6 d 2814
4bc6 4bc6 s 	jr	z,A4BDC			; yep, go partial end
4bc8 4bc8 d 4d
4bc8 4bc8 s 	ld	c,l
4bc9 4bc9 d 44
4bc9 4bc9 s 	ld	b,h
4bca 4bca d 21f70f
4bca 4bca s 	ld	hl,00FF7H
4bcd 4bcd d ed52
4bcd 4bcd s 	sbc	hl,de			; end cluster ?
4bcf 4bcf d 3811
4bcf 4bcf s 	jr	c,A4BE2			; yep, finish without partial end
4bd1 4bd1 d 2aeaf2
4bd1 4bd1 s 	ld	hl,(YF2EA)
4bd4 4bd4 d 23
4bd4 4bd4 s 	inc	hl
4bd5 4bd5 d 22eaf2
4bd5 4bd5 s 	ld	(YF2EA),hl		; increase current relarive cluster
4bd8 4bd8 d af
4bd8 4bd8 s 	xor	a			; current relative sector in cluster = first sector
4bd9 4bd9 d eb
4bd9 4bd9 s 	ex	de,hl
4bda 4bda d 18b2
4bda 4bda s 	jr	A4B8E			; again
4bdc 4bdc s ;
4bdc 4bdc d cd6b4a
4bdc 4bdc s A4BDC:	call	A4A6B			; last partial sector ?
4bdf 4bdf d d4364a
4bdf 4bdf s 	call	nc,A4A36		; yes, do partical sector read if needed
4be2 4be2 d cd91f2
4be2 4be2 s A4BE2:	call	XF291
4be5 4be5 d 2ae2f2
4be5 4be5 s 	ld	hl,(YF2E2)		; current transferadres (end)
4be8 4be8 d ed5b3df2
4be8 4be8 s 	ld	de,(YF23D)		; transferadres (begin)
4bec 4bec d b7
4bec 4bec s 	or	a
4bed 4bed d ed52
4bed 4bed s 	sbc	hl,de
4bef 4bef d 4d
4bef 4bef s 	ld	c,l
4bf0 4bf0 d 44
4bf0 4bf0 s 	ld	b,h			; size of transfer
4bf1 4bf1 d 118000
4bf1 4bf1 s 	ld	de,00080H
4bf4 4bf4 d 3a06f3
4bf4 4bf4 s 	ld	a,(YF306)
4bf7 4bf7 d b7
4bf7 4bf7 s 	or	a			; Random Block
4bf8 4bf8 d 2006
4bf8 4bf8 s 	jr	nz,A4C00		; nope, use 128 bytes recordsize
4bfa 4bfa d fd5e0e
4bfa 4bfa s 	ld	e,(iy+00EH)
4bfd 4bfd d fd560f
4bfd 4bfd s 	ld	d,(iy+00FH)		; user recordsize for Random Block
4c00 4c00 d cd2f49
4c00 4c00 s A4C00:	call	A492F			; how many records ?
4c03 4c03 d 7c
4c03 4c03 s 	ld	a,h
4c04 4c04 d b5
4c04 4c04 s 	or	l			; partly records ?
4c05 4c05 d 2810
4c05 4c05 s 	jr	z,A4C17			; nop,
4c07 4c07 d 03
4c07 4c07 s 	inc	bc			; records +1
4c08 4c08 d eb
4c08 4c08 s 	ex	de,hl
4c09 4c09 d ed52
4c09 4c09 s 	sbc	hl,de			; 'missed' bytes
4c0b 4c0b d ed5be2f2
4c0b 4c0b s 	ld	de,(YF2E2)
4c0f 4c0f d af
4c0f 4c0f s A4C0F:	xor	a
4c10 4c10 d 12
4c10 4c10 s 	ld	(de),a
4c11 4c11 d 13
4c11 4c11 s 	inc	de
4c12 4c12 d 2b
4c12 4c12 s 	dec	hl
4c13 4c13 d 7c
4c13 4c13 s 	ld	a,h
4c14 4c14 d b5
4c14 4c14 s 	or	l
4c15 4c15 d 20f8
4c15 4c15 s 	jr	nz,A4C0F		; clear 'missed' bytes
4c17 4c17 d 2ae8f2
4c17 4c17 s A4C17:	ld	hl,(YF2E8)		; number of records requested
4c1a 4c1a d ed42
4c1a 4c1a s 	sbc	hl,bc
4c1c 4c1c d 2804
4c1c 4c1c s 	jr	z,A4C22			; all done,
4c1e 4c1e d 3c
4c1e 4c1e s 	inc	a
4c1f 4c1f d 32def2
4c1f 4c1f s 	ld	(YF2DE),a		; error in record operation
4c22 4c22 d cd94f2
4c22 4c22 s A4C22:	call	XF294
4c25 4c25 d 2aecf2
4c25 4c25 s 	ld	hl,(YF2EC)
4c28 4c28 d fd751c
4c28 4c28 s 	ld	(iy+01CH),l
4c2b 4c2b d fd741d
4c2b 4c2b s 	ld	(iy+01DH),h		; current cluster of file FCB
4c2e 4c2e d 2aeaf2
4c2e 4c2e s 	ld	hl,(YF2EA)
4c31 4c31 d fd751e
4c31 4c31 s 	ld	(iy+01EH),l
4c34 4c34 d fd741f
4c34 4c34 s 	ld	(iy+01FH),h		; current relative cluster of file FCB
4c37 4c37 d 2ae4f2
4c37 4c37 s A4C37:	ld	hl,(YF2E4+0)
4c3a 4c3a d ed5be6f2
4c3a 4c3a s 	ld	de,(YF2E4+2)		; startrecord
4c3e 4c3e d 78
4c3e 4c3e s 	ld	a,b
4c3f 4c3f d b1
4c3f 4c3f s 	or	c			; done any records ?
4c40 4c40 d c8
4c40 4c40 s 	ret	z			; nope, quit
4c41 4c41 d 0b
4c41 4c41 s 	dec	bc
4c42 4c42 d 09
4c42 4c42 s 	add	hl,bc
4c43 4c43 d 03
4c43 4c43 s 	inc	bc
4c44 4c44 d d0
4c44 4c44 s 	ret	nc
4c45 4c45 d 13
4c45 4c45 s 	inc	de			; return current record
4c46 4c46 d c9
4c46 4c46 s 	ret
4c47 4c47 s 
4c47 4c47 s ;	  Subroutine write record for dos devices
4c47 4c47 s ;	     Inputs  
4c47 4c47 s ;	     Outputs ________________________ 
4c47 4c47 s 
4c47 4c47 d 2a3df2
4c47 4c47 s A4C47:	ld	hl,(YF23D)		; transferadres
4c4a 4c4a d f640
4c4a 4c4a s 	or	040H
4c4c 4c4c d 3c
4c4c 4c4c s 	inc	a
4c4d 4c4d d 2824
4c4d 4c4d s 	jr	z,A4C73			; CON, handle
4c4f 4c4f d 3c
4c4f 4c4f s 	inc	a
4c50 4c50 d 2811
4c50 4c50 s 	jr	z,A4C63			; AUX, handle
4c52 4c52 d 3c
4c52 4c52 s 	inc	a
4c53 4c53 d 282c
4c53 4c53 s A4C53:	jr	z,A4C81			; NUL, handle
4c55 4c55 s 
4c55 4c55 d 7e
4c55 4c55 s 	ld	a,(hl)
4c56 4c56 d 23
4c56 4c56 s 	inc	hl
4c57 4c57 d fe1a
4c57 4c57 s 	cp	01AH
4c59 4c59 d 2826
4c59 4c59 s 	jr	z,A4C81
4c5b 4c5b d cd6654
4c5b 4c5b s 	call	A5466			; printer output
4c5e 4c5e d 0b
4c5e 4c5e s 	dec	bc
4c5f 4c5f d 78
4c5f 4c5f s 	ld	a,b
4c60 4c60 d b1
4c60 4c60 s 	or	c
4c61 4c61 d 18f0
4c61 4c61 s 	jr	A4C53
4c63 4c63 s ;
4c63 4c63 d 7e
4c63 4c63 s A4C63:	ld	a,(hl)
4c64 4c64 d 23
4c64 4c64 s 	inc	hl
4c65 4c65 d cd7554
4c65 4c65 s 	call	A5475			; auxiliary output
4c68 4c68 d fe1a
4c68 4c68 s 	cp	01AH
4c6a 4c6a d 2815
4c6a 4c6a s 	jr	z,A4C81
4c6c 4c6c d 0b
4c6c 4c6c s 	dec	bc
4c6d 4c6d d 78
4c6d 4c6d s 	ld	a,b
4c6e 4c6e d b1
4c6e 4c6e s 	or	c
4c6f 4c6f d 20f2
4c6f 4c6f s 	jr	nz,A4C63
4c71 4c71 d 180e
4c71 4c71 s 	jr	A4C81
4c73 4c73 s ;
4c73 4c73 d 7e
4c73 4c73 s A4C73:	ld	a,(hl)
4c74 4c74 d 23
4c74 4c74 s 	inc	hl
4c75 4c75 d fe1a
4c75 4c75 s 	cp	01AH
4c77 4c77 d 2808
4c77 4c77 s 	jr	z,A4C81
4c79 4c79 d cda853
4c79 4c79 s 	call	A53A8			; console output
4c7c 4c7c d 0b
4c7c 4c7c s 	dec	bc
4c7d 4c7d d 78
4c7d 4c7d s 	ld	a,b
4c7e 4c7e d b1
4c7e 4c7e s 	or	c
4c7f 4c7f d 20f2
4c7f 4c7f s 	jr	nz,A4C73
4c81 4c81 d ed4be8f2
4c81 4c81 s A4C81:	ld	bc,(YF2E8)		; no. of records
4c85 4c85 d 18b0
4c85 4c85 s 	jr	A4C37
4c87 4c87 s ;
4c87 4c87 d 4b
4c87 4c87 s A4C87:	ld	c,e
4c88 4c88 d 42
4c88 4c88 s 	ld	b,d			; clusters to skip
4c89 4c89 d cdb149
4c89 4c89 s 	call	A49B1			; get next absolute cluster
4c8c 4c8c d 78
4c8c 4c8c s 	ld	a,b
4c8d 4c8d d b1
4c8d 4c8d s 	or	c			; found ?
4c8e 4c8e d ca414d
4c8e 4c8e s 	jp	z,A4D41			; yep,
4c91 4c91 d cd124f
4c91 4c91 s 	call	A4F12			; allocate chain
4c94 4c94 d d2414d
4c94 4c94 s 	jp	nc,A4D41		; ok, go writing
4c97 4c97 s 
4c97 4c97 d cd97f2
4c97 4c97 s A4C97:	call	XF297
4c9a 4c9a d af
4c9a 4c9a s 	xor	a
4c9b 4c9b d 4f
4c9b 4c9b s 	ld	c,a
4c9c 4c9c d 47
4c9c 4c9c s 	ld	b,a			; no records read/write
4c9d 4c9d d 3c
4c9d 4c9d s 	inc	a
4c9e 4c9e d 32def2
4c9e 4c9e s 	ld	(YF2DE),a		; error in record operation
4ca1 4ca1 d 1894
4ca1 4ca1 s 	jr	A4C37
4ca3 4ca3 s 
4ca3 4ca3 s ;	  Subroutine write record
4ca3 4ca3 s ;	     Inputs  DEBC = recordnumber, HL = number of records
4ca3 4ca3 s ;	     Outputs ________________________ 
4ca3 4ca3 s 
4ca3 4ca3 d cd7d48
4ca3 4ca3 s A4CA3:	call	A487D			; initialize record info
4ca6 4ca6 d f5
4ca6 4ca6 s 	push	af
4ca7 4ca7 d c5
4ca7 4ca7 s 	push	bc
4ca8 4ca8 d cd9654
4ca8 4ca8 s 	call	A5496			; get time and date (dirformat)
4cab 4cab d fd7114
4cab 4cab s 	ld	(iy+014H),c
4cae 4cae d fd7015
4cae 4cae s 	ld	(iy+015H),b
4cb1 4cb1 d fd7316
4cb1 4cb1 s 	ld	(iy+016H),e
4cb4 4cb4 d fd7217
4cb4 4cb4 s 	ld	(iy+017H),d
4cb7 4cb7 d c1
4cb7 4cb7 s 	pop	bc
4cb8 4cb8 d f1
4cb8 4cb8 s 	pop	af
4cb9 4cb9 d fa474c
4cb9 4cb9 s 	jp	m,A4C47			; DOS device, special action
4cbc 4cbc d fdcb18b6
4cbc 4cbc s 	res	6,(iy+018H)		; flag FCB changed
4cc0 4cc0 d c5
4cc0 4cc0 s 	push	bc
4cc1 4cc1 d cd5349
4cc1 4cc1 s 	call	A4953			; calculate partical sector transfers
4cc4 4cc4 d c1
4cc4 4cc4 s 	pop	bc
4cc5 4cc5 d 2af4f2
4cc5 4cc5 s 	ld	hl,(YF2F4+0)
4cc8 4cc8 d ed5bf6f2
4cc8 4cc8 s 	ld	de,(YF2F4+2)		; startbyte
4ccc 4ccc d 78
4ccc 4ccc s 	ld	a,b
4ccd 4ccd d b1
4ccd 4ccd s 	or	c			; zero bytes to write (only possible with Random Block) ?
4cce 4cce d cadd4d
4cce 4cce s 	jp	z,A4DDD			; yep, filesize adjust action
4cd1 4cd1 d 0b
4cd1 4cd1 s 	dec	bc
4cd2 4cd2 d 09
4cd2 4cd2 s 	add	hl,bc
4cd3 4cd3 d 3001
4cd3 4cd3 s 	jr	nc,A4CD6
4cd5 4cd5 d 13
4cd5 4cd5 s 	inc	de			; endbyte
4cd6 4cd6 d 44
4cd6 4cd6 s A4CD6:	ld	b,h
4cd7 4cd7 d 4d
4cd7 4cd7 s 	ld	c,l
4cd8 4cd8 d eb
4cd8 4cd8 s 	ex	de,hl
4cd9 4cd9 d dd5e02
4cd9 4cd9 s 	ld	e,(ix+002H)
4cdc 4cdc d dd5603
4cdc 4cdc s 	ld	d,(ix+003H)
4cdf 4cdf d cd3249
4cdf 4cdf s 	call	A4932			; / sectorsize
4ce2 4ce2 d 60
4ce2 4ce2 s 	ld	h,b
4ce3 4ce3 d 69
4ce3 4ce3 s 	ld	l,c			; relative sector of endbyte
4ce4 4ce4 d dd4607
4ce4 4ce4 s 	ld	b,(ix+007H)		; clustershift
4ce7 4ce7 d 05
4ce7 4ce7 s 	dec	b
4ce8 4ce8 d 2806
4ce8 4ce8 s 	jr	z,A4CF0
4cea 4cea d cb3c
4cea 4cea s A4CEA:	srl	h
4cec 4cec d cb1d
4cec 4cec s 	rr	l
4cee 4cee d 10fa
4cee 4cee s 	djnz	A4CEA			; relative cluster of endbyte
4cf0 4cf0 d e5
4cf0 4cf0 s A4CF0:	push	hl
4cf1 4cf1 d fd4e10
4cf1 4cf1 s 	ld	c,(iy+010H)
4cf4 4cf4 d fd4611
4cf4 4cf4 s 	ld	b,(iy+011H)
4cf7 4cf7 d fd6e12
4cf7 4cf7 s 	ld	l,(iy+012H)
4cfa 4cfa d fd6613
4cfa 4cfa s 	ld	h,(iy+013H)		; filesize
4cfd 4cfd d cd3249
4cfd 4cfd s 	call	A4932			; / sectorsize
4d00 4d00 d 7c
4d00 4d00 s 	ld	a,h
4d01 4d01 d b5
4d01 4d01 s 	or	l			; offset in sector
4d02 4d02 d 2801
4d02 4d02 s 	jr	z,A4D05
4d04 4d04 d 03
4d04 4d04 s 	inc	bc			; relative sector
4d05 4d05 d cd9af2
4d05 4d05 s A4D05:	call	XF29A
4d08 4d08 d ed43f0f2
4d08 4d08 s 	ld	(YF2F0),bc		; relative sector behind fileend
4d0c 4d0c d ed4becf2
4d0c 4d0c s 	ld	bc,(YF2EC)		; relative cluster of startbyte
4d10 4d10 d cd8949
4d10 4d10 s 	call	A4989			; get absolute cluster
4d13 4d13 d 22ecf2
4d13 4d13 s 	ld	(YF2EC),hl		; current cluster = cluster of startbyte
4d16 4d16 d ed53eaf2
4d16 4d16 s 	ld	(YF2EA),de		; current relative cluster = relative cluster of startbyte
4d1a 4d1a d e3
4d1a 4d1a s 	ex	(sp),hl
4d1b 4d1b d b7
4d1b 4d1b s 	or	a
4d1c 4d1c d ed52
4d1c 4d1c s 	sbc	hl,de			; start and endbyte in same cluster ?
4d1e 4d1e d eb
4d1e 4d1e s 	ex	de,hl
4d1f 4d1f d e1
4d1f 4d1f s 	pop	hl
4d20 4d20 d 281f
4d20 4d20 s 	jr	z,A4D41			; yep,
4d22 4d22 d 78
4d22 4d22 s 	ld	a,b
4d23 4d23 d b1
4d23 4d23 s 	or	c			; is cluster of startbyte found ?
4d24 4d24 d ca874c
4d24 4d24 s 	jp	z,A4C87			; yep, make chain to cluster of endbyte if needed and start writing
4d27 4d27 d c5
4d27 4d27 s 	push	bc
4d28 4d28 d 4b
4d28 4d28 s 	ld	c,e
4d29 4d29 d 42
4d29 4d29 s 	ld	b,d			; clusters to allocate
4d2a 4d2a d cd124f
4d2a 4d2a s 	call	A4F12			; allocate chain
4d2d 4d2d d c1
4d2d 4d2d s 	pop	bc
4d2e 4d2e d da974c
4d2e 4d2e s 	jp	c,A4C97			; failed, quit with nothing done
4d31 4d31 d ed5beaf2
4d31 4d31 s 	ld	de,(YF2EA)
4d35 4d35 d 13
4d35 4d35 s 	inc	de			; relative cluster to start
4d36 4d36 d 0b
4d36 4d36 s 	dec	bc			; clusters to skip
4d37 4d37 d cdb149
4d37 4d37 s 	call	A49B1			; get next absolute cluster
4d3a 4d3a d 22ecf2
4d3a 4d3a s 	ld	(YF2EC),hl		; cluster of startbyte
4d3d 4d3d d ed53eaf2
4d3d 4d3d s 	ld	(YF2EA),de		; relative cluster of startbyte
4d41 4d41 d cd464a
4d41 4d41 s A4D41:	call	A4A46			; handle partial sector write
4d44 4d44 d 2afcf2
4d44 4d44 s 	ld	hl,(YF2FC)
4d47 4d47 d 7c
4d47 4d47 s 	ld	a,h
4d48 4d48 d b5
4d48 4d48 s 	or	l			; any complete sectors ?
4d49 4d49 d 2841
4d49 4d49 s 	jr	z,A4D8C			; nope, goto partial end
4d4b 4d4b d ed5beef2
4d4b 4d4b s 	ld	de,(YF2EE)
4d4f 4d4f d 19
4d4f 4d4f s 	add	hl,de
4d50 4d50 d 22eef2
4d50 4d50 s 	ld	(YF2EE),hl		; update relative sector of startbyte
4d53 4d53 d cd7b4a
4d53 4d53 s 	call	A4A7B			; to the next sector (only when partial write was done)
4d56 4d56 d 3e01
4d56 4d56 s 	ld	a,1
4d58 4d58 d 32dff2
4d58 4d58 s 	ld	(YF2DF),a		; flag do increase sector
4d5b 4d5b d 3addf2
4d5b 4d5b s 	ld	a,(YF2DD)		; current relative sector in cluster
4d5e 4d5e d 2aecf2
4d5e 4d5e s 	ld	hl,(YF2EC)		; relative cluster
4d61 4d61 d ed4bfcf2
4d61 4d61 s 	ld	bc,(YF2FC)		; whole sectors
4d65 4d65 d c5
4d65 4d65 s A4D65:	push	bc
4d66 4d66 d cd484e
4d66 4d66 s 	call	A4E48			; calculate sequencial sectors
4d69 4d69 d c5
4d69 4d69 s 	push	bc
4d6a 4d6a d f5
4d6a 4d6a s 	push	af
4d6b 4d6b d 47
4d6b 4d6b s 	ld	b,a
4d6c 4d6c d 3805
4d6c 4d6c s 	jr	c,A4D73			; sectors writen does not include the sector in the datasector buffer
4d6e 4d6e d 3eff
4d6e 4d6e s 	ld	a,0FFH
4d70 4d70 d 3241f2
4d70 4d70 s 	ld	(YF241),a		; invalid datasector buffer
4d73 4d73 d cd5547
4d73 4d73 s A4D73:	call	A4755			; write datasectors with DOS error handling
4d76 4d76 d f1
4d76 4d76 s 	pop	af
4d77 4d77 d d1
4d77 4d77 s 	pop	de
4d78 4d78 d e1
4d78 4d78 s 	pop	hl
4d79 4d79 d 4f
4d79 4d79 s 	ld	c,a
4d7a 4d7a d af
4d7a 4d7a s 	xor	a
4d7b 4d7b d 47
4d7b 4d7b s 	ld	b,a
4d7c 4d7c d ed42
4d7c 4d7c s 	sbc	hl,bc			; whole sectors left ?
4d7e 4d7e d 280c
4d7e 4d7e s 	jr	z,A4D8C			; nop, go to partial end
4d80 4d80 d 4d
4d80 4d80 s 	ld	c,l
4d81 4d81 d 44
4d81 4d81 s 	ld	b,h
4d82 4d82 d 2aeaf2
4d82 4d82 s 	ld	hl,(YF2EA)
4d85 4d85 d 23
4d85 4d85 s 	inc	hl
4d86 4d86 d 22eaf2
4d86 4d86 s 	ld	(YF2EA),hl		; update relative cluster
4d89 4d89 d eb
4d89 4d89 s 	ex	de,hl
4d8a 4d8a d 18d9
4d8a 4d8a s 	jr	A4D65			; again
4d8c 4d8c s ;
4d8c 4d8c d cd9df2
4d8c 4d8c s A4D8C:	call	XF29D
4d8f 4d8f d cd6b4a
4d8f 4d8f s 	call	A4A6B			; last partial sector ?
4d92 4d92 d d4464a
4d92 4d92 s 	call	nc,A4A46		; partial end, handle partial sector write
4d95 4d95 d 2ae2f2
4d95 4d95 s 	ld	hl,(YF2E2)		; current transferadres
4d98 4d98 d ed5b3df2
4d98 4d98 s 	ld	de,(YF23D)		; transferadres
4d9c 4d9c d b7
4d9c 4d9c s 	or	a
4d9d 4d9d d ed52
4d9d 4d9d s 	sbc	hl,de
4d9f 4d9f d ed5bf4f2
4d9f 4d9f s 	ld	de,(YF2F4+0)
4da3 4da3 d 19
4da3 4da3 s 	add	hl,de
4da4 4da4 d ed5bf6f2
4da4 4da4 s 	ld	de,(YF2F4+2)
4da8 4da8 d 3001
4da8 4da8 s 	jr	nc,A4DAB
4daa 4daa d 13
4daa 4daa s 	inc	de
4dab 4dab d 22f4f2
4dab 4dab s A4DAB:	ld	(YF2F4+0),hl
4dae 4dae d ed53f6f2
4dae 4dae s 	ld	(YF2F4+2),de		; startbyte = startbyte + transfersize
4db2 4db2 d fd4e10
4db2 4db2 s 	ld	c,(iy+010H)
4db5 4db5 d fd4611
4db5 4db5 s 	ld	b,(iy+011H)
4db8 4db8 d b7
4db8 4db8 s 	or	a
4db9 4db9 d ed42
4db9 4db9 s 	sbc	hl,bc
4dbb 4dbb d fd4e12
4dbb 4dbb s 	ld	c,(iy+012H)
4dbe 4dbe d fd4613
4dbe 4dbe s 	ld	b,(iy+013H)
4dc1 4dc1 d eb
4dc1 4dc1 s 	ex	de,hl
4dc2 4dc2 d ed42
4dc2 4dc2 s 	sbc	hl,bc			; has file expanded ?
4dc4 4dc4 d 3810
4dc4 4dc4 s 	jr	c,A4DD6			; nop,
4dc6 4dc6 d fde5
4dc6 4dc6 s A4DC6:	push	iy
4dc8 4dc8 d e1
4dc8 4dc8 s 	pop	hl
4dc9 4dc9 d 111000
4dc9 4dc9 s 	ld	de,00010H
4dcc 4dcc d 19
4dcc 4dcc s 	add	hl,de
4dcd 4dcd d eb
4dcd 4dcd s 	ex	de,hl
4dce 4dce d 21f4f2
4dce 4dce s 	ld	hl,YF2F4		; filelength = endbyte
4dd1 4dd1 d 010400
4dd1 4dd1 s 	ld	bc,4
4dd4 4dd4 d edb0
4dd4 4dd4 s 	ldir
4dd6 4dd6 d ed4be8f2
4dd6 4dd6 s A4DD6:	ld	bc,(YF2E8)		; no. of records
4dda 4dda d c3224c
4dda 4dda s 	jp	A4C22
4ddd 4ddd s 
4ddd 4ddd s ; filesize adjust
4ddd 4ddd s 
4ddd 4ddd d 7c
4ddd 4ddd s A4DDD:	ld	a,h
4dde 4dde d b5
4dde 4dde s 	or	l
4ddf 4ddf d b2
4ddf 4ddf s 	or	d
4de0 4de0 d b3
4de0 4de0 s 	or	e			; startbyte zero ?
4de1 4de1 d 284f
4de1 4de1 s 	jr	z,A4E32			; yep, kill chain and quit
4de3 4de3 d 010100
4de3 4de3 s 	ld	bc,1
4de6 4de6 d ed42
4de6 4de6 s 	sbc	hl,bc
4de8 4de8 d eb
4de8 4de8 s 	ex	de,hl
4de9 4de9 d 0b
4de9 4de9 s 	dec	bc
4dea 4dea d ed42
4dea 4dea s 	sbc	hl,bc
4dec 4dec d 42
4dec 4dec s 	ld	b,d
4ded 4ded d 4b
4ded 4ded s 	ld	c,e			; filesize = startbyte-1
4dee 4dee d dd5e02
4dee 4dee s 	ld	e,(ix+002H)
4df1 4df1 d dd5603
4df1 4df1 s 	ld	d,(ix+003H)
4df4 4df4 d cd3249
4df4 4df4 s 	call	A4932			; / sectorsize
4df7 4df7 d dd7e07
4df7 4df7 s 	ld	a,(ix+007H)		; clustershift
4dfa 4dfa d 3d
4dfa 4dfa s A4DFA:	dec	a
4dfb 4dfb d 2806
4dfb 4dfb s 	jr	z,A4E03
4dfd 4dfd d cb38
4dfd 4dfd s 	srl	b
4dff 4dff d cb19
4dff 4dff s 	rr	c
4e01 4e01 d 18f7
4e01 4e01 s 	jr	A4DFA
4e03 4e03 s ;
4e03 4e03 d cd8949
4e03 4e03 s A4E03:	call	A4989			; get absolute cluster
4e06 4e06 d 78
4e06 4e06 s 	ld	a,b
4e07 4e07 d b1
4e07 4e07 s 	or	c			; found ?
4e08 4e08 d 281c
4e08 4e08 s 	jr	z,A4E26			; yep, this means chain must be shortend
4e0a 4e0a d cd124f
4e0a 4e0a s 	call	A4F12			; allocate chain
4e0d 4e0d d da974c
4e0d 4e0d s 	jp	c,A4C97			; failed, quit with nothing done
4e10 4e10 d 010000
4e10 4e10 s A4E10:	ld	bc,0
4e13 4e13 d ed43e8f2
4e13 4e13 s 	ld	(YF2E8),bc		; number of records = 0
4e17 4e17 d ed43eaf2
4e17 4e17 s 	ld	(YF2EA),bc		; current relative cluster = 0
4e1b 4e1b d fd6e1a
4e1b 4e1b s 	ld	l,(iy+01AH)
4e1e 4e1e d fd661b
4e1e 4e1e s 	ld	h,(iy+01BH)		; start cluster of file
4e21 4e21 d 22ecf2
4e21 4e21 s 	ld	(YF2EC),hl		; current cluster = start cluster of file
4e24 4e24 d 18a0
4e24 4e24 s 	jr	A4DC6
4e26 4e26 s ;
4e26 4e26 d 01ff0f
4e26 4e26 s A4E26:	ld	bc,00FFFH
4e29 4e29 d cd9e4f
4e29 4e29 s 	call	A4F9E			; mark end & release rest chain
4e2c 4e2c d 1b
4e2c 4e2c s A4E2C:	dec	de
4e2d 4e2d s 
4e2d 4e2d s ; VERSION 1.1 CHANGE
4e2d 4e2d s ;
4e2d 4e2d s ; CHANGED, BUGFIX
4e2d 4e2d s ; ld a,0FFH
4e2d 4e2d s ;
4e2d 4e2d s 
4e2d 4e2d d 3e01
4e2d 4e2d s 	ld	a,001H
4e2f 4e2f d 12
4e2f 4e2f s 	ld	(de),a			; flag FAT buffer changed
4e30 4e30 d 18de
4e30 4e30 s 	jr	A4E10
4e32 4e32 s ;
4e32 4e32 d fd6e1a
4e32 4e32 s A4E32:	ld	l,(iy+01AH)
4e35 4e35 d fd661b
4e35 4e35 s 	ld	h,(iy+01BH)
4e38 4e38 d 7c
4e38 4e38 s 	ld	a,h
4e39 4e39 d b5
4e39 4e39 s 	or	l			; file has start cluster ?
4e3a 4e3a d 28d4
4e3a 4e3a s 	jr	z,A4E10			; nop,
4e3c 4e3c d af
4e3c 4e3c s 	xor	a
4e3d 4e3d d fd771a
4e3d 4e3d s 	ld	(iy+01AH),a
4e40 4e40 d fd771b
4e40 4e40 s 	ld	(iy+01BH),a		; file has no start cluster (empty file)
4e43 4e43 d cd9b4f
4e43 4e43 s 	call	A4F9B			; release chain
4e46 4e46 d 18e4
4e46 4e46 s 	jr	A4E2C
4e48 4e48 s ;
4e48 4e48 d cda0f2
4e48 4e48 s A4E48:	call	XF2A0
4e4b 4e4b d 57
4e4b 4e4b s 	ld	d,a
4e4c 4e4c d e5
4e4c 4e4c s 	push	hl
4e4d 4e4d d 04
4e4d 4e4d s 	inc	b
4e4e 4e4e d 05
4e4e 4e4e s 	dec	b
4e4f 4e4f d 2802
4e4f 4e4f s 	jr	z,A4E53
4e51 4e51 d 0eff
4e51 4e51 s 	ld	c,0FFH
4e53 4e53 d 59
4e53 4e53 s A4E53:	ld	e,c
4e54 4e54 d d5
4e54 4e54 s 	push	de
4e55 4e55 d dd7e06
4e55 4e55 s 	ld	a,(ix+006H)		; clustermask
4e58 4e58 d 32ddf2
4e58 4e58 s 	ld	(YF2DD),a		; current relative sector in cluster
4e5b 4e5b d 3c
4e5b 4e5b s 	inc	a
4e5c 4e5c d 92
4e5c 4e5c s 	sub	d
4e5d 4e5d d 47
4e5d 4e5d s 	ld	b,a
4e5e 4e5e d 22ecf2
4e5e 4e5e s A4E5E:	ld	(YF2EC),hl
4e61 4e61 d e5
4e61 4e61 s 	push	hl
4e62 4e62 d cdf441
4e62 4e62 s 	call	A41F4			; get FAT entry content
4e65 4e65 d d1
4e65 4e65 s 	pop	de
4e66 4e66 d 79
4e66 4e66 s 	ld	a,c
4e67 4e67 d 90
4e67 4e67 s 	sub	b
4e68 4e68 d 4f
4e68 4e68 s 	ld	c,a
4e69 4e69 d 280d
4e69 4e69 s 	jr	z,A4E78
4e6b 4e6b d dd4606
4e6b 4e6b s 	ld	b,(ix+006H)		; clustermask
4e6e 4e6e d 385a
4e6e 4e6e s 	jr	c,A4ECA
4e70 4e70 d 04
4e70 4e70 s 	inc	b
4e71 4e71 d 13
4e71 4e71 s 	inc	de
4e72 4e72 d eb
4e72 4e72 s 	ex	de,hl
4e73 4e73 d ed52
4e73 4e73 s 	sbc	hl,de
4e75 4e75 d eb
4e75 4e75 s 	ex	de,hl
4e76 4e76 d 28e6
4e76 4e76 s 	jr	z,A4E5E
4e78 4e78 d d1
4e78 4e78 s A4E78:	pop	de
4e79 4e79 d e3
4e79 4e79 s 	ex	(sp),hl
4e7a 4e7a d e5
4e7a 4e7a s 	push	hl
4e7b 4e7b d d5
4e7b 4e7b s 	push	de
4e7c 4e7c d 7b
4e7c 4e7c s 	ld	a,e
4e7d 4e7d d 91
4e7d 4e7d s 	sub	c
4e7e 4e7e d 5f
4e7e 4e7e s 	ld	e,a
4e7f 4e7f d 1600
4e7f 4e7f s 	ld	d,000H
4e81 4e81 d dd4e02
4e81 4e81 s 	ld	c,(ix+002H)
4e84 4e84 d dd4603
4e84 4e84 s 	ld	b,(ix+003H)		; sectorsize
4e87 4e87 d cd1649
4e87 4e87 s 	call	A4916			; multiply
4e8a 4e8a d f1
4e8a 4e8a s 	pop	af
4e8b 4e8b d 2ae2f2
4e8b 4e8b s 	ld	hl,(YF2E2)
4e8e 4e8e d e5
4e8e 4e8e s 	push	hl
4e8f 4e8f d 09
4e8f 4e8f s 	add	hl,bc
4e90 4e90 d 22e2f2
4e90 4e90 s 	ld	(YF2E2),hl		; update current transferadres
4e93 4e93 d c1
4e93 4e93 s 	pop	bc
4e94 4e94 d e1
4e94 4e94 s 	pop	hl
4e95 4e95 d c5
4e95 4e95 s 	push	bc
4e96 4e96 d d5
4e96 4e96 s 	push	de
4e97 4e97 d eb
4e97 4e97 s 	ex	de,hl
4e98 4e98 d 2aecf2
4e98 4e98 s 	ld	hl,(YF2EC)
4e9b 4e9b d ed52
4e9b 4e9b s 	sbc	hl,de
4e9d 4e9d d ed4beaf2
4e9d 4e9d s 	ld	bc,(YF2EA)
4ea1 4ea1 d 09
4ea1 4ea1 s 	add	hl,bc
4ea2 4ea2 d 22eaf2
4ea2 4ea2 s 	ld	(YF2EA),hl
4ea5 4ea5 d eb
4ea5 4ea5 s 	ex	de,hl
4ea6 4ea6 d cddb4e
4ea6 4ea6 s 	call	A4EDB			; get sectornumber of cluster
4ea9 4ea9 d eb
4ea9 4ea9 s 	ex	de,hl
4eaa 4eaa d c1
4eaa 4eaa s 	pop	bc
4eab 4eab d 3a41f2
4eab 4eab s 	ld	a,(YF241)
4eae 4eae d ddbe00
4eae 4eae s 	cp	(ix+000H)		; driveid
4eb1 4eb1 d 79
4eb1 4eb1 s 	ld	a,c
4eb2 4eb2 d 37
4eb2 4eb2 s 	scf
4eb3 4eb3 d 2012
4eb3 4eb3 s 	jr	nz,A4EC7
4eb5 4eb5 d 2a3ff2
4eb5 4eb5 s 	ld	hl,(YF23F)		; sectornumber of datasector buffer
4eb8 4eb8 d b7
4eb8 4eb8 s 	or	a
4eb9 4eb9 d ed52
4eb9 4eb9 s 	sbc	hl,de
4ebb 4ebb d 380a
4ebb 4ebb s 	jr	c,A4EC7
4ebd 4ebd d 60
4ebd 4ebd s 	ld	h,b
4ebe 4ebe d 69
4ebe 4ebe s 	ld	l,c
4ebf 4ebf d 19
4ebf 4ebf s 	add	hl,de
4ec0 4ec0 d 2b
4ec0 4ec0 s 	dec	hl
4ec1 4ec1 d ed4b3ff2
4ec1 4ec1 s 	ld	bc,(YF23F)		; sectornumber of datasector buffer
4ec5 4ec5 d ed42
4ec5 4ec5 s 	sbc	hl,bc
4ec7 4ec7 d e1
4ec7 4ec7 s A4EC7:	pop	hl
4ec8 4ec8 d c1
4ec8 4ec8 s 	pop	bc
4ec9 4ec9 d c9
4ec9 4ec9 s 	ret
4eca 4eca s ;
4eca 4eca d 80
4eca 4eca s A4ECA:	add	a,b
4ecb 4ecb d 32ddf2
4ecb 4ecb s 	ld	(YF2DD),a		; current relative sector in cluster
4ece 4ece d 0e00
4ece 4ece s 	ld	c,000H
4ed0 4ed0 d 18a6
4ed0 4ed0 s 	jr	A4E78
4ed2 4ed2 s 
4ed2 4ed2 s ;	  Subroutine get decoded characterpair (not needed)
4ed2 4ed2 s ;	     Inputs  
4ed2 4ed2 s ;	     Outputs ________________________ 
4ed2 4ed2 s 
4ed2 4ed2 d cdfa41
4ed2 4ed2 s A4ED2:	call	A41FA
4ed5 4ed5 d 7d
4ed5 4ed5 s 	ld	a,l
4ed6 4ed6 d 29
4ed6 4ed6 s 	add	hl,hl
4ed7 4ed7 d 29
4ed7 4ed7 s 	add	hl,hl			; second char in H
4ed8 4ed8 d e63f
4ed8 4ed8 s 	and	03FH			; first char in A
4eda 4eda d c9
4eda 4eda s 	ret
4edb 4edb s 
4edb 4edb s ; clusternumber to sectornumber
4edb 4edb s 
4edb 4edb d cda3f2
4edb 4edb s A4EDB:	call	XF2A3
4ede 4ede d c5
4ede 4ede s 	push	bc
4edf 4edf d dd4607
4edf 4edf s 	ld	b,(ix+007H)		; clustershift
4ee2 4ee2 d 2b
4ee2 4ee2 s 	dec	hl
4ee3 4ee3 d 2b
4ee3 4ee3 s 	dec	hl
4ee4 4ee4 d 05
4ee4 4ee4 s 	dec	b
4ee5 4ee5 d 2806
4ee5 4ee5 s 	jr	z,A4EED
4ee7 4ee7 d cb25
4ee7 4ee7 s A4EE7:	sla	l
4ee9 4ee9 d cb14
4ee9 4ee9 s 	rl	h
4eeb 4eeb d 10fa
4eeb 4eeb s 	djnz	A4EE7
4eed 4eed d b5
4eed 4eed s A4EED:	or	l
4eee 4eee d 6f
4eee 4eee s 	ld	l,a
4eef 4eef d dd4e0c
4eef 4eef s 	ld	c,(ix+00CH)
4ef2 4ef2 d dd460d
4ef2 4ef2 s 	ld	b,(ix+00DH)
4ef5 4ef5 d 09
4ef5 4ef5 s 	add	hl,bc			; + first datasector
4ef6 4ef6 d c1
4ef6 4ef6 s 	pop	bc
4ef7 4ef7 d c9
4ef7 4ef7 s 	ret
4ef8 4ef8 s ;
4ef8 4ef8 d d5
4ef8 4ef8 s A4EF8:	push	de
4ef9 4ef9 d fde1
4ef9 4ef9 s 	pop	iy
4efb 4efb d fd4e20
4efb 4efb s 	ld	c,(iy+020H)		; CR (current record)
4efe 4efe d fd460c
4efe 4efe s 	ld	b,(iy+00CH)		; EX (extent)
4f01 4f01 d fd5e0e
4f01 4f01 s 	ld	e,(iy+00EH)		; S2
4f04 4f04 d 1600
4f04 4f04 s 	ld	d,000H
4f06 4f06 d cb21
4f06 4f06 s 	sla	c
4f08 4f08 d cb3b
4f08 4f08 s 	srl	e
4f0a 4f0a d cb18
4f0a 4f0a s 	rr	b
4f0c 4f0c d cb19
4f0c 4f0c s 	rr	c			; debc = recordnumber
4f0e 4f0e d 210100
4f0e 4f0e s 	ld	hl,00001H		; 1 record
4f11 4f11 d c9
4f11 4f11 s 	ret
4f12 4f12 s 
4f12 4f12 s ; allocate chain
4f12 4f12 s 
4f12 4f12 d cda6f2
4f12 4f12 s A4F12:	call	XF2A6
4f15 4f15 d dd5e13
4f15 4f15 s 	ld	e,(ix+013H)
4f18 4f18 d dd5614
4f18 4f18 s 	ld	d,(ix+014H)
4f1b 4f1b d eb
4f1b 4f1b s 	ex	de,hl			; pointer to FAT buffer of drive
4f1c 4f1c d 7e
4f1c 4f1c s 	ld	a,(hl)
4f1d 4f1d d 23
4f1d 4f1d s 	inc	hl
4f1e 4f1e d 66
4f1e 4f1e s 	ld	h,(hl)
4f1f 4f1f d 6f
4f1f 4f1f s 	ld	l,a			; pointer to FAT
4f20 4f20 d e5
4f20 4f20 s 	push	hl
4f21 4f21 d eb
4f21 4f21 s 	ex	de,hl
4f22 4f22 d dd5e0e
4f22 4f22 s 	ld	e,(ix+00EH)
4f25 4f25 d dd560f
4f25 4f25 s 	ld	d,(ix+00FH)		; Max cluster
4f28 4f28 d ed5302f3
4f28 4f28 s 	ld	(YF302),de		; store
4f2c 4f2c d e5
4f2c 4f2c s 	push	hl
4f2d 4f2d d c5
4f2d 4f2d s A4F2D:	push	bc			; clusters to allocate
4f2e 4f2e d e5
4f2e 4f2e s 	push	hl			; start cluster
4f2f 4f2f d 54
4f2f 4f2f s 	ld	d,h
4f30 4f30 d 5d
4f30 4f30 s 	ld	e,l
4f31 4f31 d d5
4f31 4f31 s A4F31:	push	de
4f32 4f32 d eb
4f32 4f32 s 	ex	de,hl
4f33 4f33 d 2a02f3
4f33 4f33 s 	ld	hl,(YF302)
4f36 4f36 d 2b
4f36 4f36 s 	dec	hl
4f37 4f37 d b7
4f37 4f37 s 	or	a
4f38 4f38 d ed52
4f38 4f38 s 	sbc	hl,de
4f3a 4f3a d eb
4f3a 4f3a s 	ex	de,hl			; last cluster on disk ?
4f3b 4f3b d d1
4f3b 4f3b s 	pop	de
4f3c 4f3c d 3010
4f3c 4f3c s 	jr	nc,A4F4E		; nop, go up
4f3e 4f3e d 7b
4f3e 4f3e s 	ld	a,e
4f3f 4f3f d b2
4f3f 4f3f s 	or	d			; search below finished ?
4f40 4f40 d 2014
4f40 4f40 s 	jr	nz,A4F56		; nop, go below
4f42 4f42 d e1
4f42 4f42 s 	pop	hl
4f43 4f43 d e1
4f43 4f43 s 	pop	hl
4f44 4f44 d e1
4f44 4f44 s 	pop	hl
4f45 4f45 d 01ff0f
4f45 4f45 s 	ld	bc,00FFFH
4f48 4f48 d cd9e4f
4f48 4f48 s 	call	A4F9E			; mark end & release rest chain
4f4b 4f4b d 37
4f4b 4f4b s 	scf
4f4c 4f4c d 1846
4f4c 4f4c s 	jr	A4F94
4f4e 4f4e s ;
4f4e 4f4e d 23
4f4e 4f4e s A4F4E:	inc	hl
4f4f 4f4f d cd5e4f
4f4f 4f4f s 	call	A4F5E			; try to allocate
4f52 4f52 d 7b
4f52 4f52 s 	ld	a,e			; nop not free !
4f53 4f53 d b2
4f53 4f53 s 	or	d			; search below finished ?
4f54 4f54 d 28db
4f54 4f54 s 	jr	z,A4F31			; try again (up)
4f56 4f56 d 1b
4f56 4f56 s A4F56:	dec	de
4f57 4f57 d eb
4f57 4f57 s 	ex	de,hl
4f58 4f58 d cd5e4f
4f58 4f58 s 	call	A4F5E			; try to allocate
4f5b 4f5b d eb
4f5b 4f5b s 	ex	de,hl			; nop not free !
4f5c 4f5c d 18d3
4f5c 4f5c s 	jr	A4F31			; try again
4f5e 4f5e s ;
4f5e 4f5e d e5
4f5e 4f5e s A4F5E:	push	hl
4f5f 4f5f d d5
4f5f 4f5f s 	push	de
4f60 4f60 d cdf441
4f60 4f60 s 	call	A41F4			; cluster free ?
4f63 4f63 d d1
4f63 4f63 s 	pop	de
4f64 4f64 d e1
4f64 4f64 s 	pop	hl
4f65 4f65 d c0
4f65 4f65 s 	ret	nz			; nop, no alloc
4f66 4f66 d c1
4f66 4f66 s 	pop	bc
4f67 4f67 d 4d
4f67 4f67 s 	ld	c,l
4f68 4f68 d 44
4f68 4f68 s 	ld	b,h
4f69 4f69 d e3
4f69 4f69 s 	ex	(sp),hl
4f6a 4f6a d dd5e13
4f6a 4f6a s 	ld	e,(ix+013H)
4f6d 4f6d d dd5614
4f6d 4f6d s 	ld	d,(ix+014H)		; pointer to FAT buffer of drive
4f70 4f70 d cd2142
4f70 4f70 s 	call	A4221			; set FAT entry content
4f73 4f73 d e1
4f73 4f73 s 	pop	hl
4f74 4f74 d c1
4f74 4f74 s 	pop	bc
4f75 4f75 d 0b
4f75 4f75 s 	dec	bc
4f76 4f76 d 78
4f76 4f76 s 	ld	a,b
4f77 4f77 d b1
4f77 4f77 s 	or	c
4f78 4f78 d 20b3
4f78 4f78 s 	jr	nz,A4F2D
4f7a 4f7a d 01ff0f
4f7a 4f7a s 	ld	bc,00FFFH		; chain endmarker
4f7d 4f7d d cd2142
4f7d 4f7d s 	call	A4221			; set FAT entry content
4f80 4f80 d 1b
4f80 4f80 s 	dec	de
4f81 4f81 d 3e01
4f81 4f81 s 	ld	a,1
4f83 4f83 d 12
4f83 4f83 s 	ld	(de),a			; FAT changed
4f84 4f84 d e1
4f84 4f84 s 	pop	hl
4f85 4f85 d e5
4f85 4f85 s 	push	hl
4f86 4f86 d cdf441
4f86 4f86 s 	call	A41F4			; get FAT entry content
4f89 4f89 d c1
4f89 4f89 s 	pop	bc
4f8a 4f8a d 79
4f8a 4f8a s 	ld	a,c
4f8b 4f8b d b0
4f8b 4f8b s 	or	b
4f8c 4f8c d 2006
4f8c 4f8c s 	jr	nz,A4F94
4f8e 4f8e d fd751a
4f8e 4f8e s 	ld	(iy+01AH),l
4f91 4f91 d fd741b
4f91 4f91 s 	ld	(iy+01BH),h		; start cluster of file
4f94 4f94 d eb
4f94 4f94 s A4F94:	ex	de,hl
4f95 4f95 d c1
4f95 4f95 s 	pop	bc
4f96 4f96 d 71
4f96 4f96 s 	ld	(hl),c
4f97 4f97 d 23
4f97 4f97 s 	inc	hl
4f98 4f98 d 70
4f98 4f98 s 	ld	(hl),b
4f99 4f99 d eb
4f99 4f99 s 	ex	de,hl
4f9a 4f9a d c9
4f9a 4f9a s 	ret
4f9b 4f9b s 
4f9b 4f9b s ; release FAT chain
4f9b 4f9b s 
4f9b 4f9b d 010000
4f9b 4f9b s A4F9B:	ld	bc,00000H
4f9e 4f9e d cda9f2
4f9e 4f9e s A4F9E:	call	XF2A9
4fa1 4fa1 d e5
4fa1 4fa1 s 	push	hl
4fa2 4fa2 d cdf441
4fa2 4fa2 s 	call	A41F4			; get FAT entry content
4fa5 4fa5 d e3
4fa5 4fa5 s 	ex	(sp),hl
4fa6 4fa6 d cd2142
4fa6 4fa6 s 	call	A4221			; set FAT entry content
4fa9 4fa9 d e1
4fa9 4fa9 s 	pop	hl
4faa 4faa d 7c
4faa 4faa s 	ld	a,h
4fab 4fab d b5
4fab 4fab s 	or	l
4fac 4fac d c8
4fac 4fac s 	ret	z
4fad 4fad d 7c
4fad 4fad s 	ld	a,h
4fae 4fae d fe0f
4fae 4fae s 	cp	00FH
4fb0 4fb0 d 38e9
4fb0 4fb0 s 	jr	c,A4F9B
4fb2 4fb2 d 7d
4fb2 4fb2 s 	ld	a,l
4fb3 4fb3 d fef8
4fb3 4fb3 s 	cp	0F8H
4fb5 4fb5 d 38e4
4fb5 4fb5 s 	jr	c,A4F9B 		; not end of chain, release
4fb7 4fb7 d c9
4fb7 4fb7 s 	ret
4fb8 4fb8 s 
4fb8 4fb8 s ;	  Subroutine BDOS 11 (search for first)
4fb8 4fb8 s ;	     Inputs  
4fb8 4fb8 s ;	     Outputs ________________________ 
4fb8 4fb8 s 
4fb8 4fb8 d cda542
4fb8 4fb8 s A4FB8:	call	A42A5			; validate FCB, clear S2 and find direntry
4fbb 4fbb d 3843
4fbb 4fbb s A4FBB:	jr	c,A5000			; error, quit
4fbd 4fbd d 3ab8f2
4fbd 4fbd s 	ld	a,(YF2B8)
4fc0 4fc0 d 2802
4fc0 4fc0 s 	jr	z,A4FC4			; file, save direntry number for search next
4fc2 4fc2 d 3eff
4fc2 4fc2 s 	ld	a,0FFH			; device, flag search next invalid
4fc4 4fc4 d 320bf3
4fc4 4fc4 s A4FC4:	ld	(YF30B),a
4fc7 4fc7 d dd2209f3
4fc7 4fc7 s 	ld	(YF309),ix		; save pointer to DPB
4fcb 4fcb d ed5b3df2
4fcb 4fcb s 	ld	de,(YF23D)		; transferadres
4fcf 4fcf d 3ae1f2
4fcf 4fcf s 	ld	a,(YF2E1)		; current driveid
4fd2 4fd2 d 3c
4fd2 4fd2 s 	inc	a
4fd3 4fd3 d 12
4fd3 4fd3 s 	ld	(de),a
4fd4 4fd4 d 13
4fd4 4fd4 s 	inc	de
4fd5 4fd5 d 7e
4fd5 4fd5 s 	ld	a,(hl)
4fd6 4fd6 d fe05
4fd6 4fd6 s 	cp	005H
4fd8 4fd8 d 2002
4fd8 4fd8 s 	jr	nz,A4FDC
4fda 4fda d 36e5
4fda 4fda s 	ld	(hl),0E5H
4fdc 4fdc d 012000
4fdc 4fdc s A4FDC:	ld	bc,00020H
4fdf 4fdf d cdd9f1
4fdf 4fdf s 	call	XF1D9			; transfer direntry to DOS memory
4fe2 4fe2 d cd3944
4fe2 4fe2 s 	call	A4439			; get max record and extent
4fe5 4fe5 d 3a0cf3
4fe5 4fe5 s 	ld	a,(YF30C)
4fe8 4fe8 d b8
4fe8 4fe8 s 	cp	b			; orginal FCB EX byte same as max extent ?
4fe9 4fe9 d 2804
4fe9 4fe9 s 	jr	z,A4FEF			; same, RC = max record
4feb 4feb d 3013
4feb 4feb s 	jr	nc,A5000		; bigger, quit with error
4fed 4fed d 0e80
4fed 4fed s 	ld	c,080H			; smaller, RC = 128 (means extend is full)
4fef 4fef d 2a3df2
4fef 4fef s A4FEF:	ld	hl,(YF23D)		; transferadres
4ff2 4ff2 d 110c00
4ff2 4ff2 s 	ld	de,0000CH
4ff5 4ff5 d 19
4ff5 4ff5 s 	add	hl,de
4ff6 4ff6 d 46
4ff6 4ff6 s 	ld	b,(hl)			; MS-DOS fileattribute
4ff7 4ff7 d 77
4ff7 4ff7 s 	ld	(hl),a			; EX = orginal FCB EX byte (CP/M: requested extent)
4ff8 4ff8 d 23
4ff8 4ff8 s 	inc	hl
4ff9 4ff9 d 70
4ff9 4ff9 s 	ld	(hl),b			; S1 = MS-DOS fileattribute (CP/M: reserved)
4ffa 4ffa d 23
4ffa 4ffa s 	inc	hl
4ffb 4ffb d 72
4ffb 4ffb s 	ld	(hl),d			; S2 = 0 (CP/M: extent high byte)
4ffc 4ffc d 23
4ffc 4ffc s 	inc	hl
4ffd 4ffd d 71
4ffd 4ffd s 	ld	(hl),c			; RC = (CP/M: recordcount)
4ffe 4ffe d af
4ffe 4ffe s 	xor	a			; CP/M direntry 0, no error
4fff 4fff d c9
4fff 4fff s 	ret
5000 5000 s ;
5000 5000 d 3eff
5000 5000 s A5000:	ld	a,0FFH
5002 5002 d 320bf3
5002 5002 s 	ld	(YF30B),a
5005 5005 d c9
5005 5005 s 	ret
5006 5006 s 
5006 5006 s ;	  Subroutine BDOS 12 (search for next)
5006 5006 s ;	     Inputs  
5006 5006 s ;	     Outputs ________________________ 
5006 5006 s 
5006 5006 d cd0e44
5006 5006 s A5006:	call	A440E			; validate FCB drive and filename
5009 5009 d 38f5
5009 5009 s 	jr	c,A5000			; invalid,
500b 500b d 3a0bf3
500b 500b s 	ld	a,(YF30B)		; saved direntrynumber of last search first
500e 500e d feff
500e 500e s 	cp	0FFH
5010 5010 d 28ee
5010 5010 s 	jr	z,A5000			; flag search next invalid, quit with error
5012 5012 d 32b8f2
5012 5012 s 	ld	(YF2B8),a
5015 5015 d dd2a09f3
5015 5015 s 	ld	ix,(YF309)		; saved pointer to DPB
5019 5019 d cdbc42
5019 5019 s 	call	A42BC			; find next directoryentry
501c 501c d 189d
501c 501c s 	jr	A4FBB			; finish
501e 501e s 
501e 501e s ;	  Subroutine BDOS 23 (compute filesize)
501e 501e s ;	     Inputs  
501e 501e s ;	     Outputs ________________________ 
501e 501e s 
501e 501e d cda542
501e 501e s A501E:	call	A42A5			; validate FCB, clear S2 and find direntry
5021 5021 d 3eff
5021 5021 s 	ld	a,0FFH
5023 5023 d d8
5023 5023 s 	ret	c
5024 5024 d d5
5024 5024 s 	push	de
5025 5025 d dde1
5025 5025 s 	pop	ix
5027 5027 d fd7e1c
5027 5027 s 	ld	a,(iy+01CH)
502a 502a d fd4e1d
502a 502a s 	ld	c,(iy+01DH)
502d 502d d fd461e
502d 502d s 	ld	b,(iy+01EH)
5030 5030 d fd5e1f
5030 5030 s 	ld	e,(iy+01FH)
5033 5033 d 87
5033 5033 s 	add	a,a
5034 5034 d cb11
5034 5034 s 	rl	c
5036 5036 d cb10
5036 5036 s 	rl	b
5038 5038 d cb13
5038 5038 s 	rl	e
503a 503a d b7
503a 503a s 	or	a
503b 503b d 2806
503b 503b s 	jr	z,A5043
503d 503d d 03
503d 503d s 	inc	bc
503e 503e d 78
503e 503e s 	ld	a,b
503f 503f d b1
503f 503f s 	or	c
5040 5040 d 2001
5040 5040 s 	jr	nz,A5043
5042 5042 d 1c
5042 5042 s 	inc	e
5043 5043 d dd7121
5043 5043 s A5043:	ld	(ix+021H),c
5046 5046 d dd7022
5046 5046 s 	ld	(ix+022H),b
5049 5049 d dd7323
5049 5049 s 	ld	(ix+023H),e
504c 504c d af
504c 504c s 	xor	a
504d 504d d c9
504d 504d s 	ret
504e 504e s 
504e 504e s ;	  Subroutine BDOS 18 (return bitmap of logged-in drives)
504e 504e s ;	     Inputs  
504e 504e s ;	     Outputs ________________________ 
504e 504e s 
504e 504e d 3a47f3
504e 504e s A504E:	ld	a,(YF347)
5051 5051 d 47
5051 5051 s 	ld	b,a
5052 5052 d af
5052 5052 s 	xor	a
5053 5053 d 37
5053 5053 s A5053:	scf
5054 5054 d 17
5054 5054 s 	rla
5055 5055 d 10fc
5055 5055 s 	djnz	A5053
5057 5057 d c9
5057 5057 s 	ret
5058 5058 s 
5058 5058 s ;	  Subroutine BDOS 1A (set DMA address)
5058 5058 s ;	     Inputs  
5058 5058 s ;	     Outputs ________________________ 
5058 5058 s 
5058 5058 d ed533df2
5058 5058 s A5058:	ld	(YF23D),de		; set transferadres
505c 505c d c9
505c 505c s 	ret
505d 505d s 
505d 505d s ;	  Subroutine BDOS 1B
505d 505d s ;	     Inputs  
505d 505d s ;	     Outputs ________________________ 
505d 505d s 
505d 505d d af
505d 505d s A505D:	xor	a
505e 505e d 3206f3
505e 505e s 	ld	(YF306),a		; no CP/M call
5061 5061 d 7b
5061 5061 s 	ld	a,e
5062 5062 d cd2744
5062 5062 s 	call	A4427			; validate fcb driveid
5065 5065 d 3eff
5065 5065 s 	ld	a,0FFH
5067 5067 d d8
5067 5067 s 	ret	c
5068 5068 d cddb44
5068 5068 s 	call	A44DB			; get latest FAT
506b 506b d dd5e13
506b 506b s 	ld	e,(ix+013H)
506e 506e d dd5614
506e 506e s 	ld	d,(ix+014H)
5071 5071 d d5
5071 5071 s 	push	de
5072 5072 d fde1
5072 5072 s 	pop	iy			; pointer to FAT buffer of drive
5074 5074 d 210200
5074 5074 s 	ld	hl,2
5077 5077 d 44
5077 5077 s 	ld	b,h
5078 5078 d 4c
5078 5078 s 	ld	c,h
5079 5079 d dd5e0e
5079 5079 s 	ld	e,(ix+00EH)
507c 507c d dd560f
507c 507c s 	ld	d,(ix+00FH)
507f 507f d 1b
507f 507f s 	dec	de			; number of clusters on disk
5080 5080 d d5
5080 5080 s 	push	de
5081 5081 d d5
5081 5081 s A5081:	push	de
5082 5082 d e5
5082 5082 s 	push	hl
5083 5083 d cdf441
5083 5083 s 	call	A41F4			; get FAT entry content
5086 5086 d e1
5086 5086 s 	pop	hl
5087 5087 d d1
5087 5087 s 	pop	de
5088 5088 d 2001
5088 5088 s 	jr	nz,A508B
508a 508a d 03
508a 508a s 	inc	bc
508b 508b d 23
508b 508b s A508B:	inc	hl
508c 508c d 1b
508c 508c s 	dec	de
508d 508d d 7b
508d 508d s 	ld	a,e
508e 508e d b2
508e 508e s 	or	d
508f 508f d 20f0
508f 508f s 	jr	nz,A5081
5091 5091 d 60
5091 5091 s 	ld	h,b
5092 5092 d 69
5092 5092 s 	ld	l,c
5093 5093 d d1
5093 5093 s 	pop	de
5094 5094 d dd7e06
5094 5094 s 	ld	a,(ix+006H)
5097 5097 d 3c
5097 5097 s 	inc	a			; number of sectors per cluster
5098 5098 d dd4e02
5098 5098 s 	ld	c,(ix+002H)
509b 509b d dd4603
509b 509b s 	ld	b,(ix+003H)		; sectorsize
509e 509e d c9
509e 509e s 	ret
509f 509f s 
509f 509f s ;	  Subroutine BDOS 0D (reset discs)
509f 509f s ;	     Inputs  
509f 509f s ;	     Outputs ________________________ 
509f 509f s 
509f 509f d 218000
509f 509f s A509F:	ld	hl,00080H
50a2 50a2 d 223df2
50a2 50a2 s 	ld	(YF23D),hl		; default transferadres
50a5 50a5 d af
50a5 50a5 s 	xor	a
50a6 50a6 d 3247f2
50a6 50a6 s 	ld	(YF247),a		; default driveid 0 (A:)
50a9 50a9 d cd2d47
50a9 50a9 s 	call	A472D			; write datasector buffer when needed
50ac 50ac d 2155f3
50ac 50ac s 	ld	hl,YF355
50af 50af d 3a47f3
50af 50af s 	ld	a,(YF347)		; all drives
50b2 50b2 d 5e
50b2 50b2 s A50B2:	ld	e,(hl)
50b3 50b3 d 23
50b3 50b3 s 	inc	hl
50b4 50b4 d 56
50b4 50b4 s 	ld	d,(hl)			; pointer to DPB
50b5 50b5 d 23
50b5 50b5 s 	inc	hl
50b6 50b6 d e5
50b6 50b6 s 	push	hl
50b7 50b7 d f5
50b7 50b7 s 	push	af
50b8 50b8 d d5
50b8 50b8 s 	push	de
50b9 50b9 d dde1
50b9 50b9 s 	pop	ix
50bb 50bb d cdc445
50bb 50bb s 	call	A45C4			; write FAT buffer when needed
50be 50be d f1
50be 50be s 	pop	af
50bf 50bf d e1
50bf 50bf s 	pop	hl
50c0 50c0 d 3d
50c0 50c0 s 	dec	a
50c1 50c1 d 20ef
50c1 50c1 s 	jr	nz,A50B2		; next drive
50c3 50c3 d c9
50c3 50c3 s 	ret
50c4 50c4 s 
50c4 50c4 s ;	  Subroutine BDOS 25 (return current drive)
50c4 50c4 s ;	     Inputs  
50c4 50c4 s ;	     Outputs ________________________ 
50c4 50c4 s 
50c4 50c4 d 3a47f2
50c4 50c4 s A50C4:	ld	a,(YF247)
50c7 50c7 d c9
50c7 50c7 s 	ret
50c8 50c8 s 
50c8 50c8 s ;	  Subroutine BDOS 34 (update random access pointer)
50c8 50c8 s ;	     Inputs  
50c8 50c8 s ;	     Outputs ________________________ 
50c8 50c8 s 
50c8 50c8 d cdf84e
50c8 50c8 s A50C8:	call	A4EF8			; get recordnumber from CR,EX and S2 field
50cb 50cb d fd7521
50cb 50cb s 	ld	(iy+021H),l
50ce 50ce d fd7422
50ce 50ce s 	ld	(iy+022H),h
50d1 50d1 d fd7323
50d1 50d1 s 	ld	(iy+023H),e
50d4 50d4 d c9
50d4 50d4 s 	ret
50d5 50d5 s ;	  Subroutine BDOS 0E (select disc)
50d5 50d5 s ;	     Inputs  
50d5 50d5 s ;	     Outputs ________________________ 
50d5 50d5 s 
50d5 50d5 d 3a47f3
50d5 50d5 s A50D5:	ld	a,(YF347)
50d8 50d8 d bb
50d8 50d8 s 	cp	e
50d9 50d9 d d8
50d9 50d9 s 	ret	c
50da 50da d c8
50da 50da s 	ret	z
50db 50db d 2147f2
50db 50db s 	ld	hl,YF247
50de 50de d 73
50de 50de s 	ld	(hl),e
50df 50df d c9
50df 50df s 	ret
50e0 50e0 s 
50e0 50e0 s ;	  Subroutine BDOS 0A (buffered console input)
50e0 50e0 s ;	     Inputs  
50e0 50e0 s ;	     Outputs ________________________ 
50e0 50e0 s 
50e0 50e0 d d5
50e0 50e0 s A50E0:	push	de
50e1 50e1 d 3a37f2
50e1 50e1 s 	ld	a,(YF237)
50e4 50e4 d 3238f2
50e4 50e4 s 	ld	(YF238),a		; save current console columnpos to record start of inputline
50e7 50e7 d af
50e7 50e7 s 	xor	a
50e8 50e8 d 3239f2
50e8 50e8 s 	ld	(YF239),a		; not in insertmode
50eb 50eb d 62
50eb 50eb s 	ld	h,d
50ec 50ec d 6b
50ec 50ec s 	ld	l,e
50ed 50ed d 47
50ed 50ed s 	ld	b,a
50ee 50ee d 4e
50ee 50ee s 	ld	c,(hl)			; size of buffer
50ef 50ef d 23
50ef 50ef s 	inc	hl
50f0 50f0 d 57
50f0 50f0 s 	ld	d,a
50f1 50f1 d 5e
50f1 50f1 s 	ld	e,(hl)			; length of line already in buffer
50f2 50f2 d 23
50f2 50f2 s 	inc	hl
50f3 50f3 d dd2159f4
50f3 50f3 s 	ld	ix,KBUF+58
50f7 50f7 d 7b
50f7 50f7 s 	ld	a,e
50f8 50f8 d b9
50f8 50f8 s 	cp	c			; is lengthbyte valid ?
50f9 50f9 s 
50f9 50f9 s ; VERSION 1.1 CHANGE
50f9 50f9 s ;
50f9 50f9 s ; CHANGED, BUGFIX
50f9 50f9 s ; jr nc,A5103
50f9 50f9 s ;
50f9 50f9 s 
50f9 50f9 d 3006
50f9 50f9 s 	jr	nc,A5101		; equal, use the line in buffer as basis otherwise use empty line as basis
50fb 50fb d e5
50fb 50fb s 	push	hl			; length smaller than size of buffer
50fc 50fc d 19
50fc 50fc s 	add	hl,de
50fd 50fd d 7e
50fd 50fd s 	ld	a,(hl)
50fe 50fe d e1
50fe 50fe s 	pop	hl
50ff 50ff d fe0d
50ff 50ff s 	cp	00DH			; then line must be terminated by a CR
5101 5101 d 2801
5101 5101 s A5101:	jr	z,A5104			; it is, use the line in buffer as basis
5103 5103 d 5a
5103 5103 s A5103:	ld	e,d			; use empty line as basis
5104 5104 s 
5104 5104 s ; linputinput headloop, also lineinput CTRL-F
5104 5104 s 
5104 5104 d cdacf2
5104 5104 s A5104:	call	XF2AC			; hook
5107 5107 d cd4e54
5107 5107 s 	call	A544E			; BDOS 8 (direct input)
510a 510a d e5
510a 510a s A510A:	push	hl
510b 510b d c5
510b 510b s 	push	bc
510c 510c d 217453
510c 510c s 	ld	hl,T5374
510f 510f d 011100
510f 510f s 	ld	bc,NKEYNT		; number of keyentries
5112 5112 d edb1
5112 5112 s 	cpir
5114 5114 d 09
5114 5114 s 	add	hl,bc
5115 5115 d 09
5115 5115 s 	add	hl,bc
5116 5116 d 09
5116 5116 s 	add	hl,bc
5117 5117 d 4e
5117 5117 s 	ld	c,(hl)
5118 5118 d 23
5118 5118 s 	inc	hl
5119 5119 d 66
5119 5119 s 	ld	h,(hl)
511a 511a d 69
511a 511a s 	ld	l,c
511b 511b d c1
511b 511b s 	pop	bc
511c 511c d e3
511c 511c s 	ex	(sp),hl
511d 511d d c9
511d 511d s 	ret
511e 511e s 
511e 511e s ; lineinput CTRL-A, MSX graphic header
511e 511e s 
511e 511e d cd4e54
511e 511e s A511E:	call	A544E			; BDOS 8 (direct input)
5121 5121 d fe40
5121 5121 s 	cp	040H
5123 5123 d 38e5
5123 5123 s 	jr	c,A510A
5125 5125 d fe60
5125 5125 s 	cp	060H
5127 5127 d 30e1
5127 5127 s 	jr	nc,A510A
5129 5129 d f5
5129 5129 s 	push	af
512a 512a d 78
512a 512a s 	ld	a,b
512b 512b d 3c
512b 512b s 	inc	a
512c 512c d b9
512c 512c s 	cp	c
512d 512d d 302f
512d 512d s 	jr	nc,A515E		; beep
512f 512f d 3e01
512f 512f s 	ld	a,001H
5131 5131 d dd7700
5131 5131 s 	ld	(ix+000H),a
5134 5134 d dd23
5134 5134 s 	inc	ix
5136 5136 d 04
5136 5136 s 	inc	b
5137 5137 d cd5d53
5137 5137 s 	call	A535D
513a 513a d f1
513a 513a s 	pop	af
513b 513b s 
513b 513b s 
513b 513b s ; lineinput, normal key action
513b 513b s 
513b 513b d f5
513b 513b s A513B:	push	af
513c 513c d 78
513c 513c s 	ld	a,b
513d 513d d b9
513d 513d s 	cp	c
513e 513e d 301e
513e 513e s 	jr	nc,A515E		; beep
5140 5140 d f1
5140 5140 s 	pop	af
5141 5141 d dd7700
5141 5141 s 	ld	(ix+000H),a
5144 5144 d dd23
5144 5144 s 	inc	ix
5146 5146 d 04
5146 5146 s 	inc	b
5147 5147 d cd5d53
5147 5147 s 	call	A535D
514a 514a d 3a39f2
514a 514a s 	ld	a,(YF239)
514d 514d d b7
514d 514d s 	or	a			; insertmode ?
514e 514e d 20b4
514e 514e s 	jr	nz,A5104		; yep,
5150 5150 d 14
5150 5150 s 	inc	d
5151 5151 d 7b
5151 5151 s 	ld	a,e
5152 5152 d ba
5152 5152 s 	cp	d
5153 5153 d 38af
5153 5153 s 	jr	c,A5104
5155 5155 d 7e
5155 5155 s 	ld	a,(hl)
5156 5156 d 3d
5156 5156 s 	dec	a
5157 5157 d 23
5157 5157 s 	inc	hl
5158 5158 d 20aa
5158 5158 s 	jr	nz,A5104
515a 515a d 14
515a 515a s 	inc	d
515b 515b d 23
515b 515b s 	inc	hl
515c 515c d 18a6
515c 515c s 	jr	A5104
515e 515e s ;
515e 515e d f1
515e 515e s A515E:	pop	af
515f 515f d 3e07
515f 515f s 	ld	a,007H			; bell
5161 5161 d cda853
5161 5161 s 	call	A53A8			; console output
5164 5164 d 189e
5164 5164 s 	jr	A5104
5166 5166 s 
5166 5166 s ; lineinput UP key, ESC key, CTRL-U (VOID)
5166 5166 s 
5166 5166 d d1
5166 5166 s A5166:	pop	de
5167 5167 d 3a38f2
5167 5167 s 	ld	a,(YF238)
516a 516a d 47
516a 516a s 	ld	b,a
516b 516b d 3a37f2
516b 516b s 	ld	a,(YF237)
516e 516e d 90
516e 516e s 	sub	b			; length of the inputline
516f 516f d 2806
516f 516f s 	jr	z,A5177			; empty inputline, restart line input
5171 5171 d 47
5171 5171 s 	ld	b,a
5172 5172 d cd4f53
5172 5172 s A5172:	call	A534F
5175 5175 d 10fb
5175 5175 s 	djnz	A5172
5177 5177 d c3e050
5177 5177 s A5177:	jp	A50E0			; restart lineinput
517a 517a s 
517a 517a s ; lineinput CTRL-J
517a 517a s 
517a 517a d 78
517a 517a s A517A:	ld	a,b
517b 517b d 323af2
517b 517b s 	ld	(YF23A),a		; store current linelength (for secret message)
517e 517e d cd8351
517e 517e s 	call	A5183			; newline
5181 5181 d 1881
5181 5181 s A5181:	jr	A5104
5183 5183 s ;
5183 5183 d 3e0d
5183 5183 s A5183:	ld	a,00DH
5185 5185 d cda853
5185 5185 s 	call	A53A8			; console output
5188 5188 d 3e0a
5188 5188 s 	ld	a,00AH
518a 518a d c3a853
518a 518a s 	jp	A53A8			; console output
518d 518d s 
518d 518d s ; lineinput CR key
518d 518d s 
518d 518d d d1
518d 518d s A518D:	pop	de
518e 518e d cda853
518e 518e s A518E:	call	A53A8			; console output
5191 5191 d d5
5191 5191 s 	push	de
5192 5192 d 13
5192 5192 s 	inc	de
5193 5193 d 78
5193 5193 s 	ld	a,b
5194 5194 d 12
5194 5194 s 	ld	(de),a
5195 5195 d b9
5195 5195 s 	cp	c
5196 5196 d f5
5196 5196 s 	push	af
5197 5197 d 13
5197 5197 s 	inc	de
5198 5198 d 48
5198 5198 s 	ld	c,b
5199 5199 d af
5199 5199 s 	xor	a
519a 519a d 47
519a 519a s 	ld	b,a
519b 519b d b1
519b 519b s 	or	c
519c 519c d 2805
519c 519c s 	jr	z,A51A3
519e 519e d 2159f4
519e 519e s 	ld	hl,KBUF+58
51a1 51a1 d edb0
51a1 51a1 s 	ldir
51a3 51a3 d f1
51a3 51a3 s A51A3:	pop	af
51a4 51a4 d 2803
51a4 51a4 s 	jr	z,A51A9
51a6 51a6 d 3e0d
51a6 51a6 s 	ld	a,00DH
51a8 51a8 d 12
51a8 51a8 s 	ld	(de),a
51a9 51a9 d d1
51a9 51a9 s A51A9:	pop	de
51aa 51aa d c9
51aa 51aa s 	ret
51ab 51ab s 
51ab 51ab s ; lineinput LEFT key, BS key (BS)
51ab 51ab s 
51ab 51ab d 3a3af2
51ab 51ab s A51AB:	ld	a,(YF23A)
51ae 51ae d a0
51ae 51ae s 	and	b
51af 51af d fe7f
51af 51af s 	cp	07FH
51b1 51b1 d ca4452
51b1 51b1 s 	jp	z,A5244			; secret programmers message
51b4 51b4 d 04
51b4 51b4 s 	inc	b
51b5 51b5 d 05
51b5 51b5 s 	dec	b
51b6 51b6 d 2824
51b6 51b6 s 	jr	z,A51DC
51b8 51b8 d 05
51b8 51b8 s 	dec	b
51b9 51b9 d dd2b
51b9 51b9 s 	dec	ix
51bb 51bb d cd4f53
51bb 51bb s 	call	A534F
51be 51be d 04
51be 51be s 	inc	b
51bf 51bf d 05
51bf 51bf s 	dec	b
51c0 51c0 d 280c
51c0 51c0 s 	jr	z,A51CE
51c2 51c2 d 05
51c2 51c2 s 	dec	b
51c3 51c3 d dd2b
51c3 51c3 s 	dec	ix
51c5 51c5 d dd7e00
51c5 51c5 s 	ld	a,(ix+000H)
51c8 51c8 d 3d
51c8 51c8 s 	dec	a
51c9 51c9 d 2811
51c9 51c9 s 	jr	z,A51DC
51cb 51cb d 04
51cb 51cb s 	inc	b
51cc 51cc d dd23
51cc 51cc s 	inc	ix
51ce 51ce d dd7e00
51ce 51ce s A51CE:	ld	a,(ix+000H)
51d1 51d1 d fe20
51d1 51d1 s 	cp	020H
51d3 51d3 d 3007
51d3 51d3 s 	jr	nc,A51DC
51d5 51d5 d fe09
51d5 51d5 s 	cp	009H
51d7 51d7 d 2822
51d7 51d7 s 	jr	z,A51FB
51d9 51d9 d cd4f53
51d9 51d9 s 	call	A534F
51dc 51dc d 3a39f2
51dc 51dc s A51DC:	ld	a,(YF239)
51df 51df d b7
51df 51df s 	or	a			; insertmode ?
51e0 51e0 d 209f
51e0 51e0 s 	jr	nz,A5181		; yep,
51e2 51e2 d 14
51e2 51e2 s 	inc	d
51e3 51e3 d 15
51e3 51e3 s 	dec	d
51e4 51e4 d 289b
51e4 51e4 s 	jr	z,A5181
51e6 51e6 d 15
51e6 51e6 s 	dec	d
51e7 51e7 d 7a
51e7 51e7 s 	ld	a,d
51e8 51e8 d bb
51e8 51e8 s 	cp	e
51e9 51e9 d 3096
51e9 51e9 s 	jr	nc,A5181
51eb 51eb d 2b
51eb 51eb s 	dec	hl
51ec 51ec d 7a
51ec 51ec s 	ld	a,d
51ed 51ed d fe01
51ed 51ed s 	cp	001H
51ef 51ef d 3890
51ef 51ef s 	jr	c,A5181
51f1 51f1 d 2b
51f1 51f1 s 	dec	hl
51f2 51f2 d 7e
51f2 51f2 s 	ld	a,(hl)
51f3 51f3 d 3d
51f3 51f3 s 	dec	a
51f4 51f4 d 23
51f4 51f4 s 	inc	hl
51f5 51f5 d 208a
51f5 51f5 s 	jr	nz,A5181
51f7 51f7 d 15
51f7 51f7 s 	dec	d
51f8 51f8 d 2b
51f8 51f8 s 	dec	hl
51f9 51f9 d 1886
51f9 51f9 s 	jr	A5181
51fb 51fb s ;
51fb 51fb d e5
51fb 51fb s A51FB:	push	hl
51fc 51fc d c5
51fc 51fc s 	push	bc
51fd 51fd d 3a38f2
51fd 51fd s 	ld	a,(YF238)
5200 5200 d 4f
5200 5200 s 	ld	c,a			; start of the inputline
5201 5201 d 04
5201 5201 s 	inc	b
5202 5202 d 05
5202 5202 s 	dec	b
5203 5203 d 2815
5203 5203 s 	jr	z,A521A
5205 5205 d 2159f4
5205 5205 s 	ld	hl,KBUF+58
5208 5208 d 7e
5208 5208 s A5208:	ld	a,(hl)
5209 5209 d 23
5209 5209 s 	inc	hl
520a 520a d fe01
520a 520a s 	cp	001H
520c 520c d 280a
520c 520c s 	jr	z,A5218
520e 520e d 0c
520e 520e s 	inc	c
520f 520f d fe20
520f 520f s 	cp	020H
5211 5211 d 3005
5211 5211 s 	jr	nc,A5218
5213 5213 d fe09
5213 5213 s 	cp	009H
5215 5215 d 2813
5215 5215 s 	jr	z,A522A
5217 5217 d 0c
5217 5217 s 	inc	c
5218 5218 d 10ee
5218 5218 s A5218:	djnz	A5208
521a 521a d 3a37f2
521a 521a s A521A:	ld	a,(YF237)		; current console columnpos
521d 521d d 91
521d 521d s 	sub	c
521e 521e d 2806
521e 521e s 	jr	z,A5226
5220 5220 d 47
5220 5220 s 	ld	b,a
5221 5221 d cd4f53
5221 5221 s A5221:	call	A534F
5224 5224 d 10fb
5224 5224 s 	djnz	A5221
5226 5226 d c1
5226 5226 s A5226:	pop	bc
5227 5227 d e1
5227 5227 s 	pop	hl
5228 5228 d 18b2
5228 5228 s 	jr	A51DC
522a 522a s ;
522a 522a d 79
522a 522a s A522A:	ld	a,c
522b 522b d c607
522b 522b s 	add	a,007H
522d 522d d e6f8
522d 522d s 	and	0F8H
522f 522f d 4f
522f 522f s 	ld	c,a
5230 5230 d 18e6
5230 5230 s 	jr	A5218
5232 5232 s 
5232 5232 s ; lineinput INS key (INSERT)
5232 5232 s 
5232 5232 d 3a39f2
5232 5232 s A5232:	ld	a,(YF239)
5235 5235 d ee01
5235 5235 s 	xor	001H
5237 5237 d 1805
5237 5237 s 	jr	A523E			; toggle insertmode
5239 5239 s 
5239 5239 s ; unused code
5239 5239 s 
5239 5239 d af
5239 5239 s 	xor	a
523a 523a d 1802
523a 523a s 	jr	A523E
523c 523c s 
523c 523c s ; unused code
523c 523c s 
523c 523c d 3e01
523c 523c s 	ld	a,001H
523e 523e s 
523e 523e d 3239f2
523e 523e s A523E:	ld	(YF239),a
5241 5241 d c30451
5241 5241 s 	jp	A5104
5244 5244 s 
5244 5244 s ;	  Subroutine display message of programmer (not needed)
5244 5244 s ;	     Inputs  
5244 5244 s ;	     Outputs
5244 5244 s ;         Remark     activated by:
5244 5244 s ;                    input 127 or 255 chars, press CTRL-J, press BS or LEFT
5244 5244 s 
5244 5244 d af
5244 5244 s A5244:	xor	a
5245 5245 d 323af2
5245 5245 s 	ld	(YF23A),a
5248 5248 d c5
5248 5248 s 	push	bc
5249 5249 d 0610
5249 5249 s 	ld	b,16
524b 524b d 117d54
524b 524b s 	ld	de,T547D
524e 524e d 210000
524e 524e s 	ld	hl,0
5251 5251 d e5
5251 5251 s A5251:	push	hl
5252 5252 d cdd24e
5252 5252 s 	call	A4ED2			; get decoded characterpair
5255 5255 d c620
5255 5255 s 	add	a,020H
5257 5257 d cda853
5257 5257 s 	call	A53A8			; console output
525a 525a d 7c
525a 525a s 	ld	a,h
525b 525b d c620
525b 525b s 	add	a,020H
525d 525d d cda853
525d 525d s 	call	A53A8			; console output
5260 5260 d e1
5260 5260 s 	pop	hl
5261 5261 d 23
5261 5261 s 	inc	hl
5262 5262 d 10ed
5262 5262 s 	djnz	A5251
5264 5264 d c1
5264 5264 s 	pop	bc
5265 5265 s 
5265 5265 s ; lineinput HOME key (NEWLINE)
5265 5265 s 
5265 5265 d 3e40
5265 5265 s A5265:	ld	a,040H
5267 5267 d d1
5267 5267 s 	pop	de
5268 5268 d cd8e51
5268 5268 s 	call	A518E
526b 526b d cd8351
526b 526b s 	call	A5183			; newline
526e 526e d 3a38f2
526e 526e s 	ld	a,(YF238)
5271 5271 d b7
5271 5271 s 	or	a			; start of the inputline at the begin of a line ?
5272 5272 d cae050
5272 5272 s 	jp	z,A50E0			; yep, restart lineinput routine
5275 5275 d 47
5275 5275 s 	ld	b,a
5276 5276 d 3e20
5276 5276 s 	ld	a," "
5278 5278 d cda853
5278 5278 s A5278:	call	A53A8			; console output
527b 527b d 10fb
527b 527b s 	djnz	A5278
527d 527d d c3e050
527d 527d s 	jp	A50E0			; restart lineinput routine
5280 5280 s 
5280 5280 s ; lineinput DOWN key (COPYALL)
5280 5280 s 
5280 5280 d 3eff
5280 5280 s A5280:	ld	a,0FFH
5282 5282 d 1831
5282 5282 s 	jr	A52B5
5284 5284 s 
5284 5284 s ; lineinput CTRL-L (SKIPUP)
5284 5284 s 
5284 5284 d cde352
5284 5284 s A5284:	call	A52E3
5287 5287 d da0451
5287 5287 s 	jp	c,A5104
528a 528a d c5
528a 528a s 	push	bc
528b 528b d 4f
528b 528b s 	ld	c,a
528c 528c d 0600
528c 528c s 	ld	b,000H
528e 528e d 09
528e 528e s 	add	hl,bc
528f 528f d c1
528f 528f s 	pop	bc
5290 5290 d 82
5290 5290 s 	add	a,d
5291 5291 d 57
5291 5291 s 	ld	d,a
5292 5292 d c30451
5292 5292 s 	jp	A5104
5295 5295 s 
5295 5295 s ; lineinput SELECT key (COPYUP)
5295 5295 s 
5295 5295 d cde352
5295 5295 s A5295:	call	A52E3
5298 5298 d da0451
5298 5298 s 	jp	c,A5104
529b 529b d 1818
529b 529b s 	jr	A52B5
529d 529d s 
529d 529d s ; lineinput DEL key (SKIP1)
529d 529d s 
529d 529d d 7a
529d 529d s A529D:	ld	a,d
529e 529e d bb
529e 529e s 	cp	e
529f 529f d d20451
529f 529f s 	jp	nc,A5104
52a2 52a2 d 14
52a2 52a2 s 	inc	d
52a3 52a3 d 7e
52a3 52a3 s 	ld	a,(hl)
52a4 52a4 d 3d
52a4 52a4 s 	dec	a
52a5 52a5 d 23
52a5 52a5 s 	inc	hl
52a6 52a6 d c20451
52a6 52a6 s 	jp	nz,A5104
52a9 52a9 d 14
52a9 52a9 s 	inc	d
52aa 52aa d 23
52aa 52aa s 	inc	hl
52ab 52ab d c30451
52ab 52ab s 	jp	A5104
52ae 52ae s 
52ae 52ae s ; lineinput RIGHT key (COPY1)
52ae 52ae s 
52ae 52ae d 7e
52ae 52ae s A52AE:	ld	a,(hl)
52af 52af d 3d
52af 52af s 	dec	a
52b0 52b0 d 3e01
52b0 52b0 s 	ld	a,001H
52b2 52b2 d 2001
52b2 52b2 s 	jr	nz,A52B5
52b4 52b4 d 3c
52b4 52b4 s 	inc	a
52b5 52b5 d f5
52b5 52b5 s A52B5:	push	af
52b6 52b6 d af
52b6 52b6 s 	xor	a
52b7 52b7 d 3239f2
52b7 52b7 s 	ld	(YF239),a		; insertmode off
52ba 52ba d 78
52ba 52ba s 	ld	a,b
52bb 52bb d b9
52bb 52bb s 	cp	c
52bc 52bc d 3021
52bc 52bc s 	jr	nc,A52DF
52be 52be d 7a
52be 52be s 	ld	a,d
52bf 52bf d bb
52bf 52bf s 	cp	e
52c0 52c0 d 301d
52c0 52c0 s 	jr	nc,A52DF
52c2 52c2 d 7e
52c2 52c2 s 	ld	a,(hl)
52c3 52c3 d fe01
52c3 52c3 s 	cp	001H
52c5 52c5 d 2006
52c5 52c5 s 	jr	nz,A52CD
52c7 52c7 d 78
52c7 52c7 s 	ld	a,b
52c8 52c8 d 3c
52c8 52c8 s 	inc	a
52c9 52c9 d b9
52c9 52c9 s 	cp	c
52ca 52ca d 3013
52ca 52ca s 	jr	nc,A52DF
52cc 52cc d 7e
52cc 52cc s 	ld	a,(hl)
52cd 52cd d 23
52cd 52cd s A52CD:	inc	hl
52ce 52ce d dd7700
52ce 52ce s 	ld	(ix+000H),a
52d1 52d1 d dd23
52d1 52d1 s 	inc	ix
52d3 52d3 d cd5d53
52d3 52d3 s 	call	A535D
52d6 52d6 d 04
52d6 52d6 s 	inc	b
52d7 52d7 d 14
52d7 52d7 s 	inc	d
52d8 52d8 d f1
52d8 52d8 s 	pop	af
52d9 52d9 d 3d
52d9 52d9 s 	dec	a
52da 52da d 20d9
52da 52da s 	jr	nz,A52B5
52dc 52dc d c30451
52dc 52dc s 	jp	A5104
52df 52df s ;
52df 52df d f1
52df 52df s A52DF:	pop	af
52e0 52e0 d c30451
52e0 52e0 s 	jp	A5104
52e3 52e3 s ;
52e3 52e3 d cd4e54
52e3 52e3 s A52E3:	call	A544E			; BDOS 8 (direct input)
52e6 52e6 d fe01
52e6 52e6 s 	cp	001H
52e8 52e8 d 2035
52e8 52e8 s 	jr	nz,A531F
52ea 52ea d cd4e54
52ea 52ea s 	call	A544E			; BDOS 8 (direct input)
52ed 52ed d fe40
52ed 52ed s 	cp	040H
52ef 52ef d 382e
52ef 52ef s 	jr	c,A531F
52f1 52f1 d fe60
52f1 52f1 s 	cp	060H
52f3 52f3 d 302a
52f3 52f3 s 	jr	nc,A531F
52f5 52f5 d e5
52f5 52f5 s 	push	hl
52f6 52f6 d d5
52f6 52f6 s 	push	de
52f7 52f7 d c5
52f7 52f7 s 	push	bc
52f8 52f8 d fd210000
52f8 52f8 s 	ld	iy,00000H
52fc 52fc d 37
52fc 52fc s A52FC:	scf
52fd 52fd d f5
52fd 52fd s 	push	af
52fe 52fe d 3e01
52fe 52fe s 	ld	a,001H
5300 5300 d cd1f53
5300 5300 s 	call	A531F
5303 5303 d 3815
5303 5303 s 	jr	c,A531A
5305 5305 d 4f
5305 5305 s 	ld	c,a
5306 5306 d 0600
5306 5306 s 	ld	b,000H
5308 5308 d 09
5308 5308 s 	add	hl,bc
5309 5309 d 82
5309 5309 s 	add	a,d
530a 530a d 57
530a 530a s 	ld	d,a
530b 530b d fde5
530b 530b s 	push	iy
530d 530d d f1
530d 530d s 	pop	af
530e 530e d 81
530e 530e s 	add	a,c
530f 530f d f5
530f 530f s 	push	af
5310 5310 d fde1
5310 5310 s 	pop	iy
5312 5312 d 23
5312 5312 s 	inc	hl
5313 5313 d f1
5313 5313 s 	pop	af
5314 5314 d be
5314 5314 s 	cp	(hl)
5315 5315 d 2b
5315 5315 s 	dec	hl
5316 5316 d 20e4
5316 5316 s 	jr	nz,A52FC
5318 5318 d fde5
5318 5318 s 	push	iy
531a 531a d f1
531a 531a s A531A:	pop	af
531b 531b d c1
531b 531b s 	pop	bc
531c 531c d d1
531c 531c s 	pop	de
531d 531d d e1
531d 531d s 	pop	hl
531e 531e d c9
531e 531e s 	ret
531f 531f s ;
531f 531f d c5
531f 531f s A531F:	push	bc
5320 5320 d f5
5320 5320 s 	push	af
5321 5321 d 7b
5321 5321 s 	ld	a,e
5322 5322 d 92
5322 5322 s 	sub	d
5323 5323 d 3826
5323 5323 s 	jr	c,A534B
5325 5325 d 2824
5325 5325 s 	jr	z,A534B
5327 5327 d 3d
5327 5327 s 	dec	a
5328 5328 d 2821
5328 5328 s 	jr	z,A534B
532a 532a d 4f
532a 532a s 	ld	c,a
532b 532b d 0600
532b 532b s 	ld	b,000H
532d 532d d f1
532d 532d s 	pop	af
532e 532e d e5
532e 532e s 	push	hl
532f 532f d f5
532f 532f s 	push	af
5330 5330 d 7e
5330 5330 s 	ld	a,(hl)
5331 5331 d 3d
5331 5331 s 	dec	a
5332 5332 d 2002
5332 5332 s 	jr	nz,A5336
5334 5334 d 23
5334 5334 s 	inc	hl
5335 5335 d 0d
5335 5335 s 	dec	c
5336 5336 d f1
5336 5336 s A5336:	pop	af
5337 5337 d 0c
5337 5337 s 	inc	c
5338 5338 d 0d
5338 5338 s 	dec	c
5339 5339 d 2004
5339 5339 s 	jr	nz,A533F
533b 533b d e1
533b 533b s 	pop	hl
533c 533c d c1
533c 533c s 	pop	bc
533d 533d d 37
533d 533d s 	scf
533e 533e d c9
533e 533e s 	ret
533f 533f s ;
533f 533f d 23
533f 533f s A533F:	inc	hl
5340 5340 d edb1
5340 5340 s 	cpir
5342 5342 d e1
5342 5342 s 	pop	hl
5343 5343 d 2007
5343 5343 s 	jr	nz,A534C
5345 5345 d 7b
5345 5345 s 	ld	a,e
5346 5346 d 92
5346 5346 s 	sub	d
5347 5347 d 3d
5347 5347 s 	dec	a
5348 5348 d 91
5348 5348 s 	sub	c
5349 5349 d c1
5349 5349 s 	pop	bc
534a 534a d c9
534a 534a s 	ret
534b 534b s ;
534b 534b d f1
534b 534b s A534B:	pop	af
534c 534c d c1
534c 534c s A534C:	pop	bc
534d 534d d 37
534d 534d s 	scf
534e 534e d c9
534e 534e s 	ret
534f 534f s ;
534f 534f d 3e08
534f 534f s A534F:	ld	a,008H
5351 5351 d cda853
5351 5351 s 	call	A53A8			; console output
5354 5354 d 3e20
5354 5354 s 	ld	a,020H
5356 5356 d cda853
5356 5356 s 	call	A53A8			; console output
5359 5359 d 3e08
5359 5359 s 	ld	a,008H
535b 535b d 184b
535b 535b s 	jr	A53A8			; console output
535d 535d s ;
535d 535d d fe20
535d 535d s A535D:	cp	020H
535f 535f d 3047
535f 535f s 	jr	nc,A53A8		; console output
5361 5361 d fe09
5361 5361 s 	cp	009H
5363 5363 d 2843
5363 5363 s 	jr	z,A53A8			; console output
5365 5365 d fe01
5365 5365 s 	cp	001H
5367 5367 d 283f
5367 5367 s 	jr	z,A53A8			; console output
5369 5369 d f5
5369 5369 s 	push	af
536a 536a d 3e5e
536a 536a s 	ld	a,"^"
536c 536c d cda853
536c 536c s 	call	A53A8			; console output
536f 536f d f1
536f 536f s 	pop	af
5370 5370 d f640
5370 5370 s 	or	040H
5372 5372 d 1834
5372 5372 s 	jr	A53A8			; console output
5374 5374 s 
5374 5374 s ; keytable lineinput
5374 5374 s ;
5374 5374 s ; first table contains all keycodes, code 8 at the end is a fake one for 'other key', because it is already in the table
5374 5374 s ; second table contains all serviceroutines, but in reserve order (so last one belongs to the first keycode)
5374 5374 s 
5374 5374 d 067f080d0a150b0c
5374 5374 s T5374:	defb	006H,07FH,008H,00DH,00AH,015H,00BH,00CH
537c 537c d 1b12181c1d1e1f01
537c 537c s 	defb	01BH,012H,018H,01CH,01DH,01EH,01FH,001H
5384 5384 d 08
5384 5384 s 	defb	008H
5385 5385 s 
5385 5385 d 3b51
5385 5385 s 	defw	A513B
5387 5387 d 1e5180526651ab51ae52955232526651
5387 5387 s 	defw	A511E,A5280,A5166,A51AB,A52AE,A5295,A5232,A5166
5397 5397 d 8452655266517a518d51ab519d520451
5397 5397 s 	defw	A5284,A5265,A5166,A517A,A518D,A51AB,A529D,A5104
53a7 53a7 s 
53a7 53a7 s NKEYNT	equ	($-T5374)/3
53a7 53a7 s 
53a7 53a7 s 
53a7 53a7 s ;	  Subroutine BDOS 02 (console output)
53a7 53a7 s ;	     Inputs  
53a7 53a7 s ;	     Outputs ________________________ 
53a7 53a7 s 
53a7 53a7 d 7b
53a7 53a7 s A53A7:	ld	a,e
53a8 53a8 d cdaff2
53a8 53a8 s A53A8:	call	XF2AF
53ab 53ab d fe0b
53ab 53ab s 	cp	00BH
53ad 53ad d 2839
53ad 53ad s 	jr	z,A53E8
53af 53af d fe0c
53af 53af s 	cp	00CH
53b1 53b1 d 2835
53b1 53b1 s 	jr	z,A53E8
53b3 53b3 d fe1c
53b3 53b3 s 	cp	01CH
53b5 53b5 d 281e
53b5 53b5 s 	jr	z,A53D5
53b7 53b7 d fe1d
53b7 53b7 s 	cp	01DH
53b9 53b9 d 2835
53b9 53b9 s 	jr	z,A53F0
53bb 53bb d fe0d
53bb 53bb s 	cp	00DH
53bd 53bd d 2829
53bd 53bd s 	jr	z,A53E8
53bf 53bf d fe08
53bf 53bf s 	cp	008H
53c1 53c1 d 282d
53c1 53c1 s 	jr	z,A53F0
53c3 53c3 d fe09
53c3 53c3 s 	cp	009H
53c5 53c5 d 2831
53c5 53c5 s 	jr	z,A53F8
53c7 53c7 d fe7f
53c7 53c7 s 	cp	07FH
53c9 53c9 d 2825
53c9 53c9 s 	jr	z,A53F0
53cb 53cb d fe20
53cb 53cb s 	cp	020H
53cd 53cd d 3806
53cd 53cd s 	jr	c,A53D5
53cf 53cf d e5
53cf 53cf s 	push	hl
53d0 53d0 d 2137f2
53d0 53d0 s 	ld	hl,YF237
53d3 53d3 d 34
53d3 53d3 s 	inc	(hl)			; increase console columnpos
53d4 53d4 d e1
53d4 53d4 s 	pop	hl
53d5 53d5 d c5
53d5 53d5 s A53D5:	push	bc
53d6 53d6 d 47
53d6 53d6 s 	ld	b,a
53d7 53d7 d cd1254
53d7 53d7 s 	call	A5412
53da 53da d 78
53da 53da s 	ld	a,b
53db 53db d cd8f40
53db 53db s 	call	A408F			; output to screen
53de 53de d 3a3bf2
53de 53de s 	ld	a,(YF23B)
53e1 53e1 d b7
53e1 53e1 s 	or	a			; console output also to printer ?
53e2 53e2 d 78
53e2 53e2 s 	ld	a,b
53e3 53e3 d c1
53e3 53e3 s 	pop	bc
53e4 53e4 d c8
53e4 53e4 s 	ret	z			; nope, quit
53e5 53e5 d c39b40
53e5 53e5 s 	jp	A409B			; output to printer
53e8 53e8 s ;
53e8 53e8 d f5
53e8 53e8 s A53E8:	push	af
53e9 53e9 d af
53e9 53e9 s 	xor	a
53ea 53ea d 3237f2
53ea 53ea s 	ld	(YF237),a		; console columpos
53ed 53ed d f1
53ed 53ed s 	pop	af
53ee 53ee d 18e5
53ee 53ee s 	jr	A53D5
53f0 53f0 s ;
53f0 53f0 d e5
53f0 53f0 s A53F0:	push	hl
53f1 53f1 d 2137f2
53f1 53f1 s 	ld	hl,YF237
53f4 53f4 d 35
53f4 53f4 s 	dec	(hl)			; decrease console columnpos
53f5 53f5 d e1
53f5 53f5 s 	pop	hl
53f6 53f6 d 18dd
53f6 53f6 s 	jr	A53D5
53f8 53f8 s ;
53f8 53f8 d 3e20
53f8 53f8 s A53F8:	ld	a," "
53fa 53fa d cda853
53fa 53fa s 	call	A53A8			; console output
53fd 53fd d 3a37f2
53fd 53fd s 	ld	a,(YF237)
5400 5400 d e607
5400 5400 s 	and	007H
5402 5402 d 20f4
5402 5402 s 	jr	nz,A53F8		; to the next console tabposition
5404 5404 d c9
5404 5404 s 	ret
5405 5405 s ;
5405 5405 d fe10
5405 5405 s A5405:	cp	010H			; CTRL-P ?
5407 5407 d 2814
5407 5407 s 	jr	z,A541D			; yep, handle it
5409 5409 d fe0e
5409 5409 s 	cp	00EH			; CTRL-N ?
540b 540b d 2810
540b 540b s 	jr	z,A541D			; yep, handle it
540d 540d d fe03
540d 540d s 	cp	003H			; CTRL-C ?
540f 540f d 280c
540f 540f s 	jr	z,A541D			; yep, handle it
5411 5411 d c9
5411 5411 s 	ret				; nope, quit
5412 5412 s ;
5412 5412 d cd3440
5412 5412 s A5412:	call	A4034			; check if keyboardinput available
5415 5415 d c8
5415 5415 s 	ret	z			; nope, quit
5416 5416 d fe13
5416 5416 s 	cp	013H			; CTRL-S ?
5418 5418 d 20eb
5418 5418 s 	jr	nz,A5405		; nope, check other specials
541a 541a d cd7840
541a 541a s 	call	A4078			; get keyboardinput (the CTRL-S)
541d 541d s 					; next wait for other consoleinput
541d 541d d cd7840
541d 541d s A541D:	call	A4078			; get keyboardinput
5420 5420 d fe10
5420 5420 s 	cp	010H
5422 5422 d 280d
5422 5422 s 	jr	z,A5431			; CTRL-P, enable printer output
5424 5424 d fe0e
5424 5424 s 	cp	00EH
5426 5426 d 280f
5426 5426 s 	jr	z,A5437			; CTRL-N, disable printer output
5428 5428 d fe03
5428 5428 s 	cp	003H			; CTRL-C ?
542a 542a d c0
542a 542a s 	ret	nz			; nope, quit
542b 542b d 2a25f3
542b 542b s 	ld	hl,(YF325)
542e 542e d c3e8f1
542e 542e s 	jp	XF1E8			; start abort handler in DOS memory
5431 5431 s ;
5431 5431 d 3e01
5431 5431 s A5431:	ld	a,1
5433 5433 d 323bf2
5433 5433 s 	ld	(YF23B),a
5436 5436 d c9
5436 5436 s 	ret
5437 5437 s ;
5437 5437 d af
5437 5437 s A5437:	xor	a
5438 5438 d 323bf2
5438 5438 s 	ld	(YF23B),a
543b 543b d c9
543b 543b s 	ret
543c 543c s 
543c 543c s ;	  Subroutine BDOS 0B (console status)
543c 543c s ;	     Inputs  
543c 543c s ;	     Outputs ________________________ 
543c 543c s 
543c 543c d cd1254
543c 543c s A543C:	call	A5412
543f 543f d 3e00
543f 543f s 	ld	a,000H
5441 5441 d c8
5441 5441 s 	ret	z
5442 5442 d f6ff
5442 5442 s 	or	0FFH
5444 5444 d c9
5444 5444 s 	ret
5445 5445 s 
5445 5445 s ;	  Subroutine BDOS 01 (console input)
5445 5445 s ;	     Inputs  
5445 5445 s ;	     Outputs ________________________ 
5445 5445 s 
5445 5445 d cd4e54
5445 5445 s A5445:	call	A544E			; BDOS 8 (direct input)
5448 5448 d f5
5448 5448 s 	push	af
5449 5449 d cda853
5449 5449 s 	call	A53A8			; console output
544c 544c d f1
544c 544c s 	pop	af
544d 544d d c9
544d 544d s 	ret
544e 544e s 
544e 544e s ;	  Subroutine BDOS 08 (direct input)
544e 544e s ;	     Inputs  
544e 544e s ;	     Outputs ________________________ 
544e 544e s 
544e 544e d cd1d54
544e 544e s A544E:	call	A541D
5451 5451 d 28fb
5451 5451 s 	jr	z,A544E
5453 5453 d c9
5453 5453 s 	ret
5454 5454 s 
5454 5454 s ;	  Subroutine BDOS 06 (direct console i/o)
5454 5454 s ;	     Inputs  A=0FFH for console input, A<>0FFH for console output
5454 5454 s ;	     Outputs A=input (console input)
5454 5454 s 
5454 5454 d 7b
5454 5454 s A5454:	ld	a,e
5455 5455 d feff
5455 5455 s 	cp	0FFH			; console input ?
5457 5457 d c28f40
5457 5457 s 	jp	nz,A408F		; console output, output to screen and quit
545a 545a d cd3440
545a 545a s 	call	A4034			; check if keyboardinput available
545d 545d d c27840
545d 545d s 	jp	nz,A4078		; yep, get keyboardinput and quit
5460 5460 d af
5460 5460 s 	xor	a
5461 5461 d c9
5461 5461 s 	ret
5462 5462 s 
5462 5462 s ;	  Subroutine BDOS 07
5462 5462 s ;	     Inputs  
5462 5462 s ;	     Outputs ________________________ 
5462 5462 s 
5462 5462 d c37840
5462 5462 s A5462:	jp	A4078			; get keyboardinput
5465 5465 s 
5465 5465 s ;	  Subroutine BDOS 05 (printer output)
5465 5465 s ;	     Inputs  
5465 5465 s ;	     Outputs ________________________ 
5465 5465 s 
5465 5465 d 7b
5465 5465 s A5465:	ld	a,e
5466 5466 d f5
5466 5466 s A5466:	push	af
5467 5467 d cd1254
5467 5467 s 	call	A5412
546a 546a d f1
546a 546a s 	pop	af
546b 546b d c39b40
546b 546b s 	jp	A409B			; output to printer
546e 546e s 
546e 546e s ;	  Subroutine BDOS 03 (auxiliary input)
546e 546e s ;	     Inputs  
546e 546e s ;	     Outputs ________________________ 
546e 546e s 
546e 546e d cd1254
546e 546e s A546E:	call	A5412
5471 5471 d c371f3
5471 5471 s 	jp	XF371
5474 5474 s 
5474 5474 s ;	  Subroutine BDOS 04 (auxiliary output)
5474 5474 s ;	     Inputs  
5474 5474 s ;	     Outputs ________________________ 
5474 5474 s 
5474 5474 d 7b
5474 5474 s A5474:	ld	a,e
5475 5475 d f5
5475 5475 s A5475:	push	af
5476 5476 d cd1254
5476 5476 s 	call	A5412
5479 5479 d f1
5479 5479 s 	pop	af
547a 547a d c374f3
547a 547a s 	jp	XF374
547d 547d s 
547d 547d s ;
547d 547d s ; Programmers message, decoded in FAT entries (not needed)
547d 547d s ;
547d 547d s ; MSXDOS BY T PATERSON J SUZUKI   @
547d 547d s 
547d 547d d ed8c93ef0c883940
547d 547d s T547D:	defb	0EDH,08CH,093H,0EFH,00CH,088H,039H,040H
5485 5485 d 03704897f2fcba80
5485 5485 s 	defb	003H,070H,048H,097H,0F2H,0FCH,0BAH,080H
548d 548d d 0accb55eaf290000
548d 548d s 	defb	00AH,0CCH,0B5H,05EH,0AFH,029H,000H,000H
5495 5495 s 
5495 5495 s ; unused code
5495 5495 s 
5495 5495 d c9
5495 5495 s 	ret
5496 5496 s 
5496 5496 s 
5496 5496 s 
5496 5496 d cdb2f2
5496 5496 s A5496:	call	XF2B2
5499 5499 d cdc054
5499 5499 s 	call	A54C0			; get time and date values
549c 549c d 79
549c 549c s 	ld	a,c
549d 549d d 87
549d 549d s 	add	a,a
549e 549e d 87
549e 549e s 	add	a,a
549f 549f d 87
549f 549f s 	add	a,a
54a0 54a0 d cb10
54a0 54a0 s 	rl	b
54a2 54a2 d 87
54a2 54a2 s 	add	a,a
54a3 54a3 d cb10
54a3 54a3 s 	rl	b
54a5 54a5 d 87
54a5 54a5 s 	add	a,a
54a6 54a6 d cb10
54a6 54a6 s 	rl	b
54a8 54a8 d cb3a
54a8 54a8 s 	srl	d
54aa 54aa d b2
54aa 54aa s 	or	d
54ab 54ab d 5f
54ab 54ab s 	ld	e,a
54ac 54ac d 50
54ac 54ac s 	ld	d,b
54ad 54ad d ed4b49f2
54ad 54ad s 	ld	bc,(YF249)
54b1 54b1 d 79
54b1 54b1 s 	ld	a,c
54b2 54b2 d 87
54b2 54b2 s 	add	a,a
54b3 54b3 d 87
54b3 54b3 s 	add	a,a
54b4 54b4 d 87
54b4 54b4 s 	add	a,a
54b5 54b5 d 87
54b5 54b5 s 	add	a,a
54b6 54b6 d 87
54b6 54b6 s 	add	a,a
54b7 54b7 d cb10
54b7 54b7 s 	rl	b
54b9 54b9 d 4f
54b9 54b9 s 	ld	c,a
54ba 54ba d 3a48f2
54ba 54ba s 	ld	a,(YF248)		; current day
54bd 54bd d b1
54bd 54bd s 	or	c
54be 54be d 4f
54be 54be s 	ld	c,a
54bf 54bf d c9
54bf 54bf s 	ret
54c0 54c0 s ;
54c0 54c0 d cd7941
54c0 54c0 s A54C0:	call	A4179			; get date and time
54c3 54c3 d 3846
54c3 54c3 s 	jr	c,A550B			; from clockchip,
54c5 54c5 d d5
54c5 54c5 s 	push	de
54c6 54c6 d e5
54c6 54c6 s 	push	hl
54c7 54c7 d ed5b4cf2
54c7 54c7 s 	ld	de,(YF24C)		; days since 1-1-1980
54cb 54cb d b7
54cb 54cb s 	or	a
54cc 54cc d ed52
54cc 54cc s 	sbc	hl,de
54ce 54ce d e1
54ce 54ce s 	pop	hl
54cf 54cf d d1
54cf 54cf s 	pop	de
54d0 54d0 d c8
54d0 54d0 s 	ret	z
54d1 54d1 d 224cf2
54d1 54d1 s 	ld	(YF24C),hl
54d4 54d4 d c5
54d4 54d4 s 	push	bc
54d5 54d5 d d5
54d5 54d5 s 	push	de
54d6 54d6 d 4d
54d6 54d6 s 	ld	c,l
54d7 54d7 d 44
54d7 54d7 s 	ld	b,h
54d8 54d8 d 11b505
54d8 54d8 s 	ld	de,4*365+1
54db 54db d cd2f49
54db 54db s 	call	A492F
54de 54de d 79
54de 54de s 	ld	a,c
54df 54df d 87
54df 54df s 	add	a,a
54e0 54e0 d 87
54e0 54e0 s 	add	a,a
54e1 54e1 d 87
54e1 54e1 s 	add	a,a
54e2 54e2 d 0600
54e2 54e2 s 	ld	b,000H
54e4 54e4 d 113455
54e4 54e4 s 	ld	de,T5534
54e7 54e7 d cd1555
54e7 54e7 s 	call	A5515
54ea 54ea d cb3f
54ea 54ea s 	srl	a
54ec 54ec d 3004
54ec 54ec s 	jr	nc,A54F2
54ee 54ee d 11c800
54ee 54ee s 	ld	de,200
54f1 54f1 d 19
54f1 54f1 s 	add	hl,de
54f2 54f2 d cd2355
54f2 54f2 s A54F2:	call	A5523			; setup days in februari
54f5 54f5 d 3e01
54f5 54f5 s 	ld	a,001H
54f7 54f7 d 112bf2
54f7 54f7 s 	ld	de,YF22B
54fa 54fa d cd1555
54fa 54fa s 	call	A5515
54fd 54fd d 3249f2
54fd 54fd s 	ld	(YF249),a
5500 5500 d 2c
5500 5500 s 	inc	l
5501 5501 d 7d
5501 5501 s 	ld	a,l
5502 5502 d 3248f2
5502 5502 s 	ld	(YF248),a		; current day
5505 5505 d cd8855
5505 5505 s A5505:	call	A5588
5508 5508 d d1
5508 5508 s 	pop	de
5509 5509 d c1
5509 5509 s 	pop	bc
550a 550a d c9
550a 550a s 	ret
550b 550b s ;
550b 550b d c5
550b 550b s A550B:	push	bc
550c 550c d d5
550c 550c s 	push	de
550d 550d d 2a4af2
550d 550d s 	ld	hl,(YF24A)
5510 5510 d cd9d55
5510 5510 s 	call	A559D			; calculate days since 1-1-1980
5513 5513 d 18f0
5513 5513 s 	jr	A5505
5515 5515 s ;
5515 5515 d eb
5515 5515 s A5515:	ex	de,hl
5516 5516 d 4e
5516 5516 s 	ld	c,(hl)
5517 5517 d 23
5517 5517 s 	inc	hl
5518 5518 d eb
5518 5518 s 	ex	de,hl
5519 5519 d b7
5519 5519 s 	or	a
551a 551a d ed42
551a 551a s 	sbc	hl,bc
551c 551c d 3803
551c 551c s 	jr	c,A5521
551e 551e d 3c
551e 551e s 	inc	a
551f 551f d 18f4
551f 551f s 	jr	A5515
5521 5521 s ;
5521 5521 d 09
5521 5521 s A5521:	add	hl,bc
5522 5522 d c9
5522 5522 s 	ret
5523 5523 s ;
5523 5523 d cdb5f2
5523 5523 s A5523:	call	XF2B5
5526 5526 d 324af2
5526 5526 s 	ld	(YF24A),a		; year (offset)
5529 5529 d e603
5529 5529 s A5529:	and	003H
552b 552b d 3e1c
552b 552b s 	ld	a,28
552d 552d d 2001
552d 552d s 	jr	nz,A5530
552f 552f d 3c
552f 552f s 	inc	a
5530 5530 d 322cf2
5530 5530 s A5530:	ld	(YF22B+1),a
5533 5533 d c9
5533 5533 s 	ret
5534 5534 s ;
5534 5534 s ;
5534 5534 d c8a6c8a5c8a5c8a5
5534 5534 s T5534:	defb	200,166,200,165,200,165,200,165
553c 553c s 
553c 553c s ;	  Subroutine BDOS 2A (get date)
553c 553c s ;	     Inputs  
553c 553c s ;	     Outputs ________________________ 
553c 553c s 
553c 553c d af
553c 553c s A553C:	xor	a
553d 553d d 3206f3
553d 553d s 	ld	(YF306),a		; no CP/M call
5540 5540 d cdc054
5540 5540 s 	call	A54C0			; get time and date values
5543 5543 d 2a4af2
5543 5543 s 	ld	hl,(YF24A)
5546 5546 d 11bc07
5546 5546 s 	ld	de,1980
5549 5549 d 19
5549 5549 s 	add	hl,de
554a 554a d ed5b48f2
554a 554a s 	ld	de,(YF248)		; current day and month
554e 554e d 3a4ef2
554e 554e s 	ld	a,(YF24E)
5551 5551 d c9
5551 5551 s 	ret
5552 5552 s 
5552 5552 s ;	  Subroutine BDOS 2B (set date)
5552 5552 s ;	     Inputs  
5552 5552 s ;	     Outputs ________________________ 
5552 5552 s 
5552 5552 d 0144f8
5552 5552 s A5552:	ld	bc,-1980
5555 5555 d 09
5555 5555 s 	add	hl,bc
5556 5556 d 3042
5556 5556 s 	jr	nc,A559A		; year <1980, error
5558 5558 d 7c
5558 5558 s 	ld	a,h
5559 5559 d b7
5559 5559 s 	or	a
555a 555a d 203e
555a 555a s 	jr	nz,A559A		; yearoffset not in 1 byte, error
555c 555c d 7d
555c 555c s 	ld	a,l
555d 555d d fe78
555d 555d s 	cp	120
555f 555f d 3039
555f 555f s 	jr	nc,A559A		; year >2099, error
5561 5561 d cd2955
5561 5561 s 	call	A5529			; setup febuari days
5564 5564 d 1c
5564 5564 s 	inc	e
5565 5565 d 1d
5565 5565 s 	dec	e
5566 5566 d 2832
5566 5566 s 	jr	z,A559A			; day 0, error
5568 5568 d 7a
5568 5568 s 	ld	a,d
5569 5569 d b7
5569 5569 s 	or	a
556a 556a d 282e
556a 556a s 	jr	z,A559A			; month 0, error
556c 556c d fe0d
556c 556c s 	cp	12+1
556e 556e d 302a
556e 556e s 	jr	nc,A559A		; month >12, error
5570 5570 d e5
5570 5570 s 	push	hl
5571 5571 d 212af2
5571 5571 s 	ld	hl,YF22B-1
5574 5574 d 85
5574 5574 s 	add	a,l
5575 5575 d 6f
5575 5575 s 	ld	l,a
5576 5576 d 3001
5576 5576 s 	jr	nc,A5579
5578 5578 d 24
5578 5578 s 	inc	h
5579 5579 d 7e
5579 5579 s A5579:	ld	a,(hl)			; days in month
557a 557a d e1
557a 557a s 	pop	hl
557b 557b d bb
557b 557b s 	cp	e
557c 557c d 381c
557c 557c s 	jr	c,A559A			; invalid day, error
557e 557e d ed5348f2
557e 557e s 	ld	(YF248),de		; current day and month
5582 5582 d cd9d55
5582 5582 s 	call	A559D			; calculate days since 1-1-1980
5585 5585 d cd1541
5585 5585 s 	call	A4115			; store date (clockchip or otherwise)
5588 5588 d ed4b4cf2
5588 5588 s A5588:	ld	bc,(YF24C)		; days since 1-1-1980
558c 558c d 110700
558c 558c s 	ld	de,7
558f 558f d 03
558f 558f s 	inc	bc
5590 5590 d 03
5590 5590 s 	inc	bc
5591 5591 d cd2f49
5591 5591 s 	call	A492F
5594 5594 d 7d
5594 5594 s 	ld	a,l
5595 5595 d 324ef2
5595 5595 s 	ld	(YF24E),a
5598 5598 d af
5598 5598 s 	xor	a
5599 5599 d c9
5599 5599 s 	ret
559a 559a s ;
559a 559a d 3eff
559a 559a s A559A:	ld	a,0FFH
559c 559c d c9
559c 559c s 	ret
559d 559d s ;
559d 559d d 7d
559d 559d s A559D:	ld	a,l			; year (offset)
559e 559e d cd2355
559e 559e s 	call	A5523			; setup days in februari
55a1 55a1 d 4d
55a1 55a1 s 	ld	c,l
55a2 55a2 d cb39
55a2 55a2 s 	srl	c
55a4 55a4 d cb39
55a4 55a4 s 	srl	c			; /4
55a6 55a6 d 0600
55a6 55a6 s 	ld	b,0
55a8 55a8 d 11b505
55a8 55a8 s 	ld	de,4*365+1
55ab 55ab d cd1649
55ab 55ab s 	call	A4916			; multiply
55ae 55ae d 69
55ae 55ae s 	ld	l,c
55af 55af d 60
55af 55af s 	ld	h,b
55b0 55b0 d 3a4af2
55b0 55b0 s 	ld	a,(YF24A)		; year (offset)
55b3 55b3 d e603
55b3 55b3 s 	and	003H
55b5 55b5 d 87
55b5 55b5 s 	add	a,a
55b6 55b6 d 113455
55b6 55b6 s 	ld	de,T5534
55b9 55b9 d 0600
55b9 55b9 s 	ld	b,0
55bb 55bb d 3c
55bb 55bb s 	inc	a
55bc 55bc d cdd255
55bc 55bc s 	call	A55D2
55bf 55bf d 112bf2
55bf 55bf s 	ld	de,YF22B
55c2 55c2 d 3a49f2
55c2 55c2 s 	ld	a,(YF249)		; current month
55c5 55c5 d cdd255
55c5 55c5 s 	call	A55D2
55c8 55c8 d 3a48f2
55c8 55c8 s 	ld	a,(YF248)		; current day
55cb 55cb d 3d
55cb 55cb s 	dec	a
55cc 55cc d 4f
55cc 55cc s 	ld	c,a
55cd 55cd d 09
55cd 55cd s 	add	hl,bc
55ce 55ce d 224cf2
55ce 55ce s 	ld	(YF24C),hl		; days since 1-1-1980
55d1 55d1 d c9
55d1 55d1 s 	ret
55d2 55d2 s ;
55d2 55d2 d 3d
55d2 55d2 s A55D2:	dec	a
55d3 55d3 d c8
55d3 55d3 s 	ret	z
55d4 55d4 d eb
55d4 55d4 s 	ex	de,hl
55d5 55d5 d 4e
55d5 55d5 s 	ld	c,(hl)
55d6 55d6 d 23
55d6 55d6 s 	inc	hl
55d7 55d7 d eb
55d7 55d7 s 	ex	de,hl
55d8 55d8 d 09
55d8 55d8 s 	add	hl,bc
55d9 55d9 d 18f7
55d9 55d9 s 	jr	A55D2
55db 55db s 
55db 55db s ;	  Subroutine BDOS 2C (get time)
55db 55db s ;	     Inputs  
55db 55db s ;	     Outputs ________________________ 
55db 55db s 
55db 55db d af
55db 55db s A55DB:	xor	a
55dc 55dc d 3206f3
55dc 55dc s 	ld	(YF306),a		; no CP/M call
55df 55df d cdc054
55df 55df s 	call	A54C0			; get time and date values
55e2 55e2 d 60
55e2 55e2 s 	ld	h,b
55e3 55e3 d 69
55e3 55e3 s 	ld	l,c
55e4 55e4 d af
55e4 55e4 s 	xor	a
55e5 55e5 d c9
55e5 55e5 s 	ret
55e6 55e6 s 
55e6 55e6 s ;	  Subroutine BDOS 2D (set time)
55e6 55e6 s ;	     Inputs  
55e6 55e6 s ;	     Outputs ________________________ 
55e6 55e6 s 
55e6 55e6 d 44
55e6 55e6 s A55E6:	ld	b,h
55e7 55e7 d 4d
55e7 55e7 s 	ld	c,l
55e8 55e8 d 78
55e8 55e8 s 	ld	a,b
55e9 55e9 d fe18
55e9 55e9 s 	cp	24
55eb 55eb d 30ad
55eb 55eb s 	jr	nc,A559A
55ed 55ed d 3e3b
55ed 55ed s 	ld	a,59
55ef 55ef d b9
55ef 55ef s 	cp	c
55f0 55f0 d 38a8
55f0 55f0 s 	jr	c,A559A
55f2 55f2 d ba
55f2 55f2 s 	cp	d
55f3 55f3 d 38a5
55f3 55f3 s 	jr	c,A559A
55f5 55f5 d 7b
55f5 55f5 s 	ld	a,e
55f6 55f6 d fe64
55f6 55f6 s 	cp	100
55f8 55f8 d 30a0
55f8 55f8 s 	jr	nc,A559A
55fa 55fa d cd3041
55fa 55fa s 	call	A4130			; store time (clockchip or otherwise)
55fd 55fd d af
55fd 55fd s 	xor	a
55fe 55fe d c9
55fe 55fe s 	ret
55ff 55ff s 
55ff 55ff s ;	  Subroutine BDOS 2E (set verify flag)
55ff 55ff s ;	     Inputs  
55ff 55ff s ;	     Outputs ________________________ 
55ff 55ff s 
55ff 55ff d 7b
55ff 55ff s A55FF:	ld	a,e
5600 5600 d 320df3
5600 5600 s 	ld	(RAWFLG),a
5603 5603 d c9
5603 5603 s 	ret
5604 5604 s 
5604 5604 s ;	  Subroutine Validate FCB filename
5604 5604 s ;	     Inputs  HL = adres of FCB+1,DE = destination
5604 5604 s ;	     Outputs ________________________ 
5604 5604 s ;	     Remark  is copied to 0F1F4H
5604 5604 s 
5604 5604 d 7e
5604 5604 s A5604:	ld	a,(hl)
5605 5605 d fe20
5605 5605 s 	cp	" "
5607 5607 d 37
5607 5607 s 	scf
5608 5608 d c8
5608 5608 s 	ret	z			; filename that start with a space is illegal, quit
5609 5609 d 010208
5609 5609 s 	ld	bc,00802H		; first do the filename, then the fileextension
560c 560c d fee5
560c 560c s 	cp	0E5H
560e 560e d 2012
560e 560e s 	jr	nz,A5622		; not the charcode also used as deleted file marker
5610 5610 d 3e05
5610 5610 s 	ld	a,005H
5612 5612 d 12
5612 5612 s 	ld	(de),a
5613 5613 d 23
5613 5613 s 	inc	hl
5614 5614 d 13
5614 5614 s 	inc	de
5615 5615 d 05
5615 5615 s 	dec	b			; use replacement charcode 005H, otherwise fileentry looks deleted
5616 5616 d 3ee5
5616 5616 s 	ld	a,0E5H
5618 5618 d cd8156
5618 5618 s 	call	A5681			; is this a double byte 'header' char ?
561b 561b d 3005
561b 561b s 	jr	nc,A5622		; nope, no special action
561d 561d d 7e
561d 561d s 	ld	a,(hl)
561e 561e d 12
561e 561e s 	ld	(de),a
561f 561f d 23
561f 561f s 	inc	hl
5620 5620 d 13
5620 5620 s 	inc	de
5621 5621 d 05
5621 5621 s 	dec	b			; yep, copy 'follow' char
5622 5622 d 7e
5622 5622 s A5622:	ld	a,(hl)
5623 5623 d cd8156
5623 5623 s 	call	A5681			; is this a double byte 'header' char ?
5626 5626 d 3009
5626 5626 s 	jr	nc,A5631		; nope, do upcasing and check
5628 5628 d 12
5628 5628 s 	ld	(de),a
5629 5629 d 23
5629 5629 s 	inc	hl
562a 562a d 13
562a 562a s 	inc	de			; copy 'header' char
562b 562b d 05
562b 562b s 	dec	b
562c 562c d 37
562c 562c s 	scf
562d 562d d c8
562d 562d s 	ret	z			; no 'follow' char, quit with error
562e 562e d 7e
562e 562e s 	ld	a,(hl)
562f 562f d 1836
562f 562f s 	jr	A5667			; copy 'follow' char and continue
5631 5631 s ;
5631 5631 d 3a0ef3
5631 5631 s A5631:	ld	a,(YF30E)
5634 5634 d a7
5634 5634 s 	and	a
5635 5635 d 7e
5635 5635 s 	ld	a,(hl)
5636 5636 d 2814
5636 5636 s 	jr	z,A564C			; japanese have no accent chars,
5638 5638 d fe80
5638 5638 s 	cp	080H
563a 563a d 3810
563a 563a s 	jr	c,A564C			; normal ASCII,
563c 563c d feba
563c 563c s 	cp	0BAH
563e 563e d 300c
563e 563e s 	jr	nc,A564C
5640 5640 d e5
5640 5640 s 	push	hl			; 080H-0B9H accent chars
5641 5641 d c5
5641 5641 s 	push	bc
5642 5642 d 4f
5642 5642 s 	ld	c,a
5643 5643 d 0600
5643 5643 s 	ld	b,000H
5645 5645 d 211656
5645 5645 s 	ld	hl,T5696-080H
5648 5648 d 09
5648 5648 s 	add	hl,bc
5649 5649 d 7e
5649 5649 s 	ld	a,(hl)			; get the upcase version of the accent char
564a 564a d c1
564a 564a s 	pop	bc
564b 564b d e1
564b 564b s 	pop	hl
564c 564c d fe61
564c 564c s A564C:	cp	"a"
564e 564e d 3806
564e 564e s 	jr	c,A5656
5650 5650 d fe7b
5650 5650 s 	cp	"z"+1
5652 5652 d 3002
5652 5652 s 	jr	nc,A5656
5654 5654 d d620
5654 5654 s 	sub	020H			; lowercase char, make upcase
5656 5656 d fe20
5656 5656 s A5656:	cp	020H
5658 5658 d d8
5658 5658 s 	ret	c			; control code are illegal, quit with error
5659 5659 d e5
5659 5659 s 	push	hl
565a 565a d c5
565a 565a s 	push	bc
565b 565b d 217756
565b 565b s 	ld	hl,T5677
565e 565e d 010a00
565e 565e s 	ld	bc,0000AH
5661 5661 d edb1
5661 5661 s 	cpir				; one of the illegal chars ?
5663 5663 d c1
5663 5663 s 	pop	bc
5664 5664 d e1
5664 5664 s 	pop	hl
5665 5665 d 37
5665 5665 s 	scf
5666 5666 d c8
5666 5666 s 	ret	z			; yep, quit with error
5667 5667 d 12
5667 5667 s A5667:	ld	(de),a			; copy char
5668 5668 d 23
5668 5668 s 	inc	hl
5669 5669 d 13
5669 5669 s 	inc	de
566a 566a d 10b6
566a 566a s 	djnz	A5622			; next char
566c 566c d 0603
566c 566c s 	ld	b,003H
566e 566e d 0d
566e 566e s 	dec	c
566f 566f d 20b1
566f 566f s 	jr	nz,A5622		; now do the fileextension
5671 5671 d b7
5671 5671 s 	or	a			; flag no error
5672 5672 d 7e
5672 5672 s 	ld	a,(hl)
5673 5673 d 320cf3
5673 5673 s 	ld	(YF30C),a		; save the FCB EX byte
5676 5676 d c9
5676 5676 s 	ret
5677 5677 s ;
5677 5677 s ;
5677 5677 d 2e222f5b5d3a2b3d3b2c
5677 5677 s T5677:	defb	'."/[]:+=;,'
5681 5681 s 
5681 5681 s ;	  Subroutine check if double byte header char
5681 5681 s ;	     Inputs  ________________________
5681 5681 s ;	     Outputs ________________________ 
5681 5681 s 
5681 5681 d e5
5681 5681 s A5681:	push	hl
5682 5682 d 210ff3
5682 5682 s 	ld	hl,YF30F
5685 5685 d be
5685 5685 s 	cp	(hl)
5686 5686 d 3f
5686 5686 s 	ccf
5687 5687 d 300b
5687 5687 s 	jr	nc,A5694		; below (F30F), quit (not in range)
5689 5689 d 23
5689 5689 s 	inc	hl
568a 568a d be
568a 568a s 	cp	(hl)
568b 568b d 3807
568b 568b s 	jr	c,A5694			; below (F310), quit (in range 1)
568d 568d d 23
568d 568d s 	inc	hl
568e 568e d be
568e 568e s 	cp	(hl)
568f 568f d 3f
568f 568f s 	ccf
5690 5690 d 3002
5690 5690 s 	jr	nc,A5694		; below (F311), quit (not in range)
5692 5692 d 23
5692 5692 s 	inc	hl
5693 5693 d be
5693 5693 s 	cp	(hl)
5694 5694 d e1
5694 5694 s A5694:	pop	hl
5695 5695 d c9
5695 5695 s 	ret
5696 5696 s ;
5696 5696 s ;	defb	" ¡¢£¤¥¦§¨©ª«¬­®¯°±²³´µ¶·¸¹"
5696 5696 d 809a45418e418f804545454949498e8f9092924f994f555559999a9b9c9d9e9f41494f55a5a5a6a7a8a9aaabacadaeafb0b0b2b2b4b4b6b6b8b8
5696 5696 s T5696:	defb	"EAAEEEIIIOOUUYAIOU¥¥¦§¨©ª«¬­®¯°°²²´´¶¶¸¸"
56d0 56d0 s 
56d0 56d0 s ;	  Subroutine unsupported CP/M BDOS calls
56d0 56d0 s ;	     Inputs  
56d0 56d0 s ;	     Outputs ________________________ 
56d0 56d0 s 
56d0 56d0 d af
56d0 56d0 s A56D0:	xor	a
56d1 56d1 d 47
56d1 56d1 s 	ld	b,a
56d2 56d2 d c9
56d2 56d2 s 	ret
56d3 56d3 s ;
56d3 56d3 s ;
56d3 56d3 d fb
56d3 56d3 s A56D3:	ei
56d4 56d4 d 3e01
56d4 56d4 s 	ld	a,1
56d6 56d6 d 3206f3
56d6 56d6 s 	ld	(YF306),a		; assume CP/M compatible call
56d9 56d9 d 79
56d9 56d9 s 	ld	a,c
56da 56da d fe31
56da 56da s 	cp	031H
56dc 56dc d 30f2
56dc 56dc s 	jr	nc,A56D0
56de 56de d d611
56de 56de s 	sub	011H
56e0 56e0 d 2004
56e0 56e0 s 	jr	nz,A56E6
56e2 56e2 d ed5307f3
56e2 56e2 s 	ld	(YF307),de
56e6 56e6 d 3d
56e6 56e6 s A56E6:	dec	a
56e7 56e7 d 2004
56e7 56e7 s 	jr	nz,A56ED
56e9 56e9 d ed5b07f3
56e9 56e9 s 	ld	de,(YF307)
56ed 56ed d e5
56ed 56ed s A56ED:	push	hl
56ee 56ee d 210057
56ee 56ee s 	ld	hl,T5700
56f1 56f1 d e3
56f1 56f1 s 	ex	(sp),hl
56f2 56f2 d e5
56f2 56f2 s 	push	hl
56f3 56f3 d 210d57
56f3 56f3 s 	ld	hl,T570D
56f6 56f6 d 0600
56f6 56f6 s 	ld	b,000H
56f8 56f8 d 09
56f8 56f8 s 	add	hl,bc
56f9 56f9 d 09
56f9 56f9 s 	add	hl,bc
56fa 56fa d 46
56fa 56fa s 	ld	b,(hl)
56fb 56fb d 23
56fb 56fb s 	inc	hl
56fc 56fc d 66
56fc 56fc s 	ld	h,(hl)
56fd 56fd d 68
56fd 56fd s 	ld	l,b
56fe 56fe d e3
56fe 56fe s 	ex	(sp),hl
56ff 56ff d c9
56ff 56ff s 	ret
5700 5700 s ;
5700 5700 s ;
5700 5700 d f5
5700 5700 s T5700:	push	af
5701 5701 d 3a06f3
5701 5701 s 	ld	a,(YF306)
5704 5704 d b7
5704 5704 s 	or	a			; CP/M compatible call
5705 5705 d 2804
5705 5705 s 	jr	z,A570B			; no, leave HL alone
5707 5707 d f1
5707 5707 s 	pop	af
5708 5708 d 6f
5708 5708 s 	ld	l,a
5709 5709 d 60
5709 5709 s 	ld	h,b			; CP/M compatible HL
570a 570a d c9
570a 570a s 	ret
570b 570b s ;
570b 570b d f1
570b 570b s A570B:	pop	af
570c 570c d c9
570c 570c s 	ret
570d 570d s ;
570d 570d s ;
570d 570d d a7404554a7536e547454655454546254
570d 570d s T570D:	defw	A40A7,A5445,A53A7,A546E,A5474,A5465,A5454,A5462
571d 571d d 4e54c9f1e0503c54ef419f50d5506244
571d 571d s 	defw	A544E,XF1C9,A50E0,A543C,A41EF,A509F,A50D5,A4462
572d 572d d 6f45b84f06506c4375477d471d469243
572d 572d s 	defw	A456F,A4FB8,A5006,A436C,A4775,A477D,A461D,A4392
573d 573d d 4e50c45058505d50d056d056d056d056
573d 573d s 	defw	A504E,A50C4,A5058,A505D,A56D0,A56D0,A56D0,A56D0
574d 574d d d056884793471e50c850d056be47b247
574d 574d s 	defw	A56D0,A4788,A4793,A501E,A50C8,A56D0,A47BE,A47B2
575d 575d d d147d0563c555255db55e655ff55ba46
575d 575d s 	defw	A47D1,A56D0,A553C,A5552,A55DB,A55E6,A55FF,A46BA
576d 576d d 2047
576d 576d s 	defw	A4720
576f 576f s 
576f 576f d cd1a74
576f 576f s A576F:	call	INIHRD			; initialize diskhardware
5772 5772 d f3
5772 5772 s 	di
5773 5773 d 3a99fd
5773 5773 s 	ld	a,(DEVICE)
5776 5776 d a7
5776 5776 s 	and	a			; abort disksystem init ?
5777 5777 d f8
5777 5777 s 	ret	m			; yep, quit
5778 5778 d c20c58
5778 5778 s 	jp	nz,A580C		; disksystem init already started by an other diskrom, skip init
577b 577b d 2120fb
577b 577b s 	ld	hl,HOKVLD
577e 577e d cb46
577e 577e s 	bit	0,(hl)			; EXTBIO hook valid ?
5780 5780 d 200c
5780 5780 s 	jr	nz,A578E
5782 5782 d cbc6
5782 5782 s 	set	0,(hl)
5784 5784 d 21caff
5784 5784 s 	ld	hl,EXTBIO
5787 5787 d 060f
5787 5787 s 	ld	b,00FH
5789 5789 d 36c9
5789 5789 s A5789:	ld	(hl),0C9H
578b 578b d 23
578b 578b s 	inc	hl
578c 578c d 10fb
578c 578c s 	djnz	A5789			; nop, init EXTBIO,DISINT and ENAINT hooks
578e 578e d 2a48fc
578e 578e s A578E:	ld	hl,(BOTTOM)
5791 5791 d 1101c0
5791 5791 s 	ld	de,0C001H
5794 5794 d e7
5794 5794 s 	rst	020H			; at least 16Kb RAM ?
5795 5795 d 300c
5795 5795 s 	jr	nc,A57A3		; nop, abort
5797 5797 d 3e06
5797 5797 s 	ld	a,006H
5799 5799 d cd4101
5799 5799 s 	call	SNSMAT
579c 579c d f3
579c 579c s 	di
579d 579d d 0f
579d 579d s 	rrca				; SHIFT key pressed ?
579e 579e d 3809
579e 579e s 	jr	c,A57A9			; nop, cont
57a0 57a0 d 3e07
57a0 57a0 s 	ld	a,007H
57a2 57a2 d df
57a2 57a2 s 	rst	018H			; beep
57a3 57a3 d 3eff
57a3 57a3 s A57A3:	ld	a,0FFH
57a5 57a5 d 3299fd
57a5 57a5 s 	ld	(DEVICE),a		; flag abort disksystem init
57a8 57a8 d c9
57a8 57a8 s 	ret
57a9 57a9 s ;
57a9 57a9 d 2181f3
57a9 57a9 s A57A9:	ld	hl,0F380H+MYSIZE
57ac 57ac d 11c9f1
57ac 57ac s 	ld	de,XF1C9
57af 57af d a7
57af 57af s 	and	a
57b0 57b0 d ed52
57b0 57b0 s 	sbc	hl,de
57b2 57b2 d d4fd5e
57b2 57b2 s 	call	nc,A5EE8		; allocate basic disksystem memory
57b5 57b5 d d8
57b5 57b5 s 	ret	c			; failed, quit
57b6 57b6 d e5
57b6 57b6 s A57B6:	push	hl
57b7 57b7 d 2149fe
57b7 57b7 s 	ld	hl,-439
57ba 57ba d 01c9f1
57ba 57ba s 	ld	bc,XF1C9
57bd 57bd d af
57bd 57bd s A57BD:	xor	a
57be 57be d 02
57be 57be s 	ld	(bc),a
57bf 57bf d 03
57bf 57bf s 	inc	bc
57c0 57c0 d 23
57c0 57c0 s 	inc	hl
57c1 57c1 d 7d
57c1 57c1 s 	ld	a,l
57c2 57c2 d b4
57c2 57c2 s 	or	h
57c3 57c3 d 20f8
57c3 57c3 s 	jr	nz,A57BD		; clear memory
57c5 57c5 d 22abf6
57c5 57c5 s 	ld	(AUTLIN),hl		; SECLEN sofar zero
57c8 57c8 d 0614
57c8 57c8 s 	ld	b,014H
57ca 57ca d 2121fb
57ca 57ca s 	ld	hl,YFB21
57cd 57cd d 77
57cd 57cd s A57CD:	ld	(hl),a
57ce 57ce d 23
57ce 57ce s 	inc	hl
57cf 57cf d 10fc
57cf 57cf s 	djnz	A57CD			; clear DRVTBL, DRVINT
57d1 57d1 d 214ff2
57d1 57d1 s 	ld	hl,XF24F
57d4 57d4 d 0669
57d4 57d4 s 	ld	b,069H
57d6 57d6 d 36c9
57d6 57d6 s A57D6:	ld	(hl),0C9H
57d8 57d8 d 23
57d8 57d8 s 	inc	hl
57d9 57d9 d 10fb
57d9 57d9 s 	djnz	A57D6			; init disksystem hooks
57db 57db d 3edb
57db 57db s 	ld	a,0DBH
57dd 57dd d 21a8c9
57dd 57dd s 	ld	hl,0C9A8H
57e0 57e0 d 3265f3
57e0 57e0 s 	ld	(XF365+0),a
57e3 57e3 d 2266f3
57e3 57e3 s 	ld	(XF365+1),hl
57e6 57e6 d 3e06
57e6 57e6 s 	ld	a,006H
57e8 57e8 d cd4101
57e8 57e8 s 	call	SNSMAT
57eb 57eb d e602
57eb 57eb s 	and	002H			; CTRL key pressed
57ed 57ed d 323ff3
57ed 57ed s 	ld	(YF33F),a		; saved for panthom drive
57f0 57f0 d 3e07
57f0 57f0 s 	ld	a,007H
57f2 57f2 d df
57f2 57f2 s 	rst	018H			; beep
57f3 57f3 d 210758
57f3 57f3 s 	ld	hl,T5807
57f6 57f6 d 11cbfe
57f6 57f6 s 	ld	de,H.RUNC
57f9 57f9 d 010500
57f9 57f9 s 	ld	bc,00005H
57fc 57fc d edb0
57fc 57fc s 	ldir
57fe 57fe d cd2d40
57fe 57fe s 	call	A402D
5801 5801 d 32ccfe
5801 5801 s 	ld	(H.RUNC+1),a		; init RUNC hook, to catch intialize interpeter
5804 5804 d d1
5804 5804 s 	pop	de			; base diskdriver workarea
5805 5805 d 181e
5805 5805 s 	jr	A5825
5807 5807 s ;
5807 5807 s ;
5807 5807 d f7
5807 5807 s T5807:	rst	030H
5808 5808 d 00
5808 5808 s 	defb	000H
5809 5809 d 9758
5809 5809 s 	defw	A5897
580b 580b d c9
580b 580b s 	ret
580c 580c s ;
580c 580c d 2121fb
580c 580c s A580C:	ld	hl,YFB21		; DRVTBL
580f 580f d 0604
580f 580f s 	ld	b,004H			; 4 diskroms
5811 5811 d af
5811 5811 s 	xor	a
5812 5812 d 86
5812 5812 s A5812:	add	a,(hl)
5813 5813 d dae15e
5813 5813 s 	jp	c,A5ECC			; invalid DRVTBL, error
5816 5816 d 23
5816 5816 s 	inc	hl
5817 5817 d 23
5817 5817 s 	inc	hl
5818 5818 d 10f8
5818 5818 s 	djnz	A5812
581a 581a d fe08
581a 581a s 	cp	008H			; 8 or more drives ?
581c 581c d d0
581c 581c s 	ret	nc			; yep, no more drives!
581d 581d d 210100
581d 581d s 	ld	hl,MYSIZE
5820 5820 d cdfd5e
5820 5820 s 	call	A5EE8			; allocate diskdriver workarea
5823 5823 d d8
5823 5823 s 	ret	c			; failed, quit
5824 5824 d eb
5824 5824 s 	ex	de,hl
5825 5825 d cde25f
5825 5825 s A5825:	call	A5FCD			; get my SLTWRK entry
5828 5828 d 73
5828 5828 s 	ld	(hl),e
5829 5829 d 23
5829 5829 s 	inc	hl
582a 582a d 72
582a 582a s 	ld	(hl),d			; save base workarea in SLTWRK
582b 582b d 2aabf6
582b 582b s 	ld	hl,(AUTLIN)
582e 582e d 110002
582e 582e s 	ld	de,SECLEN
5831 5831 d e7
5831 5831 s 	rst	020H			; SECLEN sofar big enough ?
5832 5832 d 3004
5832 5832 s 	jr	nc,A5838
5834 5834 d ed53abf6
5834 5834 s 	ld	(AUTLIN),de		; nop, adjust
5838 5838 d 1121fb
5838 5838 s A5838:	ld	de,YFB21		; DRVTBL
583b 583b d 010004
583b 583b s 	ld	bc,00400H		; 4 diskroms
583e 583e d 1a
583e 583e s A583E:	ld	a,(de)
583f 583f d a7
583f 583f s 	and	a
5840 5840 d 2809
5840 5840 s 	jr	z,A584B			; free entry, use it
5842 5842 d 81
5842 5842 s 	add	a,c
5843 5843 d 4f
5843 5843 s 	ld	c,a
5844 5844 d 13
5844 5844 s 	inc	de
5845 5845 d 13
5845 5845 s 	inc	de
5846 5846 d 10f6
5846 5846 s 	djnz	A583E			; next entry
5848 5848 d c3e15e
5848 5848 s 	jp	A5ECC			; none free, error
584b 584b s ;
584b 584b d 3a3ff3
584b 584b s A584B:	ld	a,(YF33F)
584e 584e d a7
584e 584e s 	and	a
584f 584f d 79
584f 584f s 	ld	a,c			; phantom flag
5850 5850 d cd7d74
5850 5850 s A5850:	call	DRIVES			; query no. of drives
5853 5853 d 85
5853 5853 s 	add	a,l
5854 5854 d fe09
5854 5854 s 	cp	009H
5856 5856 d 7d
5856 5856 s 	ld	a,l			; more as 8 drives ?
5857 5857 d 3803
5857 5857 s 	jr	c,A585C			; nop, ok
5859 5859 d 3e08
5859 5859 s 	ld	a,008H
585b 585b d 91
585b 585b s 	sub	c			; as much as possible
585c 585c d c5
585c 585c s A585C:	push	bc
585d 585d d 12
585d 585d s 	ld	(de),a			; save drives
585e 585e d 13
585e 585e s 	inc	de
585f 585f d cd2d40
585f 585f s 	call	A402D
5862 5862 d 12
5862 5862 s 	ld	(de),a			; save slotid diskrom
5863 5863 d c1
5863 5863 s 	pop	bc			; drivenumber
5864 5864 d 0600
5864 5864 s 	ld	b,000H
5866 5866 d 2155f3
5866 5866 s 	ld	hl,YF355
5869 5869 d 09
5869 5869 s 	add	hl,bc
586a 586a d 09
586a 586a s 	add	hl,bc			; DPBTBL
586b 586b d e5
586b 586b s 	push	hl
586c 586c d 1b
586c 586c s 	dec	de
586d 586d d 1a
586d 586d s 	ld	a,(de)
586e 586e d f5
586e 586e s 	push	af
586f 586f d 4f
586f 586f s 	ld	c,a			; drives
5870 5870 d 111500
5870 5870 s 	ld	de,00015H
5873 5873 d cd1649
5873 5873 s 	call	A4916			; * size of DPB
5876 5876 d 69
5876 5876 s 	ld	l,c
5877 5877 d 60
5877 5877 s 	ld	h,b
5878 5878 d cddd5e
5878 5878 s 	call	A5EC8			; allocate space for DPB's
587b 587b d eb
587b 587b s 	ex	de,hl
587c 587c d f1
587c 587c s 	pop	af
587d 587d d e1
587d 587d s 	pop	hl
587e 587e d 73
587e 587e s A587E:	ld	(hl),e
587f 587f d 23
587f 587f s 	inc	hl
5880 5880 d 72
5880 5880 s 	ld	(hl),d			; save in DPBTBL
5881 5881 d 23
5881 5881 s 	inc	hl
5882 5882 d e5
5882 5882 s 	push	hl
5883 5883 d 215a75
5883 5883 s 	ld	hl,DEFDPB
5886 5886 d 011500
5886 5886 s 	ld	bc,00015H
5889 5889 d edb0
5889 5889 s 	ldir				; initialize DPB
588b 588b d e1
588b 588b s 	pop	hl
588c 588c d 3d
588c 588c s 	dec	a
588d 588d d 20ef
588d 588d s 	jr	nz,A587E		; next drive
588f 588f d cd9c74
588f 588f s 	call	INIENV			; initialize driver workarea
5892 5892 d 2199fd
5892 5892 s 	ld	hl,DEVICE
5895 5895 d 34
5895 5895 s 	inc	(hl)			; increase diskdriver count
5896 5896 d c9
5896 5896 s 	ret
5897 5897 s 
5897 5897 s ;	  Subroutine H.RUNC interceptor
5897 5897 s ;	     Inputs  -
5897 5897 s ;	     Outputs -
5897 5897 s ;         Remark     Control is passed to this routine when the BASIC interpreter is initialized
5897 5897 s ;                    There are two ways: a BASIC program in ROM is started OR at the start of MSX-BASIC
5897 5897 s 
5897 5897 d 21cbfe
5897 5897 s A5897:	ld	hl,H.RUNC
589a 589a d 0605
589a 589a s 	ld	b,005H
589c 589c d 36c9
589c 589c s A589C:	ld	(hl),0C9H
589e 589e d 23
589e 589e s 	inc	hl
589f 589f d 10fb
589f 589f s 	djnz	A589C			; clear RUNC hook
58a1 58a1 d 2199fd
58a1 58a1 s 	ld	hl,DEVICE
58a4 58a4 d af
58a4 58a4 s 	xor	a
58a5 58a5 d be
58a5 58a5 s 	cp	(hl)
58a6 58a6 d 77
58a6 58a6 s 	ld	(hl),a			; clear
58a7 58a7 d f0
58a7 58a7 s 	ret	p			; already cleared, return control
58a8 58a8 d cd4262
58a8 58a8 s A58A8:	call	A622D			; hook H.LOPD when H.CLEA is hooked (for register system bottom)
58ab 58ab d 3248f3
58ab 58ab s 	ld	(YF348),a		; disksystem diskrom slotid
58ae 58ae d 21ac73
58ae 58ae s 	ld	hl,A7397
58b1 58b1 d 11c9f1
58b1 58b1 s 	ld	de,XF1C9
58b4 58b4 d 016e00
58b4 58b4 s 	ld	bc,0006EH
58b7 58b7 d edb0
58b7 58b7 s 	ldir
58b9 58b9 d 213400
58b9 58b9 s 	ld	hl,00034H
58bc 58bc d 110ff3
58bc 58bc s 	ld	de,YF30F
58bf 58bf d 010400
58bf 58bf s 	ld	bc,00004H
58c2 58c2 d edb0
58c2 58c2 s 	ldir				; initialize double byte header char table
58c4 58c4 d 3a2b00
58c4 58c4 s 	ld	a,(IDBYT0)
58c7 58c7 d 0f
58c7 58c7 s 	rrca
58c8 58c8 d 0f
58c8 58c8 s 	rrca
58c9 58c9 d 0f
58c9 58c9 s 	rrca
58ca 58ca d 0f
58ca 58ca s 	rrca
58cb 58cb d e607
58cb 58cb s 	and	007H
58cd 58cd d 320ef3
58cd 58cd s 	ld	(YF30E),a		; date format
58d0 58d0 d 3eff
58d0 58d0 s 	ld	a,0FFH
58d2 58d2 d 3241f2
58d2 58d2 s 	ld	(YF241),a		; invalid datasector buffer
58d5 58d5 d 3246f2
58d5 58d5 s 	ld	(YF246),a		; invalid directorysector buffer
58d8 58d8 d 324df2
58d8 58d8 s 	ld	(YF24C+1),a		; days since 1-1-1980 is 65280 (0FF00H) (somewhere in the year 2158), this is inpossible, so when no clockchip this is updated!
58db 58db d 3e0d
58db 58db s 	ld	a,00DH
58dd 58dd d 325bf5
58dd 58dd s 	ld	(KBUF+316),a		; ???
58e0 58e0 d 3e07
58e0 58e0 s 	ld	a,7
58e2 58e2 d 3245f3
58e2 58e2 s 	ld	(YF345),a		; max number of FCB´s is 7
58e5 58e5 d 21b505
58e5 58e5 s 	ld	hl,1461
58e8 58e8 d 223bf3
58e8 58e8 s 	ld	(YF33B),hl		; default date when no clockchip is 1-1-1984
58eb 58eb d 0608
58eb 58eb s 	ld	b,008H
58ed 58ed d 2168f3
58ed 58ed s 	ld	hl,XF368
58f0 58f0 d 36c3
58f0 58f0 s A58F0:	ld	(hl),0C3H
58f2 58f2 d 23
58f2 58f2 s 	inc	hl
58f3 58f3 d 23
58f3 58f3 s 	inc	hl
58f4 58f4 d 23
58f4 58f4 s 	inc	hl
58f5 58f5 d 10f9
58f5 58f5 s 	djnz	A58F0			; initialize diskvars
58f7 58f7 d 2aabf6
58f7 58f7 s 	ld	hl,(AUTLIN)
58fa 58fa d e5
58fa 58fa s 	push	hl
58fb 58fb d cddd5e
58fb 58fb s 	call	A5EC8
58fe 58fe d 224df3
58fe 58fe s 	ld	($SECBUF),hl		; allocate sectorbuffer
5901 5901 d e1
5901 5901 s 	pop	hl
5902 5902 d e5
5902 5902 s 	push	hl
5903 5903 d cddd5e
5903 5903 s 	call	A5EC8
5906 5906 d 224ff3
5906 5906 s 	ld	(YF34F),hl		; allocate datasector buffer
5909 5909 d e1
5909 5909 s 	pop	hl
590a 590a d cddd5e
590a 590a s 	call	A5EC8
590d 590d d 2251f3
590d 590d s 	ld	(YF351),hl		; allocate dirsector buffer
5910 5910 d 2121fb
5910 5910 s 	ld	hl,YFB21		; DRVTBL
5913 5913 d 0604
5913 5913 s 	ld	b,004H			; 4 diskroms
5915 5915 d af
5915 5915 s 	xor	a
5916 5916 d 86
5916 5916 s A5916:	add	a,(hl)
5917 5917 d dae15e
5917 5917 s 	jp	c,A5ECC			; invalid, error
591a 591a d 23
591a 591a s 	inc	hl
591b 591b d 23
591b 591b s 	inc	hl
591c 591c d 10f8
591c 591c s 	djnz	A5916
591e 591e d fe09
591e 591e s 	cp	009H			; more as 8 drives ?
5920 5920 d d2e15e
5920 5920 s 	jp	nc,A5ECC		; yep, error
5923 5923 d 3247f3
5923 5923 s 	ld	(YF347),a		; drives in system
5926 5926 d 47
5926 5926 s 	ld	b,a
5927 5927 d 0e00
5927 5927 s 	ld	c,000H
5929 5929 d 2155f3
5929 5929 s 	ld	hl,YF355
592c 592c d 5e
592c 592c s A592C:	ld	e,(hl)
592d 592d d 23
592d 592d s 	inc	hl
592e 592e d 56
592e 592e s 	ld	d,(hl)
592f 592f d 23
592f 592f s 	inc	hl
5930 5930 d e5
5930 5930 s 	push	hl
5931 5931 d d5
5931 5931 s 	push	de
5932 5932 d dde1
5932 5932 s 	pop	ix
5934 5934 d dd7100
5934 5934 s 	ld	(ix+000H),c		; set drivenumber in DPB
5937 5937 d 0c
5937 5937 s 	inc	c
5938 5938 d c5
5938 5938 s 	push	bc
5939 5939 d dd4e02
5939 5939 s 	ld	c,(ix+002H)
593c 593c d dd4603
593c 593c s 	ld	b,(ix+003H)		; sectorsize
593f 593f d dd5e10
593f 593f s 	ld	e,(ix+010H)
5942 5942 d 1600
5942 5942 s 	ld	d,0			; number of sectors per FAT
5944 5944 d cd1649
5944 5944 s 	call	A4916			; * FAT size
5947 5947 d 03
5947 5947 s 	inc	bc			; and a FAT flag
5948 5948 d 69
5948 5948 s 	ld	l,c
5949 5949 d 60
5949 5949 s 	ld	h,b
594a 594a d cddd5e
594a 594a s 	call	A5EC8			; allocate FAT buffer
594d 594d d 2249f3
594d 594d s 	ld	(YF349),hl		; base system bottom sofar
5950 5950 d 36ff
5950 5950 s 	ld	(hl),0FFH		; flag invalid FAT buffer
5952 5952 d 23
5952 5952 s 	inc	hl
5953 5953 d dd7513
5953 5953 s 	ld	(ix+013H),l
5956 5956 d dd7414
5956 5956 s 	ld	(ix+014H),h		; pointer to FAT buffer
5959 5959 d c1
5959 5959 s 	pop	bc
595a 595a d e1
595a 595a s 	pop	hl
595b 595b d 10cf
595b 595b s 	djnz	A592C			; next drive
595d 595d d 2127f3
595d 595d s 	ld	hl,XF327
5960 5960 d 363e
5960 5960 s 	ld	(hl),03EH
5962 5962 d 23
5962 5962 s 	inc	hl
5963 5963 d 361a
5963 5963 s 	ld	(hl),01AH
5965 5965 d 0608
5965 5965 s 	ld	b,008H
5967 5967 d 23
5967 5967 s A5967:	inc	hl
5968 5968 d 36c9
5968 5968 s 	ld	(hl),0C9H
596a 596a d 10fb
596a 596a s 	djnz	A5967
596c 596c d 2127f3
596c 596c s 	ld	hl,XF327
596f 596f d 2272f3
596f 596f s 	ld	(XF371+1),hl
5972 5972 d 212cf3
5972 5972 s 	ld	hl,XF32C
5975 5975 d 2275f3
5975 5975 s 	ld	(XF374+1),hl
5978 5978 d 2131f3
5978 5978 s 	ld	hl,XF331
597b 597b d 227ef3
597b 597b s 	ld	(XF37D+1),hl
597e 597e d 212f7d
597e 597e s 	ld	hl,BASSCR
5981 5981 d 3ac1fc
5981 5981 s 	ld	a,(EXPTBL+0)
5984 5984 d cd0c00
5984 5984 s 	call	RDSLT
5987 5987 d f5
5987 5987 s 	push	af
5988 5988 d 23
5988 5988 s 	inc	hl
5989 5989 d 3ac1fc
5989 5989 s 	ld	a,(EXPTBL+0)
598c 598c d cd0c00
598c 598c s 	call	RDSLT
598f 598f d d1
598f 598f s 	pop	de
5990 5990 d 67
5990 5990 s 	ld	h,a
5991 5991 d 6a
5991 5991 s 	ld	l,d
5992 5992 d e5
5992 5992 s 	push	hl
5993 5993 d dde1
5993 5993 s 	pop	ix
5995 5995 d fd2ac0fc
5995 5995 s 	ld	iy,(EXPTBL-1+0)
5999 5999 d cd1c00
5999 5999 s 	call	CALSLT			; setup startup screen
599c 599c d cdb840
599c 599c s 	call	A40B8			; check for and initialize clockchip
599f 599f d cd835c
599f 599f s 	call	A5C6E			; initialize hooks
59a2 59a2 d 3ac1fc
59a2 59a2 s 	ld	a,(EXPTBL+0)
59a5 59a5 d 3241f3
59a5 59a5 s 	ld	(RAMAD0),a
59a8 59a8 d 3242f3
59a8 59a8 s 	ld	(RAMAD1),a		; assume no ram available for page 0 and 1
59ab 59ab d cdad5f
59ab 59ab s 	call	A5F98
59ae 59ae d 3243f3
59ae 59ae s 	ld	(RAMAD2),a		; slotid of current page 2
59b1 59b1 d cdaa5f
59b1 59b1 s 	call	A5F95
59b4 59b4 d 3244f3
59b4 59b4 s 	ld	(RAMAD3),a		; slotid of current page 3
59b7 59b7 d 0e00
59b7 59b7 s 	ld	c,000H
59b9 59b9 d cd675e
59b9 59b9 s 	call	A5E52			; search ram in page 0
59bc 59bc d 3803
59bc 59bc s 	jr	c,A59C1
59be 59be d 3241f3
59be 59be s 	ld	(RAMAD0),a		; found, set ram slotid page 0
59c1 59c1 d 0e40
59c1 59c1 s A59C1:	ld	c,040H
59c3 59c3 d cd675e
59c3 59c3 s 	call	A5E52			; search ram in page 1
59c6 59c6 d 3803
59c6 59c6 s 	jr	c,A59CB
59c8 59c8 d 3242f3
59c8 59c8 s 	ld	(RAMAD1),a		; found, set ram slotid page 1
59cb 59cb d 3100c2
59cb 59cb s A59CB:	ld	sp,0C200H		; stack just above temp startbuffer
59ce 59ce d 3adafe
59ce 59ce s 	ld	a,(H.STKE+0)
59d1 59d1 d fec9
59d1 59d1 s 	cp	0C9H			; STKE hook set ?
59d3 59d3 d 2806
59d3 59d3 s 	jr	z,A59DB			; nop, cont
59d5 59d5 d dd21177d
59d5 59d5 s 	ld	ix,SKPROM
59d9 59d9 d 1812
59d9 59d9 s 	jr	A59ED			; skip BASIC extension ROMs and transfer control
59db 59db s ;
59db 59db d 21c9fc
59db 59db s A59DB:	ld	hl,SLTATR
59de 59de d 0640
59de 59de s 	ld	b,040H
59e0 59e0 d 7e
59e0 59e0 s A59E0:	ld	a,(hl)
59e1 59e1 d 87
59e1 59e1 s 	add	a,a			; TEXT extension ?
59e2 59e2 d 3805
59e2 59e2 s 	jr	c,A59E9			; yep, start it
59e4 59e4 d 23
59e4 59e4 s 	inc	hl
59e5 59e5 d 10f9
59e5 59e5 s 	djnz	A59E0
59e7 59e7 d 180a
59e7 59e7 s 	jr	A59F3			; no TEXT extension ROM found,
59e9 59e9 s ;
59e9 59e9 d dd21147e
59e9 59e9 s A59E9:	ld	ix,RSTCLR		; start BASIC program in ROM
59ed 59ed d cd2b5c
59ed 59ed s A59ED:	call	A5C16			; initialize diskbasic
59f0 59f0 d c35901
59f0 59f0 s 	jp	CALBAS
59f3 59f3 s ;
59f3 59f3 d 213a5b
59f3 59f3 s A59F3:	ld	hl,A5B3A
59f6 59f6 d e5
59f6 59f6 s 	push	hl			; if quit anywhere start diskbasic
59f7 59f7 d cd0365
59f7 59f7 s 	call	ABOOT			; NEW: READ BOOTSECTOR FROM ANY DRIVE
59fa 59fa d d8
59fa 59fa s 	ret	c			; failed, start diskbasic
59fb 59fb d cd7e5a
59fb 59fb s 	call	A5ADB			; start bootcode with Cx reset (some disk can take control from here)
59fe 59fe d 2a48fc
59fe 59fe s 	ld	hl,(BOTTOM)
5a01 5a01 d 110080
5a01 5a01 s 	ld	de,08000H
5a04 5a04 d e7
5a04 5a04 s 	rst	020H			; check if ram on both page 3 and 2
5a05 5a05 d c0
5a05 5a05 s 	ret	nz			; nope, start diskbasic
5a06 5a06 d 2141f3
5a06 5a06 s 	ld	hl,RAMAD0
5a09 5a09 d 3ac1fc
5a09 5a09 s 	ld	a,(EXPTBL+0)
5a0c 5a0c d be
5a0c 5a0c s 	cp	(hl)
5a0d 5a0d d c8
5a0d 5a0d s 	ret	z			; no ram available on page 0, start diskbasic
5a0e 5a0e d 23
5a0e 5a0e s 	inc	hl
5a0f 5a0f d be
5a0f 5a0f s 	cp	(hl)
5a10 5a10 d c8
5a10 5a10 s 	ret	z			; no ram available on page 1, start diskbasic
5a11 5a11 s ;
5a11 5a11 s ; MSXDOS requirement are met, try starting it
5a11 5a11 s ;
5a11 5a11 s ; CHANGED TO CREATE ROOM FOR NEW CODE
5a11 5a11 s ; Init procedure simplified, but code is compatible
5a11 5a11 s ;
5a11 5a11 s A5A11:
5a11 5a11 s 
5a11 5a11 s ; start of orginal code
5a11 5a11 s 
5a11 5a11 s 
5a11 5a11 s 
5a11 5a11 s 
5a11 5a11 s ; start of updated code
5a11 5a11 s 
5a11 5a11 d 3a47f2
5a11 5a11 s 	ld	a,(YF247)		; NEW: _SYSTEM FROM DEFAULT DRIVE
5a14 5a14 d cdaf60
5a14 5a14 s 	call	A609A			; mark FAT buffer of default drive as invalid
5a17 5a17 d 2a49f3
5a17 5a17 s 	ld	hl,(YF349)
5a1a 5a1a d 224bf3
5a1a 5a1a s 	ld	(YF34B),hl		; set MSXDOS system bottom to base system bottom
5a1d 5a1d d cda75a
5a1d 5a1d s 	call	A5AE7			; read bootsector from the default drive
5a20 5a20 d da3a5b
5a20 5a20 s 	jp	c,A5B3A			; error reading bootsector or bootsector non-bootable
5a23 5a23 d 3246f3
5a23 5a23 s 	ld	(YF346),a		; bootable disk, flag CALL SYSTEM is valid
5a26 5a26 d 3a41f3
5a26 5a26 s 	ld	a,(RAMAD0)
5a29 5a29 d 2600
5a29 5a29 s 	ld	h,000H
5a2b 5a2b d cd3664
5a2b 5a2b s 	call	A649C			; enable ram on page 0 (649C works because RAM is in one slot!)
5a2e 5a2e d af
5a2e 5a2e s 	xor	a
5a2f 5a2f d 6f
5a2f 5a2f s 	ld	l,a
5a30 5a30 d 67
5a30 5a30 s 	ld	h,a
5a31 5a31 d 77
5a31 5a31 s A5A36:	ld	(hl),a
5a32 5a32 d 2c
5a32 5a32 s 	inc	l
5a33 5a33 d 20fc
5a33 5a33 s 	jr	nz,A5A36		; clear 0000H-00FFH
5a35 5a35 d 21e964
5a35 5a35 s 	ld	hl,A655C
5a38 5a38 d 113b00
5a38 5a38 s 	ld	de,X003B
5a3b 5a3b d 011a00
5a3b 5a3b s 	ld	bc,0001AH
5a3e 5a3e d edb0
5a3e 5a3e s 	ldir				; copy slotswitching code at 003BH
5a40 5a40 d 019c01
5a40 5a40 s 	ld	bc,LDOSR		; total count
5a43 5a43 d cdc25e
5a43 5a43 s 	call	A5EAD			; allocate MSXDOS memory
5a46 5a46 d e5
5a46 5a46 s 	push	hl
5a47 5a47 d eb
5a47 5a47 s 	ex	de,hl
5a48 5a48 d 214d63
5a48 5a48 s 	ld	hl,A6336		; routines in ROM
5a4b 5a4b d e5
5a4b 5a4b s 	push	hl
5a4c 5a4c d edb0
5a4c 5a4c s 	ldir				; copy interrupt/slotswitching routines
5a4e 5a4e d c1
5a4e 5a4e s 	pop	bc
5a4f 5a4f d e1
5a4f 5a4f s 	pop	hl
5a50 5a50 d e5
5a50 5a50 s 	push	hl
5a51 5a51 d b7
5a51 5a51 s 	or	a
5a52 5a52 d ed42
5a52 5a52 s 	sbc	hl,bc
5a54 5a54 d 113963
5a54 5a54 s 	ld	de,T632E		; relocate info
5a57 5a57 d cd1b63
5a57 5a57 s 	call	A6306			; relocate code
5a5a 5a5a d 218a5a
5a5a 5a5a s 	ld	hl,T5B0F		; jumptable
5a5d 5a5d d 5e
5a5d 5a5d s A5A84:	ld	e,(hl)
5a5e 5a5e d 23
5a5e 5a5e s 	inc	hl
5a5f 5a5f d 56
5a5f 5a5f s 	ld	d,(hl)			; adres jumpentry
5a60 5a60 d 23
5a60 5a60 s 	inc	hl
5a61 5a61 d 7b
5a61 5a61 s 	ld	a,e
5a62 5a62 d b2
5a62 5a62 s 	or	d
5a63 5a63 d 2811
5a63 5a63 s 	jr	z,A5A98			; end of table
5a65 5a65 d 4e
5a65 5a65 s 	ld	c,(hl)
5a66 5a66 d 23
5a66 5a66 s 	inc	hl
5a67 5a67 d 0600
5a67 5a67 s 	ld	b,0			; offset
5a69 5a69 d e3
5a69 5a69 s 	ex	(sp),hl			; previous routine adres
5a6a 5a6a d 09
5a6a 5a6a s 	add	hl,bc
5a6b 5a6b d eb
5a6b 5a6b s 	ex	de,hl
5a6c 5a6c d 36c3
5a6c 5a6c s 	ld	(hl),0C3h
5a6e 5a6e d 23
5a6e 5a6e s 	inc	hl
5a6f 5a6f d 73
5a6f 5a6f s 	ld	(hl),e
5a70 5a70 d 23
5a70 5a70 s 	inc	hl
5a71 5a71 d 72
5a71 5a71 s 	ld	(hl),d
5a72 5a72 d eb
5a72 5a72 s 	ex	de,hl			; make jumpentry
5a73 5a73 d e3
5a73 5a73 s 	ex	(sp),hl
5a74 5a74 d 18e7
5a74 5a74 s 	jr	A5A84			; next entry
5a76 5a76 d e1
5a76 5a76 s A5A98:	pop	hl
5a77 5a77 d 01a000
5a77 5a77 s 	ld	bc,000A0H		; temporary stackspace for KEYINT
5a7a 5a7a d cdc25e
5a7a 5a7a s 	call	A5EAD			; allocate MSXDOS memory
5a7d 5a7d d 37
5a7d 5a7d s 	scf				; start bootcode with Cx set
5a7e 5a7e d 2123f3
5a7e 5a7e s A5ADB:	ld	hl,YF323		; adres diskerror handler pointer
5a81 5a81 d 1168f3
5a81 5a81 s 	ld	de,XF368
5a84 5a84 d 3a40f3
5a84 5a84 s 	ld	a,(YF340)		; cold boot flag
5a87 5a87 d c31ec0
5a87 5a87 s 	jp	YC000+01EH		; start bootsector code
5a8a 5a8a s 
5a8a 5a8a d 3800
5a8a 5a8a s T5B0F:	defw	KEYINT
5a8c 5a8c d 00
5a8c 5a8c s 	defb	A6336-A6336
5a8d 5a8d d 0c00
5a8d 5a8d s 	defw	RDSLT
5a8f 5a8f d 45
5a8f 5a8f s 	defb	A63F4-A6336
5a90 5a90 d 1400
5a90 5a90 s 	defw	WRSLT
5a92 5a92 d 1b
5a92 5a92 s 	defb	A6415-A63F4
5a93 5a93 d 3000
5a93 5a93 s 	defw	CALLF
5a95 5a95 d 2f
5a95 5a95 s 	defb	A6443-A6415
5a96 5a96 d 1c00
5a96 5a96 s 	defw	CALSLT
5a98 5a98 d 12
5a98 5a98 s 	defb	A6455-A6443
5a99 5a99 d 2400
5a99 5a99 s 	defw	ENASLT
5a9b 5a9b d 48
5a9b 5a9b s 	defb	A649C-A6455
5a9c 5a9c d 68f3
5a9c 5a9c s 	defw	XF368
5a9e 5a9e d 76
5a9e 5a9e s 	defb	A63A1-A649C
5a9f 5a9f d 6bf3
5a9f 5a9f s 	defw	XF36B
5aa1 5aa1 d 06
5aa1 5aa1 s 	defb	A63A3-A63A1
5aa2 5aa2 d 6ef3
5aa2 5aa2 s 	defw	XFER
5aa4 5aa4 d 11
5aa4 5aa4 s 	defb	A637B-A63A3
5aa5 5aa5 d 0000
5aa5 5aa5 s 	defw	0
5aa7 5aa7 s ;
5aa7 5aa7 s ; CHANGED: READ BOOTSECTOR FROM DEFAULT DRIVE
5aa7 5aa7 s ;
5aa7 5aa7 d 3a47f2
5aa7 5aa7 s A5AE7:	ld	a,(YF247)
5aaa 5aaa d b7
5aaa 5aaa s 	or	a
5aab 5aab d f5
5aab 5aab s 	push	af
5aac 5aac d 87
5aac 5aac s 	add	a,a
5aad 5aad d 5f
5aad 5aad s 	ld	e,a
5aae 5aae d 1600
5aae 5aae s 	ld	d,0
5ab0 5ab0 d 2155f3
5ab0 5ab0 s 	ld	hl,YF355
5ab3 5ab3 d 19
5ab3 5ab3 s 	add	hl,de
5ab4 5ab4 d 7e
5ab4 5ab4 s 	ld	a,(hl)
5ab5 5ab5 d 23
5ab5 5ab5 s 	inc	hl
5ab6 5ab6 d 66
5ab6 5ab6 s 	ld	h,(hl)
5ab7 5ab7 d 6f
5ab7 5ab7 s 	ld	l,a			; pointer to DPB
5ab8 5ab8 d f1
5ab8 5ab8 s 	pop	af
5ab9 5ab9 d 23
5ab9 5ab9 s 	inc	hl
5aba 5aba d 4e
5aba 5aba s 	ld	c,(hl)
5abb 5abb d 0601
5abb 5abb s 	ld	b,001H
5abd 5abd d 2a51f3
5abd 5abd s 	ld	hl,(YF351)		; temporary use dirsector buffer
5ac0 5ac0 d e5
5ac0 5ac0 s 	push	hl
5ac1 5ac1 d 110000
5ac1 5ac1 s 	ld	de,0
5ac4 5ac4 d cd4401
5ac4 5ac4 s 	call	PHYDIO
5ac7 5ac7 d 3eff
5ac7 5ac7 s 	ld	a,0FFH
5ac9 5ac9 d 3246f2
5ac9 5ac9 s 	ld	(YF246),a		; invalid dirsector buffer
5acc 5acc d e1
5acc 5acc s 	pop	hl
5acd 5acd d d8
5acd 5acd s 	ret	c
5ace 5ace d 7e
5ace 5ace s 	ld	a,(hl)
5acf 5acf d 1100c0
5acf 5acf s 	ld	de,YC000
5ad2 5ad2 d 010001
5ad2 5ad2 s 	ld	bc,00100H
5ad5 5ad5 d edb0
5ad5 5ad5 s 	ldir
5ad7 5ad7 d feeb
5ad7 5ad7 s 	cp	0EBH
5ad9 5ad9 d c8
5ad9 5ad9 s 	ret	z
5ada 5ada d fee9
5ada 5ada s 	cp	0E9H
5adc 5adc d c8
5adc 5adc s 	ret	z
5add 5add d 37
5add 5add s 	scf
5ade 5ade d c9
5ade 5ade s 	ret
5adf 5adf s ;
5adf 5adf s ; ROOM CREATED BY CHANGE IS FILLED WITH NOPS
5adf 5adf s ; TO KEEP FOLLOWING CODE AT SAME ADDRESSES
5adf 5adf s ;
5adf 5adf s 	defs	05B1AH-05A11H-($-A5A11),0
5adf 5adf d 00000000000000000000000000000000
5aef 5aef d 00000000000000000000000000000000
5aff 5aff d 00000000000000000000000000000000
5b0f 5b0f d 0000000000000000000000
5b1a 5b1a s ;
5b1a 5b1a s ; END OF CHANGE
5b1a 5b1a s ;
5b1a 5b1a s 
5b1a 5b1a d 004155544f4558454342415300
5b1a 5b1a s T5B1A:	defb	0,"AUTOEXECBAS",0
5b27 5b27 s 
5b27 5b27 d 52554e224155544f455845432e42415300
5b27 5b27 s T5B27:	defb	'RUN"AUTOEXEC.BAS',0
5b38 5b38 s 
5b38 5b38 d 925b
5b38 5b38 s T5B38:	defw	A5B92
5b3a 5b3a s 
5b3a 5b3a s ; Start diskbasic
5b3a 5b3a s ;
5b3a 5b3a s ;
5b3a 5b3a s 
5b3a 5b3a d cd755c
5b3a 5b3a s A5B3A:	call	A5C60			; disable XFER,ENARAM,ENAKRN routines
5b3d 5b3d d 21275b
5b3d 5b3d s 	ld	hl,T5B27
5b40 5b40 d 1168f5
5b40 5b40 s 	ld	de,BUF+10
5b43 5b43 d 011100
5b43 5b43 s 	ld	bc,00011H
5b46 5b46 d edb0
5b46 5b46 s 	ldir
5b48 5b48 d 2140f3
5b48 5b48 s 	ld	hl,YF340
5b4b 5b4b d 7e
5b4b 5b4b s 	ld	a,(hl)
5b4c 5b4c d a7
5b4c 5b4c s 	and	a
5b4d 5b4d d 74
5b4d 5b4d s 	ld	(hl),h			; next boot is a warm boot
5b4e 5b4e d 201e
5b4e 5b4e s 	jr	nz,A5B6E		; this was a warm boot, no need to start autoexec.bas
5b50 5b50 d 3246f3
5b50 5b50 s 	ld	(YF346),a		; this was a cold boot, flag CALL SYSTEM invalid
5b53 5b53 d 21385b
5b53 5b53 s 	ld	hl,T5B38
5b56 5b56 d 2223f3
5b56 5b56 s 	ld	(YF323),hl		; setup disk errorhandler
5b59 5b59 d 211a5b
5b59 5b59 s 	ld	hl,T5B1A
5b5c 5b5c d 1179f5
5b5c 5b5c s 	ld	de,BUF+27
5b5f 5b5f d 012500
5b5f 5b5f s 	ld	bc,00025H
5b62 5b62 d d5
5b62 5b62 s 	push	de
5b63 5b63 d edb0
5b63 5b63 s 	ldir				; setup FCB for autoexec.bas
5b65 5b65 d d1
5b65 5b65 s 	pop	de
5b66 5b66 d cd6244
5b66 5b66 s 	call	A4462			; open FCB
5b69 5b69 d 3c
5b69 5b69 s 	inc	a
5b6a 5b6a d 2826
5b6a 5b6a s 	jr	z,A5B92			; error,
5b6c 5b6c d 1832
5b6c 5b6c s 	jr	A5BA0
5b6e 5b6e s ;
5b6e 5b6e d 3a0000
5b6e 5b6e s A5B6E:	ld	a,(WBOOT)
5b71 5b71 d fec3
5b71 5b71 s 	cp	0C3H
5b73 5b73 d 2027
5b73 5b73 s 	jr	nz,A5B9C		; diskbasic not started from MSXDOS, just start diskbasic
5b75 5b75 d 218000
5b75 5b75 s 	ld	hl,00080H
5b78 5b78 d 46
5b78 5b78 s 	ld	b,(hl)
5b79 5b79 d 04
5b79 5b79 s 	inc	b
5b7a 5b7a d 05
5b7a 5b7a s 	dec	b
5b7b 5b7b d 281f
5b7b 5b7b s 	jr	z,A5B9C			; no parameter specified (after the BASIC command), just start diskbasic
5b7d 5b7d d 23
5b7d 5b7d s A5B7D:	inc	hl
5b7e 5b7e d 7e
5b7e 5b7e s 	ld	a,(hl)
5b7f 5b7f d fe20
5b7f 5b7f s 	cp	" "
5b81 5b81 d 2004
5b81 5b81 s 	jr	nz,A5B87
5b83 5b83 d 10f8
5b83 5b83 s 	djnz	A5B7D			; remove spaces in front
5b85 5b85 d 1815
5b85 5b85 s 	jr	A5B9C			; no parameter specified, just start diskbasic
5b87 5b87 s ;
5b87 5b87 d af
5b87 5b87 s A5B87:	xor	a
5b88 5b88 d 48
5b88 5b88 s 	ld	c,b
5b89 5b89 d 47
5b89 5b89 s 	ld	b,a
5b8a 5b8a d 116cf5
5b8a 5b8a s 	ld	de,BUF+14
5b8d 5b8d d edb0
5b8d 5b8d s 	ldir				; copy file name after the RUN" at BUF+10
5b8f 5b8f d 12
5b8f 5b8f s 	ld	(de),a			; and a end of line marker
5b90 5b90 d 180e
5b90 5b90 s 	jr	A5BA0
5b92 5b92 s ;
5b92 5b92 d 3100c2
5b92 5b92 s A5B92:	ld	sp,0C200H
5b95 5b95 d 3a38f3
5b95 5b95 s 	ld	a,(YF338)
5b98 5b98 d a7
5b98 5b98 s 	and	a
5b99 5b99 d cc545d
5b99 5b99 s 	call	z,A5D3F			; no clockchip, ask the date
5b9c 5b9c d af
5b9c 5b9c s A5B9C:	xor	a
5b9d 5b9d d 326bf5
5b9d 5b9d s 	ld	(BUF+13),a		; make it a ordinary RUN at BUF+10
5ba0 5ba0 d 3100c2
5ba0 5ba0 s A5BA0:	ld	sp,0C200H
5ba3 5ba3 d 3a43f3
5ba3 5ba3 s 	ld	a,(RAMAD2)
5ba6 5ba6 d 2680
5ba6 5ba6 s 	ld	h,080H
5ba8 5ba8 d cd2400
5ba8 5ba8 s 	call	ENASLT			; ram on page 2
5bab 5bab d 3ac1fc
5bab 5bab s 	ld	a,(EXPTBL+0)
5bae 5bae d 2600
5bae 5bae s 	ld	h,000H
5bb0 5bb0 d cd2400
5bb0 5bb0 s 	call	ENASLT			; rom-bios on page 0
5bb3 5bb3 d 2a48fc
5bb3 5bb3 s 	ld	hl,(BOTTOM)
5bb6 5bb6 d af
5bb6 5bb6 s 	xor	a
5bb7 5bb7 d 77
5bb7 5bb7 s 	ld	(hl),a			; before the program always a end of line marker
5bb8 5bb8 d 23
5bb8 5bb8 s 	inc	hl
5bb9 5bb9 d 2276f6
5bb9 5bb9 s 	ld	(TXTTAB),hl		; start of basictext space
5bbc 5bbc d 77
5bbc 5bbc s 	ld	(hl),a
5bbd 5bbd d 23
5bbd 5bbd s 	inc	hl
5bbe 5bbe d 77
5bbe 5bbe s 	ld	(hl),a			; end of program marker
5bbf 5bbf d 23
5bbf 5bbf s 	inc	hl
5bc0 5bc0 d 22c2f6
5bc0 5bc0 s 	ld	(VARTAB),hl		; start of the variablespace
5bc3 5bc3 d 21ffff
5bc3 5bc3 s 	ld	hl,0FFFFH
5bc6 5bc6 d 221cf4
5bc6 5bc6 s 	ld	(CURLIN),hl		; interpeter in direct mode
5bc9 5bc9 d cd2b5c
5bc9 5bc9 s 	call	A5C16			; initialize diskbasic
5bcc 5bcc d ed7b74f6
5bcc 5bcc s 	ld	sp,(STKTOP)
5bd0 5bd0 d 3eff
5bd0 5bd0 s 	ld	a,0FFH
5bd2 5bd2 d 32def3
5bd2 5bd2 s 	ld	(CNSDFG),a		; enable function keys
5bd5 5bd5 d 3e0c
5bd5 5bd5 s 	ld	a,00CH
5bd7 5bd7 d df
5bd7 5bd7 s 	rst	018H			; clear screen
5bd8 5bd8 d dd21317d
5bd8 5bd8 s 	ld	ix,TXTINI
5bdc 5bdc d cd5901
5bdc 5bdc s 	call	CALBAS			; setup basic startup screen
5bdf 5bdf d cd9b5f
5bdf 5bdf s 	call	A5F86
5be2 5be2 d 0d0a
5be2 5be2 s 	defb	13,10
5be4 5be4 d 4469736b2042415349432076657273696f6e20312e300d0a
5be4 5be4 s     defb    "Disk BASIC version 1.0",13,10
5bfc 5bfc d 4d53585069204472697665722076302e382e310d0a00
5bfc 5bfc s     defb    "MSXPi Driver v0.8.1",13,10,0
5c12 5c12 d 217341
5c12 5c12 s 	ld	hl,M.4173
5c15 5c15 d e5
5c15 5c15 s 	push	hl			; after the RUN command completes
5c16 5c16 d 2167f5
5c16 5c16 s 	ld	hl,BUF+9
5c19 5c19 d e5
5c19 5c19 s 	push	hl
5c1a 5c1a d 219ef5
5c1a 5c1a s 	ld	hl,BUF+64
5c1d 5c1d d e5
5c1d 5c1d s 	push	hl
5c1e 5c1e d 36e1
5c1e 5c1e s 	ld	(hl),0E1H
5c20 5c20 d 23
5c20 5c20 s 	inc	hl
5c21 5c21 d 36c9
5c21 5c21 s 	ld	(hl),0C9H		; pop the basicpointer when returning
5c23 5c23 d 3ac1fc
5c23 5c23 s 	ld	a,(EXPTBL+0)
5c26 5c26 d 2640
5c26 5c26 s 	ld	h,040H
5c28 5c28 d c32400
5c28 5c28 s 	jp	ENASLT			; enable basic-rom on page 1
5c2b 5c2b s 
5c2b 5c2b d 21c372
5c2b 5c2b s A5C16:	ld	hl,T72AE
5c2e 5c2e d 2223f3
5c2e 5c2e s 	ld	(YF323),hl		; setup diskerror handler
5c31 5c31 d 21815c
5c31 5c31 s 	ld	hl,T5C6C
5c34 5c34 d 2225f3
5c34 5c34 s 	ld	(YF325),hl		; setup abort handler
5c37 5c37 d 2a49f3
5c37 5c37 s 	ld	hl,(YF349)
5c3a 5c3a d 224afc
5c3a 5c3a s 	ld	(HIMEM),hl
5c3d 5c3d d 3a45f3
5c3d 5c3d s 	ld	a,(YF345)
5c40 5c40 d 4f
5c40 5c40 s 	ld	c,a
5c41 5c41 d 0600
5c41 5c41 s 	ld	b,000H			; number of FCB´s
5c43 5c43 d 112500
5c43 5c43 s 	ld	de,37
5c46 5c46 d cd1649
5c46 5c46 s 	call	A4916			; * 37
5c49 5c49 d cdcd5e
5c49 5c49 s 	call	A5EB8			; allocate basic memory
5c4c 5c4c d 2253f3
5c4c 5c4c s 	ld	(YF353),hl
5c4f 5c4f d 011900
5c4f 5c4f s 	ld	bc,25
5c52 5c52 d cdcd5e
5c52 5c52 s 	call	A5EB8			; allocate basic memory
5c55 5c55 d 2278f3
5c55 5c55 s 	ld	(XF377+1),hl
5c58 5c58 d eb
5c58 5c58 s 	ex	de,hl
5c59 5c59 d 210263
5c59 5c59 s 	ld	hl,T62ED
5c5c 5c5c d edb0
5c5c 5c5c s 	ldir				; copy bsave/bload patch code
5c5e 5c5e d 21f5ff
5c5e 5c5e s 	ld	hl,0FFF5H
5c61 5c61 d 19
5c61 5c61 s 	add	hl,de
5c62 5c62 d 227bf3
5c62 5c62 s 	ld	(XF37A+1),hl
5c65 5c65 d 3a48f3
5c65 5c65 s 	ld	a,(YF348)
5c68 5c68 d 11f9ff
5c68 5c68 s 	ld	de,0FFF9H
5c6b 5c6b d 19
5c6b 5c6b s 	add	hl,de
5c6c 5c6c d 77
5c6c 5c6c s 	ld	(hl),a
5c6d 5c6d d 110e00
5c6d 5c6d s 	ld	de,0000EH
5c70 5c70 d 19
5c70 5c70 s 	add	hl,de
5c71 5c71 d 77
5c71 5c71 s 	ld	(hl),a
5c72 5c72 d cd745f
5c72 5c72 s 	call	A5F5F			; setup io channels
5c75 5c75 s 					; disable XFER..
5c75 5c75 d 3ec9
5c75 5c75 s A5C60:	ld	a,0C9H
5c77 5c77 d 3268f3
5c77 5c77 s A5C62:	ld	(XF368+0),a
5c7a 5c7a d 326bf3
5c7a 5c7a s 	ld	(XF36B+0),a
5c7d 5c7d d 326ef3
5c7d 5c7d s 	ld	(XFER+0),a
5c80 5c80 d c9
5c80 5c80 s 	ret
5c81 5c81 s ;
5c81 5c81 s ;
5c81 5c81 d a740
5c81 5c81 s T5C6C:	defw	A40A7
5c83 5c83 s 
5c83 5c83 d 21fd62
5c83 5c83 s A5C6E:	ld	hl,T62E8
5c86 5c86 d 11bcfe
5c86 5c86 s 	ld	de,H.POSD
5c89 5c89 d 010500
5c89 5c89 s 	ld	bc,00005H
5c8c 5c8c d edb0
5c8c 5c8c s 	ldir
5c8e 5c8e d 21ab5c
5c8e 5c8e s 	ld	hl,T5C96
5c91 5c91 d 5e
5c91 5c91 s A5C7C:	ld	e,(hl)
5c92 5c92 d 23
5c92 5c92 s 	inc	hl
5c93 5c93 d 56
5c93 5c93 s 	ld	d,(hl)
5c94 5c94 d 23
5c94 5c94 s 	inc	hl
5c95 5c95 d 7b
5c95 5c95 s 	ld	a,e
5c96 5c96 d b2
5c96 5c96 s 	or	d
5c97 5c97 d c8
5c97 5c97 s 	ret	z
5c98 5c98 d eb
5c98 5c98 s 	ex	de,hl
5c99 5c99 d 36f7
5c99 5c99 s 	ld	(hl),0F7H
5c9b 5c9b d 23
5c9b 5c9b s 	inc	hl
5c9c 5c9c d 3a48f3
5c9c 5c9c s 	ld	a,(YF348)
5c9f 5c9f d 77
5c9f 5c9f s 	ld	(hl),a
5ca0 5ca0 d 23
5ca0 5ca0 s 	inc	hl
5ca1 5ca1 d eb
5ca1 5ca1 s 	ex	de,hl
5ca2 5ca2 d eda0
5ca2 5ca2 s 	ldi
5ca4 5ca4 d eda0
5ca4 5ca4 s 	ldi
5ca6 5ca6 d 3ec9
5ca6 5ca6 s 	ld	a,0C9H
5ca8 5ca8 d 12
5ca8 5ca8 s 	ld	(de),a
5ca9 5ca9 d 18e6
5ca9 5ca9 s 	jr	A5C7C
5cab 5cab s ;
5cab 5cab s ;
5cab 5cab d effdab6b
5cab 5cab s T5C96:	defw	H.DSKO,A6B96
5caf 5caf d 17fe8a6b
5caf 5caf s 	defw	H.DSKI,A6B75
5cb3 5cb3 d f9fd356f
5cb3 5cb3 s 	defw	H.NAME,A6F20
5cb7 5cb7 d fefd156f
5cb7 5cb7 s 	defw	H.KILL,A6F00
5cbb 5cbb d 08fe9070
5cbb 5cbb s 	defw	H.COPY,A707B
5cbf 5cbf d 12fe7670
5cbf 5cbf s 	defw	H.DSKF,A7061
5cc3 5cc3 d 21feec6c
5cc3 5cc3 s 	defw	H.LSET,A6CD7
5cc7 5cc7 d 26feeb6c
5cc7 5cc7 s 	defw	H.RSET,A6CD6
5ccb 5ccb d 2bfe5e6c
5ccb 5ccb s 	defw	H.FIEL,A6C49
5ccf 5ccf d 30fec46d
5ccf 5ccf s 	defw	H.MKI$,A6DAF
5cd3 5cd3 d 35fec76d
5cd3 5cd3 s 	defw	H.MKS$,A6DB2
5cd7 5cd7 d 3afeca6d
5cd7 5cd7 s 	defw	H.MKD$,A6DB5
5cdb 5cdb d 3ffeec6d
5cdb 5cdb s 	defw	H.CVI,A6DD7
5cdf 5cdf d 44feef6d
5cdf 5cdf s 	defw	H.CVS,A6DDA
5ce3 5ce3 d 49fef26d
5ce3 5ce3 s 	defw	H.CVD,A6DDD
5ce7 5ce7 d 4efeb966
5ce7 5ce7 s 	defw	H.GETP,A66A4
5ceb 5ceb d 58fec866
5ceb 5ceb s 	defw	H.NOFO,A66B3
5cef 5cef d 5dfe1167
5cef 5cef s 	defw	H.NULO,A66FC
5cf3 5cf3 d 62fee568
5cf3 5cf3 s 	defw	H.NTFL,A68D0
5cf7 5cf7 d 71fe2369
5cf7 5cf7 s 	defw	H.BINS,A690E
5cfb 5cfb d 76fe4e69
5cfb 5cfb s 	defw	H.BINL,A6939
5cff 5cff d 7bfe9d6e
5cff 5cff s 	defw	H.FILE,A6E88
5d03 5d03 d 80feef6b
5d03 5d03 s 	defw	H.DGET,A6BDA
5d07 5d07 d 85fea368
5d07 5d07 s 	defw	H.FILO,A688E
5d0b 5d0b d 8afe2e68
5d0b 5d0b s 	defw	H.INDS,A6819
5d0f 5d0f d 99fe2270
5d0f 5d0f s 	defw	H.LOC,A700D
5d13 5d13 d 9efe1e70
5d13 5d13 s 	defw	H.LOF,A7009
5d17 5d17 d a3fe856e
5d17 5d17 s 	defw	H.EOF,A6E70
5d1b 5d1b d adfe8a68
5d1b 5d1b s 	defw	H.BAKU,A6875
5d1f 5d1f d b2fe3873
5d1f 5d1f s 	defw	H.PARD,A7323
5d23 5d23 d b7fe9173
5d23 5d23 s 	defw	H.NODE,A737C
5d27 5d27 d fdfee871
5d27 5d27 s 	defw	H.ERRP,A71D3
5d2b 5d2b d a7ff6a60
5d2b 5d2b s 	defw	H.PHYD,A6055
5d2f 5d2f d acffc560
5d2f 5d2f s 	defw	H.FORM,A60B0
5d33 5d33 d 31f3d356
5d33 5d33 s 	defw	XF331,A56D3
5d37 5d37 d 0000
5d37 5d37 s 	defw	0
5d39 5d39 s 
5d39 5d39 d 01482d01412d0147293a00
5d39 5d39 s T5D24:	defb	1,048H,"-",1,041H,"-",1,047H,"):",0
5d44 5d44 d 4d2d442d59293a00
5d44 5d44 s T5D2F:	defb	"M-D-Y):",0
5d4c 5d4c d 442d4d2d59293a00
5d4c 5d4c s T5D37:	defb	"D-M-Y):",0
5d54 5d54 s 
5d54 5d54 d ed73c0f5
5d54 5d54 s A5D3F:	ld	(BUF+98),sp
5d58 5d58 d 3e14
5d58 5d58 s 	ld	a,20
5d5a 5d5a d 32c2f5
5d5a 5d5a s 	ld	(BUF+100),a		; size of lineinput buffer
5d5d 5d5d d cd9b5f
5d5d 5d5d s A5D48:	call	A5F86
5d60 5d60 d 0d0a456e7465722064617465202800
5d60 5d60 s 	defb	13,10,"Enter date (",0
5d6f 5d6f d 00
5d6f 5d6f s 	nop
5d70 5d70 d 00
5d70 5d70 s 	nop
5d71 5d71 d 00
5d71 5d71 s 	nop
5d72 5d72 d 00
5d72 5d72 s 	nop				; room for expansion ??
5d73 5d73 d 00
5d73 5d73 s 	nop				; extra 5 bytes
5d74 5d74 d 3a0ef3
5d74 5d74 s 	ld	a,(YF30E)
5d77 5d77 d fe01
5d77 5d77 s 	cp	1
5d79 5d79 d 21395d
5d79 5d79 s 	ld	hl,T5D24
5d7c 5d7c d 3808
5d7c 5d7c s 	jr	c,A5D71			; japanese Y-M-D
5d7e 5d7e d 21445d
5d7e 5d7e s 	ld	hl,T5D2F
5d81 5d81 d 2803
5d81 5d81 s 	jr	z,A5D71			; european D-M-Y
5d83 5d83 d 214c5d
5d83 5d83 s 	ld	hl,T5D37		; american M-D-Y
5d86 5d86 d cda15f
5d86 5d86 s A5D71:	call	A5F8C			; print string
5d89 5d89 d 21605e
5d89 5d89 s 	ld	hl,T5E4B
5d8c 5d8c d 2225f3
5d8c 5d8c s 	ld	(YF325),hl		; setup abort handler
5d8f 5d8f d 11c2f5
5d8f 5d8f s 	ld	de,BUF+100
5d92 5d92 d cde050
5d92 5d92 s 	call	A50E0			; BDOS 0A (buffered console input)
5d95 5d95 d 21c4f5
5d95 5d95 s 	ld	hl,BUF+100+2
5d98 5d98 d 7e
5d98 5d98 s 	ld	a,(hl)
5d99 5d99 d fe0d
5d99 5d99 s 	cp	00DH
5d9b 5d9b d c8
5d9b 5d9b s 	ret	z			; empty input, do not set date, quit
5d9c 5d9c d 3a0ef3
5d9c 5d9c s 	ld	a,(YF30E)
5d9f 5d9f d a7
5d9f 5d9f s 	and	a
5da0 5da0 d 2012
5da0 5da0 s 	jr	nz,A5D9F		; no japanese
5da2 5da2 d cd225e
5da2 5da2 s 	call	A5E0D			; get date year
5da5 5da5 d cdfe5d
5da5 5da5 s 	call	A5DE9			; check for seperator and get date number (month)
5da8 5da8 d 51
5da8 5da8 s 	ld	d,c
5da9 5da9 d 7e
5da9 5da9 s 	ld	a,(hl)
5daa 5daa d 23
5daa 5daa s 	inc	hl
5dab 5dab d b8
5dab 5dab s 	cp	b			; check if same seperator as the first one
5dac 5dac d 2032
5dac 5dac s 	jr	nz,A5DCB		; nope, error
5dae 5dae d cd0d5e
5dae 5dae s 	call	A5DF8			; get date number (day)
5db1 5db1 d 59
5db1 5db1 s 	ld	e,c
5db2 5db2 d 181a
5db2 5db2 s 	jr	A5DB9
5db4 5db4 s ;
5db4 5db4 d cd0d5e
5db4 5db4 s A5D9F:	call	A5DF8			; get date number (day european, month american)
5db7 5db7 d 51
5db7 5db7 s 	ld	d,c
5db8 5db8 d cdfe5d
5db8 5db8 s 	call	A5DE9			; check for seperator and get date number (month european, day american)
5dbb 5dbb d 59
5dbb 5dbb s 	ld	e,c
5dbc 5dbc d 7e
5dbc 5dbc s 	ld	a,(hl)
5dbd 5dbd d 23
5dbd 5dbd s 	inc	hl
5dbe 5dbe d b8
5dbe 5dbe s 	cp	b			; check if same seperator as the first one
5dbf 5dbf d 2005
5dbf 5dbf s 	jr	nz,A5DB1		; nope, error
5dc1 5dc1 d cd225e
5dc1 5dc1 s 	call	A5E0D			; get date year
5dc4 5dc4 d 1808
5dc4 5dc4 s 	jr	A5DB9
5dc6 5dc6 s ;
5dc6 5dc6 d d5
5dc6 5dc6 s A5DB1:	push	de
5dc7 5dc7 d cd3c55
5dc7 5dc7 s 	call	A553C			; get date
5dca 5dca d e5
5dca 5dca s 	push	hl
5dcb 5dcb d dde1
5dcb 5dcb s 	pop	ix
5dcd 5dcd d d1
5dcd 5dcd s A5DB8:	pop	de
5dce 5dce d 3a0ef3
5dce 5dce s A5DB9:	ld	a,(YF30E)
5dd1 5dd1 d fe02
5dd1 5dd1 s 	cp	002H
5dd3 5dd3 d 3803
5dd3 5dd3 s 	jr	c,A5DC3			; european or japanese, month already in register D
5dd5 5dd5 d 7b
5dd5 5dd5 s 	ld	a,e
5dd6 5dd6 d 5a
5dd6 5dd6 s 	ld	e,d
5dd7 5dd7 d 57
5dd7 5dd7 s 	ld	d,a			; month in register D, day in register E
5dd8 5dd8 d dde5
5dd8 5dd8 s A5DC3:	push	ix
5dda 5dda d e1
5dda 5dda s 	pop	hl
5ddb 5ddb d cd5255
5ddb 5ddb s 	call	A5552			; set date
5dde 5dde d b7
5dde 5dde s 	or	a
5ddf 5ddf d c8
5ddf 5ddf s 	ret	z			; no error, quit
5de0 5de0 d ed7bc0f5
5de0 5de0 s A5DCB:	ld	sp,(BUF+98)
5de4 5de4 d cd9b5f
5de4 5de4 s 	call	A5F86
5de7 5de7 d 0d0a496e76616c6964206461746500
5de7 5de7 s 	defb	13,10,"Invalid date",0
5df6 5df6 d 00
5df6 5df6 s 	nop
5df7 5df7 d 00
5df7 5df7 s 	nop
5df8 5df8 d 00
5df8 5df8 s 	nop
5df9 5df9 d 00
5df9 5df9 s 	nop				; room for expansion ??
5dfa 5dfa d 00
5dfa 5dfa s 	nop				; extra 5 bytes
5dfb 5dfb d c35d5d
5dfb 5dfb s 	jp	A5D48			; try again
5dfe 5dfe s ;
5dfe 5dfe d 7e
5dfe 5dfe s A5DE9:	ld	a,(hl)
5dff 5dff d 23
5dff 5dff s 	inc	hl
5e00 5e00 d 47
5e00 5e00 s 	ld	b,a
5e01 5e01 d fe2f
5e01 5e01 s 	cp	"/"
5e03 5e03 d 2808
5e03 5e03 s 	jr	z,A5DF8
5e05 5e05 d fe2e
5e05 5e05 s 	cp	"."
5e07 5e07 d 2804
5e07 5e07 s 	jr	z,A5DF8
5e09 5e09 d fe2d
5e09 5e09 s 	cp	"-"
5e0b 5e0b d 20d3
5e0b 5e0b s 	jr	nz,A5DCB
5e0d 5e0d s 
5e0d 5e0d d cd565e
5e0d 5e0d s A5DF8:	call	A5E41			; is digit ?
5e10 5e10 d 38ce
5e10 5e10 s 	jr	c,A5DCB			; nope, error
5e12 5e12 d 4f
5e12 5e12 s 	ld	c,a			; save digit
5e13 5e13 d cd565e
5e13 5e13 s 	call	A5E41			; is digit ?
5e16 5e16 d d8
5e16 5e16 s 	ret	c			; nope, quit
5e17 5e17 d f5
5e17 5e17 s 	push	af
5e18 5e18 d 79
5e18 5e18 s 	ld	a,c
5e19 5e19 d 87
5e19 5e19 s 	add	a,a
5e1a 5e1a d 87
5e1a 5e1a s 	add	a,a
5e1b 5e1b d 81
5e1b 5e1b s 	add	a,c
5e1c 5e1c d 87
5e1c 5e1c s 	add	a,a
5e1d 5e1d d 4f
5e1d 5e1d s 	ld	c,a			; first digit *10
5e1e 5e1e d f1
5e1e 5e1e s 	pop	af
5e1f 5e1f d 81
5e1f 5e1f s 	add	a,c
5e20 5e20 d 4f
5e20 5e20 s 	ld	c,a			; + second digit
5e21 5e21 d c9
5e21 5e21 s 	ret
5e22 5e22 s ;
5e22 5e22 d cd0d5e
5e22 5e22 s A5E0D:	call	A5DF8			; get date number
5e25 5e25 d 41
5e25 5e25 s 	ld	b,c
5e26 5e26 d cd565e
5e26 5e26 s 	call	A5E41			; is digit (is year more as 2 digit number) ?
5e29 5e29 d 3816
5e29 5e29 s 	jr	c,A5E2C			; nope, make it a 4 digit number
5e2b 5e2b d 2b
5e2b 5e2b s 	dec	hl
5e2c 5e2c d cd0d5e
5e2c 5e2c s 	call	A5DF8			; get date number
5e2f 5e2f d e5
5e2f 5e2f s 	push	hl
5e30 5e30 d c5
5e30 5e30 s 	push	bc
5e31 5e31 d 48
5e31 5e31 s 	ld	c,b
5e32 5e32 d 0600
5e32 5e32 s 	ld	b,000H
5e34 5e34 d d5
5e34 5e34 s 	push	de
5e35 5e35 d 116400
5e35 5e35 s 	ld	de,100
5e38 5e38 d cd1649
5e38 5e38 s 	call	A4916			; * 100
5e3b 5e3b d d1
5e3b 5e3b s 	pop	de
5e3c 5e3c d e1
5e3c 5e3c s 	pop	hl
5e3d 5e3d d 2600
5e3d 5e3d s 	ld	h,000H
5e3f 5e3f d 180f
5e3f 5e3f s 	jr	A5E3B
5e41 5e41 s ;
5e41 5e41 d e5
5e41 5e41 s A5E2C:	push	hl
5e42 5e42 d 48
5e42 5e42 s 	ld	c,b
5e43 5e43 d 0600
5e43 5e43 s 	ld	b,0
5e45 5e45 d 216c07
5e45 5e45 s 	ld	hl,1900
5e48 5e48 d 79
5e48 5e48 s 	ld	a,c
5e49 5e49 d fe50
5e49 5e49 s 	cp	80
5e4b 5e4b d 3003
5e4b 5e4b s 	jr	nc,A5E3B		; >= 80 means 19xx
5e4d 5e4d d 21d007
5e4d 5e4d s 	ld	hl,2000			; >80 means 20xx
5e50 5e50 d 09
5e50 5e50 s A5E3B:	add	hl,bc
5e51 5e51 d e5
5e51 5e51 s 	push	hl
5e52 5e52 d dde1
5e52 5e52 s 	pop	ix
5e54 5e54 d e1
5e54 5e54 s 	pop	hl
5e55 5e55 d c9
5e55 5e55 s 	ret
5e56 5e56 s ;
5e56 5e56 d 7e
5e56 5e56 s A5E41:	ld	a,(hl)
5e57 5e57 d d630
5e57 5e57 s 	sub	030H
5e59 5e59 d d8
5e59 5e59 s 	ret	c
5e5a 5e5a d fe0a
5e5a 5e5a s 	cp	00AH
5e5c 5e5c d 3f
5e5c 5e5c s 	ccf
5e5d 5e5d d d8
5e5d 5e5d s 	ret	c
5e5e 5e5e d 23
5e5e 5e5e s 	inc	hl
5e5f 5e5f d c9
5e5f 5e5f s 	ret
5e60 5e60 s ;
5e60 5e60 d 625e
5e60 5e60 s T5E4B:	defw	A5E4D
5e62 5e62 s 
5e62 5e62 d ed7bc0f5
5e62 5e62 s A5E4D:	ld	sp,(BUF+98)
5e66 5e66 d c9
5e66 5e66 s 	ret
5e67 5e67 s ;
5e67 5e67 s ; CHANGED, TO CREATE ROOM FOR OTHER ROUTINES
5e67 5e67 s ; ONLY 64 KB RAM'S ARE ALLOWED AS RAM!!
5e67 5e67 s ;
5e67 5e67 d 61
5e67 5e67 s A5E52:	ld	h,c
5e68 5e68 d 2e10
5e68 5e68 s A5E5E:	ld	l,010H
5e6a 5e6a d cd9a5e
5e6a 5e6a s A5E60:	call	ARDSL
5e6d 5e6d d 2f
5e6d 5e6d s 	cpl
5e6e 5e6e d 5f
5e6e 5e6e s 	ld	e,a
5e6f 5e6f d d5
5e6f 5e6f s 	push	de
5e70 5e70 d cda05e
5e70 5e70 s 	call	AWRSL
5e73 5e73 d cd9a5e
5e73 5e73 s 	call	ARDSL
5e76 5e76 d c1
5e76 5e76 s 	pop	bc
5e77 5e77 d 47
5e77 5e77 s 	ld	b,a
5e78 5e78 d 79
5e78 5e78 s 	ld	a,c
5e79 5e79 d 2f
5e79 5e79 s 	cpl
5e7a 5e7a d 5f
5e7a 5e7a s 	ld	e,a
5e7b 5e7b d c5
5e7b 5e7b s 	push	bc
5e7c 5e7c d cda05e
5e7c 5e7c s 	call	AWRSL
5e7f 5e7f d c1
5e7f 5e7f s 	pop	bc
5e80 5e80 d 79
5e80 5e80 s 	ld	a,c
5e81 5e81 d b8
5e81 5e81 s 	cp	b
5e82 5e82 d 2014
5e82 5e82 s 	jr	nz,A5E9A
5e84 5e84 d 2d
5e84 5e84 s 	dec	l
5e85 5e85 d 20e3
5e85 5e85 s 	jr	nz,A5E60
5e87 5e87 d 24
5e87 5e87 s 	inc	h
5e88 5e88 d 24
5e88 5e88 s 	inc	h
5e89 5e89 d 24
5e89 5e89 s 	inc	h
5e8a 5e8a d 24
5e8a 5e8a s 	inc	h
5e8b 5e8b d 7c
5e8b 5e8b s 	ld	a,h
5e8c 5e8c d fe40
5e8c 5e8c s 	cp	040H
5e8e 5e8e d 2804
5e8e 5e8e s 	jr	z,A5E96
5e90 5e90 d fe80
5e90 5e90 s 	cp	080H
5e92 5e92 d 20d4
5e92 5e92 s 	jr	nz,A5E5E
5e94 5e94 d 3a44f3
5e94 5e94 s A5E96:	ld	a,(RAMAD3)
5e97 5e97 d c9
5e97 5e97 s 	ret
5e98 5e98 s ;
5e98 5e98 d 37
5e98 5e98 s A5E9A:	scf
5e99 5e99 d c9
5e99 5e99 s 	ret
5e9a 5e9a s 
5e9a 5e9a d 3a44f3
5e9a 5e9a s ARDSL:	ld	a,(RAMAD3)
5e9d 5e9d d c30c00
5e9d 5e9d s 	jp	RDSLT
5ea0 5ea0 s 
5ea0 5ea0 d 3a44f3
5ea0 5ea0 s AWRSL:	ld	a,(RAMAD3)
5ea3 5ea3 d c31400
5ea3 5ea3 s 	jp	WRSLT
5ea6 5ea6 s ;
5ea6 5ea6 s ; END OF CHANGE, BUT KEEP FOLLOWING ROUTINES AT SAME ADDRESSES!
5ea6 5ea6 s ;
5ea6 5ea6 s 	defs	05EADH-05E52H-($-A5E52),0
5ea6 5ea6 d 00000000000000000000000000000000
5eb6 5eb6 d 000000000000000000000000
5ec2 5ec2 s 
5ec2 5ec2 s 
5ec2 5ec2 d 2a4bf3
5ec2 5ec2 s A5EAD:	ld	hl,(YF34B)
5ec5 5ec5 d a7
5ec5 5ec5 s 	and	a
5ec6 5ec6 d ed42
5ec6 5ec6 s 	sbc	hl,bc
5ec8 5ec8 d 224bf3
5ec8 5ec8 s 	ld	(YF34B),hl
5ecb 5ecb d 1809
5ecb 5ecb s 	jr	A5EC1
5ecd 5ecd s ;
5ecd 5ecd d 2a4afc
5ecd 5ecd s A5EB8:	ld	hl,(HIMEM)
5ed0 5ed0 d a7
5ed0 5ed0 s 	and	a
5ed1 5ed1 d ed42
5ed1 5ed1 s 	sbc	hl,bc
5ed3 5ed3 d 224afc
5ed3 5ed3 s 	ld	(HIMEM),hl
5ed6 5ed6 d 3809
5ed6 5ed6 s A5EC1:	jr	c,A5ECC
5ed8 5ed8 d 7c
5ed8 5ed8 s 	ld	a,h
5ed9 5ed9 d fec2
5ed9 5ed9 s 	cp	0C2H
5edb 5edb d 1803
5edb 5edb s 	jr	A5ECB
5edd 5edd s ;
5edd 5edd d cdfd5e
5edd 5edd s A5EC8:	call	A5EE8
5ee0 5ee0 d d0
5ee0 5ee0 s A5ECB:	ret	nc
5ee1 5ee1 d cd9b5f
5ee1 5ee1 s A5ECC:	call	A5F86
5ee4 5ee4 d 0c
5ee4 5ee4 s 	defb	12
5ee5 5ee5 d 4e6f20656e6f756768206d656d6f727900
5ee5 5ee5 s T5ED0:	defb	"No enough memory",0
5ef6 5ef6 d 00
5ef6 5ef6 s 	nop
5ef7 5ef7 d 00
5ef7 5ef7 s 	nop
5ef8 5ef8 d 00
5ef8 5ef8 s 	nop
5ef9 5ef9 d 00
5ef9 5ef9 s 	nop				; room for expansion ??
5efa 5efa d 00
5efa 5efa s 	nop				; extra 5 bytes
5efb 5efb d f3
5efb 5efb s 	di
5efc 5efc d 76
5efc 5efc s 	halt
5efd 5efd d 7d
5efd 5efd s A5EE8:	ld	a,l
5efe 5efe d b4
5efe 5efe s 	or	h
5eff 5eff d c8
5eff 5eff s 	ret	z
5f00 5f00 d af
5f00 5f00 s 	xor	a
5f01 5f01 d 95
5f01 5f01 s 	sub	l
5f02 5f02 d 6f
5f02 5f02 s 	ld	l,a
5f03 5f03 d 3e00
5f03 5f03 s 	ld	a,000H
5f05 5f05 d 9c
5f05 5f05 s 	sbc	a,h
5f06 5f06 d 67
5f06 5f06 s 	ld	h,a
5f07 5f07 d 4d
5f07 5f07 s 	ld	c,l
5f08 5f08 d 44
5f08 5f08 s 	ld	b,h
5f09 5f09 d 39
5f09 5f09 s 	add	hl,sp
5f0a 5f0a d 3f
5f0a 5f0a s 	ccf
5f0b 5f0b d d8
5f0b 5f0b s 	ret	c
5f0c 5f0c d ed5b48fc
5f0c 5f0c s 	ld	de,(BOTTOM)
5f10 5f10 d ed52
5f10 5f10 s 	sbc	hl,de
5f12 5f12 d d8
5f12 5f12 s 	ret	c
5f13 5f13 d 7c
5f13 5f13 s 	ld	a,h
5f14 5f14 d fe02
5f14 5f14 s 	cp	002H
5f16 5f16 d d8
5f16 5f16 s 	ret	c
5f17 5f17 d c5
5f17 5f17 s 	push	bc
5f18 5f18 d 210000
5f18 5f18 s 	ld	hl,00000H
5f1b 5f1b d 39
5f1b 5f1b s 	add	hl,sp
5f1c 5f1c d 5d
5f1c 5f1c s 	ld	e,l
5f1d 5f1d d 54
5f1d 5f1d s 	ld	d,h
5f1e 5f1e d 09
5f1e 5f1e s 	add	hl,bc
5f1f 5f1f d e5
5f1f 5f1f s 	push	hl
5f20 5f20 d 2a74f6
5f20 5f20 s 	ld	hl,(STKTOP)
5f23 5f23 d a7
5f23 5f23 s 	and	a
5f24 5f24 d ed52
5f24 5f24 s 	sbc	hl,de
5f26 5f26 d 4d
5f26 5f26 s 	ld	c,l
5f27 5f27 d 44
5f27 5f27 s 	ld	b,h
5f28 5f28 d 03
5f28 5f28 s 	inc	bc
5f29 5f29 d e1
5f29 5f29 s 	pop	hl
5f2a 5f2a d f9
5f2a 5f2a s 	ld	sp,hl
5f2b 5f2b d eb
5f2b 5f2b s 	ex	de,hl
5f2c 5f2c d edb0
5f2c 5f2c s 	ldir
5f2e 5f2e d c1
5f2e 5f2e s 	pop	bc
5f2f 5f2f d 2a4afc
5f2f 5f2f s 	ld	hl,(HIMEM)
5f32 5f32 d 09
5f32 5f32 s 	add	hl,bc
5f33 5f33 d 224afc
5f33 5f33 s 	ld	(HIMEM),hl
5f36 5f36 d 11eafd
5f36 5f36 s 	ld	de,0FDEAH
5f39 5f39 d 19
5f39 5f39 s 	add	hl,de
5f3a 5f3a d 2260f8
5f3a 5f3a s 	ld	(FILTAB),hl
5f3d 5f3d d eb
5f3d 5f3d s 	ex	de,hl
5f3e 5f3e d 2a72f6
5f3e 5f3e s 	ld	hl,(MEMSIZ)
5f41 5f41 d 09
5f41 5f41 s 	add	hl,bc
5f42 5f42 d 2272f6
5f42 5f42 s 	ld	(MEMSIZ),hl
5f45 5f45 d 2a62f8
5f45 5f45 s 	ld	hl,(NULBUF)
5f48 5f48 d 09
5f48 5f48 s 	add	hl,bc
5f49 5f49 d 2262f8
5f49 5f49 s 	ld	(NULBUF),hl
5f4c 5f4c d 2a74f6
5f4c 5f4c s 	ld	hl,(STKTOP)
5f4f 5f4f d 09
5f4f 5f4f s 	add	hl,bc
5f50 5f50 d 2274f6
5f50 5f50 s A5F3B:	ld	(STKTOP),hl
5f53 5f53 d 2b
5f53 5f53 s 	dec	hl
5f54 5f54 d 2b
5f54 5f54 s 	dec	hl
5f55 5f55 d 22b1f6
5f55 5f55 s 	ld	(SAVSTK),hl
5f58 5f58 d 6b
5f58 5f58 s 	ld	l,e
5f59 5f59 d 62
5f59 5f59 s 	ld	h,d
5f5a 5f5a d 23
5f5a 5f5a s 	inc	hl
5f5b 5f5b d 23
5f5b 5f5b s 	inc	hl
5f5c 5f5c d 23
5f5c 5f5c s 	inc	hl
5f5d 5f5d d 23
5f5d 5f5d s A5F48:	inc	hl
5f5e 5f5e d 3e02
5f5e 5f5e s 	ld	a,002H
5f60 5f60 d eb
5f60 5f60 s A5F4B:	ex	de,hl
5f61 5f61 d 73
5f61 5f61 s 	ld	(hl),e
5f62 5f62 d 23
5f62 5f62 s 	inc	hl
5f63 5f63 d 72
5f63 5f63 s 	ld	(hl),d
5f64 5f64 d 23
5f64 5f64 s 	inc	hl
5f65 5f65 d eb
5f65 5f65 s 	ex	de,hl
5f66 5f66 d 010700
5f66 5f66 s 	ld	bc,00007H
5f69 5f69 d 70
5f69 5f69 s 	ld	(hl),b
5f6a 5f6a d 09
5f6a 5f6a s 	add	hl,bc
5f6b 5f6b d 70
5f6b 5f6b s 	ld	(hl),b
5f6c 5f6c d 010201
5f6c 5f6c s 	ld	bc,00102H
5f6f 5f6f d 09
5f6f 5f6f s 	add	hl,bc
5f70 5f70 d 3d
5f70 5f70 s 	dec	a
5f71 5f71 d 20ed
5f71 5f71 s 	jr	nz,A5F4B
5f73 5f73 d c9
5f73 5f73 s 	ret
5f74 5f74 s ;
5f74 5f74 d 3e01
5f74 5f74 s A5F5F:	ld	a,001H
5f76 5f76 d 325ff8
5f76 5f76 s 	ld	(MAXFIL),a
5f79 5f79 d 2a4afc
5f79 5f79 s 	ld	hl,(HIMEM)
5f7c 5f7c d 11eafd
5f7c 5f7c s 	ld	de,0FDEAH
5f7f 5f7f d 19
5f7f 5f7f s 	add	hl,de
5f80 5f80 d 2260f8
5f80 5f80 s 	ld	(FILTAB),hl
5f83 5f83 d 5d
5f83 5f83 s 	ld	e,l
5f84 5f84 d 54
5f84 5f84 s 	ld	d,h
5f85 5f85 d 2b
5f85 5f85 s 	dec	hl
5f86 5f86 d 2b
5f86 5f86 s 	dec	hl
5f87 5f87 d 2272f6
5f87 5f87 s 	ld	(MEMSIZ),hl
5f8a 5f8a d 01c800
5f8a 5f8a s 	ld	bc,000C8H
5f8d 5f8d d a7
5f8d 5f8d s 	and	a
5f8e 5f8e d ed42
5f8e 5f8e s 	sbc	hl,bc
5f90 5f90 d e5
5f90 5f90 s 	push	hl
5f91 5f91 d 210d00
5f91 5f91 s 	ld	hl,0000DH
5f94 5f94 d 19
5f94 5f94 s 	add	hl,de
5f95 5f95 d 2262f8
5f95 5f95 s 	ld	(NULBUF),hl
5f98 5f98 d e1
5f98 5f98 s 	pop	hl
5f99 5f99 d 18b5
5f99 5f99 s 	jr	A5F3B
5f9b 5f9b s ;
5f9b 5f9b d e3
5f9b 5f9b s A5F86:	ex	(sp),hl
5f9c 5f9c d cda15f
5f9c 5f9c s 	call	A5F8C			; print string
5f9f 5f9f d e3
5f9f 5f9f s 	ex	(sp),hl
5fa0 5fa0 d c9
5fa0 5fa0 s 	ret
5fa1 5fa1 s ;
5fa1 5fa1 d 7e
5fa1 5fa1 s A5F8C:	ld	a,(hl)
5fa2 5fa2 d 23
5fa2 5fa2 s 	inc	hl
5fa3 5fa3 d a7
5fa3 5fa3 s 	and	a
5fa4 5fa4 d c8
5fa4 5fa4 s 	ret	z
5fa5 5fa5 d cd8f40
5fa5 5fa5 s 	call	A408F			; output to screen
5fa8 5fa8 d 18f7
5fa8 5fa8 s 	jr	A5F8C
5faa 5faa s 
5faa 5faa s ;	  Subroutine get slotid of page 3
5faa 5faa s ;	     Inputs  -
5faa 5faa s ;	     Outputs A = slotid
5faa 5faa s 
5faa 5faa d 0606
5faa 5faa s A5F95:	ld	b,6
5fac 5fac d 21
5fac 5fac s 	defb	021H			; LD HL,xxxx (skips next instruction)
5fad 5fad s 
5fad 5fad s ;	  Subroutine get slotid of page 2
5fad 5fad s ;	     Inputs  -
5fad 5fad s ;	     Outputs A = slotid
5fad 5fad s 
5fad 5fad d 0604
5fad 5fad s A5F98:	ld	b,4
5faf 5faf d cd65f3
5faf 5faf s 	call	XF365
5fb2 5fb2 d c5
5fb2 5fb2 s 	push	bc
5fb3 5fb3 d 0f
5fb3 5fb3 s A5F9E:	rrca
5fb4 5fb4 d 10fd
5fb4 5fb4 s 	djnz	A5F9E
5fb6 5fb6 d cd0160
5fb6 5fb6 s 	call	A5FEC
5fb9 5fb9 d c1
5fb9 5fb9 s 	pop	bc
5fba 5fba d b6
5fba 5fba s 	or	(hl)
5fbb 5fbb d 4f
5fbb 5fbb s 	ld	c,a
5fbc 5fbc d 23
5fbc 5fbc s 	inc	hl
5fbd 5fbd d 23
5fbd 5fbd s 	inc	hl
5fbe 5fbe d 23
5fbe 5fbe s 	inc	hl
5fbf 5fbf d 23
5fbf 5fbf s 	inc	hl
5fc0 5fc0 d 7e
5fc0 5fc0 s 	ld	a,(hl)
5fc1 5fc1 d 05
5fc1 5fc1 s 	dec	b
5fc2 5fc2 d 05
5fc2 5fc2 s 	dec	b
5fc3 5fc3 d 0f
5fc3 5fc3 s A5FAE:	rrca
5fc4 5fc4 d 10fd
5fc4 5fc4 s 	djnz	A5FAE
5fc6 5fc6 d 180b
5fc6 5fc6 s 	jr	A5FBE
5fc8 5fc8 s 
5fc8 5fc8 s ;	  Subroutine get my slotid
5fc8 5fc8 s ;	     Inputs  -
5fc8 5fc8 s ;	     Outputs A = slotid
5fc8 5fc8 s 
5fc8 5fc8 s GETSLT:
5fc8 5fc8 d cdfc5f
5fc8 5fc8 s A5FB3:	call	A5FE7
5fcb 5fcb d b6
5fcb 5fcb s 	or	(hl)
5fcc 5fcc d f0
5fcc 5fcc s 	ret	p			; non expanded slot, quit
5fcd 5fcd d 4f
5fcd 5fcd s 	ld	c,a
5fce 5fce d 23
5fce 5fce s 	inc	hl
5fcf 5fcf d 23
5fcf 5fcf s 	inc	hl
5fd0 5fd0 d 23
5fd0 5fd0 s 	inc	hl
5fd1 5fd1 d 23
5fd1 5fd1 s 	inc	hl
5fd2 5fd2 d 7e
5fd2 5fd2 s 	ld	a,(hl)
5fd3 5fd3 d e60c
5fd3 5fd3 s A5FBE:	and	00CH
5fd5 5fd5 d b1
5fd5 5fd5 s 	or	c
5fd6 5fd6 d c9
5fd6 5fd6 s 	ret
5fd7 5fd7 s 
5fd7 5fd7 s ;	  Subroutine get my diskdriver workarea
5fd7 5fd7 s ;	     Inputs  -
5fd7 5fd7 s ;	     Outputs HL = IX = pointer to workarea
5fd7 5fd7 s ;	  Remark     used by the diskdriver
5fd7 5fd7 s 
5fd7 5fd7 s GETWRK:
5fd7 5fd7 d cde25f
5fd7 5fd7 s A5FC2:	call	A5FCD			; get my SLTWRK entry
5fda 5fda d 7e
5fda 5fda s 	ld	a,(hl)
5fdb 5fdb d 23
5fdb 5fdb s 	inc	hl
5fdc 5fdc d 66
5fdc 5fdc s 	ld	h,(hl)
5fdd 5fdd d 6f
5fdd 5fdd s 	ld	l,a			; pointer to workarea
5fde 5fde d e5
5fde 5fde s 	push	hl
5fdf 5fdf d dde1
5fdf 5fdf s 	pop	ix
5fe1 5fe1 d c9
5fe1 5fe1 s 	ret
5fe2 5fe2 s 
5fe2 5fe2 s ;	  Subroutine get my SLTWRK entry
5fe2 5fe2 s ;	     Inputs  -
5fe2 5fe2 s ;	     Outputs HL = pointer to SLTWRK entry
5fe2 5fe2 s 
5fe2 5fe2 d cdfc5f
5fe2 5fe2 s A5FCD:	call	A5FE7			; get my primairy slot
5fe5 5fe5 d 87
5fe5 5fe5 s 	add	a,a
5fe6 5fe6 d 87
5fe6 5fe6 s 	add	a,a
5fe7 5fe7 d 87
5fe7 5fe7 s 	add	a,a
5fe8 5fe8 d 37
5fe8 5fe8 s 	scf
5fe9 5fe9 d 8f
5fe9 5fe9 s 	adc	a,a			; primary slot*4 + 1
5fea 5fea d 4f
5fea 5fea s 	ld	c,a
5feb 5feb d 7e
5feb 5feb s 	ld	a,(hl)
5fec 5fec d 87
5fec 5fec s 	add	a,a
5fed 5fed d 9f
5fed 5fed s 	sbc	a,a
5fee 5fee d e60c
5fee 5fee s 	and	00CH			; 0 for non expanded, 0CH for expanded
5ff0 5ff0 d 23
5ff0 5ff0 s 	inc	hl
5ff1 5ff1 d 23
5ff1 5ff1 s 	inc	hl
5ff2 5ff2 d 23
5ff2 5ff2 s 	inc	hl
5ff3 5ff3 d 23
5ff3 5ff3 s 	inc	hl
5ff4 5ff4 d a6
5ff4 5ff4 s 	and	(hl)
5ff5 5ff5 d b1
5ff5 5ff5 s 	or	c
5ff6 5ff6 d 87
5ff6 5ff6 s 	add	a,a			; word entries
5ff7 5ff7 d 2109fd
5ff7 5ff7 s 	ld	hl,SLTWRK
5ffa 5ffa d 180c
5ffa 5ffa s 	jr	A5FF3
5ffc 5ffc s 
5ffc 5ffc s ;	  Subroutine get my EXPTBL entry
5ffc 5ffc s ;	     Inputs  -
5ffc 5ffc s ;	     Outputs HL = pointer to SLTWRK entry
5ffc 5ffc s 
5ffc 5ffc d cd65f3
5ffc 5ffc s A5FE7:	call	XF365
5fff 5fff d 0f
5fff 5fff s 	rrca
6000 6000 d 0f
6000 6000 s 	rrca
6001 6001 d e603
6001 6001 s A5FEC:	and	003H
6003 6003 d 21c1fc
6003 6003 s 	ld	hl,EXPTBL
6006 6006 d 0600
6006 6006 s A5FF1:	ld	b,000H
6008 6008 d 4f
6008 6008 s A5FF3:	ld	c,a
6009 6009 d 09
6009 6009 s 	add	hl,bc
600a 600a d c9
600a 600a s 	ret
600b 600b s 
600b 600b s ;	  Subroutine install my diskdriver interrupt handler
600b 600b s ;	     Inputs  HL = pointer to interrupt handler
600b 600b s ;	     Outputs -
600b 600b s ;	  Remark     used by the diskdriver
600b 600b s 
600b 600b s SETINT:
600b 600b d 3a9ffd
600b 600b s A5FF6:	ld	a,(H.TIMI+0)
600e 600e d fec9
600e 600e s 	cp	0C9H
6010 6010 d 2815
6010 6010 s 	jr	z,A6012			; H.TIMI not hooked, skip saving H.TIMI
6012 6012 d e5
6012 6012 s 	push	hl
6013 6013 d 3a99fd
6013 6013 s 	ld	a,(DEVICE)		; this diskdriver number
6016 6016 d 2129fb
6016 6016 s 	ld	hl,YFB29
6019 6019 d cd0660
6019 6019 s 	call	A5FF1
601c 601c d 09
601c 601c s 	add	hl,bc
601d 601d d 09
601d 601d s 	add	hl,bc			; get DRVINT pointer
601e 601e d eb
601e 601e s 	ex	de,hl
601f 601f d 21a0fd
601f 601f s 	ld	hl,H.TIMI+1
6022 6022 d 0e03
6022 6022 s 	ld	c,003H
6024 6024 d edb0
6024 6024 s 	ldir				; save slotid and adres (assumes that is hooked by a CALLF!)
6026 6026 d e1
6026 6026 s 	pop	hl
6027 6027 d f3
6027 6027 s A6012:	di
6028 6028 d 3ef7
6028 6028 s 	ld	a,0F7H
602a 602a d 329ffd
602a 602a s 	ld	(H.TIMI+0),a
602d 602d d 22a1fd
602d 602d s 	ld	(H.TIMI+2),hl		; diskdriver interrupt handler
6030 6030 d 3ec9
6030 6030 s 	ld	a,0C9H
6032 6032 d 32a3fd
6032 6032 s 	ld	(H.TIMI+4),a
6035 6035 d cd2d40
6035 6035 s 	call	A402D
6038 6038 d 32a0fd
6038 6038 s 	ld	(H.TIMI+1),a		; slotid of this diskdriver
603b 603b d c9
603b 603b s 	ret
603c 603c s 
603c 603c s ;	  Subroutine call orginal interrupt handler
603c 603c s ;	     Inputs  -
603c 603c s ;	     Outputs -
603c 603c s ;	  Remark     used by the diskdriver
603c 603c s 
603c 603c s PRVINT:
603c 603c d f5
603c 603c s A6027:	push	af
603d 603d d cd2d40
603d 603d s 	call	A402D			; slotid of this diskdriver
6040 6040 d 0604
6040 6040 s 	ld	b,4
6042 6042 d 1129fb
6042 6042 s 	ld	de,YFB29
6045 6045 d 2122fb
6045 6045 s 	ld	hl,YFB21+1
6048 6048 d be
6048 6048 s A6033:	cp	(hl)			; is this my DRVTBL entry ?
6049 6049 d 2809
6049 6049 s 	jr	z,A603F			; yep, get the saved interrupt handler and jump to it
604b 604b d 13
604b 604b s 	inc	de
604c 604c d 13
604c 604c s 	inc	de
604d 604d d 13
604d 604d s 	inc	de
604e 604e d 23
604e 604e s 	inc	hl
604f 604f d 23
604f 604f s 	inc	hl
6050 6050 d 10f6
6050 6050 s 	djnz	A6033			; next DRVTBL and DRVINT entry
6052 6052 d f1
6052 6052 s A603D:	pop	af
6053 6053 d c9
6053 6053 s 	ret				; quit
6054 6054 s ;
6054 6054 d eb
6054 6054 s A603F:	ex	de,hl
6055 6055 d 7e
6055 6055 s 	ld	a,(hl)
6056 6056 d a7
6056 6056 s 	and	a
6057 6057 d 28f9
6057 6057 s 	jr	z,A603D			; DRVINT entry not used, quit
6059 6059 d f5
6059 6059 s 	push	af
605a 605a d fde1
605a 605a s 	pop	iy			; slotid
605c 605c d 23
605c 605c s 	inc	hl
605d 605d d 4e
605d 605d s 	ld	c,(hl)
605e 605e d 23
605e 605e s 	inc	hl
605f 605f d 46
605f 605f s 	ld	b,(hl)
6060 6060 d c5
6060 6060 s 	push	bc
6061 6061 d dde1
6061 6061 s 	pop	ix			; adres
6063 6063 d f1
6063 6063 s 	pop	af
6064 6064 d c31c00
6064 6064 s 	jp	CALSLT
6067 6067 s 
6067 6067 s ;	  Subroutine read disksector
6067 6067 s ;	     Inputs  A = driveid, B = number of sectors, C = mediadescriptor, DE = start sector, HL = transferadres
6067 6067 s ;	     Outputs -
6067 6067 s 
6067 6067 d a7
6067 6067 s A6052:	and	a
6068 6068 d 38
6068 6068 s 	defb	038H			; JR C,xx (skips next instruction)
6069 6069 s 
6069 6069 s ;	  Subroutine write disksector
6069 6069 s ;	     Inputs  A = driveid, B = number of sectors, C = mediadescriptor, DE = start sector, HL = transferadres
6069 6069 s ;	     Outputs -
6069 6069 s 
6069 6069 d 37
6069 6069 s A6054:	scf
606a 606a s 
606a 606a s ;	  Subroutine PHYDIO BIOS call
606a 606a s ;	     Inputs  A = driveid, B = number of sectors, C = mediadescriptor, DE = start sector, HL = transferadres
606a 606a s ;	     Outputs -
606a 606a s 
606a 606a d dde5
606a 606a s A6055:	push	ix
606c 606c d fde5
606c 606c s 	push	iy
606e 606e d e5
606e 606e s 	push	hl
606f 606f d f5
606f 606f s 	push	af
6070 6070 d cd9b60
6070 6070 s 	call	A6086			; get diskdriverparameters
6073 6073 d 6f
6073 6073 s 	ld	l,a
6074 6074 d f1
6074 6074 s 	pop	af			; restore flags (Cx)
6075 6075 d 7d
6075 6075 s 	ld	a,l
6076 6076 d dd211040
6076 6076 s 	ld	ix,T4010
607a 607a d 1814
607a 607a s 	jr	A607B
607c 607c s ;
607c 607c d dde5
607c 607c s A6067:	push	ix
607e 607e d dd211340
607e 607e s 	ld	ix,T4013
6082 6082 d 1806
6082 6082 s 	jr	A6075
6084 6084 s ;
6084 6084 d dde5
6084 6084 s A606F:	push	ix
6086 6086 d dd211640
6086 6086 s 	ld	ix,T4016
608a 608a d fde5
608a 608a s A6075:	push	iy
608c 608c d e5
608c 608c s 	push	hl
608d 608d d cd9b60
608d 608d s 	call	A6086			; get diskdriverparameters
6090 6090 d e1
6090 6090 s A607B:	pop	hl
6091 6091 d e5
6091 6091 s 	push	hl
6092 6092 d cd1c00
6092 6092 s 	call	CALSLT
6095 6095 d c38563
6095 6095 s 	jp	A636E
6098 6098 s 
6098 6098 s ; Unused code
6098 6098 s ;
6098 6098 s ; looks like the previous jump is a patch, may be the ´ei´ instruction at the end of the patch was forgotten ??
6098 6098 s ; patch code does not fit here, 1 byte too less
6098 6098 s 
6098 6098 d 00
6098 6098 s 	nop
6099 6099 d 00
6099 6099 s 	nop
609a 609a d 00
609a 609a s 	nop
609b 609b s 
609b 609b s ;	  Subroutine get diskdriverparameters
609b 609b s ;	     Inputs  A=driveid
609b 609b s ;	     Outputs IYH=slotid diskdriver, H=slotid diskdriver, A=local driveid diskdriver
609b 609b s 
609b 609b d 323ff3
609b 609b s A6086:	ld	(YF33F),a		; save driveid (for PROMPT)
609e 609e d 2121fb
609e 609e s 	ld	hl,YFB21		; diskdriver table
60a1 60a1 d 96
60a1 60a1 s A608C:	sub	(hl)
60a2 60a2 d 3804
60a2 60a2 s 	jr	c,A6093
60a4 60a4 d 23
60a4 60a4 s 	inc	hl
60a5 60a5 d 23
60a5 60a5 s 	inc	hl
60a6 60a6 d 18f9
60a6 60a6 s 	jr	A608C
60a8 60a8 s ;
60a8 60a8 d 86
60a8 60a8 s A6093:	add	a,(hl)			; driveid driver
60a9 60a9 d 23
60a9 60a9 s 	inc	hl
60aa 60aa d 66
60aa 60aa s 	ld	h,(hl)			; slotid driver
60ab 60ab d e5
60ab 60ab s 	push	hl
60ac 60ac d fde1
60ac 60ac s 	pop	iy
60ae 60ae d c9
60ae 60ae s 	ret
60af 60af s 
60af 60af s ;	  Subroutine mark FAT buffer as invalid
60af 60af s ;	     Inputs  A=driveid
60af 60af s ;	     Outputs ________________________ 
60af 60af s 
60af 60af d 2155f3
60af 60af s A609A:	ld	hl,YF355
60b2 60b2 d cd0660
60b2 60b2 s 	call	A5FF1
60b5 60b5 d 09
60b5 60b5 s 	add	hl,bc
60b6 60b6 d 5e
60b6 60b6 s 	ld	e,(hl)
60b7 60b7 d 23
60b7 60b7 s 	inc	hl
60b8 60b8 d 56
60b8 60b8 s 	ld	d,(hl)			; pointer to DPB
60b9 60b9 d 211300
60b9 60b9 s 	ld	hl,00013H
60bc 60bc d 19
60bc 60bc s 	add	hl,de
60bd 60bd d 5e
60bd 60bd s 	ld	e,(hl)
60be 60be d 23
60be 60be s 	inc	hl
60bf 60bf d 56
60bf 60bf s 	ld	d,(hl)
60c0 60c0 d 1b
60c0 60c0 s 	dec	de
60c1 60c1 d eb
60c1 60c1 s 	ex	de,hl
60c2 60c2 d 36ff
60c2 60c2 s 	ld	(hl),0FFH
60c4 60c4 d c9
60c4 60c4 s 	ret
60c5 60c5 s 
60c5 60c5 s ;	  Subroutine FORMAT BIOS call
60c5 60c5 s ;	     Inputs  
60c5 60c5 s ;	     Outputs ________________________ 
60c5 60c5 s 
60c5 60c5 d a7
60c5 60c5 s A60B0:	and	a			; use free BASIC memory as formatbuffer
60c6 60c6 s 
60c6 60c6 s ;	  Subroutine format disk
60c6 60c6 s ;	     Inputs  Cx reset = use free BASIC memory as formatbuffer, Cx set = use specified buffer, HL = start of buffer, BC = size of buffer
60c6 60c6 s ;	     Outputs ________________________ 
60c6 60c6 s 
60c6 60c6 d ed7339f3
60c6 60c6 s A60B1:	ld	(YF339),sp		; save stackpointer for abort
60ca 60ca d d4eb62
60ca 60ca s 	call	nc,A62D6		; get formatbuffer in free BASIC memory
60cd 60cd d e5
60cd 60cd s 	push	hl
60ce 60ce d c5
60ce 60ce s 	push	bc
60cf 60cf d 3a47f3
60cf 60cf s 	ld	a,(YF347)
60d2 60d2 d 3d
60d2 60d2 s 	dec	a			; only 1 diskdrive ?
60d3 60d3 d 2841
60d3 60d3 s 	jr	z,A6101			; yep, skip drivename input and use driveid 0
60d5 60d5 d cd9b5f
60d5 60d5 s A60C0:	call	A5F86
60d8 60d8 d 4472697665206e616d653f202800
60d8 60d8 s 	defb	"Drive name? (",0
60e6 60e6 d 00
60e6 60e6 s 	nop
60e7 60e7 d 00
60e7 60e7 s 	nop
60e8 60e8 d 00
60e8 60e8 s 	nop
60e9 60e9 d 00
60e9 60e9 s 	nop				; room for expansion ??
60ea 60ea d 00
60ea 60ea s 	nop				; extra 5 bytes
60eb 60eb d 3a47f3
60eb 60eb s 	ld	a,(YF347)
60ee 60ee d 47
60ee 60ee s 	ld	b,a			; number of diskdrives
60ef 60ef d 3e41
60ef 60ef s 	ld	a,"A"			; starts with "A" drive
60f1 60f1 d 1807
60f1 60f1 s 	jr	A60E5
60f3 60f3 s ;
60f3 60f3 d f5
60f3 60f3 s A60DE:	push	af
60f4 60f4 d 3e2c
60f4 60f4 s 	ld	a,","
60f6 60f6 d cd8f40
60f6 60f6 s 	call	A408F			; output to screen
60f9 60f9 d f1
60f9 60f9 s 	pop	af
60fa 60fa d cd8f40
60fa 60fa s A60E5:	call	A408F			; output to screen
60fd 60fd d 3c
60fd 60fd s 	inc	a
60fe 60fe d 10f3
60fe 60fe s 	djnz	A60DE			; next drive
6100 6100 d cd9b5f
6100 6100 s 	call	A5F86
6103 6103 d 292000
6103 6103 s 	defb	") ",0
6106 6106 d cdaa61
6106 6106 s 	call	A6195			; get fresh consoleinput (CTRL-C aborts)
6109 6109 d cddb62
6109 6109 s 	call	A62C6			; print input and CR/LF
610c 610c d e6df
610c 610c s 	and	0DFH			; upcase
610e 610e d d641
610e 610e s 	sub	"A"
6110 6110 d 2147f3
6110 6110 s 	ld	hl,YF347
6113 6113 d be
6113 6113 s 	cp	(hl)			; driveletter valid ?
6114 6114 d 30bf
6114 6114 s 	jr	nc,A60C0		; nope, ask again
6116 6116 d cdaf60
6116 6116 s A6101:	call	A609A			; mark FAT buffer as invalid
6119 6119 d cd9b60
6119 6119 s 	call	A6086			; get diskdriverparameters
611c 611c d fde5
611c 611c s 	push	iy
611e 611e d f5
611e 611e s 	push	af
611f 611f d fde5
611f 611f s 	push	iy
6121 6121 d dd211940
6121 6121 s 	ld	ix,T4019
6125 6125 d cd1c00
6125 6125 s 	call	CALSLT			; call CHOICE diskdriver
6128 6128 d 7d
6128 6128 s 	ld	a,l
6129 6129 d b4
6129 6129 s 	or	h			; choice string ?
612a 612a d 2827
612a 612a s 	jr	z,A613E			; nope, skip choice input and use choice 0 (default format)
612c 612c d f1
612c 612c s 	pop	af
612d 612d d f5
612d 612d s A6118:	push	af
612e 612e d cd0c00
612e 612e s 	call	RDSLT
6131 6131 d a7
6131 6131 s 	and	a
6132 6132 d 2807
6132 6132 s 	jr	z,A6126
6134 6134 d cd8f40
6134 6134 s 	call	A408F			; output to screen
6137 6137 d 23
6137 6137 s 	inc	hl
6138 6138 d f1
6138 6138 s 	pop	af
6139 6139 d 18f2
6139 6139 s 	jr	A6118			; print choice string
613b 613b s ;
613b 613b d f1
613b 613b s A6126:	pop	af
613c 613c d cd9b5f
613c 613c s 	call	A5F86
613f 613f d 3f2000
613f 613f s 	defb	"? ",0
6142 6142 d cdaa61
6142 6142 s A612D:	call	A6195			; get fresh consoleinput (CTRL-C aborts)
6145 6145 d d631
6145 6145 s 	sub	"1"
6147 6147 d fe09
6147 6147 s 	cp	009H			; input "1"-"9" ?
6149 6149 d 30f7
6149 6149 s 	jr	nc,A612D		; nope, ask again
614b 614b d c631
614b 614b s 	add	a,"1"
614d 614d d cddb62
614d 614d s A6138:	call	A62C6			; print input and CR/LF
6150 6150 d d630
6150 6150 s 	sub	"0"			; choice 1-9
6152 6152 d f5
6152 6152 s 	push	af
6153 6153 d cd8961
6153 6153 s A613E:	call	A6174			; prompt and get fresh consoleinput (CTRL-C aborts)
6156 6156 d f1
6156 6156 s 	pop	af
6157 6157 d d1
6157 6157 s 	pop	de
6158 6158 d fde1
6158 6158 s 	pop	iy
615a 615a d c1
615a 615a s 	pop	bc
615b 615b d e1
615b 615b s 	pop	hl
615c 615c d dd211c40
615c 615c s 	ld	ix,T401C
6160 6160 d cd1c00
6160 6160 s 	call	CALSLT			; call DSKFMT diskdriver
6163 6163 d 21f561
6163 6163 s 	ld	hl,T61E0
6166 6166 d 300a
6166 6166 s 	jr	nc,A615D		; no error, print "format complete" and quit
6168 6168 d 215d62
6168 6168 s 	ld	hl,T6248
616b 616b d cd0660
616b 616b s 	call	A5FF1			; get errorstring entry
616e 616e d 7e
616e 616e s 	ld	a,(hl)
616f 616f d 23
616f 616f s 	inc	hl
6170 6170 d 66
6170 6170 s 	ld	h,(hl)
6171 6171 d 6f
6171 6171 s 	ld	l,a			; pointer to errorstring
6172 6172 d cdde62
6172 6172 s A615D:	call	A62C9			; print CR/LF
6175 6175 d cda15f
6175 6175 s 	call	A5F8C			; print string
6178 6178 d c3de62
6178 6178 s 	jp	A62C9			; print CR/LF
617b 617b s 
617b 617b s ;	  Subroutine get fresh keyboardinput
617b 617b s ;	     Inputs  
617b 617b s ;	     Outputs ________________________ 
617b 617b s 
617b 617b d af
617b 617b s A6166:	xor	a
617c 617c d 3236f3
617c 617c s 	ld	(YF336),a		; no saved input
617f 617f d dd215601
617f 617f s 	ld	ix,KILBUF
6183 6183 d cdab40
6183 6183 s 	call	A40AB			; KILBUF BIOS call
6186 6186 d c37840
6186 6186 s 	jp	A4078			; get keyboardinput
6189 6189 s ;
6189 6189 d cd9b5f
6189 6189 s A6174:	call	A5F86
618c 618c d 537472696b652061206b6579207768656e2072656164792000
618c 618c s 	defb	"Strike a key when ready ",0
61a5 61a5 d 00
61a5 61a5 s 	nop
61a6 61a6 d 00
61a6 61a6 s 	nop
61a7 61a7 d 00
61a7 61a7 s 	nop
61a8 61a8 d 00
61a8 61a8 s 	nop				; room for expansion ??
61a9 61a9 d 00
61a9 61a9 s 	nop				; extra 5 bytes
61aa 61aa d cd7b61
61aa 61aa s A6195:	call	A6166			; get fresh keyboardinput
61ad 61ad d fe03
61ad 61ad s 	cp	003H
61af 61af d c0
61af 61af s 	ret	nz
61b0 61b0 d ed7b39f3
61b0 61b0 s 	ld	sp,(YF339)
61b4 61b4 d cd9b5f
61b4 61b4 s 	call	A5F86
61b7 61b7 d 0d0a41626f7274656400
61b7 61b7 s 	defb	13,10,"Aborted",0
61c1 61c1 d c9
61c1 61c1 s 	ret
61c2 61c2 s ;
61c2 61c2 s ;
61c2 61c2 d 57726974652070726f74656374656400
61c2 61c2 s T61AD:	defb	"Write protected",0
61d2 61d2 d 4e6f7420726561647900
61d2 61d2 s T61BD:	defb	"Not ready",0
61dc 61dc d 4469736b206572726f7200
61dc 61dc s T61C7:	defb	"Disk error",0
61e7 61e7 d 42616420706172616d6574657200
61e7 61e7 s T61D2:	defb	"Bad parameter",0
61f5 61f5 d 466f726d617420636f6d706c65746500
61f5 61f5 s T61E0:	defb	"Format complete",0
6205 6205 s 
6205 6205 s ; unused code ??
6205 6205 s ;
6205 6205 d 00
6205 6205 s 	nop
6206 6206 s ;
6206 6206 s ;
6206 6206 d 1198f6
6206 6206 s A61F1:	ld	de,TEMPST+30
6209 6209 d 2a78f6
6209 6209 s 	ld	hl,(TEMPPT)
620c 620c d 22f8f7
620c 620c s 	ld	(DAC+2),hl
620f 620f d 3e03
620f 620f s 	ld	a,003H
6211 6211 d 3263f6
6211 6211 s A61FC:	ld	(VALTYP),a
6214 6214 d cdf32e
6214 6214 s 	call	VMOVE
6217 6217 d 119bf6
6217 6217 s 	ld	de,TEMPST+30+3
621a 621a d e7
621a 621a s 	rst	020H
621b 621b d 2278f6
621b 621b s 	ld	(TEMPPT),hl
621e 621e d c0
621e 621e s 	ret	nz
621f 621f d c30c73
621f 621f s 	jp	A72F7
6222 6222 s ;
6222 6222 d 2121fb
6222 6222 s A620D:	ld	hl,YFB21
6225 6225 d 0604
6225 6225 s 	ld	b,004H
6227 6227 d 23
6227 6227 s A6212:	inc	hl
6228 6228 d 7e
6228 6228 s 	ld	a,(hl)
6229 6229 d f5
6229 6229 s 	push	af
622a 622a d fde1
622a 622a s 	pop	iy
622c 622c d 23
622c 622c s 	inc	hl
622d 622d d e5
622d 622d s 	push	hl
622e 622e d c5
622e 622e s 	push	bc
622f 622f d 211f40
622f 622f s 	ld	hl,T401F
6232 6232 d e5
6232 6232 s 	push	hl
6233 6233 d dde1
6233 6233 s 	pop	ix
6235 6235 d a7
6235 6235 s 	and	a
6236 6236 d c40c00
6236 6236 s 	call	nz,RDSLT
6239 6239 d a7
6239 6239 s A6224:	and	a
623a 623a d c41c00
623a 623a s 	call	nz,CALSLT
623d 623d d c1
623d 623d s 	pop	bc
623e 623e d e1
623e 623e s 	pop	hl
623f 623f d 10e6
623f 623f s 	djnz	A6212
6241 6241 d c9
6241 6241 s 	ret
6242 6242 s ;
6242 6242 d 3ad0fe
6242 6242 s A622D:	ld	a,(H.CLEA+0)
6245 6245 d fec9
6245 6245 s 	cp	0C9H
6247 6247 d 2811
6247 6247 s A6232:	jr	z,A6245
6249 6249 d 210773
6249 6249 s A6234:	ld	hl,T72F2
624c 624c d 11d5fe
624c 624c s 	ld	de,H.LOPD
624f 624f d 010500
624f 624f s 	ld	bc,00005H
6252 6252 d edb0
6252 6252 s 	ldir
6254 6254 d cd2d40
6254 6254 s 	call	A402D
6257 6257 d 32d6fe
6257 6257 s 	ld	(H.LOPD+1),a
625a 625a d c32d40
625a 625a s A6245:	jp	A402D
625d 625d s ;
625d 625d s ;
625d 625d d c261
625d 625d s T6248:	defw	T61AD		; dskfmt error 0
625f 625f d d261
625f 625f s 	defw	T61BD		; dskfmt error 2
6261 6261 d dc61
6261 6261 s 	defw	T61C7		; dskfmt error 4
6263 6263 d dc61
6263 6263 s 	defw	T61C7		; dskfmt error 6
6265 6265 d dc61
6265 6265 s 	defw	T61C7		; dskfmt error 8
6267 6267 d dc61
6267 6267 s 	defw	T61C7		; dskfmt error 10
6269 6269 d e761
6269 6269 s 	defw	T61D2		; dskfmt error 12
626b 626b d e55e
626b 626b s 	defw	T5ED0		; dskfmt error 14
626d 626d d dc61
626d 626d s 	defw	T61C7		; dskfmt error 16
626f 626f s 
626f 626f s PROMPT:
626f 626f d 3a3ff3
626f 626f s L625A:	ld	a,(YF33F)		; driveid
6272 6272 d c641
6272 6272 s 	add	a,"A"
6274 6274 d cd4ff2
6274 6274 s 	call	XF24F			; PROMPT hook
6277 6277 d f5
6277 6277 s 	push	af
6278 6278 d cd9b5f
6278 6278 s 	call	A5F86
627b 627b d 0d0a496e73657274206469736b6574746520666f722064726976652000
627b 627b s 	defb	13,10,"Insert diskette for drive ",0
6298 6298 d 00
6298 6298 s 	nop
6299 6299 d 00
6299 6299 s 	nop
629a 629a d 00
629a 629a s 	nop
629b 629b d 00
629b 629b s 	nop
629c 629c d 00
629c 629c s 	nop
629d 629d d 00
629d 629d s 	nop
629e 629e d 00
629e 629e s 	nop
629f 629f d 00
629f 629f s 	nop
62a0 62a0 d 00
62a0 62a0 s 	nop				; room for expansion
62a1 62a1 d 00
62a1 62a1 s 	nop				; extra 10 bytes
62a2 62a2 d f1
62a2 62a2 s 	pop	af
62a3 62a3 d cd8f40
62a3 62a3 s 	call	A408F			; output to screen
62a6 62a6 d cd9b5f
62a6 62a6 s 	call	A5F86
62a9 62a9 d 3a0d0a616e6420737472696b652061206b6579207768656e20726561647900
62a9 62a9 s 	defb	":",13,10,"and strike a key when ready",0
62c8 62c8 d 00
62c8 62c8 s 	nop
62c9 62c9 d 00
62c9 62c9 s 	nop
62ca 62ca d 00
62ca 62ca s 	nop
62cb 62cb d 00
62cb 62cb s 	nop
62cc 62cc d 00
62cc 62cc s 	nop
62cd 62cd d 00
62cd 62cd s 	nop
62ce 62ce d 00
62ce 62ce s 	nop
62cf 62cf d 00
62cf 62cf s 	nop
62d0 62d0 d 00
62d0 62d0 s 	nop				; room for expansion
62d1 62d1 d 00
62d1 62d1 s 	nop				; extra 10 bytes
62d2 62d2 d cd7b61
62d2 62d2 s A62BD:	call	A6166			; get fresh keyboardinput
62d5 62d5 d fe03
62d5 62d5 s 	cp	003H
62d7 62d7 d 28f9
62d7 62d7 s 	jr	z,A62BD
62d9 62d9 d 1803
62d9 62d9 s 	jr	A62C9			; print CR/LF
62db 62db s ;
62db 62db d cd8f40
62db 62db s A62C6:	call	A408F			; output to screen
62de 62de d f5
62de 62de s A62C9:	push	af
62df 62df d 3e0d
62df 62df s 	ld	a,00DH
62e1 62e1 d cd8f40
62e1 62e1 s 	call	A408F			; output to screen
62e4 62e4 d 3e0a
62e4 62e4 s 	ld	a,00AH
62e6 62e6 d cd8f40
62e6 62e6 s 	call	A408F			; output to screen
62e9 62e9 d f1
62e9 62e9 s A62D4:	pop	af
62ea 62ea d c9
62ea 62ea s 	ret
62eb 62eb s ;
62eb 62eb d 2100ff
62eb 62eb s A62D6:	ld	hl,0FF00H
62ee 62ee d 39
62ee 62ee s 	add	hl,sp			; leave room for the stack
62ef 62ef d ed5bc6f6
62ef 62ef s 	ld	de,(STREND)		; end of used BASIC memory
62f3 62f3 d af
62f3 62f3 s 	xor	a
62f4 62f4 d ed52
62f4 62f4 s 	sbc	hl,de
62f6 62f6 d 4d
62f6 62f6 s 	ld	c,l
62f7 62f7 d 44
62f7 62f7 s 	ld	b,h			; size of buffer
62f8 62f8 d eb
62f8 62f8 s 	ex	de,hl			; start of buffer
62f9 62f9 d d0
62f9 62f9 s 	ret	nc
62fa 62fa d 4f
62fa 62fa s 	ld	c,a
62fb 62fb d 47
62fb 62fb s 	ld	b,a			; not enough room, size=0
62fc 62fc d c9
62fc 62fc s 	ret
62fd 62fd s ;
62fd 62fd s ;
62fd 62fd d 33
62fd 62fd s T62E8:	inc	sp
62fe 62fe d 33
62fe 62fe s 	inc	sp
62ff 62ff d c31d6f
62ff 62ff s 	jp	SKPCHK
6302 6302 s ;
6302 6302 s ;
6302 6302 d 7a
6302 6302 s T62ED:	ld	a,d
6303 6303 d fe09
6303 6303 s 	cp	009H
6305 6305 d d2c96e
6305 6305 s 	jp	nc,CALBLD+3
6308 6308 d f7
6308 6308 s 	rst	030H
6309 6309 d 00
6309 6309 s 	defb	000H
630a 630a d bc6a
630a 630a s 	defw	A6AA7
630c 630c d e5
630c 630c s 	push	hl
630d 630d d c3f46e
630d 630d s 	jp	EXEBLD
6310 6310 s ;
6310 6310 s ;
6310 6310 d 7a
6310 6310 s 	ld	a,d
6311 6311 d fe09
6311 6311 s 	cp	009H
6313 6313 d d2956e
6313 6313 s 	jp	nc,CALBSV+3
6316 6316 d f7
6316 6316 s 	rst	030H
6317 6317 d 00
6317 6317 s 	defb	000H
6318 6318 d fc69
6318 6318 s 	defw	A69E7
631a 631a d c9
631a 631a s 	ret
631b 631b s ;
631b 631b s ; CHANGED TO CREATE ROOM FOR FUTURE EXPANDING CODE
631b 631b s ; routine functions have compatible code
631b 631b s ;
631b 631b d 1a
631b 631b s A6306:	ld	a,(de)
631c 631c d 13
631c 631c s 	inc	de
631d 631d d b7
631d 631d s 	or	a
631e 631e d c8
631e 631e s 	ret	z
631f 631f d dd2a4bf3
631f 631f s 	ld	ix,(YF34B)
6323 6323 d 0600
6323 6323 s 	ld	b,0
6325 6325 d 4f
6325 6325 s 	ld	c,a
6326 6326 d dd09
6326 6326 s 	add	ix,bc
6328 6328 d dd4e00
6328 6328 s 	ld	c,(ix+0)
632b 632b d dd4601
632b 632b s 	ld	b,(ix+1)
632e 632e d 09
632e 632e s 	add	hl,bc
632f 632f d dd7500
632f 632f s 	ld	(ix+0),l
6332 6332 d dd7401
6332 6332 s 	ld	(ix+1),h
6335 6335 d ed42
6335 6335 s 	sbc	hl,bc
6337 6337 d 18e2
6337 6337 s 	jr	A6306
6339 6339 s 
6339 6339 s ; relocate data
6339 6339 s ;
6339 6339 d 0d
6339 6339 s T632E:	defb	R0000+1-A6336
633a 633a d 1f
633a 633a s 	defb	R0001+2-A6336
633b 633b d 22
633b 633b s 	defb	R0002+1-A6336
633c 633c d 30
633c 633c s 	defb	R0003+1-A6336
633d 633d d 46
633d 633d s 	defb	R0100+1-A6336
633e 633e d 49
633e 633e s 	defb	R0101+1-A6336
633f 633f d 57
633f 633f s 	defb	R0102+1-A6336
6340 6340 d 5c
6340 6340 s 	defb	R0103+1-A6336
6341 6341 d 62
6341 6341 s 	defb	R0200+1-A6336
6342 6342 d 65
6342 6342 s 	defb	R0201+1-A6336
6343 6343 d 73
6343 6343 s 	defb	R0202+1-A6336
6344 6344 d 79
6344 6344 s 	defb	R0203+1-A6336
6345 6345 d aa
6345 6345 s 	defb	R0300+1-A6336
6346 6346 d ad
6346 6346 s 	defb	R0301+1-A6336
6347 6347 d b9
6347 6347 s 	defb	R0302+1-A6336
6348 6348 d cf
6348 6348 s 	defb	R0303+1-A6336
6349 6349 d ea
6349 6349 s 	defb	R0400+1-A6336
634a 634a d ed
634a 634a s 	defb	R0401+1-A6336
634b 634b d f8
634b 634b s 	defb	R0402+1-A6336
634c 634c d 00
634c 634c s 	defb	0
634d 634d s 
634d 634d s ;
634d 634d s ; DOS KEYINT routine
634d 634d s ;
634d 634d s 
634d 634d d dde5
634d 634d s A6336:	push	ix
634f 634f d fde5
634f 634f s 	push	iy
6351 6351 d e5
6351 6351 s 	push	hl
6352 6352 d d5
6352 6352 s 	push	de
6353 6353 d c5
6353 6353 s 	push	bc
6354 6354 d f5
6354 6354 s 	push	af
6355 6355 d d9
6355 6355 s 	exx
6356 6356 d 08
6356 6356 s 	ex	af,af'
6357 6357 d f5
6357 6357 s 	push	af
6358 6358 d e5
6358 6358 s 	push	hl
6359 6359 d 2a7663
6359 6359 s R0000:	ld	hl,(D635E+1)
635c 635c d 7d
635c 635c s 	ld	a,l
635d 635d d b4
635d 635d s 	or	h			; already in KEYINT ?
635e 635e d e1
635e 635e s 	pop	hl
635f 635f d dd213800
635f 635f s 	ld	ix,KEYINT
6363 6363 d fd2ac0fc
6363 6363 s 	ld	iy,(EXPTBL-1+0)
6367 6367 d 2023
6367 6367 s 	jr	nz,A6375		; yep, start BIOS KEYINT
6369 6369 d f1
6369 6369 s 	pop	af
636a 636a d ed737663
636a 636a s R0001:	ld	(D635E+1),sp		; save current stackpointer
636e 636e d 314d63
636e 636e s R0002:	ld	sp,A6336		; switch to special KEYINT stack (because stackpointer in DOS could be in page 0)
6371 6371 d cd1c00
6371 6371 s 	call	CALSLT			; start BIOS KEYINT
6374 6374 d f3
6374 6374 s 	di
6375 6375 d 310000
6375 6375 s D635E:	ld	sp,00000H		; restore orginal stackpointer
6378 6378 d e5
6378 6378 s 	push	hl
6379 6379 d 210000
6379 6379 s 	ld	hl,0
637c 637c d 227663
637c 637c s R0003:	ld	(D635E+1),hl		; flag not in KEYINT
637f 637f d e1
637f 637f s 	pop	hl
6380 6380 d 08
6380 6380 s A6369:	ex	af,af'
6381 6381 d d9
6381 6381 s 	exx
6382 6382 d f1
6382 6382 s 	pop	af
6383 6383 d c1
6383 6383 s 	pop	bc
6384 6384 d d1
6384 6384 s 	pop	de
6385 6385 d e1
6385 6385 s A636E:	pop	hl
6386 6386 d fde1
6386 6386 s 	pop	iy
6388 6388 d dde1
6388 6388 s 	pop	ix
638a 638a d fb
638a 638a s 	ei
638b 638b d c9
638b 638b s 	ret
638c 638c s ;
638c 638c d f1
638c 638c s A6375:	pop	af
638d 638d d cd1c00
638d 638d s 	call	CALSLT
6390 6390 d 18ee
6390 6390 s 	jr	A6369
6392 6392 s 
6392 6392 s ; DOS RDSLT routine
6392 6392 s 
6392 6392 s A63F4:
6392 6392 d cd5664
6392 6392 s R0100:	call	A64C2			; calculate masks
6395 6395 d faa263
6395 6395 s R0101:	jp	m,A6404			; expanded slot specified,
6398 6398 d dba8
6398 6398 s 	in	a,(0A8H)
639a 639a d 57
639a 639a s 	ld	d,a			; save primary slotregister
639b 639b d a1
639b 639b s 	and	c
639c 639c d b0
639c 639c s 	or	b			; change slot of specified page
639d 639d d cd80f3
639d 639d s 	call	RDPRIM			; change primary slotregister, read memory and restore primary slotregister
63a0 63a0 d 7b
63a0 63a0 s 	ld	a,e
63a1 63a1 d c9
63a1 63a1 s 	ret
63a2 63a2 s ;
63a2 63a2 d e5
63a2 63a2 s A6404:	push	hl
63a3 63a3 d cd7964
63a3 63a3 s R0102:	call	A64E7			; setup secundairy slotregister
63a6 63a6 d e3
63a6 63a6 s 	ex	(sp),hl
63a7 63a7 d c5
63a7 63a7 s 	push	bc
63a8 63a8 d cd9263
63a8 63a8 s R0103:	call	A63F4			; RDSLT, but now only with primary slot
63ab 63ab d 181b
63ab 63ab s 	jr	A6436			; restore secundairy slotregister
63ad 63ad s 
63ad 63ad s ; DOS WRSLT routine
63ad 63ad s ;
63ad 63ad d d5
63ad 63ad s A6415:	push	de
63ae 63ae d cd5664
63ae 63ae s R0200:	call	A64C2			; calculate masks
63b1 63b1 d fabd63
63b1 63b1 s R0201:	jp	m,A6425			; expanded slot specified,
63b4 63b4 d d1
63b4 63b4 s 	pop	de
63b5 63b5 d dba8
63b5 63b5 s 	in	a,(0A8H)
63b7 63b7 d 57
63b7 63b7 s 	ld	d,a			; save primary slotregister
63b8 63b8 d a1
63b8 63b8 s 	and	c
63b9 63b9 d b0
63b9 63b9 s 	or	b			; change slot of specified page
63ba 63ba d c385f3
63ba 63ba s 	jp	WRPRIM			; change primairy slotregister, write memory and restore primary slotregister
63bd 63bd s ;
63bd 63bd d e3
63bd 63bd s A6425:	ex	(sp),hl
63be 63be d e5
63be 63be s 	push	hl
63bf 63bf d cd7964
63bf 63bf s R0202:	call	A64E7			; setup secundairy slotregister
63c2 63c2 d d1
63c2 63c2 s 	pop	de
63c3 63c3 d e3
63c3 63c3 s 	ex	(sp),hl
63c4 63c4 d c5
63c4 63c4 s 	push	bc
63c5 63c5 d cdad63
63c5 63c5 s R0203:	call	A6415			; WRSLT, but now only with primary slot
63c8 63c8 d c1
63c8 63c8 s A6436:	pop	bc
63c9 63c9 d e3
63c9 63c9 s 	ex	(sp),hl
63ca 63ca d f5
63ca 63ca s 	push	af
63cb 63cb d 78
63cb 63cb s 	ld	a,b
63cc 63cc d e63f
63cc 63cc s 	and	03FH
63ce 63ce d b1
63ce 63ce s 	or	c
63cf 63cf d b8
63cf 63cf s 	cp	b			; restore secundairy slotregister currently in page 3 ?
63d0 63d0 d 2004
63d0 63d0 s 	jr	nz,ARDWR		; nope, use helper routine in page 0
63d2 63d2 d 7d
63d2 63d2 s 	ld	a,l
63d3 63d3 d 32ffff
63d3 63d3 s 	ld	(0FFFFH),a		; yep, restore secundairy slotregister directly to avoid crash for page 0 addresses
63d6 63d6 d c44600
63d6 63d6 s ARDWR:	call	nz,X0046		; restore secundairy slotregister
63d9 63d9 d f1
63d9 63d9 s 	pop	af
63da 63da d e1
63da 63da s 	pop	hl
63db 63db d c9
63db 63db s 	ret
63dc 63dc s 
63dc 63dc s ; DOS CALLF routine
63dc 63dc s ;
63dc 63dc d e3
63dc 63dc s A6443:	ex	(sp),hl
63dd 63dd d f5
63dd 63dd s 	push	af
63de 63de d d5
63de 63de s 	push	de
63df 63df d 7e
63df 63df s 	ld	a,(hl)
63e0 63e0 d f5
63e0 63e0 s 	push	af
63e1 63e1 d fde1
63e1 63e1 s 	pop	iy
63e3 63e3 d 23
63e3 63e3 s 	inc	hl
63e4 63e4 d 5e
63e4 63e4 s 	ld	e,(hl)
63e5 63e5 d 23
63e5 63e5 s 	inc	hl
63e6 63e6 d 56
63e6 63e6 s 	ld	d,(hl)
63e7 63e7 d 23
63e7 63e7 s 	inc	hl
63e8 63e8 d d5
63e8 63e8 s 	push	de
63e9 63e9 d dde1
63e9 63e9 s 	pop	ix
63eb 63eb d d1
63eb 63eb s 	pop	de
63ec 63ec d f1
63ec 63ec s 	pop	af
63ed 63ed d e3
63ed 63ed s 	ex	(sp),hl
63ee 63ee s 
63ee 63ee s ; DOS CALSLT routine
63ee 63ee s ;
63ee 63ee d d9
63ee 63ee s A6455:	exx
63ef 63ef d 08
63ef 63ef s 	ex	af,af'
63f0 63f0 d fde5
63f0 63f0 s 	push	iy
63f2 63f2 d f1
63f2 63f2 s 	pop	af
63f3 63f3 d dde5
63f3 63f3 s 	push	ix
63f5 63f5 d e1
63f5 63f5 s 	pop	hl
63f6 63f6 d cd5664
63f6 63f6 s R0300:	call	A64C2			; calculate masks
63f9 63f9 d fa0564
63f9 63f9 s R0301:	jp	m,A646C			; expanded slot specified,
63fc 63fc d dba8
63fc 63fc s 	in	a,(0A8H)
63fe 63fe d f5
63fe 63fe s 	push	af			; save primary slotregister
63ff 63ff d a1
63ff 63ff s 	and	c
6400 6400 d b0
6400 6400 s 	or	b			; change slot of specified page
6401 6401 d d9
6401 6401 s 	exx
6402 6402 d c38cf3
6402 6402 s 	jp	CLPRIM			; change primary slotregister, execute routine and restore primary slotregister
6405 6405 s ;
6405 6405 s A646C:
6405 6405 d cd7964
6405 6405 s R0302:	call	A64E7			; setup secundairy slotregister
6408 6408 d f5
6408 6408 s 	push	af
6409 6409 d fde1
6409 6409 s 	pop	iy
640b 640b d e5
640b 640b s 	push	hl
640c 640c d c5
640c 640c s 	push	bc
640d 640d d 4f
640d 640d s 	ld	c,a
640e 640e d 0600
640e 640e s 	ld	b,000H
6410 6410 d 7d
6410 6410 s 	ld	a,l
6411 6411 d a4
6411 6411 s 	and	h
6412 6412 d b2
6412 6412 s 	or	d
6413 6413 d 21c5fc
6413 6413 s 	ld	hl,SLTTBL
6416 6416 d 09
6416 6416 s 	add	hl,bc
6417 6417 d 77
6417 6417 s 	ld	(hl),a			; update SLTTBL to reflect the change of the secundairy slotregister
6418 6418 d e5
6418 6418 s 	push	hl
6419 6419 d 08
6419 6419 s 	ex	af,af'
641a 641a d d9
641a 641a s 	exx
641b 641b d cdee63
641b 641b s R0303:	call	A6455			; CALSLT, but now only with primary slot
641e 641e d d9
641e 641e s 	exx
641f 641f d 08
641f 641f s 	ex	af,af'
6420 6420 d e1
6420 6420 s 	pop	hl
6421 6421 d c1
6421 6421 s 	pop	bc
6422 6422 d d1
6422 6422 s 	pop	de
6423 6423 d 78
6423 6423 s 	ld	a,b
6424 6424 d e63f
6424 6424 s 	and	03FH
6426 6426 d b1
6426 6426 s 	or	c
6427 6427 d f3
6427 6427 s 	di
6428 6428 d b8
6428 6428 s 	cp	b			; same primairy slot ?
6429 6429 d 2004
6429 6429 s 	jr	nz,ACALL		; nope, use the helper routine in page 0
642b 642b d 7b
642b 642b s 	ld	a,e
642c 642c d 32ffff
642c 642c s 	ld	(0FFFFH),a		; yep, setup secudairy slotregister directly to avoid crash for page 0 addresses
642f 642f d c44b00
642f 642f s ACALL:	call	nz,X004B		; nope, setup secundairy slotregister
6432 6432 d 73
6432 6432 s 	ld	(hl),e
6433 6433 d 08
6433 6433 s 	ex	af,af'
6434 6434 d d9
6434 6434 s 	exx
6435 6435 d c9
6435 6435 s 	ret
6436 6436 s 
6436 6436 s ; DOS ENASLT routine
6436 6436 s ;
6436 6436 s A649C:
6436 6436 d cd5664
6436 6436 s R0400:	call	A64C2			; calculate masks
6439 6439 d fa4364
6439 6439 s R0401:	jp	m,A64A9			; expanded slot specified,
643c 643c d dba8
643c 643c s A64A2:	in	a,(0A8H)
643e 643e d a1
643e 643e s 	and	c
643f 643f d b0
643f 643f s 	or	b
6440 6440 d d3a8
6440 6440 s 	out	(0A8H),a		; change slot of specified page
6442 6442 d c9
6442 6442 s 	ret
6443 6443 s ;
6443 6443 s A64A9:
6443 6443 d e5
6443 6443 s A64AF:	push	hl
6444 6444 d cd7964
6444 6444 s R0402:	call	A64E7			; setup secundairy slotregister
6447 6447 d 4f
6447 6447 s 	ld	c,a
6448 6448 d 0600
6448 6448 s 	ld	b,000H
644a 644a d 7d
644a 644a s 	ld	a,l
644b 644b d a4
644b 644b s 	and	h
644c 644c d b2
644c 644c s 	or	d
644d 644d d 21c5fc
644d 644d s 	ld	hl,SLTTBL
6450 6450 d 09
6450 6450 s 	add	hl,bc
6451 6451 d 77
6451 6451 s 	ld	(hl),a			; update SLTTBL to reflect the change of the secundairy slotregister
6452 6452 d e1
6452 6452 s 	pop	hl
6453 6453 d 79
6453 6453 s 	ld	a,c
6454 6454 d 18e0
6454 6454 s 	jr	A649C			; ENASLT, but now only with primary slot
6456 6456 s ;
6456 6456 d f3
6456 6456 s A64C2:	di
6457 6457 d f5
6457 6457 s 	push	af
6458 6458 d e603
6458 6458 s 	and	003H
645a 645a d 47
645a 645a s 	ld	b,a
645b 645b d 04
645b 645b s 	inc	b
645c 645c d 3eab
645c 645c s 	ld	a,0ABH
645e 645e d c655
645e 645e s A64DD:	add	a,055H
6460 6460 d 10fc
6460 6460 s 	djnz	A64DD
6462 6462 d 57
6462 6462 s 	ld	d,a			; primary slot mask (PP PP PP PP)
6463 6463 d 7c
6463 6463 s 	ld	a,h
6464 6464 d 07
6464 6464 s 	rlca
6465 6465 d 07
6465 6465 s 	rlca
6466 6466 d e603
6466 6466 s 	and	003H
6468 6468 d 47
6468 6468 s 	ld	b,a
6469 6469 d 04
6469 6469 s 	inc	b
646a 646a d 3ec0
646a 646a s 	ld	a,0C0H
646c 646c d 07
646c 646c s A64CD:	rlca
646d 646d d 07
646d 646d s 	rlca
646e 646e d 10fc
646e 646e s 	djnz	A64CD
6470 6470 d 5f
6470 6470 s 	ld	e,a			; select page mask
6471 6471 d 2f
6471 6471 s 	cpl
6472 6472 d 4f
6472 6472 s 	ld	c,a			; clear page mask
6473 6473 d 7a
6473 6473 s 	ld	a,d
6474 6474 d a3
6474 6474 s 	and	e
6475 6475 d 47
6475 6475 s 	ld	b,a			; set primary slot mask
6476 6476 d f1
6476 6476 s 	pop	af
6477 6477 d a7
6477 6477 s 	and	a			; sign flag set if expanded slot
6478 6478 d c9
6478 6478 s 	ret
6479 6479 s 
6479 6479 d f5
6479 6479 s A64E7:	push	af
647a 647a d e60c
647a 647a s 	and	00CH
647c 647c d 0f
647c 647c s 	rrca
647d 647d d 0f
647d 647d s 	rrca				; requested secundairy slot in b1-b0
647e 647e d 47
647e 647e s 	ld	b,a
647f 647f d 04
647f 647f s 	inc	b
6480 6480 d 3eab
6480 6480 s 	ld	a,0ABH
6482 6482 d c655
6482 6482 s A64FF:	add	a,055H
6484 6484 d 10fc
6484 6484 s 	djnz	A64FF
6486 6486 d a3
6486 6486 s 	and	e
6487 6487 d 57
6487 6487 s 	ld	d,a
6488 6488 d 7b
6488 6488 s 	ld	a,e
6489 6489 d 2f
6489 6489 s 	cpl
648a 648a d 67
648a 648a s 	ld	h,a
648b 648b d f1
648b 648b s 	pop	af
648c 648c d e603
648c 648c s 	and	003H			; requested primary slot in b1-b0
648e 648e d f5
648e 648e s 	push	af
648f 648f d 0f
648f 648f s 	rrca
6490 6490 d 0f
6490 6490 s 	rrca
6491 6491 d 4f
6491 6491 s 	ld	c,a			; OR mask for selecting primary slot in page 3
6492 6492 d dba8
6492 6492 s 	in	a,(0A8H)
6494 6494 d 47
6494 6494 s 	ld	b,a			; current primary slotregister
6495 6495 d e63f
6495 6495 s 	and	03FH
6497 6497 d b1
6497 6497 s 	or	c
6498 6498 d b8
6498 6498 s 	cp	b			; change secundairy slotregister currently in page 3 ?
6499 6499 d 200c
6499 6499 s 	jr	nz,ASSEC		; no, use helper routine in page 0
649b 649b d 3affff
649b 649b s 	ld	a,(0FFFFH)
649e 649e d 2f
649e 649e s 	cpl
649f 649f d 6f
649f 649f s 	ld	l,a
64a0 64a0 d a4
64a0 64a0 s 	and	h
64a1 64a1 d b2
64a1 64a1 s 	or	d
64a2 64a2 d 32ffff
64a2 64a2 s 	ld	(0FFFFH),a		; yep adjust secundairy slotregister directly to avoid crash for page 0 addresses
64a5 64a5 d f1
64a5 64a5 s 	pop	af
64a6 64a6 d c9
64a6 64a6 s 	ret
64a7 64a7 d cd3b00
64a7 64a7 s ASSEC:	call	X003B			; save and change secundairy slotregister
64aa 64aa d f1
64aa 64aa s 	pop	af
64ab 64ab d c9
64ab 64ab s 	ret
64ac 64ac s 
64ac 64ac s ; DOS ENAKRN routine
64ac 64ac s ;
64ac 64ac d f5
64ac 64ac s A63A1:	push	af
64ad 64ad d 3a48f3
64ad 64ad s 	ld	a,(YF348)		; slotid kernel ROM
64b0 64b0 d 1804
64b0 64b0 s 	jr	A63AD
64b2 64b2 s 
64b2 64b2 s ; DOS ENARAM routine
64b2 64b2 s ;
64b2 64b2 d f5
64b2 64b2 s A63A3:	push	af
64b3 64b3 d 3a42f3
64b3 64b3 s 	ld	a,(RAMAD1)		; slotid TPA (RAM) page 1
64b6 64b6 d e5
64b6 64b6 s A63AD:	push	hl
64b7 64b7 d d5
64b7 64b7 s 	push	de
64b8 64b8 d c5
64b8 64b8 s 	push	bc
64b9 64b9 d 2640
64b9 64b9 s 	ld	h,040H
64bb 64bb d cd2400
64bb 64bb s 	call	ENASLT
64be 64be d c1
64be 64be s 	pop	bc
64bf 64bf d d1
64bf 64bf s 	pop	de
64c0 64c0 d e1
64c0 64c0 s 	pop	hl
64c1 64c1 d f1
64c1 64c1 s 	pop	af
64c2 64c2 d c9
64c2 64c2 s 	ret
64c3 64c3 s 
64c3 64c3 s ; DOS XFER routine
64c3 64c3 s ;
64c3 64c3 d f5
64c3 64c3 s A637B:	push	af
64c4 64c4 d e5
64c4 64c4 s 	push	hl
64c5 64c5 d d5
64c5 64c5 s 	push	de
64c6 64c6 d c5
64c6 64c6 s 	push	bc
64c7 64c7 d cd2d40
64c7 64c7 s 	call	A402D
64ca 64ca d f5
64ca 64ca s 	push	af			; save slotid currently on page 1 (the diskdriver ROM)
64cb 64cb d 2640
64cb 64cb s 	ld	h,040H
64cd 64cd d 3a42f3
64cd 64cd s 	ld	a,(RAMAD1)
64d0 64d0 d cd2400
64d0 64d0 s 	call	ENASLT			; enable TPA (RAM) on page 1
64d3 64d3 d f1
64d3 64d3 s 	pop	af
64d4 64d4 d c1
64d4 64d4 s 	pop	bc
64d5 64d5 d d1
64d5 64d5 s 	pop	de
64d6 64d6 d e1
64d6 64d6 s 	pop	hl
64d7 64d7 d edb0
64d7 64d7 s 	ldir				; transfer to/from TPA
64d9 64d9 d e5
64d9 64d9 s 	push	hl
64da 64da d d5
64da 64da s 	push	de
64db 64db d c5
64db 64db s 	push	bc
64dc 64dc d cd68f3
64dc 64dc s 	call	XF368			; enable kernel ROM on page 1
64df 64df d 2640
64df 64df s 	ld	h,040H
64e1 64e1 d cd2400
64e1 64e1 s 	call	ENASLT			; restore diskdriver ROM on page 1
64e4 64e4 d c1
64e4 64e4 s 	pop	bc
64e5 64e5 d d1
64e5 64e5 s 	pop	de
64e6 64e6 d e1
64e6 64e6 s 	pop	hl
64e7 64e7 d f1
64e7 64e7 s 	pop	af
64e8 64e8 d c9
64e8 64e8 s 	ret
64e9 64e9 s 
64e9 64e9 s 
64e9 64e9 s LDOSR	equ	$-A6336
64e9 64e9 s ;
64e9 64e9 s A655C:
64e9 64e9 s 
64e9 64e9 s ; change secundairy slotregister (copied to 003BH)
64e9 64e9 s 
64e9 64e9 d d3a8
64e9 64e9 s 	out	(0A8H),a
64eb 64eb d 3affff
64eb 64eb s 	ld	a,(YFFFF)
64ee 64ee d 2f
64ee 64ee s 	cpl
64ef 64ef d 6f
64ef 64ef s 	ld	l,a
64f0 64f0 d a4
64f0 64f0 s 	and	h
64f1 64f1 d b2
64f1 64f1 s 	or	d
64f2 64f2 d 1808
64f2 64f2 s 	jr	A656F
64f4 64f4 s 
64f4 64f4 s ; restore secundairy slotregister (copied to 0046H)
64f4 64f4 s 
64f4 64f4 d d3a8
64f4 64f4 s 	out	(0A8H),a
64f6 64f6 d 7d
64f6 64f6 s 	ld	a,l
64f7 64f7 d 1803
64f7 64f7 s 	jr	A656F
64f9 64f9 s 
64f9 64f9 s ; setup secundairy slotregister (copied to 004BH)
64f9 64f9 s 
64f9 64f9 d d3a8
64f9 64f9 s 	out	(0A8H),a
64fb 64fb d 7b
64fb 64fb s 	ld	a,e
64fc 64fc d 32ffff
64fc 64fc s A656F:	ld	(YFFFF),a
64ff 64ff d 78
64ff 64ff s 	ld	a,b
6500 6500 d d3a8
6500 6500 s 	out	(0A8H),a
6502 6502 d c9
6502 6502 s 	ret
6503 6503 s ;
6503 6503 s ; NEW ROUTINE: READ BOOTSECTOR FROM ANY PHYSICAL DRIVE
6503 6503 s ;
6503 6503 d 215f65
6503 6503 s ABOOT:	ld	hl,AINCP
6506 6506 d 1168f5
6506 6506 s 	ld	de,BUF+10
6509 6509 d 010800
6509 6509 s 	ld	bc,LINCP
650c 650c d edb0
650c 650c s 	ldir
650e 650e d 3a47f3
650e 650e s 	ld	a,(YF347)
6511 6511 d 47
6511 6511 s 	ld	b,a			; try all drives
6512 6512 d 0e00
6512 6512 s 	ld	c,0			; begin with A:
6514 6514 d 79
6514 6514 s ANXBT:	ld	a,c
6515 6515 d 3247f2
6515 6515 s 	ld	(YF247),a		; set default drive
6518 6518 d cd4765
6518 6518 s 	call	ADPTH			; hook PROMPT
651b 651b d c5
651b 651b s 	push	bc
651c 651c d cda75a
651c 651c s 	call	A5AE7			; read bootsector from the default drive
651f 651f d c1
651f 651f s 	pop	bc
6520 6520 d 9f
6520 6520 s 	sbc	a,a
6521 6521 d 5f
6521 6521 s 	ld	e,a			; validflag
6522 6522 d 3a4ff2
6522 6522 s 	ld	a,(XF24F)
6525 6525 d fec3
6525 6525 s 	cp	0C3H			; used PROMPT (panthom drive)
6527 6527 d 280f
6527 6527 s 	jr	z,ANPTH			; nop,
6529 6529 d cd4765
6529 6529 s 	call	ADPTH			; hook PROMPT
652c 652c d 79
652c 652c s 	ld	a,c
652d 652d d 3d
652d 652d s 	dec	a
652e 652e d 3247f2
652e 652e s 	ld	(YF247),a		; physical drive panthomed is now default
6531 6531 d c5
6531 6531 s 	push	bc
6532 6532 d cda75a
6532 6532 s 	call	A5AE7			; read bootsector from the default drive (just restoring panthom status)
6535 6535 d c1
6535 6535 s 	pop	bc
6536 6536 d 1eff
6536 6536 s 	ld	e,0FFH			; invalid
6538 6538 d cd5365
6538 6538 s ANPTH:	call	AEPTH			; clear hook PROMPT
653b 653b d af
653b 653b s 	xor	a
653c 653c d 93
653c 653c s 	sub	e
653d 653d d d0
653d 653d s 	ret	nc			; valid bootsector, quit
653e 653e d 0c
653e 653e s 	inc	c
653f 653f d 10d3
653f 653f s 	djnz	ANXBT			; next drive
6541 6541 d af
6541 6541 s 	xor	a
6542 6542 d 3247f2
6542 6542 s 	ld	(YF247),a
6545 6545 d 37
6545 6545 s 	scf				; none found, restore A: as default drive
6546 6546 d c9
6546 6546 s 	ret
6547 6547 s 
6547 6547 d 214ff2
6547 6547 s ADPTH:	ld	hl,XF24F
654a 654a d 36c3
654a 654a s 	ld	(hl),0C3H
654c 654c d 23
654c 654c s 	inc	hl
654d 654d d 3668
654d 654d s 	ld	(hl),LOW (BUF+10)
654f 654f d 23
654f 654f s 	inc	hl
6550 6550 d 36f5
6550 6550 s 	ld	(hl),HIGH (BUF+10)
6552 6552 d c9
6552 6552 s 	ret
6553 6553 s 
6553 6553 d 214ff2
6553 6553 s AEPTH:	ld	hl,XF24F
6556 6556 d 36c9
6556 6556 s 	ld	(hl),0C9H
6558 6558 d 23
6558 6558 s 	inc	hl
6559 6559 d 36c9
6559 6559 s 	ld	(hl),0C9H
655b 655b d 23
655b 655b s 	inc	hl
655c 655c d 36c9
655c 655c s 	ld	(hl),0C9H
655e 655e d c9
655e 655e s 	ret
655f 655f s 
655f 655f d e3
655f 655f s AINCP:	ex	(sp),hl
6560 6560 d 214ff2
6560 6560 s 	ld	hl,XF24F
6563 6563 d 36c9
6563 6563 s 	ld	(hl),0C9H
6565 6565 d e1
6565 6565 s 	pop	hl
6566 6566 d c9
6566 6566 s 	ret
6567 6567 s 
6567 6567 s LINCP	equ	$-AINCP
6567 6567 s ;
6567 6567 s ; UNUSED SPACE IS FILLED WITH NOPS, TO KEEP FOLLOWING CODE AT
6567 6567 s ; THE SAME ADDRESSES FOR MAXIUM COMPATIBLITY
6567 6567 s ;
6567 6567 s 	defs	06576H-06306H-($-A6306),0
6567 6567 d 00000000000000000000000000000000
6577 6577 d 00000000000000000000000000000000
6587 6587 d 00000000
658b 658b s ;
658b 658b s ; END OF CHANGE
658b 658b s ;
658b 658b d 3a4efe
658b 658b s A6576:	ld	a,(H.GETP+0)
658e 658e d fec9
658e 658e s 	cp	0C9H
6590 6590 d 37
6590 6590 s 	scf
6591 6591 d c8
6591 6591 s 	ret	z
6592 6592 d e5
6592 6592 s 	push	hl
6593 6593 d cd2d40
6593 6593 s 	call	A402D
6596 6596 d 2148f3
6596 6596 s 	ld	hl,YF348
6599 6599 d be
6599 6599 s 	cp	(hl)
659a 659a d 2026
659a 659a s 	jr	nz,A65AD
659c 659c d 21c665
659c 659c s 	ld	hl,T65B1
659f 659f d 1189fd
659f 659f s A658A:	ld	de,PROCNM
65a2 65a2 d 1a
65a2 65a2 s A658D:	ld	a,(de)
65a3 65a3 d be
65a3 65a3 s 	cp	(hl)
65a4 65a4 d 13
65a4 65a4 s 	inc	de
65a5 65a5 d 23
65a5 65a5 s 	inc	hl
65a6 65a6 d 2010
65a6 65a6 s 	jr	nz,A65A3
65a8 65a8 d a7
65a8 65a8 s 	and	a
65a9 65a9 d 20f7
65a9 65a9 s 	jr	nz,A658D
65ab 65ab d 7e
65ab 65ab s 	ld	a,(hl)
65ac 65ac d 23
65ac 65ac s 	inc	hl
65ad 65ad d 66
65ad 65ad s 	ld	h,(hl)
65ae 65ae d 6f
65ae 65ae s 	ld	l,a
65af 65af d e3
65af 65af s 	ex	(sp),hl
65b0 65b0 d cdef72
65b0 65b0 s 	call	A72DA
65b3 65b3 d 37
65b3 65b3 s 	scf
65b4 65b4 d 3f
65b4 65b4 s 	ccf
65b5 65b5 d c9
65b5 65b5 s 	ret
65b6 65b6 s ;
65b6 65b6 d 23
65b6 65b6 s A65A1:	inc	hl
65b7 65b7 d 7e
65b7 65b7 s 	ld	a,(hl)
65b8 65b8 d a7
65b8 65b8 s A65A3:	and	a
65b9 65b9 d 20fb
65b9 65b9 s 	jr	nz,A65A1
65bb 65bb d 23
65bb 65bb s 	inc	hl
65bc 65bc d 23
65bc 65bc s 	inc	hl
65bd 65bd d 23
65bd 65bd s 	inc	hl
65be 65be d 7e
65be 65be s 	ld	a,(hl)
65bf 65bf d a7
65bf 65bf s 	and	a
65c0 65c0 d 20dd
65c0 65c0 s 	jr	nz,A658A
65c2 65c2 d e1
65c2 65c2 s A65AD:	pop	hl
65c3 65c3 d c3c475
65c3 65c3 s 	jp	OEMSTA
65c6 65c6 s ;
65c6 65c6 s ;
65c6 65c6 d 53595354454d00
65c6 65c6 s T65B1:	defb	"SYSTEM",0
65cd 65cd d d965
65cd 65cd s 	defw	A65C4
65cf 65cf d 464f524d415400
65cf 65cf s 	defb	"FORMAT",0
65d6 65d6 d f165
65d6 65d6 s 	defw	A65DC
65d8 65d8 d 00
65d8 65d8 s 	defb	0
65d9 65d9 s 
65d9 65d9 d c0
65d9 65d9 s A65C4:	ret	nz
65da 65da d 3a46f3
65da 65da s 	ld	a,(YF346)
65dd 65dd d a7
65dd 65dd s 	and	a
65de 65de d ca2a73
65de 65de s 	jp	z,A7315
65e1 65e1 d dd211c6c
65e1 65e1 s 	ld	ix,ACLOSE
65e5 65e5 d cd3373
65e5 65e5 s 	call	A731E
65e8 65e8 d cdd200
65e8 65e8 s 	call	TOTEXT
65eb 65eb d cdcc00
65eb 65eb s 	call	ERAFNK
65ee 65ee d c3115a
65ee 65ee s 	jp	A5A11			; start MSXDOS
65f1 65f1 s ;
65f1 65f1 d e5
65f1 65f1 s A65DC:	push	hl
65f2 65f2 d ccc660
65f2 65f2 s 	call	z,A60B1
65f5 65f5 d e1
65f5 65f5 s 	pop	hl
65f6 65f6 d a7
65f6 65f6 s 	and	a
65f7 65f7 d c9
65f7 65f7 s 	ret
65f8 65f8 s ;
65f8 65f8 d 7a
65f8 65f8 s A65E3:	ld	a,d
65f9 65f9 d 3d
65f9 65f9 s A65E4:	dec	a
65fa 65fa d f0
65fa 65fa s 	ret	p
65fb 65fb d 3a47f2
65fb 65fb s 	ld	a,(YF247)
65fe 65fe d c9
65fe 65fe s 	ret
65ff 65ff s ;
65ff 65ff d e5
65ff 65ff s A65EA:	push	hl
6600 6600 d d5
6600 6600 s 	push	de
6601 6601 d c5
6601 6601 s 	push	bc
6602 6602 d cdf865
6602 6602 s 	call	A65E3			; convert to driveid
6605 6605 d 4f
6605 6605 s 	ld	c,a
6606 6606 d 2a60f8
6606 6606 s 	ld	hl,(FILTAB)		; I/O channel pointer table
6609 6609 d 3a5ff8
6609 6609 s 	ld	a,(MAXFIL)		; number of I/O channels
660c 660c d f5
660c 660c s A65F7:	push	af
660d 660d d 5e
660d 660d s 	ld	e,(hl)
660e 660e d 23
660e 660e s 	inc	hl
660f 660f d 56
660f 660f s 	ld	d,(hl)
6610 6610 d 23
6610 6610 s 	inc	hl
6611 6611 d e5
6611 6611 s 	push	hl
6612 6612 d eb
6612 6612 s 	ex	de,hl			; pointer to I/O channel
6613 6613 d 7e
6613 6613 s 	ld	a,(hl)
6614 6614 d a7
6614 6614 s 	and	a			; channel in use ?
6615 6615 d 282c
6615 6615 s 	jr	z,A662E			; nope, check next
6617 6617 d 23
6617 6617 s 	inc	hl
6618 6618 d 23
6618 6618 s 	inc	hl
6619 6619 d 23
6619 6619 s 	inc	hl
661a 661a d 23
661a 661a s 	inc	hl
661b 661b d 7e
661b 661b s 	ld	a,(hl)
661c 661c d fe09
661c 661c s 	cp	009H			; channel in use by a disk device ?
661e 661e d 3023
661e 661e s 	jr	nc,A662E		; nope, check next
6620 6620 d 2b
6620 6620 s 	dec	hl
6621 6621 d 2b
6621 6621 s 	dec	hl
6622 6622 d 56
6622 6622 s 	ld	d,(hl)
6623 6623 d 2b
6623 6623 s 	dec	hl
6624 6624 d 5e
6624 6624 s 	ld	e,(hl)			; pointer to FCB
6625 6625 d 1a
6625 6625 s 	ld	a,(de)			; DR byte of FCB
6626 6626 d cdf965
6626 6626 s 	call	A65E4			; convert to driveid
6629 6629 d b9
6629 6629 s 	cp	c			; same as the requested one ?
662a 662a d 2017
662a 662a s 	jr	nz,A662E		; nope, check next
662c 662c d 13
662c 662c s 	inc	de
662d 662d d eb
662d 662d s 	ex	de,hl
662e 662e d 1166f8
662e 662e s 	ld	de,FILNAM
6631 6631 d 060b
6631 6631 s 	ld	b,11
6633 6633 d 1a
6633 6633 s A661E:	ld	a,(de)
6634 6634 d fe3f
6634 6634 s 	cp	"?"
6636 6636 d 2803
6636 6636 s 	jr	z,A6626			; wildcard, treat as equal
6638 6638 d be
6638 6638 s 	cp	(hl)
6639 6639 d 2008
6639 6639 s 	jr	nz,A662E		; filename not equal, check next
663b 663b d 13
663b 663b s A6626:	inc	de
663c 663c d 23
663c 663c s 	inc	hl
663d 663d d 10f4
663d 663d s 	djnz	A661E			; next char
663f 663f d e1
663f 663f s 	pop	hl
6640 6640 d e1
6640 6640 s 	pop	hl
6641 6641 d 1872
6641 6641 s 	jr	A66A0			; quit with Zx set (file open)
6643 6643 s ;
6643 6643 d e1
6643 6643 s A662E:	pop	hl
6644 6644 d f1
6644 6644 s 	pop	af
6645 6645 d 3d
6645 6645 s 	dec	a
6646 6646 d f20c66
6646 6646 s 	jp	p,A65F7			; next channel
6649 6649 d 186a
6649 6649 s 	jr	A66A0			; quit with Zx reset (file not open)
664b 664b s ;
664b 664b d e5
664b 664b s A6636:	push	hl
664c 664c d d5
664c 664c s 	push	de
664d 664d d c5
664d 664d s 	push	bc
664e 664e d 7a
664e 664e s 	ld	a,d
664f 664f d 3268f5
664f 664f s 	ld	(BUF+10),a
6652 6652 d cd6c66
6652 6652 s 	call	A6657			; copy FILNAM to FCB
6655 6655 d cd5a66
6655 6655 s 	call	A6645			; search file
6658 6658 d 185b
6658 6658 s 	jr	A66A0
665a 665a s ;
665a 665a d 21b2f5
665a 665a s A6645:	ld	hl,BUF+84
665d 665d d 223df2
665d 665d s 	ld	(YF23D),hl		; transferadres in BUF
6660 6660 d 1168f5
6660 6660 s 	ld	de,BUF+10
6663 6663 d af
6663 6663 s 	xor	a
6664 6664 d 3274f5
6664 6664 s 	ld	(BUF+10+12),a		; clear EX byte of FCB
6667 6667 d cdb84f
6667 6667 s D6652:	call	A4FB8			; search for first
666a 666a d 3c
666a 666a s 	inc	a
666b 666b d c9
666b 666b s 	ret
666c 666c s ;
666c 666c d 1169f5
666c 666c s A6657:	ld	de,BUF+10+1
666f 666f d 2166f8
666f 666f s A665A:	ld	hl,FILNAM
6672 6672 d 010b00
6672 6672 s 	ld	bc,11
6675 6675 d edb0
6675 6675 s 	ldir
6677 6677 d c9
6677 6677 s 	ret
6678 6678 s ;
6678 6678 d fb
6678 6678 s A6663:	ei
6679 6679 d e5
6679 6679 s 	push	hl
667a 667a d d5
667a 667a s 	push	de
667b 667b d c5
667b 667b s 	push	bc
667c 667c d f5
667c 667c s 	push	af
667d 667d d 3a48f3
667d 667d s 	ld	a,(YF348)
6680 6680 d 87
6680 6680 s 	add	a,a
6681 6681 d 211000
6681 6681 s 	ld	hl,16
6684 6684 d 3002
6684 6684 s 	jr	nc,A6673
6686 6686 d 2e18
6686 6686 s 	ld	l,16+8
6688 6688 d 39
6688 6688 s A6673:	add	hl,sp
6689 6689 d dde5
6689 6689 s 	push	ix
668b 668b d c1
668b 668b s 	pop	bc
668c 668c d 71
668c 668c s 	ld	(hl),c
668d 668d d 23
668d 668d s 	inc	hl
668e 668e d 70
668e 668e s 	ld	(hl),b
668f 668f d 210a00
668f 668f s 	ld	hl,10
6692 6692 d 39
6692 6692 s 	add	hl,sp
6693 6693 d eb
6693 6693 s 	ex	de,hl
6694 6694 d 180c
6694 6694 s 	jr	A668D
6696 6696 s ;
6696 6696 d fde5
6696 6696 s A6681:	push	iy
6698 6698 d c1
6698 6698 s 	pop	bc
6699 6699 d 4e
6699 6699 s A6684:	ld	c,(hl)
669a 669a d 1a
669a 669a s 	ld	a,(de)
669b 669b d 77
669b 669b s 	ld	(hl),a
669c 669c d 79
669c 669c s 	ld	a,c
669d 669d d 12
669d 669d s 	ld	(de),a
669e 669e d 23
669e 669e s 	inc	hl
669f 669f d 13
669f 669f s 	inc	de
66a0 66a0 d 10f7
66a0 66a0 s 	djnz	A6684
66a2 66a2 d 3a48f3
66a2 66a2 s A668D:	ld	a,(YF348)
66a5 66a5 d 87
66a5 66a5 s 	add	a,a
66a6 66a6 d 211200
66a6 66a6 s 	ld	hl,00012H
66a9 66a9 d 3002
66a9 66a9 s 	jr	nc,A6698
66ab 66ab d 2e1a
66ab 66ab s 	ld	l,01AH
66ad 66ad d 39
66ad 66ad s A6698:	add	hl,sp
66ae 66ae d 7b
66ae 66ae s 	ld	a,e
66af 66af d 95
66af 66af s 	sub	l
66b0 66b0 d 7a
66b0 66b0 s 	ld	a,d
66b1 66b1 d 9c
66b1 66b1 s 	sbc	a,h
66b2 66b2 d 38e2
66b2 66b2 s 	jr	c,A6681
66b4 66b4 d f1
66b4 66b4 s A669F:	pop	af
66b5 66b5 d c1
66b5 66b5 s A66A0:	pop	bc
66b6 66b6 d d1
66b6 66b6 s 	pop	de
66b7 66b7 d e1
66b7 66b7 s 	pop	hl
66b8 66b8 d c9
66b8 66b8 s 	ret
66b9 66b9 s 
66b9 66b9 s ;	  Subroutine  (H.GETP)
66b9 66b9 s ;	     Inputs  
66b9 66b9 s ;	     Outputs ________________________ 
66b9 66b9 s 
66b9 66b9 d dd218bf3
66b9 66b9 s A66A4:	ld	ix,RETRTN
66bd 66bd d fd210002
66bd 66bd s 	ld	iy,00200H
66c1 66c1 d cd7866
66c1 66c1 s 	call	A6663			; take control from caller
66c4 66c4 d e1
66c4 66c4 s 	pop	hl
66c5 66c5 d 7e
66c5 66c5 s 	ld	a,(hl)
66c6 66c6 d a7
66c6 66c6 s 	and	a
66c7 66c7 d c9
66c7 66c7 s 	ret
66c8 66c8 s 
66c8 66c8 s ;	  Subroutine OPEN statement expander (H.NOFO)
66c8 66c8 s ;	     Inputs  
66c8 66c8 s ;	     Outputs ________________________ 
66c8 66c8 s 
66c8 66c8 d fb
66c8 66c8 s A66B3:	ei
66c9 66c9 d 010001
66c9 66c9 s 	ld	bc,256
66cc 66cc d ed433df3
66cc 66cc s 	ld	(YF33D),bc		; default recordsize 256
66d0 66d0 d cdef72
66d0 66d0 s 	call	A72DA			; already end of statement ?
66d3 66d3 d 7b
66d3 66d3 s 	ld	a,e
66d4 66d4 d c8
66d4 66d4 s 	ret	z			; yes, quit
66d5 66d5 d f5
66d5 66d5 s 	push	af
66d6 66d6 d e5
66d6 66d6 s 	push	hl
66d7 66d7 d 3a48f3
66d7 66d7 s 	ld	a,(YF348)
66da 66da d 87
66da 66da s 	add	a,a
66db 66db d 210c00
66db 66db s 	ld	hl,0000CH
66de 66de d 3002
66de 66de s 	jr	nc,A66CD
66e0 66e0 d 2e14
66e0 66e0 s 	ld	l,014H
66e2 66e2 d 39
66e2 66e2 s A66CD:	add	hl,sp
66e3 66e3 d 7e
66e3 66e3 s 	ld	a,(hl)
66e4 66e4 d fe04
66e4 66e4 s 	cp	004H			; random mode ?
66e6 66e6 d c22d73
66e6 66e6 s 	jp	nz,A7318		; nope,
66e9 66e9 d 23
66e9 66e9 s 	inc	hl
66ea 66ea d 7e
66ea 66ea s 	ld	a,(hl)
66eb 66eb d fe09
66eb 66eb s 	cp	009H			; disk device ?
66ed 66ed d d22d73
66ed 66ed s 	jp	nc,A7318		; nope,
66f0 66f0 d e1
66f0 66f0 s 	pop	hl
66f1 66f1 d cde572
66f1 66f1 s 	call	A72D0
66f4 66f4 d ff
66f4 66f4 s 	defb	0FFH
66f5 66f5 d cde572
66f5 66f5 s 	call	A72D0
66f8 66f8 d 92
66f8 66f8 s 	defb	092H
66f9 66f9 d cde572
66f9 66f9 s 	call	A72D0
66fc 66fc d ef
66fc 66fc s 	defb	0EFH			; check for LEN=
66fd 66fd d dd215647
66fd 66fd s 	ld	ix,EVWORD
6701 6701 d cd3373
6701 6701 s 	call	A731E			; evaluate word operand
6704 6704 d 1b
6704 6704 s 	dec	de
6705 6705 d 14
6705 6705 s 	inc	d
6706 6706 d 15
6706 6706 s 	dec	d			; should be 1-256
6707 6707 d c22a73
6707 6707 s 	jp	nz,A7315		; nope,
670a 670a d 13
670a 670a s 	inc	de
670b 670b d ed533df3
670b 670b s 	ld	(YF33D),de		; recordsize
670f 670f d f1
670f 670f s 	pop	af
6710 6710 d c9
6710 6710 s 	ret
6711 6711 s 
6711 6711 s ;	  Subroutine OPEN statement  (H.NULO)
6711 6711 s ;	     Inputs  
6711 6711 s ;	     Outputs ________________________ 
6711 6711 s 
6711 6711 d fb
6711 6711 s A66FC:	ei
6712 6712 d d0
6712 6712 s 	ret	nc			; not for a disk device, return control
6713 6713 d dd218bf3
6713 6713 s 	ld	ix,RETRTN
6717 6717 d fd210004
6717 6717 s 	ld	iy,00400H
671b 671b d cd7866
671b 671b s 	call	A6663			; take control from caller
671e 671e d cdbe6f
671e 671e s 	call	A6FA9			; validate filename
6721 6721 d cdff65
6721 6721 s 	call	A65EA			; is file already open in one of the I/O channels ?
6724 6724 d ca1e73
6724 6724 s 	jp	z,A7309			; yep, error
6727 6727 d 2264f8
6727 6727 s 	ld	(PTRFIL),hl
672a 672a d 7b
672a 672a s 	ld	a,e
672b 672b d fe04
672b 672b s 	cp	004H
672d 672d d 2807
672d 672d s 	jr	z,A6721			; random mode, recordsize already set
672f 672f d 010100
672f 672f s 	ld	bc,1
6732 6732 d ed433df3
6732 6732 s 	ld	(YF33D),bc		; all others use recordsize 1
6736 6736 d f1
6736 6736 s A6721:	pop	af
6737 6737 d f5
6737 6737 s 	push	af			; I/O channel number
6738 6738 d e5
6738 6738 s 	push	hl
6739 6739 d d5
6739 6739 s 	push	de
673a 673a d 2145f3
673a 673a s 	ld	hl,YF345
673d 673d d be
673d 673d s 	cp	(hl)			; do I have a FCB for this channel ?
673e 673e d d22173
673e 673e s 	jp	nc,A730C		; nope,
6741 6741 d 012500
6741 6741 s 	ld	bc,37
6744 6744 d 5f
6744 6744 s 	ld	e,a
6745 6745 d 50
6745 6745 s 	ld	d,b
6746 6746 d 2a53f3
6746 6746 s 	ld	hl,(YF353)		; base of the FCB's
6749 6749 d cd1c49
6749 6749 s 	call	A491C			; base + 37 * channelnumber
674c 674c d af
674c 674c s 	xor	a
674d 674d d 210c00
674d 674d s 	ld	hl,0000CH
6750 6750 d 09
6750 6750 s 	add	hl,bc
6751 6751 d 77
6751 6751 s 	ld	(hl),a			; reset EX byte of FCB
6752 6752 d d1
6752 6752 s 	pop	de
6753 6753 d e1
6753 6753 s 	pop	hl
6754 6754 d 23
6754 6754 s 	inc	hl
6755 6755 d 71
6755 6755 s 	ld	(hl),c
6756 6756 d 23
6756 6756 s 	inc	hl
6757 6757 d 70
6757 6757 s 	ld	(hl),b			; pointer to FCB
6758 6758 d 23
6758 6758 s 	inc	hl
6759 6759 d 77
6759 6759 s 	ld	(hl),a			; no backup char
675a 675a d 23
675a 675a s 	inc	hl
675b 675b d 72
675b 675b s 	ld	(hl),d			; devicenumber
675c 675c d 23
675c 675c s 	inc	hl
675d 675d d 23
675d 675d s 	inc	hl
675e 675e d 77
675e 675e s 	ld	(hl),a			; current bufferoffset = 0
675f 675f d cd4b66
675f 675f s 	call	A6636			; search file
6762 6762 d c5
6762 6762 s 	push	bc
6763 6763 d d5
6763 6763 s 	push	de
6764 6764 d 7a
6764 6764 s 	ld	a,d
6765 6765 d 02
6765 6765 s 	ld	(bc),a			; devicenumber
6766 6766 d 59
6766 6766 s 	ld	e,c
6767 6767 d 50
6767 6767 s 	ld	d,b
6768 6768 d 13
6768 6768 s 	inc	de
6769 6769 d cd6f66
6769 6769 s 	call	A665A			; copy FILNAM to FCB
676c 676c d d1
676c 676c s 	pop	de
676d 676d d c1
676d 676d s 	pop	bc
676e 676e d 7b
676e 676e s 	ld	a,e
676f 676f d 201c
676f 676f s 	jr	nz,A6778		; file exists,
6771 6771 d e686
6771 6771 s 	and	086H			; file not exists and not binsav, random or output mode ?
6773 6773 d ca2773
6773 6773 s 	jp	z,A7312			; yep, error
6776 6776 d d5
6776 6776 s A6761:	push	de
6777 6777 d c5
6777 6777 s 	push	bc
6778 6778 d 59
6778 6778 s 	ld	e,c
6779 6779 d 50
6779 6779 s 	ld	d,b
677a 677a d cd1d46
677a 677a s 	call	A461D			; create file
677d 677d d a7
677d 677d s 	and	a
677e 677e d c2c071
677e 677e s 	jp	nz,A71AB		; failed, error
6781 6781 d e1
6781 6781 s 	pop	hl
6782 6782 d cd1368
6782 6782 s 	call	A67FE			; setup FCB fields
6785 6785 d d1
6785 6785 s 	pop	de
6786 6786 d 2a64f8
6786 6786 s 	ld	hl,(PTRFIL)
6789 6789 d 73
6789 6789 s 	ld	(hl),e			; filemode, I/O channel open
678a 678a d f1
678a 678a s A6775:	pop	af
678b 678b d e1
678b 678b s 	pop	hl
678c 678c d c9
678c 678c s 	ret
678d 678d s ;
678d 678d d fe08
678d 678d s A6778:	cp	008H
678f 678f d 2845
678f 678f s 	jr	z,A67C1			; append mode,
6791 6791 d fe02
6791 6791 s 	cp	002H
6793 6793 d 28e1
6793 6793 s 	jr	z,A6761			; output mode, create file (overwrites!)
6795 6795 d fe80
6795 6795 s 	cp	080H
6797 6797 d 28dd
6797 6797 s 	jr	z,A6761			; binsav mode, create file (overwrites!)
6799 6799 d d5
6799 6799 s 	push	de
679a 679a d c5
679a 679a s 	push	bc
679b 679b d 59
679b 679b s 	ld	e,c
679c 679c d 50
679c 679c s 	ld	d,b
679d 679d d cd6244
679d 679d s 	call	A4462			; open fcb
67a0 67a0 d e1
67a0 67a0 s 	pop	hl
67a1 67a1 d cd1368
67a1 67a1 s 	call	A67FE			; setup FCB fields
67a4 67a4 d d1
67a4 67a4 s 	pop	de
67a5 67a5 d 2a64f8
67a5 67a5 s 	ld	hl,(PTRFIL)
67a8 67a8 d 73
67a8 67a8 s 	ld	(hl),e			; filemode, I/O channel open
67a9 67a9 d 7b
67a9 67a9 s 	ld	a,e
67aa 67aa d fe04
67aa 67aa s 	cp	004H			; random mode ?
67ac 67ac d 28dc
67ac 67ac s 	jr	z,A6775			; yep, quit
67ae 67ae d e5
67ae 67ae s 	push	hl
67af 67af d 21aefc
67af 67af s 	ld	hl,FLBMEM
67b2 67b2 d af
67b2 67b2 s 	xor	a
67b3 67b3 d be
67b3 67b3 s 	cp	(hl)
67b4 67b4 d 77
67b4 67b4 s 	ld	(hl),a
67b5 67b5 d e1
67b5 67b5 s 	pop	hl
67b6 67b6 d 20d2
67b6 67b6 s 	jr	nz,A6775		; yep, quit
67b8 67b8 d 010600
67b8 67b8 s 	ld	bc,00006H
67bb 67bb d 09
67bb 67bb s 	add	hl,bc
67bc 67bc d e5
67bc 67bc s 	push	hl
67bd 67bd d 36ff
67bd 67bd s 	ld	(hl),0FFH		; position 255, so next get char fills buffer
67bf 67bf d 2a64f8
67bf 67bf s 	ld	hl,(PTRFIL)
67c2 67c2 d cd3f68
67c2 67c2 s 	call	A682A			; get char from I/O channel
67c5 67c5 d e1
67c5 67c5 s 	pop	hl
67c6 67c6 d 2b
67c6 67c6 s 	dec	hl
67c7 67c7 d 2b
67c7 67c7 s 	dec	hl
67c8 67c8 d 2b
67c8 67c8 s 	dec	hl
67c9 67c9 d 77
67c9 67c9 s 	ld	(hl),a
67ca 67ca d feff
67ca 67ca s 	cp	0FFH
67cc 67cc d 20bc
67cc 67cc s 	jr	nz,A6775		; yep, quit
67ce 67ce d 23
67ce 67ce s 	inc	hl
67cf 67cf d 23
67cf 67cf s 	inc	hl
67d0 67d0 d 23
67d0 67d0 s 	inc	hl
67d1 67d1 d 23
67d1 67d1 s 	inc	hl
67d2 67d2 d 3680
67d2 67d2 s 	ld	(hl),080H
67d4 67d4 d 18b4
67d4 67d4 s A67BF:	jr	A6775			; quit
67d6 67d6 s ;
67d6 67d6 d c5
67d6 67d6 s A67C1:	push	bc
67d7 67d7 d 59
67d7 67d7 s 	ld	e,c
67d8 67d8 d 50
67d8 67d8 s 	ld	d,b
67d9 67d9 d cd6244
67d9 67d9 s 	call	A4462			; open fcb
67dc 67dc d e1
67dc 67dc s 	pop	hl
67dd 67dd d e5
67dd 67dd s 	push	hl
67de 67de d cd1368
67de 67de s 	call	A67FE			; setup FCB fields
67e1 67e1 d 2a64f8
67e1 67e1 s 	ld	hl,(PTRFIL)
67e4 67e4 d 3601
67e4 67e4 s 	ld	(hl),001H		; first in input mode
67e6 67e6 d 010600
67e6 67e6 s 	ld	bc,00006H
67e9 67e9 d 09
67e9 67e9 s 	add	hl,bc
67ea 67ea d 36ff
67ea 67ea s 	ld	(hl),0FFH
67ec 67ec d 2a64f8
67ec 67ec s 	ld	hl,(PTRFIL)
67ef 67ef d e5
67ef 67ef s A67DA:	push	hl
67f0 67f0 d cd3f68
67f0 67f0 s 	call	A682A			; get char from I/O channel
67f3 67f3 d e1
67f3 67f3 s 	pop	hl
67f4 67f4 d 30f9
67f4 67f4 s 	jr	nc,A67DA		; not at the end of file, continue
67f6 67f6 d 3602
67f6 67f6 s 	ld	(hl),002H		; continue in output mode
67f8 67f8 d e1
67f8 67f8 s 	pop	hl
67f9 67f9 d 012100
67f9 67f9 s 	ld	bc,00021H
67fc 67fc d 09
67fc 67fc s 	add	hl,bc			; to the Rx field
67fd 67fd d 0e04
67fd 67fd s 	ld	c,004H
67ff 67ff d e5
67ff 67ff s 	push	hl
6800 6800 d 37
6800 6800 s 	scf
6801 6801 d 7e
6801 6801 s A67EC:	ld	a,(hl)
6802 6802 d 98
6802 6802 s 	sbc	a,b
6803 6803 d 77
6803 6803 s 	ld	(hl),a
6804 6804 d 23
6804 6804 s 	inc	hl
6805 6805 d 0d
6805 6805 s 	dec	c
6806 6806 d 20f9
6806 6806 s 	jr	nz,A67EC		; decrease by 1
6808 6808 d e1
6808 6808 s 	pop	hl
6809 6809 d 0c
6809 6809 s 	inc	c
680a 680a d 3002
680a 680a s 	jr	nc,A67F9		; Make Rx a multiply of 256
680c 680c d 0e04
680c 680c s 	ld	c,004H			; Rx = 0
680e 680e d cd2868
680e 680e s A67F9:	call	A6813
6811 6811 d 18c1
6811 6811 s 	jr	A67BF			; quit
6813 6813 s ;
6813 6813 d 010c00
6813 6813 s A67FE:	ld	bc,0000CH
6816 6816 d 09
6816 6816 s 	add	hl,bc
6817 6817 d 70
6817 6817 s 	ld	(hl),b			; clear EX byte
6818 6818 d 23
6818 6818 s 	inc	hl
6819 6819 d 70
6819 6819 s 	ld	(hl),b			; clear S1 byte
681a 681a d 23
681a 681a s 	inc	hl
681b 681b d ed4b3df3
681b 681b s 	ld	bc,(YF33D)
681f 681f d 71
681f 681f s 	ld	(hl),c
6820 6820 d 23
6820 6820 s 	inc	hl
6821 6821 d 70
6821 6821 s 	ld	(hl),b			; user recordsize = recordsize
6822 6822 d 011100
6822 6822 s 	ld	bc,00011H
6825 6825 d 09
6825 6825 s 	add	hl,bc
6826 6826 d 0e05
6826 6826 s 	ld	c,005H
6828 6828 d 70
6828 6828 s A6813:	ld	(hl),b
6829 6829 d 23
6829 6829 s 	inc	hl
682a 682a d 0d
682a 682a s 	dec	c
682b 682b d 20fb
682b 682b s 	jr	nz,A6813		; clear CR byte and Rx bytes
682d 682d d c9
682d 682d s 	ret
682e 682e s ;
682e 682e s ;
682e 682e d dd218bf3
682e 682e s A6819:	ld	ix,RETRTN
6832 6832 d fd210006
6832 6832 s 	ld	iy,00600H
6836 6836 d cd7866
6836 6836 s 	call	A6663			; take control from caller
6839 6839 d cd3f68
6839 6839 s 	call	A682A			; get char from I/O channel
683c 683c d c3b566
683c 683c s 	jp	A66A0			; quit
683f 683f s ;
683f 683f d e5
683f 683f s A682A:	push	hl
6840 6840 d 7e
6840 6840 s 	ld	a,(hl)
6841 6841 d fe01
6841 6841 s 	cp	001H			; input mode ?
6843 6843 d c2ae71
6843 6843 s 	jp	nz,A7199		; nope, error
6846 6846 d 5d
6846 6846 s 	ld	e,l
6847 6847 d 54
6847 6847 s 	ld	d,h
6848 6848 d 23
6848 6848 s 	inc	hl
6849 6849 d 23
6849 6849 s 	inc	hl
684a 684a d 23
684a 684a s 	inc	hl
684b 684b d 7e
684b 684b s 	ld	a,(hl)
684c 684c d a7
684c 684c s 	and	a			; backup char ?
684d 684d d 202c
684d 684d s 	jr	nz,A6866		; yep, use that
684f 684f d 23
684f 684f s 	inc	hl
6850 6850 d 23
6850 6850 s 	inc	hl
6851 6851 d 23
6851 6851 s 	inc	hl
6852 6852 d 34
6852 6852 s 	inc	(hl)			; update counter
6853 6853 d 7e
6853 6853 s 	ld	a,(hl)
6854 6854 d 23
6854 6854 s 	inc	hl
6855 6855 d 23
6855 6855 s 	inc	hl
6856 6856 d 23
6856 6856 s 	inc	hl			; to the buffer
6857 6857 d 201d
6857 6857 s 	jr	nz,A6861		; still characters left, use them
6859 6859 d e5
6859 6859 s 	push	hl
685a 685a d 223df2
685a 685a s 	ld	(YF23D),hl		; transferadres is I/O channel buffer
685d 685d d eb
685d 685d s 	ex	de,hl
685e 685e d 23
685e 685e s 	inc	hl
685f 685f d 5e
685f 685f s 	ld	e,(hl)
6860 6860 d 23
6860 6860 s 	inc	hl
6861 6861 d 56
6861 6861 s 	ld	d,(hl)			; pointer to FCB
6862 6862 d 210001
6862 6862 s 	ld	hl,256
6865 6865 d cdb247
6865 6865 s 	call	A47B2			; random block read
6868 6868 d 5d
6868 6868 s 	ld	e,l
6869 6869 d 54
6869 6869 s 	ld	d,h
686a 686a d 25
686a 686a s 	dec	h
686b 686b d 7d
686b 686b s 	ld	a,l
686c 686c d b4
686c 686c s 	or	h			; have read 256 records ?
686d 686d d e1
686d 686d s 	pop	hl
686e 686e d 2806
686e 686e s 	jr	z,A6861			; yep, then not at end of file
6870 6870 d e5
6870 6870 s 	push	hl
6871 6871 d 19
6871 6871 s 	add	hl,de
6872 6872 d 361a
6872 6872 s 	ld	(hl),01AH		; put a CTRL-Z at the end
6874 6874 d e1
6874 6874 s 	pop	hl
6875 6875 d af
6875 6875 s 	xor	a
6876 6876 d 4f
6876 6876 s A6861:	ld	c,a
6877 6877 d 0600
6877 6877 s 	ld	b,000H
6879 6879 d 09
6879 6879 s 	add	hl,bc
687a 687a d 7e
687a 687a s 	ld	a,(hl)			; get char
687b 687b d 47
687b 687b s A6866:	ld	b,a
687c 687c d d61a
687c 687c s 	sub	01AH
687e 687e d d601
687e 687e s 	sub	001H
6880 6880 d 78
6880 6880 s 	ld	a,b
6881 6881 d e1
6881 6881 s 	pop	hl
6882 6882 d 23
6882 6882 s 	inc	hl
6883 6883 d 23
6883 6883 s 	inc	hl
6884 6884 d 23
6884 6884 s 	inc	hl
6885 6885 d 3600
6885 6885 s 	ld	(hl),0			; no backup char
6887 6887 d d0
6887 6887 s 	ret	nc			; no CTRL-Z, quit
6888 6888 d 77
6888 6888 s 	ld	(hl),a			; CTRL-Z as backup char, so it is always read again
6889 6889 d c9
6889 6889 s 	ret
688a 688a s ;
688a 688a s ;
688a 688a d fb
688a 688a s A6875:	ei
688b 688b d e5
688b 688b s 	push	hl
688c 688c d 3a48f3
688c 688c s 	ld	a,(YF348)
688f 688f d 87
688f 688f s 	add	a,a
6890 6890 d 210800
6890 6890 s 	ld	hl,00008H
6893 6893 d 3002
6893 6893 s 	jr	nc,A6882
6895 6895 d 2e10
6895 6895 s 	ld	l,010H
6897 6897 d 39
6897 6897 s A6882:	add	hl,sp
6898 6898 d 3641
6898 6898 s 	ld	(hl),LOW M.6E41
689a 689a d 23
689a 689a s 	inc	hl
689b 689b d 366e
689b 689b s 	ld	(hl),HIGH M.6E41
689d 689d d e1
689d 689d s 	pop	hl
689e 689e d 23
689e 689e s 	inc	hl
689f 689f d 23
689f 689f s 	inc	hl
68a0 68a0 d 23
68a0 68a0 s 	inc	hl
68a1 68a1 d 71
68a1 68a1 s 	ld	(hl),c
68a2 68a2 d c9
68a2 68a2 s 	ret
68a3 68a3 s ;
68a3 68a3 s ;
68a3 68a3 d dd218bf3
68a3 68a3 s A688E:	ld	ix,RETRTN
68a7 68a7 d fd210008
68a7 68a7 s 	ld	iy,00800H
68ab 68ab d cd7866
68ab 68ab s 	call	A6663			; take control from caller
68ae 68ae d 7e
68ae 68ae s 	ld	a,(hl)
68af 68af d fe02
68af 68af s 	cp	002H			; output mode ?
68b1 68b1 d c2ae71
68b1 68b1 s 	jp	nz,A7199		; nope, error
68b4 68b4 d f1
68b4 68b4 s 	pop	af
68b5 68b5 d f5
68b5 68b5 s 	push	af
68b6 68b6 d cdbc68
68b6 68b6 s 	call	A68A7			; write char to I/O channel
68b9 68b9 d c3b466
68b9 68b9 s 	jp	A669F			; quit
68bc 68bc s ;
68bc 68bc d e5
68bc 68bc s A68A7:	push	hl
68bd 68bd d 010600
68bd 68bd s 	ld	bc,00006H
68c0 68c0 d 09
68c0 68c0 s 	add	hl,bc
68c1 68c1 d 4e
68c1 68c1 s 	ld	c,(hl)			; position
68c2 68c2 d 34
68c2 68c2 s 	inc	(hl)			; update
68c3 68c3 d 23
68c3 68c3 s 	inc	hl
68c4 68c4 d 23
68c4 68c4 s 	inc	hl
68c5 68c5 d 23
68c5 68c5 s 	inc	hl			; to buffer
68c6 68c6 d 09
68c6 68c6 s 	add	hl,bc
68c7 68c7 d 77
68c7 68c7 s 	ld	(hl),a			; put char in buffer
68c8 68c8 d e1
68c8 68c8 s 	pop	hl
68c9 68c9 d c0
68c9 68c9 s 	ret	nz			; buffer not full, quit
68ca 68ca d e5
68ca 68ca s A68B5:	push	hl
68cb 68cb d 23
68cb 68cb s 	inc	hl
68cc 68cc d 5e
68cc 68cc s 	ld	e,(hl)
68cd 68cd d 23
68cd 68cd s 	inc	hl
68ce 68ce d 56
68ce 68ce s 	ld	d,(hl)			; pointer to FCB
68cf 68cf d 010400
68cf 68cf s 	ld	bc,00004H
68d2 68d2 d 09
68d2 68d2 s 	add	hl,bc
68d3 68d3 d 7e
68d3 68d3 s 	ld	a,(hl)			; position
68d4 68d4 d 23
68d4 68d4 s 	inc	hl
68d5 68d5 d 23
68d5 68d5 s 	inc	hl
68d6 68d6 d 23
68d6 68d6 s 	inc	hl
68d7 68d7 d 223df2
68d7 68d7 s 	ld	(YF23D),hl		; transferadres
68da 68da d a7
68da 68da s 	and	a
68db 68db d 6f
68db 68db s 	ld	l,a
68dc 68dc d 60
68dc 68dc s 	ld	h,b
68dd 68dd d 2001
68dd 68dd s 	jr	nz,A68CB		; not a complete buffer, only the used part
68df 68df d 24
68df 68df s 	inc	h			; 256
68e0 68e0 d cda471
68e0 68e0 s A68CB:	call	A718F			; random block write
68e3 68e3 d e1
68e3 68e3 s 	pop	hl
68e4 68e4 d c9
68e4 68e4 s 	ret
68e5 68e5 s 
68e5 68e5 s ;	  Subroutine  (H.NTFL)
68e5 68e5 s ;	     Inputs  
68e5 68e5 s ;	     Outputs ________________________ 
68e5 68e5 s 
68e5 68e5 d dd218bf3
68e5 68e5 s A68D0:	ld	ix,RETRTN
68e9 68e9 d fd210004
68e9 68e9 s 	ld	iy,00400H
68ed 68ed d cd7866
68ed 68ed s 	call	A6663			; take control from caller
68f0 68f0 d e1
68f0 68f0 s 	pop	hl
68f1 68f1 d 7e
68f1 68f1 s 	ld	a,(hl)
68f2 68f2 d d602
68f2 68f2 s 	sub	002H
68f4 68f4 d 2013
68f4 68f4 s 	jr	nz,A68F4
68f6 68f6 d e5
68f6 68f6 s 	push	hl
68f7 68f7 d 21aefc
68f7 68f7 s 	ld	hl,FLBMEM
68fa 68fa d be
68fa 68fa s 	cp	(hl)
68fb 68fb d 77
68fb 68fb s 	ld	(hl),a
68fc 68fc d e1
68fc 68fc s 	pop	hl
68fd 68fd d 200a
68fd 68fd s 	jr	nz,A68F4
68ff 68ff d 3604
68ff 68ff s 	ld	(hl),004H
6901 6901 d 3e1a
6901 6901 s 	ld	a,01AH			; CTRL-Z
6903 6903 d cdbc68
6903 6903 s 	call	A68A7			; write char to I/O channel
6906 6906 d c4ca68
6906 6906 s 	call	nz,A68B5		; buffer not empty, write remaining I/O channel buffer
6909 6909 d e5
6909 6909 s A68F4:	push	hl
690a 690a d 23
690a 690a s 	inc	hl
690b 690b d 5e
690b 690b s 	ld	e,(hl)
690c 690c d 23
690c 690c s 	inc	hl
690d 690d d 56
690d 690d s 	ld	d,(hl)			; pointer to FCB
690e 690e d cd6f45
690e 690e s 	call	A456F			; close fcb
6911 6911 d e1
6911 6911 s 	pop	hl
6912 6912 d e5
6912 6912 s 	push	hl
6913 6913 d 110700
6913 6913 s 	ld	de,00007H
6916 6916 d 19
6916 6916 s 	add	hl,de
6917 6917 d 72
6917 6917 s 	ld	(hl),d
6918 6918 d 6a
6918 6918 s 	ld	l,d
6919 6919 d 62
6919 6919 s 	ld	h,d
691a 691a d 2264f8
691a 691a s 	ld	(PTRFIL),hl
691d 691d d e1
691d 691d s 	pop	hl
691e 691e d 34
691e 691e s 	inc	(hl)
691f 691f d 35
691f 691f s 	dec	(hl)
6920 6920 d 72
6920 6920 s 	ld	(hl),d
6921 6921 d e1
6921 6921 s 	pop	hl
6922 6922 d c9
6922 6922 s 	ret
6923 6923 s 
6923 6923 s ;	  Subroutine Binary Save  (H.BINS)
6923 6923 s ;	     Inputs  
6923 6923 s ;	     Outputs ________________________ 
6923 6923 s 
6923 6923 d cd9573
6923 6923 s A690E:	call	A7380
6926 6926 d e5
6926 6926 s 	push	hl
6927 6927 d dd21f754
6927 6927 s 	ld	ix,PTOLN
692b 692b d cd3373
692b 692b s 	call	A731E
692e 692e d 3eff
692e 692e s 	ld	a,0FFH
6930 6930 d cddc69
6930 6930 s 	call	A69C7
6933 6933 d 2a76f6
6933 6933 s 	ld	hl,(TXTTAB)
6936 6936 d 223df2
6936 6936 s 	ld	(YF23D),hl		; transferadres
6939 6939 d eb
6939 6939 s 	ex	de,hl
693a 693a d 2ac2f6
693a 693a s 	ld	hl,(VARTAB)
693d 693d d a7
693d 693d s 	and	a
693e 693e d ed52
693e 693e s 	sbc	hl,de
6940 6940 d cda071
6940 6940 s 	call	A718B
6943 6943 d 327cf8
6943 6943 s 	ld	(NLONLY),a
6946 6946 d e1
6946 6946 s 	pop	hl
6947 6947 d dd21246b
6947 6947 s 	ld	ix,CLOCHN
694b 694b d c33373
694b 694b s 	jp	A731E
694e 694e s 
694e 694e s ;	  Subroutine Binary Load  (H.BINL)
694e 694e s ;	     Inputs  
694e 694e s ;	     Outputs ________________________ 
694e 694e s 
694e 694e d dd219a73
694e 694e s A6939:	ld	ix,QUITLD
6952 6952 d fd210002
6952 6952 s 	ld	iy,00200H
6956 6956 d cd7866
6956 6956 s 	call	A6663			; take control from caller
6959 6959 d f1
6959 6959 s 	pop	af
695a 695a d caae71
695a 695a s 	jp	z,A7199
695d 695d d dd211c6c
695d 695d s 	ld	ix,ACLOSE
6961 6961 d cd3373
6961 6961 s 	call	A731E
6964 6964 d 2a53f3
6964 6964 s 	ld	hl,(YF353)
6967 6967 d e5
6967 6967 s 	push	hl
6968 6968 d cd1368
6968 6968 s 	call	A67FE
696b 696b d e1
696b 696b s 	pop	hl
696c 696c d e5
696c 696c s 	push	hl
696d 696d d 011300
696d 696d s 	ld	bc,00013H
6970 6970 d 09
6970 6970 s 	add	hl,bc
6971 6971 d 7e
6971 6971 s 	ld	a,(hl)
6972 6972 d a7
6972 6972 s 	and	a
6973 6973 d c21273
6973 6973 s 	jp	nz,A72FD
6976 6976 d 2b
6976 6976 s 	dec	hl
6977 6977 d b6
6977 6977 s 	or	(hl)
6978 6978 d c21273
6978 6978 s 	jp	nz,A72FD
697b 697b d 2b
697b 697b s 	dec	hl
697c 697c d 56
697c 697c s 	ld	d,(hl)
697d 697d d 2b
697d 697d s 	dec	hl
697e 697e d 5e
697e 697e s 	ld	e,(hl)
697f 697f d 2a76f6
697f 697f s 	ld	hl,(TXTTAB)
6982 6982 d 19
6982 6982 s 	add	hl,de
6983 6983 d da1273
6983 6983 s 	jp	c,A72FD
6986 6986 d 019300
6986 6986 s 	ld	bc,00093H
6989 6989 d 09
6989 6989 s 	add	hl,bc
698a 698a d da1273
698a 698a s 	jp	c,A72FD
698d 698d d ed72
698d 698d s 	sbc	hl,sp
698f 698f d d21273
698f 698f s 	jp	nc,A72FD
6992 6992 d eb
6992 6992 s 	ex	de,hl
6993 6993 d e3
6993 6993 s 	ex	(sp),hl
6994 6994 d eb
6994 6994 s 	ex	de,hl
6995 6995 d cde569
6995 6995 s 	call	A69D0
6998 6998 d 2a76f6
6998 6998 s 	ld	hl,(TXTTAB)
699b 699b d 223df2
699b 699b s 	ld	(YF23D),hl		; transferadress
699e 699e d e1
699e 699e s 	pop	hl
699f 699f d 2b
699f 699f s 	dec	hl
69a0 69a0 d cdb247
69a0 69a0 s 	call	A47B2			; random block read
69a3 69a3 d ed5b76f6
69a3 69a3 s 	ld	de,(TXTTAB)
69a7 69a7 d 19
69a7 69a7 s 	add	hl,de
69a8 69a8 d 22c2f6
69a8 69a8 s 	ld	(VARTAB),hl
69ab 69ab d dd215342
69ab 69ab s 	ld	ix,MKPTRS
69af 69af d cd3373
69af 69af s 	call	A731E
69b2 69b2 d 3a66f8
69b2 69b2 s 	ld	a,(FILNAM+0)
69b5 69b5 d a7
69b5 69b5 s 	and	a
69b6 69b6 d c0
69b6 69b6 s 	ret	nz
69b7 69b7 d 327cf8
69b7 69b7 s 	ld	(NLONLY),a
69ba 69ba d 21ce69
69ba 69ba s 	ld	hl,T69B9
69bd 69bd d 1168f5
69bd 69bd s 	ld	de,BUF+10
69c0 69c0 d 010500
69c0 69c0 s 	ld	bc,00005H
69c3 69c3 d d5
69c3 69c3 s 	push	de
69c4 69c4 d edb0
69c4 69c4 s 	ldir
69c6 69c6 d e1
69c6 69c6 s 	pop	hl
69c7 69c7 d dd210146
69c7 69c7 s 	ld	ix,EXECLP
69cb 69cb d c33373
69cb 69cb s 	jp	A731E
69ce 69ce s ;
69ce 69ce s ;
69ce 69ce d 3a92000000
69ce 69ce s T69B9:	defb	":",092H,000H,000H,000H
69d3 69d3 s 
69d3 69d3 d e5
69d3 69d3 s A69BE:	push	hl
69d4 69d4 d 7d
69d4 69d4 s 	ld	a,l
69d5 69d5 d cde069
69d5 69d5 s 	call	A69CB
69d8 69d8 d e1
69d8 69d8 s 	pop	hl
69d9 69d9 d 7c
69d9 69d9 s 	ld	a,h
69da 69da d 1804
69da 69da s 	jr	A69CB
69dc 69dc s ;
69dc 69dc d ed5b53f3
69dc 69dc s A69C7:	ld	de,(YF353)
69e0 69e0 d 01be47
69e0 69e0 s A69CB:	ld	bc,A47BE		; random block write
69e3 69e3 d 1803
69e3 69e3 s 	jr	A69D3
69e5 69e5 s ;
69e5 69e5 d 01b247
69e5 69e5 s A69D0:	ld	bc,A47B2		; random block read
69e8 69e8 d f5
69e8 69e8 s A69D3:	push	af
69e9 69e9 d 210100
69e9 69e9 s 	ld	hl,00001H
69ec 69ec d 39
69ec 69ec s 	add	hl,sp
69ed 69ed d 223df2
69ed 69ed s 	ld	(YF23D),hl		; transferadres
69f0 69f0 d d5
69f0 69f0 s 	push	de
69f1 69f1 d cdf769
69f1 69f1 s 	call	A69E2
69f4 69f4 d d1
69f4 69f4 s 	pop	de
69f5 69f5 d f1
69f5 69f5 s 	pop	af
69f6 69f6 d c9
69f6 69f6 s 	ret
69f7 69f7 s ;
69f7 69f7 d 210100
69f7 69f7 s A69E2:	ld	hl,00001H
69fa 69fa d c5
69fa 69fa s 	push	bc
69fb 69fb d c9
69fb 69fb s 	ret
69fc 69fc s ;
69fc 69fc s ;
69fc 69fc d d5
69fc 69fc s A69E7:	push	de
69fd 69fd d cd7f6b
69fd 69fd s 	call	A6B6A
6a00 6a00 d ed53bffc
6a00 6a00 s 	ld	(SAVENT),de
6a04 6a04 d d5
6a04 6a04 s 	push	de
6a05 6a05 d cd7f6b
6a05 6a05 s 	call	A6B6A
6a08 6a08 d ed537df8
6a08 6a08 s 	ld	(SAVEND),de
6a0c 6a0c d e3
6a0c 6a0c s 	ex	(sp),hl
6a0d 6a0d d eb
6a0d 6a0d s 	ex	de,hl
6a0e 6a0e d e7
6a0e 6a0e s 	rst	020H
6a0f 6a0f d da2a73
6a0f 6a0f s 	jp	c,A7315
6a12 6a12 d eb
6a12 6a12 s 	ex	de,hl
6a13 6a13 d e3
6a13 6a13 s 	ex	(sp),hl
6a14 6a14 d cdef72
6a14 6a14 s 	call	A72DA
6a17 6a17 d 37
6a17 6a17 s 	scf
6a18 6a18 d 2816
6a18 6a18 s 	jr	z,A6A1B
6a1a 6a1a d cde572
6a1a 6a1a s 	call	A72D0
6a1d 6a1d d 2c
6a1d 6a1d s 	defb	","
6a1e 6a1e d fe53
6a1e 6a1e s 	cp	"S"
6a20 6a20 d 2006
6a20 6a20 s 	jr	nz,A6A13
6a22 6a22 d cdf072
6a22 6a22 s 	call	A72DB
6a25 6a25 d a7
6a25 6a25 s 	and	a
6a26 6a26 d 1808
6a26 6a26 s 	jr	A6A1B
6a28 6a28 s ;
6a28 6a28 d cd836b
6a28 6a28 s A6A13:	call	A6B6E
6a2b 6a2b d ed53bffc
6a2b 6a2b s 	ld	(SAVENT),de
6a2f 6a2f d 37
6a2f 6a2f s 	scf
6a30 6a30 d c1
6a30 6a30 s A6A1B:	pop	bc
6a31 6a31 d 3005
6a31 6a31 s 	jr	nc,A6A23
6a33 6a33 d 04
6a33 6a33 s 	inc	b
6a34 6a34 d 05
6a34 6a34 s 	dec	b
6a35 6a35 d f22a73
6a35 6a35 s 	jp	p,A7315
6a38 6a38 d d1
6a38 6a38 s A6A23:	pop	de
6a39 6a39 d e5
6a39 6a39 s 	push	hl
6a3a 6a3a d c5
6a3a 6a3a s 	push	bc
6a3b 6a3b d f5
6a3b 6a3b s 	push	af
6a3c 6a3c d af
6a3c 6a3c s 	xor	a
6a3d 6a3d d 1e02
6a3d 6a3d s 	ld	e,002H
6a3f 6a3f d dd21fa6a
6a3f 6a3f s 	ld	ix,OPNCHN
6a43 6a43 d cd3373
6a43 6a43 s 	call	A731E
6a46 6a46 d 3efe
6a46 6a46 s 	ld	a,0FEH
6a48 6a48 d cddc69
6a48 6a48 s 	call	A69C7
6a4b 6a4b d f1
6a4b 6a4b s 	pop	af
6a4c 6a4c d e1
6a4c 6a4c s 	pop	hl
6a4d 6a4d d e5
6a4d 6a4d s 	push	hl
6a4e 6a4e d f5
6a4e 6a4e s 	push	af
6a4f 6a4f d cdd369
6a4f 6a4f s 	call	A69BE
6a52 6a52 d 2a7df8
6a52 6a52 s 	ld	hl,(SAVEND)
6a55 6a55 d cdd369
6a55 6a55 s 	call	A69BE
6a58 6a58 d 2abffc
6a58 6a58 s 	ld	hl,(SAVENT)
6a5b 6a5b d cdd369
6a5b 6a5b s 	call	A69BE
6a5e 6a5e d f1
6a5e 6a5e s 	pop	af
6a5f 6a5f d c1
6a5f 6a5f s 	pop	bc
6a60 6a60 d f5
6a60 6a60 s 	push	af
6a61 6a61 d ed433df2
6a61 6a61 s 	ld	(YF23D),bc		; transferadres
6a65 6a65 d 2a7df8
6a65 6a65 s 	ld	hl,(SAVEND)
6a68 6a68 d a7
6a68 6a68 s 	and	a
6a69 6a69 d ed42
6a69 6a69 s 	sbc	hl,bc
6a6b 6a6b d 23
6a6b 6a6b s 	inc	hl
6a6c 6a6c d f1
6a6c 6a6c s 	pop	af
6a6d 6a6d d 3013
6a6d 6a6d s 	jr	nc,A6A6D
6a6f 6a6f d cda071
6a6f 6a6f s 	call	A718B
6a72 6a72 d 3eff
6a72 6a72 s A6A5D:	ld	a,0FFH
6a74 6a74 d 32aefc
6a74 6a74 s 	ld	(FLBMEM),a
6a77 6a77 d af
6a77 6a77 s 	xor	a
6a78 6a78 d dd21246b
6a78 6a78 s 	ld	ix,CLOCHN
6a7c 6a7c d cd3373
6a7c 6a7c s 	call	A731E
6a7f 6a7f d c30d6f
6a7f 6a7f s 	jp	A6EF8
6a82 6a82 s ;
6a82 6a82 d cd7a71
6a82 6a82 s A6A6D:	call	A7165
6a85 6a85 d e5
6a85 6a85 s A6A70:	push	hl
6a86 6a86 d ed5bbffc
6a86 6a86 s 	ld	de,(SAVENT)
6a8a 6a8a d e7
6a8a 6a8a s 	rst	020H
6a8b 6a8b d f5
6a8b 6a8b s 	push	af
6a8c 6a8c d 4d
6a8c 6a8c s 	ld	c,l
6a8d 6a8d d 44
6a8d 6a8d s 	ld	b,h
6a8e 6a8e d 2a7df8
6a8e 6a8e s 	ld	hl,(SAVEND)
6a91 6a91 d e5
6a91 6a91 s 	push	hl
6a92 6a92 d 09
6a92 6a92 s 	add	hl,bc
6a93 6a93 d 227df8
6a93 6a93 s 	ld	(SAVEND),hl
6a96 6a96 d e1
6a96 6a96 s 	pop	hl
6a97 6a97 d ed5b3df2
6a97 6a97 s 	ld	de,(YF23D)		; transferadres
6a9b 6a9b d cd5900
6a9b 6a9b s 	call	LDIRMV
6a9e 6a9e d f1
6a9e 6a9e s 	pop	af
6a9f 6a9f d 3012
6a9f 6a9f s 	jr	nc,A6A9E
6aa1 6aa1 d e1
6aa1 6aa1 s 	pop	hl
6aa2 6aa2 d e5
6aa2 6aa2 s 	push	hl
6aa3 6aa3 d cda071
6aa3 6aa3 s 	call	A718B
6aa6 6aa6 d 2abffc
6aa6 6aa6 s 	ld	hl,(SAVENT)
6aa9 6aa9 d d1
6aa9 6aa9 s 	pop	de
6aaa 6aaa d a7
6aaa 6aaa s 	and	a
6aab 6aab d ed52
6aab 6aab s 	sbc	hl,de
6aad 6aad d 22bffc
6aad 6aad s 	ld	(SAVENT),hl
6ab0 6ab0 d eb
6ab0 6ab0 s 	ex	de,hl
6ab1 6ab1 d 18d2
6ab1 6ab1 s 	jr	A6A70
6ab3 6ab3 s ;
6ab3 6ab3 d e1
6ab3 6ab3 s A6A9E:	pop	hl
6ab4 6ab4 d 2abffc
6ab4 6ab4 s 	ld	hl,(SAVENT)
6ab7 6ab7 d cda071
6ab7 6ab7 s 	call	A718B
6aba 6aba d 18b6
6aba 6aba s 	jr	A6A5D
6abc 6abc s ;
6abc 6abc s ;
6abc 6abc d d5
6abc 6abc s A6AA7:	push	de
6abd 6abd d af
6abd 6abd s 	xor	a
6abe 6abe d 32befc
6abe 6abe s 	ld	(RUNBNF),a
6ac1 6ac1 d 4f
6ac1 6ac1 s 	ld	c,a
6ac2 6ac2 d 47
6ac2 6ac2 s 	ld	b,a
6ac3 6ac3 d cdef72
6ac3 6ac3 s 	call	A72DA
6ac6 6ac6 d 281d
6ac6 6ac6 s 	jr	z,A6AD0
6ac8 6ac8 d cde572
6ac8 6ac8 s 	call	A72D0
6acb 6acb d 2c
6acb 6acb s 	defb	","
6acc 6acc d fe52
6acc 6acc s 	cp	"R"
6ace 6ace d 2804
6ace 6ace s 	jr	z,A6ABF
6ad0 6ad0 d fe53
6ad0 6ad0 s 	cp	"S"
6ad2 6ad2 d 200c
6ad2 6ad2 s 	jr	nz,A6ACB
6ad4 6ad4 d 32befc
6ad4 6ad4 s A6ABF:	ld	(RUNBNF),a
6ad7 6ad7 d cdf072
6ad7 6ad7 s 	call	A72DB
6ada 6ada d 2809
6ada 6ada s 	jr	z,A6AD0
6adc 6adc d cde572
6adc 6adc s 	call	A72D0
6adf 6adf d 2c
6adf 6adf s 	defb	","
6ae0 6ae0 d cd836b
6ae0 6ae0 s A6ACB:	call	A6B6E
6ae3 6ae3 d 42
6ae3 6ae3 s 	ld	b,d
6ae4 6ae4 d 4b
6ae4 6ae4 s 	ld	c,e
6ae5 6ae5 d d1
6ae5 6ae5 s A6AD0:	pop	de
6ae6 6ae6 d e5
6ae6 6ae6 s 	push	hl
6ae7 6ae7 d c5
6ae7 6ae7 s 	push	bc
6ae8 6ae8 d 3eff
6ae8 6ae8 s 	ld	a,0FFH
6aea 6aea d 32aefc
6aea 6aea s 	ld	(FLBMEM),a
6aed 6aed d af
6aed 6aed s 	xor	a
6aee 6aee d 1e01
6aee 6aee s 	ld	e,001H
6af0 6af0 d dd21fa6a
6af0 6af0 s 	ld	ix,OPNCHN
6af4 6af4 d cd3373
6af4 6af4 s 	call	A731E
6af7 6af7 d ed5b53f3
6af7 6af7 s 	ld	de,(YF353)
6afb 6afb d cde569
6afb 6afb s 	call	A69D0
6afe 6afe d fefe
6afe 6afe s 	cp	0FEH
6b00 6b00 d c2ae71
6b00 6b00 s 	jp	nz,A7199
6b03 6b03 d c1
6b03 6b03 s 	pop	bc
6b04 6b04 d cd716b
6b04 6b04 s 	call	A6B5C
6b07 6b07 d e5
6b07 6b07 s 	push	hl
6b08 6b08 d cd716b
6b08 6b08 s 	call	A6B5C
6b0b 6b0b d e5
6b0b 6b0b s 	push	hl
6b0c 6b0c d cd716b
6b0c 6b0c s 	call	A6B5C
6b0f 6b0f d 22bffc
6b0f 6b0f s 	ld	(SAVENT),hl
6b12 6b12 d e1
6b12 6b12 s 	pop	hl
6b13 6b13 d c1
6b13 6b13 s 	pop	bc
6b14 6b14 d a7
6b14 6b14 s 	and	a
6b15 6b15 d ed42
6b15 6b15 s 	sbc	hl,bc
6b17 6b17 d 23
6b17 6b17 s 	inc	hl
6b18 6b18 d ed433df2
6b18 6b18 s 	ld	(YF23D),bc		; transferadres
6b1c 6b1c d 3abefc
6b1c 6b1c s 	ld	a,(RUNBNF)
6b1f 6b1f d fe53
6b1f 6b1f s 	cp	"S"
6b21 6b21 d 280c
6b21 6b21 s 	jr	z,A6B1A
6b23 6b23 d cdb247
6b23 6b23 s 	call	A47B2			; random block read
6b26 6b26 d dd21ff4a
6b26 6b26 s A6B11:	ld	ix,SCROUT
6b2a 6b2a d cd3373
6b2a 6b2a s 	call	A731E
6b2d 6b2d d e1
6b2d 6b2d s 	pop	hl
6b2e 6b2e d c9
6b2e 6b2e s 	ret
6b2f 6b2f s ;
6b2f 6b2f d cd7a71
6b2f 6b2f s A6B1A:	call	A7165
6b32 6b32 d e5
6b32 6b32 s A6B1D:	push	hl
6b33 6b33 d ed5bbffc
6b33 6b33 s 	ld	de,(SAVENT)
6b37 6b37 d e7
6b37 6b37 s 	rst	020H
6b38 6b38 d f5
6b38 6b38 s 	push	af
6b39 6b39 d ed5b53f3
6b39 6b39 s 	ld	de,(YF353)
6b3d 6b3d d cdb247
6b3d 6b3d s 	call	A47B2			; random block read
6b40 6b40 d f1
6b40 6b40 s 	pop	af
6b41 6b41 d c1
6b41 6b41 s 	pop	bc
6b42 6b42 d c5
6b42 6b42 s 	push	bc
6b43 6b43 d f5
6b43 6b43 s 	push	af
6b44 6b44 d 2a7df8
6b44 6b44 s 	ld	hl,(SAVEND)
6b47 6b47 d e5
6b47 6b47 s 	push	hl
6b48 6b48 d 09
6b48 6b48 s 	add	hl,bc
6b49 6b49 d 227df8
6b49 6b49 s 	ld	(SAVEND),hl
6b4c 6b4c d d1
6b4c 6b4c s 	pop	de
6b4d 6b4d d 2a3df2
6b4d 6b4d s 	ld	hl,(YF23D)		; transferadres
6b50 6b50 d f1
6b50 6b50 s 	pop	af
6b51 6b51 d 3010
6b51 6b51 s 	jr	nc,A6B4E
6b53 6b53 d cd5c00
6b53 6b53 s 	call	LDIRVM
6b56 6b56 d 2abffc
6b56 6b56 s 	ld	hl,(SAVENT)
6b59 6b59 d d1
6b59 6b59 s 	pop	de
6b5a 6b5a d a7
6b5a 6b5a s 	and	a
6b5b 6b5b d ed52
6b5b 6b5b s 	sbc	hl,de
6b5d 6b5d d 22bffc
6b5d 6b5d s 	ld	(SAVENT),hl
6b60 6b60 d eb
6b60 6b60 s 	ex	de,hl
6b61 6b61 d 18cf
6b61 6b61 s 	jr	A6B1D
6b63 6b63 s ;
6b63 6b63 d c1
6b63 6b63 s A6B4E:	pop	bc
6b64 6b64 d ed4bbffc
6b64 6b64 s 	ld	bc,(SAVENT)
6b68 6b68 d cd5c00
6b68 6b68 s 	call	LDIRVM
6b6b 6b6b d af
6b6b 6b6b s 	xor	a
6b6c 6b6c d 32befc
6b6c 6b6c s 	ld	(RUNBNF),a
6b6f 6b6f d 18b5
6b6f 6b6f s 	jr	A6B11
6b71 6b71 s ;
6b71 6b71 d c5
6b71 6b71 s A6B5C:	push	bc
6b72 6b72 d cde569
6b72 6b72 s 	call	A69D0
6b75 6b75 d f5
6b75 6b75 s 	push	af
6b76 6b76 d cde569
6b76 6b76 s 	call	A69D0
6b79 6b79 d 67
6b79 6b79 s 	ld	h,a
6b7a 6b7a d f1
6b7a 6b7a s 	pop	af
6b7b 6b7b d 6f
6b7b 6b7b s 	ld	l,a
6b7c 6b7c d c1
6b7c 6b7c s 	pop	bc
6b7d 6b7d d 09
6b7d 6b7d s 	add	hl,bc
6b7e 6b7e d c9
6b7e 6b7e s 	ret
6b7f 6b7f s ;
6b7f 6b7f d cde572
6b7f 6b7f s A6B6A:	call	A72D0
6b82 6b82 d 2c
6b82 6b82 s 	defb	","
6b83 6b83 d dd210b6f
6b83 6b83 s A6B6E:	ld	ix,BADRES
6b87 6b87 d c33373
6b87 6b87 s 	jp	A731E
6b8a 6b8a s ;
6b8a 6b8a s ;
6b8a 6b8a d cd9573
6b8a 6b8a s A6B75:	call	A7380
6b8d 6b8d d cdf072
6b8d 6b8d s 	call	A72DB
6b90 6b90 d cde572
6b90 6b90 s 	call	A72D0
6b93 6b93 d 28
6b93 6b93 s 	defb	"("
6b94 6b94 d cdda6b
6b94 6b94 s 	call	A6BC5
6b97 6b97 d cde572
6b97 6b97 s 	call	A72D0
6b9a 6b9a d 29
6b9a 6b9a s 	defb	")"
6b9b 6b9b d e5
6b9b 6b9b s 	push	hl
6b9c 6b9c d 21d63f
6b9c 6b9c s 	ld	hl,03FD6H
6b9f 6b9f d 22f8f7
6b9f 6b9f s 	ld	(DAC+2),hl
6ba2 6ba2 d e1
6ba2 6ba2 s 	pop	hl
6ba3 6ba3 d 3e03
6ba3 6ba3 s 	ld	a,003H
6ba5 6ba5 d 3263f6
6ba5 6ba5 s 	ld	(VALTYP),a
6ba8 6ba8 d a7
6ba8 6ba8 s 	and	a
6ba9 6ba9 d 180b
6ba9 6ba9 s 	jr	A6BA1
6bab 6bab s ;
6bab 6bab s ;
6bab 6bab d cd9573
6bab 6bab s A6B96:	call	A7380
6bae 6bae d cdda6b
6bae 6bae s 	call	A6BC5
6bb1 6bb1 d cdef72
6bb1 6bb1 s 	call	A72DA
6bb4 6bb4 d c0
6bb4 6bb4 s 	ret	nz
6bb5 6bb5 d 37
6bb5 6bb5 s 	scf
6bb6 6bb6 d f5
6bb6 6bb6 s A6BA1:	push	af
6bb7 6bb7 d e5
6bb7 6bb7 s 	push	hl
6bb8 6bb8 d d5
6bb8 6bb8 s 	push	de
6bb9 6bb9 d 59
6bb9 6bb9 s 	ld	e,c
6bba 6bba d cd5d50
6bba 6bba s 	call	A505D
6bbd 6bbd d 3c
6bbd 6bbd s 	inc	a
6bbe 6bbe d cab171
6bbe 6bbe s 	jp	z,A719C
6bc1 6bc1 d d1
6bc1 6bc1 s 	pop	de
6bc2 6bc2 d e1
6bc2 6bc2 s 	pop	hl
6bc3 6bc3 d f1
6bc3 6bc3 s 	pop	af
6bc4 6bc4 d e5
6bc4 6bc4 s 	push	hl
6bc5 6bc5 d 3eff
6bc5 6bc5 s 	ld	a,0FFH
6bc7 6bc7 d 3246f2
6bc7 6bc7 s 	ld	(YF246),a		; invalid dirsector buffer
6bca 6bca d dd7e00
6bca 6bca s 	ld	a,(ix+000H)		; driveid
6bcd 6bcd d 0601
6bcd 6bcd s 	ld	b,001H
6bcf 6bcf d dd4e01
6bcf 6bcf s 	ld	c,(ix+001H)		; mediadescriptor
6bd2 6bd2 d 2a51f3
6bd2 6bd2 s 	ld	hl,(YF351)		; temporary use dirsector buffer
6bd5 6bd5 d cd4401
6bd5 6bd5 s 	call	PHYDIO
6bd8 6bd8 d e1
6bd8 6bd8 s 	pop	hl
6bd9 6bd9 d c9
6bd9 6bd9 s 	ret
6bda 6bda s ;
6bda 6bda d dd211c52
6bda 6bda s A6BC5:	ld	ix,EVBYTE
6bde 6bde d cd3373
6bde 6bde s 	call	A731E
6be1 6be1 d d5
6be1 6be1 s 	push	de
6be2 6be2 d cde572
6be2 6be2 s 	call	A72D0
6be5 6be5 d 2c
6be5 6be5 s 	defb	","
6be6 6be6 d dd212f54
6be6 6be6 s 	ld	ix,EVADR
6bea 6bea d cd3373
6bea 6bea s 	call	A731E
6bed 6bed d c1
6bed 6bed s 	pop	bc
6bee 6bee d c9
6bee 6bee s 	ret
6bef 6bef s ;
6bef 6bef s ;
6bef 6bef d dd218bf3
6bef 6bef s A6BDA:	ld	ix,RETRTN
6bf3 6bf3 d fd210004
6bf3 6bf3 s 	ld	iy,00400H
6bf7 6bf7 d cd7866
6bf7 6bf7 s 	call	A6663			; take control from caller
6bfa 6bfa d 7e
6bfa 6bfa s 	ld	a,(hl)
6bfb 6bfb d fe04
6bfb 6bfb s 	cp	004H
6bfd 6bfd d c2ae71
6bfd 6bfd s 	jp	nz,A7199
6c00 6c00 d 23
6c00 6c00 s 	inc	hl
6c01 6c01 d 5e
6c01 6c01 s 	ld	e,(hl)
6c02 6c02 d 23
6c02 6c02 s 	inc	hl
6c03 6c03 d 56
6c03 6c03 s 	ld	d,(hl)
6c04 6c04 d 010700
6c04 6c04 s 	ld	bc,00007H
6c07 6c07 d 09
6c07 6c07 s 	add	hl,bc
6c08 6c08 d e3
6c08 6c08 s 	ex	(sp),hl
6c09 6c09 d cdef72
6c09 6c09 s 	call	A72DA
6c0c 6c0c d 2830
6c0c 6c0c s 	jr	z,A6C29
6c0e 6c0e d d5
6c0e 6c0e s 	push	de
6c0f 6c0f d cde572
6c0f 6c0f s 	call	A72D0
6c12 6c12 d 2c
6c12 6c12 s 	defb	","
6c13 6c13 d dd21644c
6c13 6c13 s 	ld	ix,EVEXPR
6c17 6c17 d cd3373
6c17 6c17 s 	call	A731E
6c1a 6c1a d e5
6c1a 6c1a s 	push	hl
6c1b 6c1b d cd106e
6c1b 6c1b s 	call	A6DFB
6c1e 6c1e d 79
6c1e 6c1e s 	ld	a,c
6c1f 6c1f d b0
6c1f 6c1f s 	or	b
6c20 6c20 d b5
6c20 6c20 s 	or	l
6c21 6c21 d b4
6c21 6c21 s 	or	h
6c22 6c22 d ca2a73
6c22 6c22 s 	jp	z,A7315
6c25 6c25 d 79
6c25 6c25 s 	ld	a,c
6c26 6c26 d b0
6c26 6c26 s 	or	b
6c27 6c27 d 0b
6c27 6c27 s 	dec	bc
6c28 6c28 d 2001
6c28 6c28 s 	jr	nz,A6C16
6c2a 6c2a d 2b
6c2a 6c2a s 	dec	hl
6c2b 6c2b d eb
6c2b 6c2b s A6C16:	ex	de,hl
6c2c 6c2c d e1
6c2c 6c2c s 	pop	hl
6c2d 6c2d d e3
6c2d 6c2d s 	ex	(sp),hl
6c2e 6c2e d e5
6c2e 6c2e s 	push	hl
6c2f 6c2f d d5
6c2f 6c2f s 	push	de
6c30 6c30 d 112100
6c30 6c30 s 	ld	de,00021H
6c33 6c33 d 19
6c33 6c33 s 	add	hl,de
6c34 6c34 d d1
6c34 6c34 s 	pop	de
6c35 6c35 d 71
6c35 6c35 s 	ld	(hl),c
6c36 6c36 d 23
6c36 6c36 s 	inc	hl
6c37 6c37 d 70
6c37 6c37 s 	ld	(hl),b
6c38 6c38 d 23
6c38 6c38 s 	inc	hl
6c39 6c39 d 73
6c39 6c39 s 	ld	(hl),e
6c3a 6c3a d 23
6c3a 6c3a s 	inc	hl
6c3b 6c3b d 72
6c3b 6c3b s 	ld	(hl),d
6c3c 6c3c d d1
6c3c 6c3c s 	pop	de
6c3d 6c3d d e1
6c3d 6c3d s 	pop	hl
6c3e 6c3e d e3
6c3e 6c3e s A6C29:	ex	(sp),hl
6c3f 6c3f d 223df2
6c3f 6c3f s 	ld	(YF23D),hl		; transferadres
6c42 6c42 d e1
6c42 6c42 s 	pop	hl
6c43 6c43 d f1
6c43 6c43 s 	pop	af
6c44 6c44 d e5
6c44 6c44 s 	push	hl
6c45 6c45 d a7
6c45 6c45 s 	and	a
6c46 6c46 d 211873
6c46 6c46 s 	ld	hl,A7303
6c49 6c49 d 01b247
6c49 6c49 s 	ld	bc,A47B2		; random block read
6c4c 6c4c d 2806
6c4c 6c4c s 	jr	z,A6C3F
6c4e 6c4e d 21bd71
6c4e 6c4e s 	ld	hl,A71A8
6c51 6c51 d 01be47
6c51 6c51 s 	ld	bc,A47BE		; random block write
6c54 6c54 d e5
6c54 6c54 s A6C3F:	push	hl
6c55 6c55 d cdf769
6c55 6c55 s 	call	A69E2
6c58 6c58 d a7
6c58 6c58 s 	and	a
6c59 6c59 d c0
6c59 6c59 s 	ret	nz
6c5a 6c5a d e1
6c5a 6c5a s 	pop	hl
6c5b 6c5b d c30d6f
6c5b 6c5b s 	jp	A6EF8
6c5e 6c5e s ;
6c5e 6c5e s ;
6c5e 6c5e d cd9573
6c5e 6c5e s A6C49:	call	A7380
6c61 6c61 d fe23
6c61 6c61 s 	cp	"#"
6c63 6c63 d ccf072
6c63 6c63 s 	call	z,A72DB
6c66 6c66 d dd211c52
6c66 6c66 s 	ld	ix,EVBYTE
6c6a 6c6a d cd3373
6c6a 6c6a s 	call	A731E
6c6d 6c6d d ca2d73
6c6d 6c6d s 	jp	z,A7318
6c70 6c70 d e5
6c70 6c70 s 	push	hl
6c71 6c71 d dd216d6a
6c71 6c71 s 	ld	ix,GTCHNP
6c75 6c75 d cd3373
6c75 6c75 s 	call	A731E
6c78 6c78 d 5d
6c78 6c78 s 	ld	e,l
6c79 6c79 d 54
6c79 6c79 s 	ld	d,h
6c7a 6c7a d ca1573
6c7a 6c7a s 	jp	z,A7300
6c7d 6c7d d da2a73
6c7d 6c7d s 	jp	c,A7315
6c80 6c80 d 7e
6c80 6c80 s 	ld	a,(hl)
6c81 6c81 d fe04
6c81 6c81 s 	cp	004H
6c83 6c83 d c2ae71
6c83 6c83 s 	jp	nz,A7199
6c86 6c86 d 23
6c86 6c86 s 	inc	hl
6c87 6c87 d 7e
6c87 6c87 s 	ld	a,(hl)
6c88 6c88 d 23
6c88 6c88 s 	inc	hl
6c89 6c89 d 66
6c89 6c89 s 	ld	h,(hl)
6c8a 6c8a d 6f
6c8a 6c8a s 	ld	l,a
6c8b 6c8b d 010e00
6c8b 6c8b s 	ld	bc,0000EH
6c8e 6c8e d 09
6c8e 6c8e s 	add	hl,bc
6c8f 6c8f d 4e
6c8f 6c8f s 	ld	c,(hl)
6c90 6c90 d 23
6c90 6c90 s 	inc	hl
6c91 6c91 d 46
6c91 6c91 s 	ld	b,(hl)
6c92 6c92 d ed4368f5
6c92 6c92 s 	ld	(BUF+10),bc
6c96 6c96 d 210000
6c96 6c96 s 	ld	hl,00000H
6c99 6c99 d 226af5
6c99 6c99 s 	ld	(BUF+12),hl
6c9c 6c9c d 010900
6c9c 6c9c s 	ld	bc,00009H
6c9f 6c9f d e1
6c9f 6c9f s 	pop	hl
6ca0 6ca0 d eb
6ca0 6ca0 s A6C8B:	ex	de,hl
6ca1 6ca1 d 09
6ca1 6ca1 s 	add	hl,bc
6ca2 6ca2 d eb
6ca2 6ca2 s 	ex	de,hl
6ca3 6ca3 d 7e
6ca3 6ca3 s 	ld	a,(hl)
6ca4 6ca4 d fe2c
6ca4 6ca4 s 	cp	","
6ca6 6ca6 d c0
6ca6 6ca6 s 	ret	nz
6ca7 6ca7 d d5
6ca7 6ca7 s 	push	de
6ca8 6ca8 d dd211b52
6ca8 6ca8 s 	ld	ix,NEVBYT
6cac 6cac d cd3373
6cac 6cac s 	call	A731E
6caf 6caf d f5
6caf 6caf s 	push	af
6cb0 6cb0 d cde572
6cb0 6cb0 s 	call	A72D0
6cb3 6cb3 d 41
6cb3 6cb3 s 	defb	"A"
6cb4 6cb4 d cde572
6cb4 6cb4 s 	call	A72D0
6cb7 6cb7 d 53
6cb7 6cb7 s 	defb	"S"
6cb8 6cb8 d dd21a45e
6cb8 6cb8 s 	ld	ix,GETVAR
6cbc 6cbc d cd3373
6cbc 6cbc s 	call	A731E
6cbf 6cbf d dd219755
6cbf 6cbf s 	ld	ix,GETYPR
6cc3 6cc3 d cd3373
6cc3 6cc3 s 	call	A731E
6cc6 6cc6 d c20f73
6cc6 6cc6 s 	jp	nz,A72FA
6cc9 6cc9 d f1
6cc9 6cc9 s 	pop	af
6cca 6cca d e3
6cca 6cca s 	ex	(sp),hl
6ccb 6ccb d d5
6ccb 6ccb s 	push	de
6ccc 6ccc d e5
6ccc 6ccc s 	push	hl
6ccd 6ccd d 2a6af5
6ccd 6ccd s 	ld	hl,(BUF+12)
6cd0 6cd0 d 4f
6cd0 6cd0 s 	ld	c,a
6cd1 6cd1 d 0600
6cd1 6cd1 s 	ld	b,000H
6cd3 6cd3 d 09
6cd3 6cd3 s 	add	hl,bc
6cd4 6cd4 d 226af5
6cd4 6cd4 s 	ld	(BUF+12),hl
6cd7 6cd7 d eb
6cd7 6cd7 s 	ex	de,hl
6cd8 6cd8 d 2a68f5
6cd8 6cd8 s 	ld	hl,(BUF+10)
6cdb 6cdb d e7
6cdb 6cdb s 	rst	020H
6cdc 6cdc d da1b73
6cdc 6cdc s 	jp	c,A7306
6cdf 6cdf d d1
6cdf 6cdf s 	pop	de
6ce0 6ce0 d e1
6ce0 6ce0 s 	pop	hl
6ce1 6ce1 d 71
6ce1 6ce1 s 	ld	(hl),c
6ce2 6ce2 d 23
6ce2 6ce2 s 	inc	hl
6ce3 6ce3 d 73
6ce3 6ce3 s 	ld	(hl),e
6ce4 6ce4 d 23
6ce4 6ce4 s 	inc	hl
6ce5 6ce5 d 72
6ce5 6ce5 s 	ld	(hl),d
6ce6 6ce6 d 0600
6ce6 6ce6 s 	ld	b,000H
6ce8 6ce8 d e1
6ce8 6ce8 s 	pop	hl
6ce9 6ce9 d 18b5
6ce9 6ce9 s 	jr	A6C8B
6ceb 6ceb s ;
6ceb 6ceb s ;
6ceb 6ceb d f6
6ceb 6ceb s A6CD6:	defb	0F6H
6cec 6cec d 37
6cec 6cec s A6CD7:	scf
6ced 6ced d cd9573
6ced 6ced s 	call	A7380
6cf0 6cf0 d f5
6cf0 6cf0 s 	push	af
6cf1 6cf1 d dd21a45e
6cf1 6cf1 s 	ld	ix,GETVAR
6cf5 6cf5 d cd3373
6cf5 6cf5 s 	call	A731E
6cf8 6cf8 d dd219755
6cf8 6cf8 s 	ld	ix,GETYPR
6cfc 6cfc d cd3373
6cfc 6cfc s 	call	A731E
6cff 6cff d c20f73
6cff 6cff s 	jp	nz,A72FA
6d02 6d02 d d5
6d02 6d02 s 	push	de
6d03 6d03 d dd215f4c
6d03 6d03 s 	ld	ix,EVLEXP
6d07 6d07 d cd3373
6d07 6d07 s 	call	A731E
6d0a 6d0a d c1
6d0a 6d0a s 	pop	bc
6d0b 6d0b d e3
6d0b 6d0b s 	ex	(sp),hl
6d0c 6d0c d e5
6d0c 6d0c s 	push	hl
6d0d 6d0d d c5
6d0d 6d0d s 	push	bc
6d0e 6d0e d dd21d067
6d0e 6d0e s 	ld	ix,FRETMP
6d12 6d12 d cd3373
6d12 6d12 s 	call	A731E
6d15 6d15 d 46
6d15 6d15 s 	ld	b,(hl)
6d16 6d16 d e3
6d16 6d16 s 	ex	(sp),hl
6d17 6d17 d 7e
6d17 6d17 s 	ld	a,(hl)
6d18 6d18 d 4f
6d18 6d18 s 	ld	c,a
6d19 6d19 d c5
6d19 6d19 s 	push	bc
6d1a 6d1a d e5
6d1a 6d1a s 	push	hl
6d1b 6d1b d f5
6d1b 6d1b s 	push	af
6d1c 6d1c d 23
6d1c 6d1c s 	inc	hl
6d1d 6d1d d 5e
6d1d 6d1d s 	ld	e,(hl)
6d1e 6d1e d 23
6d1e 6d1e s 	inc	hl
6d1f 6d1f d 56
6d1f 6d1f s 	ld	d,(hl)
6d20 6d20 d b7
6d20 6d20 s 	or	a
6d21 6d21 d 285c
6d21 6d21 s 	jr	z,A6D6A
6d23 6d23 d 2a62f8
6d23 6d23 s 	ld	hl,(NULBUF)
6d26 6d26 d 2b
6d26 6d26 s 	dec	hl
6d27 6d27 d e7
6d27 6d27 s 	rst	020H
6d28 6d28 d 3833
6d28 6d28 s 	jr	c,A6D48
6d2a 6d2a d 2ac2f6
6d2a 6d2a s 	ld	hl,(VARTAB)
6d2d 6d2d d e7
6d2d 6d2d s 	rst	020H
6d2e 6d2e d 382d
6d2e 6d2e s 	jr	c,A6D48
6d30 6d30 d 59
6d30 6d30 s 	ld	e,c
6d31 6d31 d 1600
6d31 6d31 s 	ld	d,000H
6d33 6d33 d 2a74f6
6d33 6d33 s 	ld	hl,(STKTOP)
6d36 6d36 d 19
6d36 6d36 s 	add	hl,de
6d37 6d37 d eb
6d37 6d37 s 	ex	de,hl
6d38 6d38 d 2a9bf6
6d38 6d38 s 	ld	hl,(FRETOP)
6d3b 6d3b d e7
6d3b 6d3b s 	rst	020H
6d3c 6d3c d 3854
6d3c 6d3c s 	jr	c,A6D7D
6d3e 6d3e d f1
6d3e 6d3e s 	pop	af
6d3f 6d3f d 79
6d3f 6d3f s A6D2A:	ld	a,c
6d40 6d40 d dd218e66
6d40 6d40 s 	ld	ix,ALSSPC
6d44 6d44 d cd3373
6d44 6d44 s 	call	A731E
6d47 6d47 d e1
6d47 6d47 s 	pop	hl
6d48 6d48 d c1
6d48 6d48 s 	pop	bc
6d49 6d49 d e3
6d49 6d49 s 	ex	(sp),hl
6d4a 6d4a d d5
6d4a 6d4a s 	push	de
6d4b 6d4b d c5
6d4b 6d4b s 	push	bc
6d4c 6d4c d dd21d067
6d4c 6d4c s 	ld	ix,FRETMP
6d50 6d50 d cd3373
6d50 6d50 s 	call	A731E
6d53 6d53 d c1
6d53 6d53 s 	pop	bc
6d54 6d54 d d1
6d54 6d54 s 	pop	de
6d55 6d55 d e3
6d55 6d55 s 	ex	(sp),hl
6d56 6d56 d c5
6d56 6d56 s 	push	bc
6d57 6d57 d e5
6d57 6d57 s 	push	hl
6d58 6d58 d 23
6d58 6d58 s 	inc	hl
6d59 6d59 d f5
6d59 6d59 s 	push	af
6d5a 6d5a d 73
6d5a 6d5a s 	ld	(hl),e
6d5b 6d5b d 23
6d5b 6d5b s 	inc	hl
6d5c 6d5c d 72
6d5c 6d5c s 	ld	(hl),d
6d5d 6d5d d f1
6d5d 6d5d s A6D48:	pop	af
6d5e 6d5e d e1
6d5e 6d5e s 	pop	hl
6d5f 6d5f d 23
6d5f 6d5f s 	inc	hl
6d60 6d60 d 5e
6d60 6d60 s 	ld	e,(hl)
6d61 6d61 d 23
6d61 6d61 s 	inc	hl
6d62 6d62 d 56
6d62 6d62 s 	ld	d,(hl)
6d63 6d63 d c1
6d63 6d63 s 	pop	bc
6d64 6d64 d e1
6d64 6d64 s 	pop	hl
6d65 6d65 d 23
6d65 6d65 s 	inc	hl
6d66 6d66 d 7e
6d66 6d66 s 	ld	a,(hl)
6d67 6d67 d 23
6d67 6d67 s 	inc	hl
6d68 6d68 d 66
6d68 6d68 s 	ld	h,(hl)
6d69 6d69 d 6f
6d69 6d69 s 	ld	l,a
6d6a 6d6a d 79
6d6a 6d6a s 	ld	a,c
6d6b 6d6b d b8
6d6b 6d6b s 	cp	b
6d6c 6d6c d 3001
6d6c 6d6c s 	jr	nc,A6D5A
6d6e 6d6e d 47
6d6e 6d6e s 	ld	b,a
6d6f 6d6f d 90
6d6f 6d6f s A6D5A:	sub	b
6d70 6d70 d 4f
6d70 6d70 s 	ld	c,a
6d71 6d71 d f1
6d71 6d71 s 	pop	af
6d72 6d72 d d4896d
6d72 6d72 s 	call	nc,A6D74
6d75 6d75 d 04
6d75 6d75 s 	inc	b
6d76 6d76 d 05
6d76 6d76 s A6D61:	dec	b
6d77 6d77 d 280b
6d77 6d77 s 	jr	z,A6D6F
6d79 6d79 d 7e
6d79 6d79 s 	ld	a,(hl)
6d7a 6d7a d 12
6d7a 6d7a s 	ld	(de),a
6d7b 6d7b d 23
6d7b 6d7b s 	inc	hl
6d7c 6d7c d 13
6d7c 6d7c s 	inc	de
6d7d 6d7d d 18f7
6d7d 6d7d s 	jr	A6D61
6d7f 6d7f s ;
6d7f 6d7f d c1
6d7f 6d7f s A6D6A:	pop	bc
6d80 6d80 d c1
6d80 6d80 s 	pop	bc
6d81 6d81 d c1
6d81 6d81 s 	pop	bc
6d82 6d82 d c1
6d82 6d82 s 	pop	bc
6d83 6d83 d c1
6d83 6d83 s 	pop	bc
6d84 6d84 d dc896d
6d84 6d84 s A6D6F:	call	c,A6D74
6d87 6d87 d e1
6d87 6d87 s 	pop	hl
6d88 6d88 d c9
6d88 6d88 s 	ret
6d89 6d89 s ;
6d89 6d89 d 3e20
6d89 6d89 s A6D74:	ld	a,020H
6d8b 6d8b d 0c
6d8b 6d8b s 	inc	c
6d8c 6d8c d 0d
6d8c 6d8c s A6D77:	dec	c
6d8d 6d8d d c8
6d8d 6d8d s 	ret	z
6d8e 6d8e d 12
6d8e 6d8e s 	ld	(de),a
6d8f 6d8f d 13
6d8f 6d8f s 	inc	de
6d90 6d90 d 18fa
6d90 6d90 s 	jr	A6D77
6d92 6d92 s ;
6d92 6d92 d f1
6d92 6d92 s A6D7D:	pop	af
6d93 6d93 d e1
6d93 6d93 s 	pop	hl
6d94 6d94 d c1
6d94 6d94 s 	pop	bc
6d95 6d95 d e3
6d95 6d95 s 	ex	(sp),hl
6d96 6d96 d eb
6d96 6d96 s 	ex	de,hl
6d97 6d97 d 2025
6d97 6d97 s 	jr	nz,A6DA9
6d99 6d99 d c5
6d99 6d99 s 	push	bc
6d9a 6d9a d 78
6d9a 6d9a s 	ld	a,b
6d9b 6d9b d dd212766
6d9b 6d9b s 	ld	ix,ALTSTR
6d9f 6d9f d cd3373
6d9f 6d9f s 	call	A731E
6da2 6da2 d 1198f6
6da2 6da2 s 	ld	de,TEMPST+30
6da5 6da5 d 2a78f6
6da5 6da5 s 	ld	hl,(TEMPPT)
6da8 6da8 d 22f8f7
6da8 6da8 s 	ld	(DAC+2),hl
6dab 6dab d 3e03
6dab 6dab s 	ld	a,003H
6dad 6dad d 3263f6
6dad 6dad s 	ld	(VALTYP),a
6db0 6db0 d cdf32e
6db0 6db0 s 	call	VMOVE
6db3 6db3 d 119bf6
6db3 6db3 s 	ld	de,TEMPST+30+3
6db6 6db6 d e7
6db6 6db6 s 	rst	020H
6db7 6db7 d 2278f6
6db7 6db7 s 	ld	(TEMPPT),hl
6dba 6dba d ca0c73
6dba 6dba s 	jp	z,A72F7
6dbd 6dbd d c1
6dbd 6dbd s 	pop	bc
6dbe 6dbe d e3
6dbe 6dbe s A6DA9:	ex	(sp),hl
6dbf 6dbf d c5
6dbf 6dbf s 	push	bc
6dc0 6dc0 d e5
6dc0 6dc0 s 	push	hl
6dc1 6dc1 d c33f6d
6dc1 6dc1 s 	jp	A6D2A
6dc4 6dc4 s ;
6dc4 6dc4 s ;
6dc4 6dc4 d 3e02
6dc4 6dc4 s A6DAF:	ld	a,002H
6dc6 6dc6 d 01
6dc6 6dc6 s 	defb	001H
6dc7 6dc7 d 3e04
6dc7 6dc7 s A6DB2:	ld	a,004H
6dc9 6dc9 d 01
6dc9 6dc9 s 	defb	001H
6dca 6dca d 3e08
6dca 6dca s A6DB5:	ld	a,008H
6dcc 6dcc d cd9573
6dcc 6dcc s 	call	A7380
6dcf 6dcf d f5
6dcf 6dcf s 	push	af
6dd0 6dd0 d dd217a51
6dd0 6dd0 s 	ld	ix,CNVDAC
6dd4 6dd4 d cd3373
6dd4 6dd4 s 	call	A731E
6dd7 6dd7 d f1
6dd7 6dd7 s 	pop	af
6dd8 6dd8 d dd212766
6dd8 6dd8 s 	ld	ix,ALTSTR
6ddc 6ddc d cd3373
6ddc 6ddc s 	call	A731E
6ddf 6ddf d 2a99f6
6ddf 6ddf s 	ld	hl,(DSCTMP+1)
6de2 6de2 d cd102f
6de2 6de2 s 	call	M.2F10
6de5 6de5 d c30662
6de5 6de5 s 	jp	A61F1
6de8 6de8 s 
6de8 6de8 s ; Unused code, patched code ??
6de8 6de8 s ;
6de8 6de8 d 00
6de8 6de8 s 	nop
6de9 6de9 d 00
6de9 6de9 s 	nop
6dea 6dea d 00
6dea 6dea s 	nop
6deb 6deb d 00
6deb 6deb s 	nop
6dec 6dec s 
6dec 6dec s ;
6dec 6dec s ;
6dec 6dec d 3e01
6dec 6dec s A6DD7:	ld	a,001H
6dee 6dee d 01
6dee 6dee s 	defb	001H
6def 6def d 3e03
6def 6def s A6DDA:	ld	a,003H
6df1 6df1 d 01
6df1 6df1 s 	defb	001H
6df2 6df2 d 3e07
6df2 6df2 s A6DDD:	ld	a,007H
6df4 6df4 d cd9573
6df4 6df4 s 	call	A7380
6df7 6df7 d f5
6df7 6df7 s 	push	af
6df8 6df8 d dd21d067
6df8 6df8 s 	ld	ix,FRETMP
6dfc 6dfc d cd3373
6dfc 6dfc s 	call	A731E
6dff 6dff d f1
6dff 6dff s 	pop	af
6e00 6e00 d be
6e00 6e00 s 	cp	(hl)
6e01 6e01 d d22a73
6e01 6e01 s 	jp	nc,A7315
6e04 6e04 d 3c
6e04 6e04 s 	inc	a
6e05 6e05 d 23
6e05 6e05 s 	inc	hl
6e06 6e06 d 4e
6e06 6e06 s 	ld	c,(hl)
6e07 6e07 d 23
6e07 6e07 s 	inc	hl
6e08 6e08 d 66
6e08 6e08 s 	ld	h,(hl)
6e09 6e09 d 69
6e09 6e09 s 	ld	l,c
6e0a 6e0a d 3263f6
6e0a 6e0a s 	ld	(VALTYP),a
6e0d 6e0d d c3082f
6e0d 6e0d s 	jp	VMOVFM
6e10 6e10 s ;
6e10 6e10 d dd219755
6e10 6e10 s A6DFB:	ld	ix,GETYPR
6e14 6e14 d cd3373
6e14 6e14 s 	call	A731E
6e17 6e17 d ed4bf8f7
6e17 6e17 s 	ld	bc,(DAC+2)
6e1b 6e1b d 210000
6e1b 6e1b s 	ld	hl,00000H
6e1e 6e1e d f8
6e1e 6e1e s 	ret	m
6e1f 6e1f d ca0f73
6e1f 6e1f s 	jp	z,A72FA
6e22 6e22 d 21f6f7
6e22 6e22 s 	ld	hl,DAC
6e25 6e25 d 11fcf5
6e25 6e25 s 	ld	de,BUF+158
6e28 6e28 d 010800
6e28 6e28 s 	ld	bc,00008H
6e2b 6e2b d edb0
6e2b 6e2b s 	ldir
6e2d 6e2d d 217d6e
6e2d 6e2d s 	ld	hl,T6E68
6e30 6e30 d 1147f8
6e30 6e30 s 	ld	de,ARG
6e33 6e33 d 0e08
6e33 6e33 s 	ld	c,008H
6e35 6e35 d edb0
6e35 6e35 s 	ldir
6e37 6e37 d cd9f28
6e37 6e37 s 	call	DECDIV
6e3a 6e3a d a7
6e3a 6e3a s 	and	a
6e3b 6e3b d cdd130
6e3b 6e3b s 	call	M.30D1
6e3e 6e3e d dd213254
6e3e 6e3e s 	ld	ix,CNVADR
6e42 6e42 d cd3373
6e42 6e42 s 	call	A731E
6e45 6e45 d d5
6e45 6e45 s 	push	de
6e46 6e46 d eb
6e46 6e46 s 	ex	de,hl
6e47 6e47 d dd21ff46
6e47 6e47 s 	ld	ix,CSNG
6e4b 6e4b d cd3373
6e4b 6e4b s 	call	A731E
6e4e 6e4e d cd4230
6e4e 6e4e s 	call	M.3042
6e51 6e51 d 014565
6e51 6e51 s 	ld	bc,06545H
6e54 6e54 d 115360
6e54 6e54 s 	ld	de,06053H
6e57 6e57 d cd5c32
6e57 6e57 s 	call	M.325C
6e5a 6e5a d 21f6f7
6e5a 6e5a s 	ld	hl,DAC
6e5d 6e5d d 1147f8
6e5d 6e5d s 	ld	de,ARG
6e60 6e60 d 010800
6e60 6e60 s 	ld	bc,00008H
6e63 6e63 d edb0
6e63 6e63 s 	ldir
6e65 6e65 d 21fcf5
6e65 6e65 s 	ld	hl,BUF+158
6e68 6e68 d 11f6f7
6e68 6e68 s 	ld	de,DAC
6e6b 6e6b d 0e08
6e6b 6e6b s 	ld	c,008H
6e6d 6e6d d edb0
6e6d 6e6d s 	ldir
6e6f 6e6f d cd8c26
6e6f 6e6f s 	call	DECSUB
6e72 6e72 d dd213254
6e72 6e72 s 	ld	ix,CNVADR
6e76 6e76 d cd3373
6e76 6e76 s 	call	A731E
6e79 6e79 d 4b
6e79 6e79 s 	ld	c,e
6e7a 6e7a d 42
6e7a 6e7a s 	ld	b,d
6e7b 6e7b d e1
6e7b 6e7b s 	pop	hl
6e7c 6e7c d c9
6e7c 6e7c s 	ret
6e7d 6e7d s ;
6e7d 6e7d d 4565536000000000
6e7d 6e7d s T6E68:	defb	045H,065H,053H,060H,000H,000H,000H,000H
6e85 6e85 s 
6e85 6e85 d cd9573
6e85 6e85 s A6E70:	call	A7380
6e88 6e88 d e5
6e88 6e88 s 	push	hl
6e89 6e89 d cd3f68
6e89 6e89 s 	call	A682A			; get char from I/O channel
6e8c 6e8c d 210000
6e8c 6e8c s 	ld	hl,00000H
6e8f 6e8f d 3001
6e8f 6e8f s 	jr	nc,A6E7D
6e91 6e91 d 2b
6e91 6e91 s 	dec	hl
6e92 6e92 d f5
6e92 6e92 s A6E7D:	push	af
6e93 6e93 d cd992f
6e93 6e93 s 	call	M.2F99
6e96 6e96 d f1
6e96 6e96 s 	pop	af
6e97 6e97 d e1
6e97 6e97 s 	pop	hl
6e98 6e98 d 23
6e98 6e98 s 	inc	hl
6e99 6e99 d 23
6e99 6e99 s 	inc	hl
6e9a 6e9a d 23
6e9a 6e9a s 	inc	hl
6e9b 6e9b d 77
6e9b 6e9b s 	ld	(hl),a
6e9c 6e9c d c9
6e9c 6e9c s 	ret
6e9d 6e9d s ;
6e9d 6e9d s ;
6e9d 6e9d d cd9573
6e9d 6e9d s A6E88:	call	A7380
6ea0 6ea0 d 1600
6ea0 6ea0 s 	ld	d,000H
6ea2 6ea2 d 2806
6ea2 6ea2 s 	jr	z,A6E95
6ea4 6ea4 d cd956f
6ea4 6ea4 s 	call	A6F80
6ea7 6ea7 d e5
6ea7 6ea7 s 	push	hl
6ea8 6ea8 d 1804
6ea8 6ea8 s 	jr	A6E99
6eaa 6eaa s ;
6eaa 6eaa d e5
6eaa 6eaa s A6E95:	push	hl
6eab 6eab d cd1370
6eab 6eab s 	call	A6FFE
6eae 6eae d cd786f
6eae 6eae s A6E99:	call	A6F63
6eb1 6eb1 d 3a16f4
6eb1 6eb1 s 	ld	a,(PRTFLG)
6eb4 6eb4 d a7
6eb4 6eb4 s 	and	a
6eb5 6eb5 d f5
6eb5 6eb5 s 	push	af
6eb6 6eb6 d cd5a66
6eb6 6eb6 s 	call	A6645
6eb9 6eb9 d ca2773
6eb9 6eb9 s 	jp	z,A7312
6ebc 6ebc d dd212373
6ebc 6ebc s 	ld	ix,COUTNL
6ec0 6ec0 d cd3373
6ec0 6ec0 s 	call	A731E
6ec3 6ec3 d 21b3f5
6ec3 6ec3 s A6EAE:	ld	hl,BUF+85
6ec6 6ec6 d 060b
6ec6 6ec6 s 	ld	b,00BH
6ec8 6ec8 d 7e
6ec8 6ec8 s A6EB3:	ld	a,(hl)
6ec9 6ec9 d 23
6ec9 6ec9 s 	inc	hl
6eca 6eca d df
6eca 6eca s 	rst	018H
6ecb 6ecb d 78
6ecb 6ecb s 	ld	a,b
6ecc 6ecc d fe04
6ecc 6ecc s 	cp	004H
6ece 6ece d 2008
6ece 6ece s 	jr	nz,A6EC3
6ed0 6ed0 d 7e
6ed0 6ed0 s 	ld	a,(hl)
6ed1 6ed1 d fe20
6ed1 6ed1 s 	cp	" "
6ed3 6ed3 d 2802
6ed3 6ed3 s 	jr	z,A6EC2
6ed5 6ed5 d 3e2e
6ed5 6ed5 s 	ld	a,"."
6ed7 6ed7 d df
6ed7 6ed7 s A6EC2:	rst	018H
6ed8 6ed8 d 10ee
6ed8 6ed8 s A6EC3:	djnz	A6EB3
6eda 6eda d cdbd00
6eda 6eda s 	call	CKCNTC
6edd 6edd d f1
6edd 6edd s 	pop	af
6ede 6ede d f5
6ede 6ede s 	push	af
6edf 6edf d 3ab0f3
6edf 6edf s 	ld	a,(LINLEN)
6ee2 6ee2 d 47
6ee2 6ee2 s 	ld	b,a
6ee3 6ee3 d 3a61f6
6ee3 6ee3 s 	ld	a,(TTYPOS)
6ee6 6ee6 d 2805
6ee6 6ee6 s 	jr	z,A6ED8
6ee8 6ee8 d 0650
6ee8 6ee8 s 	ld	b,80
6eea 6eea d 3a15f4
6eea 6eea s 	ld	a,(LPTPOS)
6eed 6eed d a7
6eed 6eed s A6ED8:	and	a
6eee 6eee d 280f
6eee 6eee s 	jr	z,A6EEA
6ef0 6ef0 d c60c
6ef0 6ef0 s 	add	a,00CH
6ef2 6ef2 d b8
6ef2 6ef2 s 	cp	b
6ef3 6ef3 d 3003
6ef3 6ef3 s 	jr	nc,A6EE3
6ef5 6ef5 d 3e20
6ef5 6ef5 s 	ld	a," "
6ef7 6ef7 d df
6ef7 6ef7 s 	rst	018H
6ef8 6ef8 d dd212873
6ef8 6ef8 s A6EE3:	ld	ix,OUTNL
6efc 6efc d d43373
6efc 6efc s 	call	nc,A731E
6eff 6eff d 1168f5
6eff 6eff s A6EEA:	ld	de,BUF+10
6f02 6f02 d af
6f02 6f02 s 	xor	a
6f03 6f03 d 3274f5
6f03 6f03 s 	ld	(BUF+22),a
6f06 6f06 d cd0650
6f06 6f06 s 	call	A5006			; search for next
6f09 6f09 d 3c
6f09 6f09 s 	inc	a
6f0a 6f0a d 20b7
6f0a 6f0a s 	jr	nz,A6EAE
6f0c 6f0c d f1
6f0c 6f0c s 	pop	af
6f0d 6f0d d e1
6f0d 6f0d s A6EF8:	pop	hl
6f0e 6f0e d dd21ff4a
6f0e 6f0e s 	ld	ix,SCROUT
6f12 6f12 d c33373
6f12 6f12 s 	jp	A731E
6f15 6f15 s ;
6f15 6f15 s ;
6f15 6f15 d cd9573
6f15 6f15 s A6F00:	call	A7380
6f18 6f18 d cdab6f
6f18 6f18 s 	call	A6F96
6f1b 6f1b d cdef72
6f1b 6f1b s 	call	A72DA
6f1e 6f1e d c0
6f1e 6f1e s 	ret	nz
6f1f 6f1f d cdff65
6f1f 6f1f s 	call	A65EA			; is file already open in one of the I/O channels ?
6f22 6f22 d cab771
6f22 6f22 s 	jp	z,A71A2
6f25 6f25 d cd786f
6f25 6f25 s 	call	A6F63
6f28 6f28 d e5
6f28 6f28 s 	push	hl
6f29 6f29 d 1168f5
6f29 6f29 s 	ld	de,BUF+10
6f2c 6f2c d cd6c43
6f2c 6f2c s 	call	A436C			; delete file
6f2f 6f2f d a7
6f2f 6f2f s 	and	a
6f30 6f30 d c22773
6f30 6f30 s 	jp	nz,A7312
6f33 6f33 d e1
6f33 6f33 s 	pop	hl
6f34 6f34 d c9
6f34 6f34 s 	ret
6f35 6f35 s ;
6f35 6f35 s ;
6f35 6f35 d cd9573
6f35 6f35 s A6F20:	call	A7380
6f38 6f38 d cdab6f
6f38 6f38 s 	call	A6F96
6f3b 6f3b d cdff65
6f3b 6f3b s 	call	A65EA			; is file already open in one of the I/O channels ?
6f3e 6f3e d cab771
6f3e 6f3e s 	jp	z,A71A2
6f41 6f41 d cd786f
6f41 6f41 s 	call	A6F63
6f44 6f44 d e5
6f44 6f44 s 	push	hl
6f45 6f45 d cd5a66
6f45 6f45 s 	call	A6645
6f48 6f48 d ca2773
6f48 6f48 s 	jp	z,A7312
6f4b 6f4b d e1
6f4b 6f4b s 	pop	hl
6f4c 6f4c d cde572
6f4c 6f4c s 	call	A72D0
6f4f 6f4f d 41
6f4f 6f4f s 	defb	"A"
6f50 6f50 d cde572
6f50 6f50 s 	call	A72D0
6f53 6f53 d 53
6f53 6f53 s 	defb	"S"
6f54 6f54 d cdab6f
6f54 6f54 s 	call	A6F96
6f57 6f57 d 7a
6f57 6f57 s 	ld	a,d
6f58 6f58 d 3278f5
6f58 6f58 s 	ld	(BUF+26),a
6f5b 6f5b d e5
6f5b 6f5b s 	push	hl
6f5c 6f5c d 2a68f5
6f5c 6f5c s 	ld	hl,(BUF+10)
6f5f 6f5f d a7
6f5f 6f5f s 	and	a
6f60 6f60 d 2804
6f60 6f60 s 	jr	z,A6F51
6f62 6f62 d bd
6f62 6f62 s 	cp	l
6f63 6f63 d c2cc71
6f63 6f63 s 	jp	nz,A71B7
6f66 6f66 d 1179f5
6f66 6f66 s A6F51:	ld	de,BUF+27
6f69 6f69 d cd6f66
6f69 6f69 s 	call	A665A
6f6c 6f6c d 1168f5
6f6c 6f6c s 	ld	de,BUF+10
6f6f 6f6f d cd9243
6f6f 6f6f s 	call	A4392			; rename file
6f72 6f72 d a7
6f72 6f72 s 	and	a
6f73 6f73 d c2ba71
6f73 6f73 s 	jp	nz,A71A5
6f76 6f76 d e1
6f76 6f76 s 	pop	hl
6f77 6f77 d c9
6f77 6f77 s 	ret
6f78 6f78 s ;
6f78 6f78 d cdf865
6f78 6f78 s A6F63:	call	A65E3
6f7b 6f7b d 3c
6f7b 6f7b s 	inc	a
6f7c 6f7c d 3268f5
6f7c 6f7c s 	ld	(BUF+10),a
6f7f 6f7f d e5
6f7f 6f7f s 	push	hl
6f80 6f80 d d5
6f80 6f80 s 	push	de
6f81 6f81 d cd6c66
6f81 6f81 s 	call	A6657
6f84 6f84 d d1
6f84 6f84 s 	pop	de
6f85 6f85 d e1
6f85 6f85 s 	pop	hl
6f86 6f86 d c9
6f86 6f86 s 	ret
6f87 6f87 s ;
6f87 6f87 d dd210e6a
6f87 6f87 s A6F72:	ld	ix,EVFSPC
6f8b 6f8b d cd3373
6f8b 6f8b s 	call	A731E
6f8e 6f8e d 7a
6f8e 6f8e s 	ld	a,d
6f8f 6f8f d fe09
6f8f 6f8f s 	cp	009H
6f91 6f91 d d8
6f91 6f91 s 	ret	c
6f92 6f92 d c3b171
6f92 6f92 s 	jp	A719C
6f95 6f95 s ;
6f95 6f95 d cd876f
6f95 6f95 s A6F80:	call	A6F72
6f98 6f98 d e5
6f98 6f98 s 	push	hl
6f99 6f99 d 2166f8
6f99 6f99 s 	ld	hl,FILNAM
6f9c 6f9c d 060b
6f9c 6f9c s 	ld	b,00BH
6f9e 6f9e d 7e
6f9e 6f9e s A6F89:	ld	a,(hl)
6f9f 6f9f d 23
6f9f 6f9f s 	inc	hl
6fa0 6fa0 d fe20
6fa0 6fa0 s 	cp	" "
6fa2 6fa2 d 200b
6fa2 6fa2 s 	jr	nz,A6F9A
6fa4 6fa4 d 10f8
6fa4 6fa4 s 	djnz	A6F89
6fa6 6fa6 d cd1370
6fa6 6fa6 s 	call	A6FFE
6fa9 6fa9 d 1804
6fa9 6fa9 s 	jr	A6F9A
6fab 6fab s ;
6fab 6fab d cd876f
6fab 6fab s A6F96:	call	A6F72
6fae 6fae d e5
6fae 6fae s 	push	hl
6faf 6faf d 2166f8
6faf 6faf s A6F9A:	ld	hl,FILNAM
6fb2 6fb2 d 0608
6fb2 6fb2 s 	ld	b,008H
6fb4 6fb4 d cd0a70
6fb4 6fb4 s 	call	A6FF5
6fb7 6fb7 d 0603
6fb7 6fb7 s 	ld	b,003H
6fb9 6fb9 d cd0a70
6fb9 6fb9 s 	call	A6FF5
6fbc 6fbc d e1
6fbc 6fbc s 	pop	hl
6fbd 6fbd d f6
6fbd 6fbd s 	defb	0F6H
6fbe 6fbe d 37
6fbe 6fbe s A6FA9:	scf
6fbf 6fbf d d5
6fbf 6fbf s 	push	de
6fc0 6fc0 d e5
6fc0 6fc0 s 	push	hl
6fc1 6fc1 d 1166f8
6fc1 6fc1 s 	ld	de,FILNAM
6fc4 6fc4 d d5
6fc4 6fc4 s 	push	de
6fc5 6fc5 d 060b
6fc5 6fc5 s 	ld	b,11
6fc7 6fc7 d c5
6fc7 6fc7 s A6FB2:	push	bc
6fc8 6fc8 d 1a
6fc8 6fc8 s 	ld	a,(de)
6fc9 6fc9 d 21e16f
6fc9 6fc9 s 	ld	hl,T6FCC
6fcc 6fcc d 010d00
6fcc 6fcc s 	ld	bc,0000DH
6fcf 6fcf d 3801
6fcf 6fcf s 	jr	c,A6FBD
6fd1 6fd1 d 0b
6fd1 6fd1 s 	dec	bc
6fd2 6fd2 d edb1
6fd2 6fd2 s A6FBD:	cpir
6fd4 6fd4 d 2831
6fd4 6fd4 s 	jr	z,A6FF2
6fd6 6fd6 d c1
6fd6 6fd6 s 	pop	bc
6fd7 6fd7 d 13
6fd7 6fd7 s 	inc	de
6fd8 6fd8 d 10ed
6fd8 6fd8 s 	djnz	A6FB2
6fda 6fda d e1
6fda 6fda s 	pop	hl
6fdb 6fdb d cdee6f
6fdb 6fdb s 	call	A6FD9
6fde 6fde d e1
6fde 6fde s 	pop	hl
6fdf 6fdf d d1
6fdf 6fdf s 	pop	de
6fe0 6fe0 d c9
6fe0 6fe0 s 	ret
6fe1 6fe1 s ;
6fe1 6fe1 s ;
6fe1 6fe1 d 2e222f5c5b5d3a2b3d3b2c2a3f
6fe1 6fe1 s T6FCC:	defb	'."/\[]:+=;,*?'
6fee 6fee s 
6fee 6fee d 3e20
6fee 6fee s A6FD9:	ld	a," "
6ff0 6ff0 d be
6ff0 6ff0 s 	cp	(hl)
6ff1 6ff1 d 2814
6ff1 6ff1 s 	jr	z,A6FF2
6ff3 6ff3 d 0607
6ff3 6ff3 s 	ld	b,007H
6ff5 6ff5 d cdfa6f
6ff5 6ff5 s 	call	A6FE5
6ff8 6ff8 d 0603
6ff8 6ff8 s 	ld	b,003H
6ffa 6ffa d 23
6ffa 6ffa s A6FE5:	inc	hl
6ffb 6ffb d be
6ffb 6ffb s 	cp	(hl)
6ffc 6ffc d 2803
6ffc 6ffc s 	jr	z,A6FEC
6ffe 6ffe d 10fa
6ffe 6ffe s 	djnz	A6FE5
7000 7000 d c9
7000 7000 s 	ret
7001 7001 s ;
7001 7001 d 05
7001 7001 s A6FEC:	dec	b
7002 7002 d c8
7002 7002 s 	ret	z
7003 7003 d 23
7003 7003 s 	inc	hl
7004 7004 d be
7004 7004 s 	cp	(hl)
7005 7005 d 28fa
7005 7005 s 	jr	z,A6FEC
7007 7007 d c32473
7007 7007 s A6FF2:	jp	A730F
700a 700a s ;
700a 700a d 7e
700a 700a s A6FF5:	ld	a,(hl)
700b 700b d fe2a
700b 700b s 	cp	"*"
700d 700d d 2809
700d 700d s 	jr	z,A7003
700f 700f d 23
700f 700f s 	inc	hl
7010 7010 d 10f8
7010 7010 s 	djnz	A6FF5
7012 7012 d c9
7012 7012 s 	ret
7013 7013 s ;
7013 7013 d 2166f8
7013 7013 s A6FFE:	ld	hl,FILNAM
7016 7016 d 060b
7016 7016 s 	ld	b,00BH
7018 7018 d 363f
7018 7018 s A7003:	ld	(hl),"?"
701a 701a d 23
701a 701a s 	inc	hl
701b 701b d 10fb
701b 701b s 	djnz	A7003
701d 701d d c9
701d 701d s 	ret
701e 701e s ;
701e 701e s ;
701e 701e d 011000
701e 701e s A7009:	ld	bc,00010H
7021 7021 d 11
7021 7021 s 	defb	011H
7022 7022 d 012100
7022 7022 s A700D:	ld	bc,00021H
7025 7025 d cd9573
7025 7025 s 	call	A7380
7028 7028 d c5
7028 7028 s 	push	bc
7029 7029 d dd211f52
7029 7029 s 	ld	ix,CNVBYT
702d 702d d cd3373
702d 702d s 	call	A731E
7030 7030 d dd216d6a
7030 7030 s 	ld	ix,GTCHNP
7034 7034 d cd3373
7034 7034 s 	call	A731E
7037 7037 d da2a73
7037 7037 s 	jp	c,A7315
703a 703a d ca1573
703a 703a s 	jp	z,A7300
703d 703d d c1
703d 703d s 	pop	bc
703e 703e d 23
703e 703e s 	inc	hl
703f 703f d 5e
703f 703f s 	ld	e,(hl)
7040 7040 d 23
7040 7040 s 	inc	hl
7041 7041 d 56
7041 7041 s 	ld	d,(hl)
7042 7042 d eb
7042 7042 s 	ex	de,hl
7043 7043 d 09
7043 7043 s 	add	hl,bc
7044 7044 d 4e
7044 7044 s 	ld	c,(hl)
7045 7045 d 23
7045 7045 s 	inc	hl
7046 7046 d 46
7046 7046 s 	ld	b,(hl)
7047 7047 d 23
7047 7047 s 	inc	hl
7048 7048 d 5e
7048 7048 s 	ld	e,(hl)
7049 7049 d 23
7049 7049 s 	inc	hl
704a 704a d 56
704a 704a s 	ld	d,(hl)
704b 704b d eb
704b 704b s 	ex	de,hl
704c 704c d c5
704c 704c s 	push	bc
704d 704d d dd21ff46
704d 704d s 	ld	ix,CSNG
7051 7051 d cd3373
7051 7051 s 	call	A731E
7054 7054 d 014565
7054 7054 s 	ld	bc,06545H
7057 7057 d 115360
7057 7057 s 	ld	de,06053H
705a 705a d cd5c32
705a 705a s 	call	M.325C
705d 705d d 21f6f7
705d 705d s 	ld	hl,DAC
7060 7060 d 1147f8
7060 7060 s 	ld	de,ARG
7063 7063 d 010800
7063 7063 s 	ld	bc,00008H
7066 7066 d edb0
7066 7066 s 	ldir
7068 7068 d e1
7068 7068 s 	pop	hl
7069 7069 d dd21ff46
7069 7069 s 	ld	ix,CSNG
706d 706d d cd3373
706d 706d s 	call	A731E
7070 7070 d cd4230
7070 7070 s 	call	M.3042
7073 7073 d c39a26
7073 7073 s 	jp	DECADD
7076 7076 s ;
7076 7076 s ;
7076 7076 d cd9573
7076 7076 s A7061:	call	A7380
7079 7079 d dd211f52
7079 7079 s 	ld	ix,CNVBYT
707d 707d d cd3373
707d 707d s 	call	A731E
7080 7080 d 2147f3
7080 7080 s 	ld	hl,YF347
7083 7083 d be
7083 7083 s 	cp	(hl)
7084 7084 d 2803
7084 7084 s 	jr	z,A7074
7086 7086 d d2b171
7086 7086 s 	jp	nc,A719C
7089 7089 d 5f
7089 7089 s A7074:	ld	e,a
708a 708a d cd5d50
708a 708a s 	call	A505D
708d 708d d c3992f
708d 708d s 	jp	M.2F99
7090 7090 s ;
7090 7090 s ;
7090 7090 d cd9573
7090 7090 s A707B:	call	A7380
7093 7093 d cd956f
7093 7093 s 	call	A6F80
7096 7096 d cdff65
7096 7096 s 	call	A65EA			; is file already open in one of the I/O channels ?
7099 7099 d cab771
7099 7099 s 	jp	z,A71A2
709c 709c d cd786f
709c 709c s 	call	A6F63
709f 709f d e5
709f 709f s 	push	hl
70a0 70a0 d 3a47f2
70a0 70a0 s 	ld	a,(YF247)
70a3 70a3 d 3c
70a3 70a3 s 	inc	a
70a4 70a4 d 328df5
70a4 70a4 s 	ld	(BUF+47),a
70a7 70a7 d 2169f5
70a7 70a7 s 	ld	hl,BUF+11
70aa 70aa d 118ef5
70aa 70aa s 	ld	de,BUF+48
70ad 70ad d 012400
70ad 70ad s 	ld	bc,00024H
70b0 70b0 d edb0
70b0 70b0 s 	ldir
70b2 70b2 d e1
70b2 70b2 s 	pop	hl
70b3 70b3 d cdef72
70b3 70b3 s 	call	A72DA
70b6 70b6 d 2820
70b6 70b6 s 	jr	z,A70C3
70b8 70b8 d cde572
70b8 70b8 s 	call	A72D0
70bb 70bb d d9
70bb 70bb s 	defb	0D9H
70bc 70bc d cd956f
70bc 70bc s 	call	A6F80
70bf 70bf d cdff65
70bf 70bf s 	call	A65EA			; is file already open in one of the I/O channels ?
70c2 70c2 d cab771
70c2 70c2 s 	jp	z,A71A2
70c5 70c5 d cdf865
70c5 70c5 s 	call	A65E3
70c8 70c8 d 3c
70c8 70c8 s 	inc	a
70c9 70c9 d 328df5
70c9 70c9 s 	ld	(BUF+47),a
70cc 70cc d e5
70cc 70cc s 	push	hl
70cd 70cd d 118ef5
70cd 70cd s 	ld	de,BUF+48
70d0 70d0 d cd6f66
70d0 70d0 s 	call	A665A
70d3 70d3 d e1
70d3 70d3 s 	pop	hl
70d4 70d4 d cdef72
70d4 70d4 s 	call	A72DA
70d7 70d7 d c0
70d7 70d7 s 	ret	nz
70d8 70d8 d e5
70d8 70d8 s A70C3:	push	hl
70d9 70d9 d cd5a66
70d9 70d9 s 	call	A6645
70dc 70dc d ca2773
70dc 70dc s 	jp	z,A7312
70df 70df d cdbd00
70df 70df s A70CA:	call	CKCNTC
70e2 70e2 d 018df5
70e2 70e2 s 	ld	bc,BUF+47
70e5 70e5 d 11d7f5
70e5 70e5 s 	ld	de,BUF+121
70e8 70e8 d 21b2f5
70e8 70e8 s 	ld	hl,BUF+84
70eb 70eb d 3e0c
70eb 70eb s 	ld	a,00CH
70ed 70ed d f5
70ed 70ed s A70D8:	push	af
70ee 70ee d 0a
70ee 70ee s 	ld	a,(bc)
70ef 70ef d fe3f
70ef 70ef s 	cp	"?"
70f1 70f1 d 2001
70f1 70f1 s 	jr	nz,A70DF
70f3 70f3 d 7e
70f3 70f3 s 	ld	a,(hl)
70f4 70f4 d 12
70f4 70f4 s A70DF:	ld	(de),a
70f5 70f5 d 03
70f5 70f5 s 	inc	bc
70f6 70f6 d 13
70f6 70f6 s 	inc	de
70f7 70f7 d 23
70f7 70f7 s 	inc	hl
70f8 70f8 d f1
70f8 70f8 s 	pop	af
70f9 70f9 d 3d
70f9 70f9 s 	dec	a
70fa 70fa d 20f1
70fa 70fa s 	jr	nz,A70D8
70fc 70fc d 21b2f5
70fc 70fc s 	ld	hl,BUF+84
70ff 70ff d 11d7f5
70ff 70ff s 	ld	de,BUF+121
7102 7102 d 060c
7102 7102 s 	ld	b,00CH
7104 7104 d 1a
7104 7104 s A70EF:	ld	a,(de)
7105 7105 d be
7105 7105 s 	cp	(hl)
7106 7106 d 2007
7106 7106 s 	jr	nz,A70FA
7108 7108 d 23
7108 7108 s 	inc	hl
7109 7109 d 13
7109 7109 s 	inc	de
710a 710a d 10f8
710a 710a s 	djnz	A70EF
710c 710c d c32a73
710c 710c s 	jp	A7315
710f 710f s ;
710f 710f d cd8171
710f 710f s A70FA:	call	A716C
7112 7112 d e5
7112 7112 s 	push	hl
7113 7113 d af
7113 7113 s 	xor	a
7114 7114 d 32bef5
7114 7114 s 	ld	(BUF+96),a
7117 7117 d 11b2f5
7117 7117 s 	ld	de,BUF+84
711a 711a d cd6244
711a 711a s 	call	A4462			; open fcb
711d 711d d 11d7f5
711d 711d s 	ld	de,BUF+121
7120 7120 d cd1d46
7120 7120 s 	call	A461D			; create file
7123 7123 d a7
7123 7123 s 	and	a
7124 7124 d c2c071
7124 7124 s 	jp	nz,A71AB
7127 7127 d 6f
7127 7127 s 	ld	l,a
7128 7128 d 67
7128 7128 s 	ld	h,a
7129 7129 d 22d3f5
7129 7129 s 	ld	(BUF+117),hl
712c 712c d 22d5f5
712c 712c s 	ld	(BUF+119),hl
712f 712f d 22f8f5
712f 712f s 	ld	(BUF+154),hl
7132 7132 d 22faf5
7132 7132 s 	ld	(BUF+156),hl
7135 7135 d 23
7135 7135 s 	inc	hl
7136 7136 d 22c0f5
7136 7136 s 	ld	(BUF+98),hl
7139 7139 d 22e5f5
7139 7139 s 	ld	(BUF+135),hl
713c 713c d e1
713c 713c s 	pop	hl
713d 713d d e5
713d 713d s A7128:	push	hl
713e 713e d 11b2f5
713e 713e s 	ld	de,BUF+84
7141 7141 d cdb247
7141 7141 s 	call	A47B2			; random block read
7144 7144 d 7d
7144 7144 s 	ld	a,l
7145 7145 d b4
7145 7145 s 	or	h
7146 7146 d 2809
7146 7146 s 	jr	z,A713C
7148 7148 d 11d7f5
7148 7148 s 	ld	de,BUF+121
714b 714b d cda471
714b 714b s 	call	A718F			; random block write
714e 714e d e1
714e 714e s 	pop	hl
714f 714f d 18ec
714f 714f s 	jr	A7128
7151 7151 s ;
7151 7151 d e1
7151 7151 s A713C:	pop	hl
7152 7152 d 2ac6f5
7152 7152 s 	ld	hl,(BUF+104)
7155 7155 d 22ebf5
7155 7155 s 	ld	(BUF+141),hl
7158 7158 d 2ac8f5
7158 7158 s 	ld	hl,(BUF+106)
715b 715b d 22edf5
715b 715b s 	ld	(BUF+143),hl
715e 715e d 11d7f5
715e 715e s 	ld	de,BUF+121
7161 7161 d cd6f45
7161 7161 s 	call	A456F			; close fcb
7164 7164 d 21b2f5
7164 7164 s 	ld	hl,BUF+84
7167 7167 d 223df2
7167 7167 s 	ld	(YF23D),hl		; transferadres
716a 716a d 1168f5
716a 716a s 	ld	de,BUF+10
716d 716d d af
716d 716d s 	xor	a
716e 716e d 3274f5
716e 716e s 	ld	(BUF+22),a
7171 7171 d cd0650
7171 7171 s 	call	A5006			; search for next
7174 7174 d 3c
7174 7174 s 	inc	a
7175 7175 d c2df70
7175 7175 s 	jp	nz,A70CA
7178 7178 d e1
7178 7178 s 	pop	hl
7179 7179 d c9
7179 7179 s 	ret
717a 717a s ;
717a 717a d 22bffc
717a 717a s A7165:	ld	(SAVENT),hl
717d 717d d ed437df8
717d 717d s 	ld	(SAVEND),bc
7181 7181 d 2100fe
7181 7181 s A716C:	ld	hl,0FE00H
7184 7184 d 39
7184 7184 s 	add	hl,sp
7185 7185 d 300d
7185 7185 s 	jr	nc,A717F
7187 7187 d ed5bc6f6
7187 7187 s 	ld	de,(STREND)
718b 718b d a7
718b 718b s 	and	a
718c 718c d ed52
718c 718c s 	sbc	hl,de
718e 718e d 3804
718e 718e s 	jr	c,A717F
7190 7190 d 7c
7190 7190 s 	ld	a,h
7191 7191 d a7
7191 7191 s 	and	a
7192 7192 d 2007
7192 7192 s 	jr	nz,A7186
7194 7194 d ed5b62f8
7194 7194 s A717F:	ld	de,(NULBUF)
7198 7198 d 210001
7198 7198 s 	ld	hl,00100H
719b 719b d ed533df2
719b 719b s A7186:	ld	(YF23D),de		; transferadres
719f 719f d c9
719f 719f s 	ret
71a0 71a0 s ;
71a0 71a0 d ed5b53f3
71a0 71a0 s A718B:	ld	de,(YF353)
71a4 71a4 d cdbe47
71a4 71a4 s A718F:	call	A47BE			; random block write
71a7 71a7 d a7
71a7 71a7 s 	and	a
71a8 71a8 d c8
71a8 71a8 s 	ret	z
71a9 71a9 d 1812
71a9 71a9 s 	jr	A71A8
71ab 71ab s ;
71ab 71ab d 1e3c
71ab 71ab s A7196:	ld	e,03CH
71ad 71ad d 01
71ad 71ad s 	defb	001H
71ae 71ae d 1e3d
71ae 71ae s A7199:	ld	e,03DH
71b0 71b0 d 01
71b0 71b0 s 	defb	001H
71b1 71b1 d 1e3e
71b1 71b1 s A719C:	ld	e,03EH
71b3 71b3 d 01
71b3 71b3 s 	defb	001H
71b4 71b4 d 1e3f
71b4 71b4 s 	ld	e,03FH
71b6 71b6 d 01
71b6 71b6 s 	defb	001H
71b7 71b7 d 1e40
71b7 71b7 s A71A2:	ld	e,040H
71b9 71b9 d 01
71b9 71b9 s 	defb	001H
71ba 71ba d 1e41
71ba 71ba s A71A5:	ld	e,041H
71bc 71bc d 01
71bc 71bc s 	defb	001H
71bd 71bd d 1e42
71bd 71bd s A71A8:	ld	e,042H
71bf 71bf d 01
71bf 71bf s 	defb	001H
71c0 71c0 d 1e43
71c0 71c0 s A71AB:	ld	e,043H
71c2 71c2 d 01
71c2 71c2 s 	defb	001H
71c3 71c3 d 1e44
71c3 71c3 s A71AE:	ld	e,044H
71c5 71c5 d 01
71c5 71c5 s 	defb	001H
71c6 71c6 d 1e45
71c6 71c6 s A71B1:	ld	e,045H
71c8 71c8 d 01
71c8 71c8 s 	defb	001H
71c9 71c9 d 1e46
71c9 71c9 s A71B4:	ld	e,046H
71cb 71cb d 01
71cb 71cb s 	defb	001H
71cc 71cc d 1e47
71cc 71cc s A71B7:	ld	e,047H
71ce 71ce d 010000
71ce 71ce s 	ld	bc,00000H
71d1 71d1 d af
71d1 71d1 s 	xor	a
71d2 71d2 d 327cf8
71d2 71d2 s 	ld	(NLONLY),a
71d5 71d5 d 32aefc
71d5 71d5 s 	ld	(FLBMEM),a
71d8 71d8 d d5
71d8 71d8 s 	push	de
71d9 71d9 d dd21246b
71d9 71d9 s 	ld	ix,CLOCHN
71dd 71dd d cd3373
71dd 71dd s 	call	A731E
71e0 71e0 d d1
71e0 71e0 s 	pop	de
71e1 71e1 d dd216f40
71e1 71e1 s 	ld	ix,ERROR
71e5 71e5 d c33373
71e5 71e5 s 	jp	A731E
71e8 71e8 s ;
71e8 71e8 s ;
71e8 71e8 d 7b
71e8 71e8 s A71D3:	ld	a,e
71e9 71e9 d fe3c
71e9 71e9 s 	cp	03CH
71eb 71eb d d8
71eb 71eb s 	ret	c
71ec 71ec d fe48
71ec 71ec s 	cp	048H
71ee 71ee d d0
71ee 71ee s 	ret	nc
71ef 71ef d d63b
71ef 71ef s 	sub	03BH
71f1 71f1 d 47
71f1 71f1 s 	ld	b,a
71f2 71f2 d 210a72
71f2 71f2 s 	ld	hl,T71F5
71f5 71f5 d 7e
71f5 71f5 s A71E0:	ld	a,(hl)
71f6 71f6 d a7
71f6 71f6 s 	and	a
71f7 71f7 d 23
71f7 71f7 s 	inc	hl
71f8 71f8 d 20fb
71f8 71f8 s 	jr	nz,A71E0
71fa 71fa d 10f9
71fa 71fa s 	djnz	A71E0
71fc 71fc d 2b
71fc 71fc s 	dec	hl
71fd 71fd d 1104f6
71fd 71fd s 	ld	de,BUF+166
7200 7200 d d5
7200 7200 s 	push	de
7201 7201 d 011600
7201 7201 s 	ld	bc,00016H
7204 7204 d edb0
7204 7204 s 	ldir
7206 7206 d 1e01
7206 7206 s 	ld	e,001H
7208 7208 d e1
7208 7208 s 	pop	hl
7209 7209 d c9
7209 7209 s 	ret
720a 720a s ;
720a 720a s ;
720a 720a d 00
720a 720a s T71F5:	defb	0
720b 720b d 4261642046415400
720b 720b s 	defb	"Bad FAT",0
7213 7213 d 4261642066696c65206d6f646500
7213 7213 s 	defb	"Bad file mode",0
7221 7221 d 426164206472697665206e616d6500
7221 7221 s 	defb	"Bad drive name",0
7230 7230 d 42616420736563746f72206e756d62657200
7230 7230 s 	defb	"Bad sector number",0
7242 7242 d 46696c65207374696c6c206f70656e00
7242 7242 s 	defb	"File still open",0
7252 7252 d 46696c6520616c72656164792065786973747300
7252 7252 s 	defb	"File already exists",0
7266 7266 d 4469736b2066756c6c00
7266 7266 s 	defb	"Disk full",0
7270 7270 d 546f6f206d616e792066696c657300
7270 7270 s 	defb	"Too many files",0
727f 727f d 4469736b2077726974652070726f74656374656400
727f 727f s 	defb	"Disk write protected",0
7294 7294 d 4469736b20492f4f206572726f7200
7294 7294 s 	defb	"Disk I/O error",0
72a3 72a3 d 4469736b206f66666c696e6500
72a3 72a3 s 	defb	"Disk offline",0
72b0 72b0 d 52656e616d65206163726f7373206469736b00
72b0 72b0 s 	defb	"Rename across disk",0
72c3 72c3 s 
72c3 72c3 d c572
72c3 72c3 s T72AE:	defw	A72B0
72c5 72c5 s 
72c5 72c5 d cb79
72c5 72c5 s A72B0:	bit	7,c
72c7 72c7 d c2ab71
72c7 72c7 s 	jp	nz,A7196
72ca 72ca d cb81
72ca 72ca s 	res	0,c
72cc 72cc d 0600
72cc 72cc s 	ld	b,000H
72ce 72ce d 21d772
72ce 72ce s 	ld	hl,T72C2
72d1 72d1 d 09
72d1 72d1 s 	add	hl,bc
72d2 72d2 d 7e
72d2 72d2 s A72BD:	ld	a,(hl)
72d3 72d3 d 23
72d3 72d3 s 	inc	hl
72d4 72d4 d 66
72d4 72d4 s 	ld	h,(hl)
72d5 72d5 d 6f
72d5 72d5 s 	ld	l,a
72d6 72d6 d e9
72d6 72d6 s 	jp	(hl)
72d7 72d7 s ;
72d7 72d7 s ;
72d7 72d7 d c371
72d7 72d7 s T72C2:	defw	A71AE
72d9 72d9 d c971
72d9 72d9 s 	defw	A71B4
72db 72db d c671
72db 72db s 	defw	A71B1
72dd 72dd d c671
72dd 72dd s 	defw	A71B1
72df 72df d c671
72df 72df s 	defw	A71B1
72e1 72e1 d c671
72e1 72e1 s 	defw	A71B1
72e3 72e3 d c671
72e3 72e3 s 	defw	A71B1
72e5 72e5 s 
72e5 72e5 d cdef72
72e5 72e5 s A72D0:	call	A72DA
72e8 72e8 d e3
72e8 72e8 s 	ex	(sp),hl
72e9 72e9 d be
72e9 72e9 s 	cp	(hl)
72ea 72ea d 2041
72ea 72ea s 	jr	nz,A7318
72ec 72ec d 23
72ec 72ec s 	inc	hl
72ed 72ed d e3
72ed 72ed s 	ex	(sp),hl
72ee 72ee d 23
72ee 72ee s 	inc	hl
72ef 72ef d 2b
72ef 72ef s A72DA:	dec	hl
72f0 72f0 d dd216646
72f0 72f0 s A72DB:	ld	ix,CHRGTR
72f4 72f4 d 183d
72f4 72f4 s 	jr	A731E
72f6 72f6 s 
72f6 72f6 s ; unused code, patched ??
72f6 72f6 s ;
72f6 72f6 d 00
72f6 72f6 s 	nop
72f7 72f7 d 00
72f7 72f7 s 	nop
72f8 72f8 d 00
72f8 72f8 s 	nop
72f9 72f9 s 
72f9 72f9 d 3ec9
72f9 72f9 s A72E4:	ld	a,0C9H
72fb 72fb d 32d5fe
72fb 72fb s A72E6:	ld	(H.LOPD+0),a
72fe 72fe d ed5b4afc
72fe 72fe s 	ld	de,(HIMEM)
7302 7302 d ed5349f3
7302 7302 s 	ld	(YF349),de
7306 7306 d c9
7306 7306 s 	ret
7307 7307 s 
7307 7307 d f7
7307 7307 s T72F2:	rst	030H
7308 7308 d 00
7308 7308 s 	defb	000H
7309 7309 d f972
7309 7309 s 	defw	A72E4
730b 730b d c9
730b 730b s 	ret
730c 730c s 
730c 730c d 1e10
730c 730c s A72F7:	ld	e,010H
730e 730e d 01
730e 730e s 	defb	001H
730f 730f d 1e0d
730f 730f s A72FA:	ld	e,00DH
7311 7311 d 01
7311 7311 s 	defb	001H
7312 7312 d 1e07
7312 7312 s A72FD:	ld	e,007H
7314 7314 d 01
7314 7314 s 	defb	001H
7315 7315 d 1e3b
7315 7315 s A7300:	ld	e,03BH
7317 7317 d 01
7317 7317 s 	defb	001H
7318 7318 d 1e37
7318 7318 s A7303:	ld	e,037H
731a 731a d 01
731a 731a s 	defb	001H
731b 731b d 1e32
731b 731b s A7306:	ld	e,032H
731d 731d d 01
731d 731d s 	defb	001H
731e 731e d 1e36
731e 731e s A7309:	ld	e,036H
7320 7320 d 01
7320 7320 s 	defb	001H
7321 7321 d 1e34
7321 7321 s A730C:	ld	e,034H
7323 7323 d 01
7323 7323 s 	defb	001H
7324 7324 d 1e38
7324 7324 s A730F:	ld	e,038H
7326 7326 d 01
7326 7326 s 	defb	001H
7327 7327 d 1e35
7327 7327 s A7312:	ld	e,035H
7329 7329 d 01
7329 7329 s 	defb	001H
732a 732a d 1e05
732a 732a s A7315:	ld	e,005H
732c 732c d 01
732c 732c s 	defb	001H
732d 732d d 1e02
732d 732d s A7318:	ld	e,002H
732f 732f d dd216f40
732f 732f s 	ld	ix,ERROR
7333 7333 d cd5901
7333 7333 s A731E:	call	CALBAS
7336 7336 d fb
7336 7336 s 	ei
7337 7337 d c9
7337 7337 s 	ret
7338 7338 s ;
7338 7338 s ;
7338 7338 d fb
7338 7338 s A7323:	ei
7339 7339 d e5
7339 7339 s 	push	hl
733a 733a d d5
733a 733a s 	push	de
733b 733b d 3a48f3
733b 733b s 	ld	a,(YF348)
733e 733e d 87
733e 733e s 	add	a,a
733f 733f d 211000
733f 733f s 	ld	hl,16
7342 7342 d 3002
7342 7342 s 	jr	nc,A7331
7344 7344 d 2e18
7344 7344 s 	ld	l,16+8
7346 7346 d 39
7346 7346 s A7331:	add	hl,sp
7347 7347 d 5e
7347 7347 s 	ld	e,(hl)
7348 7348 d 23
7348 7348 s 	inc	hl
7349 7349 d 56
7349 7349 s 	ld	d,(hl)
734a 734a d e5
734a 734a s 	push	hl
734b 734b d 21956e
734b 734b s 	ld	hl,CALBSV+3
734e 734e d e7
734e 734e s 	rst	020H
734f 734f d e1
734f 734f s 	pop	hl
7350 7350 d 280d
7350 7350 s 	jr	z,A734A
7352 7352 d e5
7352 7352 s 	push	hl
7353 7353 d 21c96e
7353 7353 s 	ld	hl,CALBLD+3
7356 7356 d e7
7356 7356 s 	rst	020H
7357 7357 d e1
7357 7357 s 	pop	hl
7358 7358 d 200b
7358 7358 s 	jr	nz,A7350
735a 735a d 1177f3
735a 735a s 	ld	de,XF377
735d 735d d 1803
735d 735d s 	jr	A734D
735f 735f s ;
735f 735f d 117af3
735f 735f s A734A:	ld	de,XF37A
7362 7362 d 72
7362 7362 s A734D:	ld	(hl),d
7363 7363 d 2b
7363 7363 s 	dec	hl
7364 7364 d 73
7364 7364 s 	ld	(hl),e
7365 7365 d d1
7365 7365 s A7350:	pop	de
7366 7366 d e1
7366 7366 s 	pop	hl
7367 7367 d 7b
7367 7367 s 	ld	a,e
7368 7368 d fe02
7368 7368 s 	cp	002H
736a 736a d d8
736a 736a s 	ret	c
736b 736b d 7e
736b 736b s 	ld	a,(hl)
736c 736c d fe3a
736c 736c s 	cp	":"
736e 736e d 28b4
736e 736e s 	jr	z,A730F
7370 7370 d 23
7370 7370 s 	inc	hl
7371 7371 d 7e
7371 7371 s 	ld	a,(hl)
7372 7372 d fe3a
7372 7372 s 	cp	":"
7374 7374 d 2b
7374 7374 s 	dec	hl
7375 7375 d c0
7375 7375 s 	ret	nz
7376 7376 d cd9573
7376 7376 s 	call	A7380
7379 7379 d 7e
7379 7379 s 	ld	a,(hl)
737a 737a d e6df
737a 737a s 	and	0DFH
737c 737c d d640
737c 737c s 	sub	040H
737e 737e d e5
737e 737e s 	push	hl
737f 737f d 2147f3
737f 737f s 	ld	hl,YF347
7382 7382 d be
7382 7382 s 	cp	(hl)
7383 7383 d e1
7383 7383 s 	pop	hl
7384 7384 d 2803
7384 7384 s 	jr	z,A7374
7386 7386 d d2b171
7386 7386 s 	jp	nc,A719C
7389 7389 d 23
7389 7389 s A7374:	inc	hl
738a 738a d 23
738a 738a s 	inc	hl
738b 738b d 1d
738b 738b s 	dec	e
738c 738c d 1d
738c 738c s 	dec	e
738d 738d d d5
738d 738d s 	push	de
738e 738e d 1c
738e 738e s 	inc	e
738f 738f d d1
738f 738f s 	pop	de
7390 7390 d c9
7390 7390 s 	ret
7391 7391 s ;
7391 7391 s ;
7391 7391 d fb
7391 7391 s A737C:	ei
7392 7392 d 3e00
7392 7392 s 	ld	a,000H
7394 7394 d c9
7394 7394 s 	ret
7395 7395 s ;
7395 7395 d fb
7395 7395 s A7380:	ei
7396 7396 d e5
7396 7396 s 	push	hl
7397 7397 d f5
7397 7397 s 	push	af
7398 7398 d 3a48f3
7398 7398 s 	ld	a,(YF348)
739b 739b d 87
739b 739b s 	add	a,a
739c 739c d 210c00
739c 739c s 	ld	hl,0000CH
739f 739f d 3002
739f 739f s 	jr	nc,A738E
73a1 73a1 d 2e14
73a1 73a1 s 	ld	l,014H
73a3 73a3 d 39
73a3 73a3 s A738E:	add	hl,sp
73a4 73a4 d 368b
73a4 73a4 s 	ld	(hl),LOW RETRTN
73a6 73a6 d 23
73a6 73a6 s 	inc	hl
73a7 73a7 d 36f3
73a7 73a7 s 	ld	(hl),HIGH RETRTN
73a9 73a9 d f1
73a9 73a9 s 	pop	af
73aa 73aa d e1
73aa 73aa s 	pop	hl
73ab 73ab d c9
73ab 73ab s 	ret
73ac 73ac s 
73ac 73ac s ;	  Subroutine BDOS 09 (output string)
73ac 73ac s ;	     Inputs  DE = adres of string
73ac 73ac s ;	     Outputs ________________________ 
73ac 73ac s ;	     Remark  is copied to 0F1C9H
73ac 73ac s 
73ac 73ac d cd6bf3
73ac 73ac s A7397:	call	XF36B			; enable ram on page 1
73af 73af d 1a
73af 73af s 	ld	a,(de)
73b0 73b0 d cd68f3
73b0 73b0 s 	call	XF368			; enable system diskrom
73b3 73b3 d 13
73b3 73b3 s 	inc	de
73b4 73b4 d fe24
73b4 73b4 s 	cp	'$'
73b6 73b6 d c8
73b6 73b6 s 	ret	z			; end of string, quit
73b7 73b7 d cda853
73b7 73b7 s 	call	A53A8			; console output
73ba 73ba d 18f0
73ba 73ba s 	jr	A7397			; next
73bc 73bc s 
73bc 73bc s ;	  Subroutine XFER (transfer)
73bc 73bc s ;	     Inputs  HL = source adres, DE = destition adres, BC = size
73bc 73bc s ;	     Outputs ________________________ 
73bc 73bc s ;	     Remark  is copied to 0F1D9H
73bc 73bc s 
73bc 73bc d cd6bf3
73bc 73bc s 	call	XF36B			; enable ram on page 1
73bf 73bf d edb0
73bf 73bf s 	ldir				; transfer
73c1 73c1 d cd68f3
73c1 73c1 s 	call	XF368			; enable system diskrom
73c4 73c4 d c9
73c4 73c4 s 	ret
73c5 73c5 s 
73c5 73c5 s ;	  Subroutine Warm Boot
73c5 73c5 s ;	     Inputs  ________________________
73c5 73c5 s ;	     Outputs ________________________ 
73c5 73c5 s ;	     Remark  is copied to 0F1E2H
73c5 73c5 s 
73c5 73c5 d cd6bf3
73c5 73c5 s 	call	XF36B			; enable ram on page 1
73c8 73c8 d c30000
73c8 73c8 s 	jp	0			; WBOOT
73cb 73cb s 
73cb 73cb s ;	  Subroutine start handler in DOS memory
73cb 73cb s ;	     Inputs  HL = adres of pointer
73cb 73cb s ;	     Outputs ________________________ 
73cb 73cb s ;	     Remark  is copied to 0F1E8H
73cb 73cb s 
73cb 73cb d 11def1
73cb 73cb s 	ld	de,XF1D9+5
73ce 73ce d d5
73ce 73ce s 	push	de			; on return, enable system diskrom
73cf 73cf d 5e
73cf 73cf s 	ld	e,(hl)
73d0 73d0 d 23
73d0 73d0 s 	inc	hl
73d1 73d1 d 56
73d1 73d1 s 	ld	d,(hl)			; get pointer
73d2 73d2 d eb
73d2 73d2 s 	ex	de,hl
73d3 73d3 d cd6bf3
73d3 73d3 s 	call	XF36B			; enable ram on page 1
73d6 73d6 d e9
73d6 73d6 s 	jp	(hl)			; start it
73d7 73d7 s 
73d7 73d7 s ;	  Subroutine validate FCB filename
73d7 73d7 s ;	     Inputs  HL = adres of pointer
73d7 73d7 s ;	     Outputs ________________________ 
73d7 73d7 s ;	     Remark  is copied to 0F1F4H
73d7 73d7 s 
73d7 73d7 d c30456
73d7 73d7 s 	jp	A5604
73da 73da s 
73da 73da s ;	  Data       table with reserved filenames (devicenames)
73da 73da s ;
73da 73da s ;	     Remark  is copied to 0F1F7H
73da 73da s 
73da 73da d 50524e20
73da 73da s 	defb	"PRN "
73de 73de d 4c535420
73de 73de s 	defb	"LST "
73e2 73e2 d 4e554c20
73e2 73e2 s 	defb	"NUL "
73e6 73e6 d 41555820
73e6 73e6 s 	defb	"AUX "
73ea 73ea d 434f4e20
73ea 73ea s 	defb	"CON "
73ee 73ee s 
73ee 73ee s ;	  Data       fake direntry for devices
73ee 73ee s ;
73ee 73ee s ;	     Remark  is copied to 0F20BH
73ee 73ee s 
73ee 73ee d 2020202020202020202020
73ee 73ee s 	defb	"           "
73f9 73f9 d 80
73f9 73f9 s 	defb	10000000b
73fa 73fa s 	defs	10
7404 7404 d 0000
7404 7404 s 	defw	0
7406 7406 d 0000
7406 7406 s 	defw	0
7408 7408 d 0000
7408 7408 s 	defw	0
740a 740a d 00000000
740a 740a s 	defw	0,0
740e 740e s 
740e 740e d 1f1c1f1e1f1e1f1f1e1f1e1f
740e 740e s 	defb	31,28,31,30,31,30,31,31,30,31,30,31
741a 741a s 
741a 741a s DSKDRV:
741a 741a s 
741a 741a s 	INCLUDE	msxpi-driver.mac
741a 741a f msxpi-driver.mac
741a 741a s ;|===========================================================================|
741a 741a s ;|                                                                           |
741a 741a s ;| MSXPi Interface                                                           |
741a 741a s ;|                                                                           |
741a 741a s ;| Version : 0.8.1                                                           |
741a 741a s ;|                                                                           |
741a 741a s ;| Copyright (c) 2015-2016 Ronivon Candido Costa (ronivon@outlook.com)       |
741a 741a s ;|                                                                           |
741a 741a s ;| All rights reserved                                                       |
741a 741a s ;|                                                                           |
741a 741a s ;| Redistribution and use in source and compiled forms, with or without      |
741a 741a s ;| modification, are permitted under GPL license.                            |
741a 741a s ;|                                                                           |
741a 741a s ;|===========================================================================|
741a 741a s ;|                                                                           |
741a 741a s ;| This file is part of MSXPi Interface project.                             |
741a 741a s ;|                                                                           |
741a 741a s ;| MSX PI Interface is free software: you can redistribute it and/or modify  |
741a 741a s ;| it under the terms of the GNU General Public License as published by      |
741a 741a s ;| the Free Software Foundation, either version 3 of the License, or         |
741a 741a s ;| (at your option) any later version.                                       |
741a 741a s ;|                                                                           |
741a 741a s ;| MSX PI Interface is distributed in the hope that it will be useful,       |
741a 741a s ;| but WITHOUT ANY WARRANTY; without even the implied warranty of            |
741a 741a s ;| MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             |
741a 741a s ;| GNU General Public License for more details.                              |
741a 741a s ;|                                                                           |
741a 741a s ;| You should have received a copy of the GNU General Public License         |
741a 741a s ;| along with MSX PI Interface.  If not, see <http://www.gnu.org/licenses/>. |
741a 741a s ;|===========================================================================|
741a 741a s ;
741a 741a s ; MSXPi Driver v0.8.1 (2017,2018)
741a 741a s 
741a 741a s TEXTTERMINATOR EQU 0
741a 741a s BDOS           EQU 5
741a 741a s BUSYretRIES    EQU 2
741a 741a s CONTROL_PORT   EQU $06
741a 741a s DATA_PORT      EQU $07
741a 741a s RESET          EQU $FF
741a 741a s 
741a 741a s STARTTRANSFER  EQU $A0
741a 741a s SENDNEXT       EQU $A1
741a 741a s ENDOFTRANSFER  EQU $A2
741a 741a s READY          EQU $AA
741a 741a s ABORT          EQU $AD
741a 741a s BUSY           EQU $AE
741a 741a s 
741a 741a s RC_SUCCESS     EQU $E0
741a 741a s RC_CRCERROR    EQU $E2
741a 741a s RC_OUTOFSYNC   EQU $E5
741a 741a s 
741a 741a s CALBAS	EQU     0159H
741a 741a s CHRGTR  EQU     04666H
741a 741a s CHPUT   EQU     0A2H
741a 741a s D.F34D	EQU     0F34DH
741a 741a s 
741a 741a s ; symbols which can be used from the kernel
741a 741a s 
741a 741a s ; errorcodes used by DSKIO, DSKCHG and GETDPB
741a 741a s ;
741a 741a s ; 0	write protect error
741a 741a s ; 2	not ready error
741a 741a s ; 4	data (crc) error
741a 741a s ; 6	seek error
741a 741a s ; 8	record not found error
741a 741a s ; 10	write fault error
741a 741a s ; 12	other error
741a 741a s 
741a 741a s ; errorcodes used by DSKFMT
741a 741a s ;
741a 741a s ; 0	write protect error
741a 741a s ; 2	not ready error
741a 741a s ; 4	data (crc) error
741a 741a s ; 6	seek error
741a 741a s ; 8	record not found error
741a 741a s ; 10	write fault error
741a 741a s ; 12	bad parameter
741a 741a s ; 14	insufficient memory
741a 741a s ; 16	other error
741a 741a s 
741a 741a s MYSIZE		equ	1		; Size of environment
741a 741a s SECLEN		equ	512		; Size of biggest sector
741a 741a s 
741a 741a s ; INIHRD
741a 741a s ;
741a 741a s ; Input:	None
741a 741a s ; Output:	None
741a 741a s ; Changed:	af,bc,de,hl,IX,IY may be affected
741a 741a s 
741a 741a s ; Remark: This i called twice. I distinguish the 1st and 2nd verifyig reggister A.
741a 741a s ; A = #40 in first call, and #80 in second all.
741a 741a s INIHRD:
741a 741a d 3e80
741a 741a s         ld      a,$80
741c 741c d bc
741c 741c s         cp      h
741d 741d d c8
741d 741d s         ret     z
741e 741e d 21cf76
741e 741e s         ld      hl,MSXPIVERSION
7421 7421 d cdaf79
7421 7421 s         call    PRINT
7424 7424 d 219677
7424 7424 s         ld      hl,PIWAITMSG
7427 7427 d cdaf79
7427 7427 s         call    PRINT
742a 742a d cd6274
742a 742a s         call    PI_WAITBOOT
742d 742d d d8
742d 742d s 		ret     c
742e 742e s 
742e 742e s ; Always initialize all disk drives
742e 742e s ; Actually, call INIHRD 4 times, but this version only implements 2 drives
742e 742e s ; This limitation is set in the Server App. Settig to more drives causes some MSX to hang.
742e 742e d af
742e 742e s 		xor 	a
742f 742f d cdfa74
742f 742f s 		call	DSKIO_SECTINFO
7432 7432 d cd5874
7432 7432 s 		call	INIHRD_PI
7435 7435 s ; Now check if user want a single drive (CTRL pressed)
7435 7435 d cdbe76
7435 7435 s 		call    CHECK_CTRL
7438 7438 d d8
7438 7438 s 		ret     c
7439 7439 s 
7439 7439 s ; Initialize all drives
7439 7439 d 3e01
7439 7439 s 		ld      a,1
743b 743b d cdfa74
743b 743b s 		call	DSKIO_SECTINFO
743e 743e d cd5874
743e 743e s 		call	INIHRD_PI
7441 7441 d 3e02
7441 7441 s 		ld      a,2
7443 7443 d cdfa74
7443 7443 s 		call	DSKIO_SECTINFO
7446 7446 d cd5874
7446 7446 s 		call	INIHRD_PI
7449 7449 d 3e03
7449 7449 s         ld      a,3
744b 744b d cdfa74
744b 744b s 		call	DSKIO_SECTINFO
744e 744e d cd5874
744e 744e s 		call	INIHRD_PI
7451 7451 d c9
7451 7451 s         ret
7452 7452 s 
7452 7452 d 494e49485244
7452 7452 s INIHRDMSG: DB "INIHRD"	
7458 7458 s INIHRD_PI:
7458 7458 d 115274
7458 7458 s 		ld		de,INIHRDMSG
745b 745b d 010600
745b 745b s 		ld		bc,6
745e 745e d cd1578
745e 745e s 		calL	SENDPICMD
7461 7461 d c9
7461 7461 s 		ret
7462 7462 s 
7462 7462 s ;-----------------------
7462 7462 s ; PI_WAITBOOT          |
7462 7462 s ;-----------------------
7462 7462 s PI_WAITBOOT:
7462 7462 d 060a
7462 7462 s         ld      b,10
7464 7464 s 
7464 7464 s PI_WAITBOOT1:
7464 7464 d 3e2e
7464 7464 s         ld      a,'.'
7466 7466 d cda200
7466 7466 s         call    CHPUT
7469 7469 d cdeb77
7469 7469 s         call    SYNCH
746c 746c d d0
746c 746c s         ret     nc
746d 746d d c5
746d 746d s         push    bc
746e 746e d cdad76
746e 746e s         call    CHECK_ESC
7471 7471 d c1
7471 7471 s         pop     bc
7472 7472 d d8
7472 7472 s         ret		c
7473 7473 s ; Pi responded
7473 7473 d 10ef
7473 7473 s         djnz    PI_WAITBOOT1
7475 7475 s ; Pi did not respond
7475 7475 d 37
7475 7475 s         scf
7476 7476 d c9
7476 7476 s         ret
7477 7477 s 
7477 7477 s ; DRIVES
7477 7477 s ;
7477 7477 s ; Input: 	F	Zx set if to return physical drives
7477 7477 s ;			    Zx reset if to return at least 2 drives, if only one
7477 7477 s ;			  physical drive it becomes a phantom drive
7477 7477 s ; Output:	L	number of drives
7477 7477 s ; Changed:	F,hl,IX,IY may be affected
7477 7477 s ;
7477 7477 s ; Remark:	DOS1 does not handle L=0 correctly. It hangs the computer upon boot if L = 0.
7477 7477 s ; During boot this is called twice, with BC = FB21 and then BC = FB23.
7477 7477 s ; This
7477 7477 s 
7477 7477 d 445249564553
7477 7477 s DRIVESMSG: DB  "DRIVES"
747d 747d s DRIVES:
747d 747d d f5
747d 747d s     	push    af
747e 747e d c5
747e 747e s 		push	bc
747f 747f d d5
747f 747f s 		push    de
7480 7480 d 117774
7480 7480 s 		ld		de,DRIVESMSG
7483 7483 d 010600
7483 7483 s 		ld		bc,6
7486 7486 d cd1578
7486 7486 s 		call	SENDPICMD
7489 7489 d 3ea1
7489 7489 s 		ld		a,SENDNEXT
748b 748b d cd567a
748b 748b s 		call	PIEXCHANGEBYTE
748e 748e s ; Is it zero? MSXDOS1 dont like it.
748e 748e d 2e01
748e 748e s         ld      l,1
7490 7490 d 3806
7490 7490 s         jr      c,DRIVES2
7492 7492 d b7
7492 7492 s 		or		a
7493 7493 d 2002
7493 7493 s 		jr		nz,DRIVES1
7495 7495 d 3e01
7495 7495 s 		ld		a,1
7497 7497 s DRIVES1:
7497 7497 d 6f
7497 7497 s         ld      l,a
7498 7498 s DRIVES2:
7498 7498 d d1
7498 7498 s 		pop		de
7499 7499 d c1
7499 7499 s 		pop		bc
749a 749a d f1
749a 749a s 		pop		af
749b 749b d c9
749b 749b s 		ret
749c 749c s 
749c 749c s ; INIENV
749c 749c s ;
749c 749c s ; Input: 	None
749c 749c s ; Output:	None
749c 749c s ; Changed:	af,bc,de,hl,IX,IY may be affected
749c 749c s ;
749c 749c s ; Remark:	examples installs own interrupt handler, but this is NOT required.
749c 749c s ;		depends on the hardware if this is needed.
749c 749c s 
749c 749c s INIENV:
749c 749c d c9
749c 749c s         ret
749d 749d s 
749d 749d s ;
749d 749d s ; DSKIO
749d 749d s ;
749d 749d s ; Input: 	A	Drivenumber
749d 749d s ;		F	Cx reset for read
749d 749d s ;			Cx set for write
749d 749d s ; 		B	number of sectors
749d 749d s ; 		C	Media descriptor
749d 749d s ;		de	logical sectornumber
749d 749d s ; 		hl	transfer address
749d 749d s ; Output:	F	Cx set for error
749d 749d s ;			Cx reset for ok
749d 749d s ;		A	if error, errorcode
749d 749d s ;		B	if error, remaining sectors
749d 749d s ; Changed:	af,bc,de,hl,IX,IY may be affected
749d 749d s 
749d 749d s 
749d 749d d 52445300
749d 749d s DOS_RSEC:   DB      "RDS",0
74a1 74a1 d 57525300
74a1 74a1 s DOS_WSEC:   DB      "WRS",0
74a5 74a5 s DSKIO:
74a5 74a5 d 3028
74a5 74a5 s         jr		nc,DSKIO_READ
74a7 74a7 s 
74a7 74a7 s DSKIO_WRITE:
74a7 74a7 d fe04
74a7 74a7 s         cp      4
74a9 74a9 d d2f174
74a9 74a9 s         jp      nc,DSKIO_ERR1
74ac 74ac s 
74ac 74ac s ; save destination address and number of sectors to write
74ac 74ac d c5
74ac 74ac s         push    bc
74ad 74ad d e5
74ad 74ad s         push    hl
74ae 74ae d cdfa74
74ae 74ae s         call    DSKIO_SECTINFO
74b1 74b1 d 383c
74b1 74b1 s         jr      c,DSKIO_ERR
74b3 74b3 d 11a174
74b3 74b3 s         ld      de,DOS_WSEC
74b6 74b6 d 010300
74b6 74b6 s         ld      bc,3
74b9 74b9 d cd1578
74b9 74b9 s         call    SENDPICMD
74bc 74bc d 3831
74bc 74bc s         jr      c,DSKIO_ERR
74be 74be s 
74be 74be s ; source address to read sector data and number of sectors
74be 74be d d1
74be 74be s         pop     de
74bf 74bf d c1
74bf 74bf s         pop     bc
74c0 74c0 s 
74c0 74c0 s ; will write one sector at a time
74c0 74c0 s DSKIO_WRITE1:
74c0 74c0 d c5
74c0 74c0 s         push    bc
74c1 74c1 d 010002
74c1 74c1 s         ld      bc,512
74c4 74c4 d cd9e78
74c4 74c4 s         call    SECSENDDATA
74c7 74c7 d c1
74c7 74c7 s         pop     bc
74c8 74c8 d 3827
74c8 74c8 s         jr      c,DSKIO_ERR1
74ca 74ca d 10f4
74ca 74ca s         djnz    DSKIO_WRITE1
74cc 74cc d b7
74cc 74cc s         or      a
74cd 74cd d fb
74cd 74cd s         ei
74ce 74ce d c9
74ce 74ce s         ret
74cf 74cf s 
74cf 74cf s ; ----------------
74cf 74cf s ; DSKIO_READ     |
74cf 74cf s ;-----------------
74cf 74cf s DSKIO_READ:
74cf 74cf d fe04
74cf 74cf s         cp      4
74d1 74d1 d 301e
74d1 74d1 s         jr      nc,DSKIO_ERR1
74d3 74d3 d f3
74d3 74d3 s         di
74d4 74d4 s 
74d4 74d4 s ; save destination address only
74d4 74d4 d c5
74d4 74d4 s         push    bc
74d5 74d5 d e5
74d5 74d5 s         push    hl
74d6 74d6 d cdfa74
74d6 74d6 s         call    DSKIO_SECTINFO
74d9 74d9 d 3814
74d9 74d9 s         jr      c,DSKIO_ERR
74db 74db d 119d74
74db 74db s         ld      de,DOS_RSEC
74de 74de d 010300
74de 74de s         ld      bc,3
74e1 74e1 d cd1578
74e1 74e1 s         call    SENDPICMD
74e4 74e4 d 3809
74e4 74e4 s         jr      c,DSKIO_ERR
74e6 74e6 d d1
74e6 74e6 s         pop     de
74e7 74e7 d cd7378
74e7 74e7 s         call    SECRECVDATA
74ea 74ea d c1
74ea 74ea s         pop     bc
74eb 74eb d 3804
74eb 74eb s         jr      c,DSKIO_ERR1
74ed 74ed d fb
74ed 74ed s         ei
74ee 74ee d c9
74ee 74ee s         ret
74ef 74ef s 
74ef 74ef s 
74ef 74ef s DSKIO_ERR:
74ef 74ef d e1
74ef 74ef s         pop     hl
74f0 74f0 d c1
74f0 74f0 s         pop     bc
74f1 74f1 s DSKIO_ERR1:
74f1 74f1 d 3e0c
74f1 74f1 s         ld      a,12
74f3 74f3 d 37
74f3 74f3 s         scf
74f4 74f4 d fb
74f4 74f4 s         ei
74f5 74f5 d c9
74f5 74f5 s         ret
74f6 74f6 s 
74f6 74f6 s ;-----------------------
74f6 74f6 s ; DSKIO_SECTINFO       |
74f6 74f6 s ;-----------------------
74f6 74f6 d 53435400
74f6 74f6 s DOS_SECINFO:    DB  "SCT",0
74fa 74fa s 
74fa 74fa s DSKIO_SECTINFO:
74fa 74fa d f5
74fa 74fa s         push    af
74fb 74fb d c5
74fb 74fb s         push    bc
74fc 74fc d d5
74fc 74fc s         push    de
74fd 74fd d e5
74fd 74fd s         push    hl
74fe 74fe d 11f674
74fe 74fe s         LD      de,DOS_SECINFO
7501 7501 d 010300
7501 7501 s         LD      bc,3
7504 7504 d cd1578
7504 7504 s         call    SENDPICMD
7507 7507 d e1
7507 7507 s         pop     hl
7508 7508 d d1
7508 7508 s         pop     de
7509 7509 d c1
7509 7509 s         pop     bc
750a 750a d 3003
750a 750a s         jr		nc,DSKIO_SECTINFO1
750c 750c d f1
750c 750c s         pop     af
750d 750d d 37
750d 750d s         scf
750e 750e d c9
750e 750e s         ret
750f 750f s 
750f 750f s DSKIO_SECTINFO1:
750f 750f s ; synchronize communication with MSX
750f 750f s 
750f 750f d 3ea1
750f 750f s 	ld		a,SENDNEXT
7511 7511 d cd567a
7511 7511 s 	call	PIEXCHANGEBYTE
7514 7514 d fea1
7514 7514 s 	cp		SENDNEXT
7516 7516 d 2803
7516 7516 s 	jr		z,DSKIO_SECTINFO2
7518 7518 d f1
7518 7518 s 	pop		af
7519 7519 d 37
7519 7519 s 	scf
751a 751a d c9
751a 751a s 	ret
751b 751b s 
751b 751b s DSKIO_SECTINFO2:
751b 751b s ; send device number
751b 751b s 
751b 751b d f1
751b 751b s 		pop     af
751c 751c d cd567a
751c 751c s         call    PIEXCHANGEBYTE
751f 751f s 
751f 751f s ; send number of sectors to read/write
751f 751f s 
751f 751f d 78
751f 751f s 		ld      a,b
7520 7520 d cd567a
7520 7520 s         call    PIEXCHANGEBYTE
7523 7523 s 
7523 7523 s ; send media decriptor
7523 7523 s 
7523 7523 d 79
7523 7523 s         ld      a,c
7524 7524 d cd567a
7524 7524 s         call    PIEXCHANGEBYTE
7527 7527 s 
7527 7527 s ; send logical sectornumber (initial sector number)
7527 7527 s 
7527 7527 d 7b
7527 7527 s 		ld      a,e
7528 7528 d cd567a
7528 7528 s         call    PIEXCHANGEBYTE
752b 752b d 7a
752b 752b s         ld      a,d
752c 752c d cd567a
752c 752c s         call    PIEXCHANGEBYTE
752f 752f d c9
752f 752f s         ret
7530 7530 s 
7530 7530 s DSKIORDMSG:
7530 7530 d 44534b494f2052454144204552524f520d0a00
7530 7530 s     DB      "DSKIO READ ERROR",13,10,0
7543 7543 s 
7543 7543 s ; DSKCHG
7543 7543 s ;
7543 7543 s ; Input: 	A	Drivenumber
7543 7543 s ; 		B	0
7543 7543 s ; 		C	Media descriptor
7543 7543 s ; 		hl	pointer to DPB
7543 7543 s ; Output:	F	Cx set for error
7543 7543 s ;			Cx reset for ok
7543 7543 s ;		A	if error, errorcode
7543 7543 s ;		B	if no error, disk change status
7543 7543 s ;			01 disk unchanged
7543 7543 s ;			00 unknown
7543 7543 s ;			FF disk changed
7543 7543 s ; Changed:	af,bc,de,hl,IX,IY may be affected
7543 7543 s ; Remark:	DOS1 kernel expects the DPB updated when disk change status is unknown or changed
7543 7543 s ;		DOS2 kernel does not care if the DPB is updated or not
7543 7543 s DSKCHG:
7543 7543 d 0600
7543 7543 s         ld		b,00
7545 7545 d b7
7545 7545 s         or		a
7546 7546 d c9
7546 7546 s         ret
7547 7547 s 
7547 7547 s ; Disk changed, must read sector and update DPB
7547 7547 s DSKCHGDPB:
7547 7547 d c9
7547 7547 s         ret
7548 7548 s 
7548 7548 s ; GETDPB
7548 7548 s ;
7548 7548 s ; Input: 	A	Drivenumber
7548 7548 s ; 		B	first byte of FAT
7548 7548 s ; 		C	Media descriptor
7548 7548 s ; 		hl	pointer to DPB
7548 7548 s ; Output:	[hl+1]
7548 7548 s ;		..
7548 7548 s ;		[hl+18]	updated
7548 7548 s ; Changed:	af,bc,de,hl,IX,IY may be affected
7548 7548 s ; GETDPB
7548 7548 s ;
7548 7548 s ; Input: 	A	Drivenumber
7548 7548 s ; 		B	first byte of FAT
7548 7548 s ; 		C	Media descriptor
7548 7548 s ; 		hl	pointer to DPB
7548 7548 s ; Output:	[hl+1]
7548 7548 s ;		..
7548 7548 s ;		[hl+18]	updated
7548 7548 s ; Changed:	af,bc,de,hl,IX,IY may be affected
7548 7548 s 
7548 7548 s GETDPB:
7548 7548 d c9
7548 7548 s         ret
7549 7549 s 
7549 7549 s DpbTable:
7549 7549 d f8
7549 7549 s         db	0F8h		; Media F8
754a 754a d 0002
754a 754a s 		dw	512		; 80 Tracks
754c 754c d 0f
754c 754c s 		db	0Fh		; 9 sectors
754d 754d d 04
754d 754d s 		db	04h		; 1 side
754e 754e d 01
754e 754e s 		db	01h		; 3.5" 360 Kb
754f 754f d 02
754f 754f s 		db	02h
7550 7550 d 0100
7550 7550 s 		dw	1
7552 7552 d 02
7552 7552 s 		db	2
7553 7553 d 70
7553 7553 s 		db	112
7554 7554 d 0c00
7554 7554 s 		dw	12
7556 7556 d 6301
7556 7556 s 		dw	355
7558 7558 d 02
7558 7558 s 		db	2
7559 7559 d 0500
7559 7559 s 		dw	5
755b 755b s 
755b 755b d f9
755b 755b s 		db	0F9h		; Media F9
755c 755c d 0002
755c 755c s 		dw	512		; 80 Tracks
755e 755e d 0f
755e 755e s 		db	0Fh		; 9 sectors
755f 755f d 04
755f 755f s 		db	04h		; 2 sides
7560 7560 d 01
7560 7560 s 		db	01h		; 3.5" 720 Kb
7561 7561 d 02
7561 7561 s 		db	02h
7562 7562 d 0100
7562 7562 s 		dw	1
7564 7564 d 02
7564 7564 s 		db	2
7565 7565 d 70
7565 7565 s 		db	112
7566 7566 d 0e00
7566 7566 s 		dw	14
7568 7568 d ca02
7568 7568 s 		dw	714
756a 756a d 03
756a 756a s 		db	3
756b 756b d 0700
756b 756b s 		dw	7
756d 756d s 
756d 756d s DEFDPB	equ	DpbTable+18-1
756d 756d s 
756d 756d s ; CHOICE
756d 756d s ;
756d 756d s ; Input: 	None
756d 756d s ; Output:	hl	pointer to choice string, 0 if no choice
756d 756d s ; Changed:	af,bc,de,hl,IX,IY may be affected
756d 756d s 
756d 756d s CHOICE:
756d 756d d 210000
756d 756d s 		ld		hl,0
7570 7570 d c9
7570 7570 s 		ret
7571 7571 s 
7571 7571 s ; Choices not used by MSXPi driver
7571 7571 d 0d0a
7571 7571 s ChoiceStr:	db	13,10
7573 7573 d 31202d2043686f69636520410d0a
7573 7573 s 		db	"1 - Choice A",13,10
7581 7581 d 32202d2043686f69636520420d0a
7581 7581 s 		db	"2 - Choice B",13,10
758f 758f d 33202d2043686f69636520430d0a
758f 758f s         db	"3 - Choice C",13,10
759d 759d d 0d0a
759d 759d s 		db	13,10
759f 759f d 00
759f 759f s 		db	0
75a0 75a0 s 
75a0 75a0 s ; DSKFMT
75a0 75a0 s ;
75a0 75a0 s ; Input: 	A	choicecode (1-9)
75a0 75a0 s ;		D	drivenumber
75a0 75a0 s ;		hl	begin of workarea
75a0 75a0 s ;		bc	length of workarea
75a0 75a0 s ; Output:	F	Cx set for error
75a0 75a0 s ;			Cx reset for ok
75a0 75a0 s ;		A	if error, errorcode
75a0 75a0 s ; Changed:	af,bc,de,hl,IX,IY may be affected
75a0 75a0 d 464d5400
75a0 75a0 s DSKFMTCMD:DB    "FMT",0
75a4 75a4 s DSKFMT:
75a4 75a4 d d5
75a4 75a4 s         push    de
75a5 75a5 d f5
75a5 75a5 s         push    af
75a6 75a6 d 010300
75a6 75a6 s         ld      bc,3
75a9 75a9 d 11a075
75a9 75a9 s         ld      de,DSKFMTCMD
75ac 75ac d cd1578
75ac 75ac s         call    SENDPICMD
75af 75af d f1
75af 75af s         pop     af
75b0 75b0 d cd567a
75b0 75b0 s         call    PIEXCHANGEBYTE
75b3 75b3 d d1
75b3 75b3 s         pop     de
75b4 75b4 d 7a
75b4 75b4 s         ld      a,d
75b5 75b5 d cd567a
75b5 75b5 s         call    PIEXCHANGEBYTE
75b8 75b8 d 3ea2
75b8 75b8 s         ld      a,ENDOFTRANSFER
75ba 75ba d cd567a
75ba 75ba s         call    PIEXCHANGEBYTE
75bd 75bd d fea2
75bd 75bd s         cp      ENDOFTRANSFER
75bf 75bf d c8
75bf 75bf s         ret     Z
75c0 75c0 d 37
75c0 75c0 s         scf
75c1 75c1 d 3e0a
75c1 75c1 s         ld      a,10
75c3 75c3 d c9
75c3 75c3 s         ret
75c4 75c4 s 
75c4 75c4 s ; OEMSTATEMENT
75c4 75c4 s ;
75c4 75c4 s ; Input:	hl	basicpointer
75c4 75c4 s ; Output:	F	Cx set if statement not recognized
75c4 75c4 s ;			Cx reset if statement is recognized
75c4 75c4 s ;		hl	basicpointer,	updated if recognized
75c4 75c4 s ;					unchanged if not recognized
75c4 75c4 s ; Changed:	af,bc,de,hl,IX,IY may be affected
75c4 75c4 s 
75c4 75c4 s OEMSTA:
75c4 75c4 d e5
75c4 75c4 s 		push    hl
75c5 75c5 d 21b777
75c5 75c5 s 		ld      hl,STR_CALL_CMD
75c8 75c8 s CALL_CHECK:
75c8 75c8 d 1189fd
75c8 75c8 s 		ld      de,PROCNM
75cb 75cb s CHECKCMD:
75cb 75cb d 1a
75cb 75cb s         ld      a,(de)
75cc 75cc d be
75cc 75cc s 		cp      (hl)
75cd 75cd d 2011
75cd 75cd s 		jr		nz,CHECKNEXT
75cf 75cf d 13
75cf 75cf s 		inc     de
75d0 75d0 d 23
75d0 75d0 s 		inc     hl
75d1 75d1 d b7
75d1 75d1 s 		or		a
75d2 75d2 d 20f7
75d2 75d2 s 		jr		nz,CHECKCMD
75d4 75d4 d 5e
75d4 75d4 s 		ld		e,(hl)
75d5 75d5 d 23
75d5 75d5 s 		inc     hl
75d6 75d6 d 56
75d6 75d6 s 		ld		d,(hl)
75d7 75d7 d cded75
75d7 75d7 s 		call	MYCOMMAND
75da 75da d e1
75da 75da s 		pop     hl
75db 75db d cdf075
75db 75db s         call	GETPREVCHAR
75de 75de d b7
75de 75de s 		or		a
75df 75df d c9
75df 75df s 		ret
75e0 75e0 s 
75e0 75e0 s ; Find entry address of next command to test
75e0 75e0 s CHECKNEXT:
75e0 75e0 d 0eff
75e0 75e0 s 		ld		c,0FFH
75e2 75e2 d af
75e2 75e2 s 		xor		a
75e3 75e3 d edb1
75e3 75e3 s 		cpir
75e5 75e5 d 23
75e5 75e5 s 		inc		hl
75e6 75e6 d 23
75e6 75e6 s 		inc		hl
75e7 75e7 d be
75e7 75e7 s         cp		(hl)
75e8 75e8 d 20de
75e8 75e8 s 		jr		nz,call_CHECK	;Check next command
75ea 75ea d e1
75ea 75ea s 		pop		hl
75eb 75eb d 37
75eb 75eb s         scf
75ec 75ec d c9
75ec 75ec s 		ret
75ed 75ed s  
75ed 75ed s MYCOMMAND:
75ed 75ed d d5
75ed 75ed s 		push	de
75ee 75ee d c9
75ee 75ee s 		ret
75ef 75ef s 
75ef 75ef s 
75ef 75ef s ; MTOFF
75ef 75ef s ;
75ef 75ef s ; Input:	None
75ef 75ef s ; Output:	None
75ef 75ef s ; Changed:	af,bc,de,hl,IX,IY may be affected
75ef 75ef s 
75ef 75ef s DSKSTP:
75ef 75ef s MTOFF:
75ef 75ef d c9
75ef 75ef s 		ret
75f0 75f0 s 
75f0 75f0 s GETPREVCHAR:
75f0 75f0 d 2b
75f0 75f0 s         dec     hl
75f1 75f1 d dd216646
75f1 75f1 s         ld      IX,CHRGTR
75f5 75f5 d c35901
75f5 75f5 s         jp      CALBAS
75f8 75f8 s 
75f8 75f8 s ;================================================================
75f8 75f8 s ; call Commands start here
75f8 75f8 s ; ================================================================
75f8 75f8 s 
75f8 75f8 s ;-----------------------
75f8 75f8 s ; call MSXPIVER        |
75f8 75f8 s ;-----------------------
75f8 75f8 s MSXPIVER:
75f8 75f8 d 21cf76
75f8 75f8 s         ld      hl,MSXPIVERSION
75fb 75fb d c3af79
75fb 75fb s         jp      PRINT
75fe 75fe s 
75fe 75fe s ;-----------------------
75fe 75fe s ; call MSXPISTATUS     |
75fe 75fe s ;-----------------------
75fe 75fe s MSXPISTATUS:
75fe 75fe s 
75fe 75fe s ; check if Pi is responding
75fe 75fe d cd2f7a
75fe 75fe s         call    CHKPIRDY
7601 7601 d 216877
7601 7601 s         ld      hl,PIOFFLINE
7604 7604 s 
7604 7604 s ; Pi App is not available, print error message
7604 7604 d 3803
7604 7604 s         jr      c,PRINTSTATUSMSG
7606 7606 s 
7606 7606 s ; Pi App is online
7606 7606 d 217e77
7606 7606 s         ld      hl,PIONLINE
7609 7609 s 
7609 7609 s PRINTSTATUSMSG:
7609 7609 d c3af79
7609 7609 s         jp      PRINT
760c 760c s 
760c 760c s ;-----------------------
760c 760c s ; call MSXPILOAD       |
760c 760c s ;-----------------------
760c 760c s ; Load the client to the memory address in the headers
760c 760c s 
760c 760c d 706c6f616462696e206d737870692d636c69656e742e62696e00
760c 760c s LOADCLIENTCMD: DB "ploadbin msxpi-client.bin",0
7626 7626 s MSXPILOAD:
7626 7626 d 215177
7626 7626 s         ld      hl,MSXPILOADING
7629 7629 d cdaf79
7629 7629 s         call    PRINT
762c 762c d 3eff
762c 762c s         ld      a,RESET
762e 762e d cd2c7a
762e 762e s         call    SENDIFCMD
7631 7631 s 
7631 7631 s ; Send command LOADROM to Pi
7631 7631 d 011900
7631 7631 s         ld      bc,25
7634 7634 d 110c76
7634 7634 s         ld      de,LOADCLIENTCMD
7637 7637 d cd1578
7637 7637 s         call    SENDPICMD
763a 763a d 3826
763a 763a s         jr		c,MSXPILOADERROR
763c 763c d cd2d79
763c 763c s         call    LOADBINPROG
763f 763f d da6276
763f 763f s         jp      c,MSXPILOADERROR
7642 7642 d f5
7642 7642 s         push    af
7643 7643 d e5
7643 7643 s         push    hl
7644 7644 d cd6876
7644 7644 s         call    GETSTDOUTNULL
7647 7647 d e1
7647 7647 s         pop     hl
7648 7648 d f1
7648 7648 s         pop     af
7649 7649 d fea2
7649 7649 s         cp      ENDOFTRANSFER
764b 764b d c0
764b 764b s         ret     nz
764c 764c d e9
764c 764c s         jp      (hl)
764d 764d s 
764d 764d d 4572726f72206c6f6164696e672066696c650d0a00
764d 764d s LOADERRMSG:     DB "Error loading file",13,10,0
7662 7662 s MSXPILOADERROR:
7662 7662 d 214d76
7662 7662 s         ld      hl,LOADERRMSG
7665 7665 d c3af79
7665 7665 s         jp      PRINT
7668 7668 s 
7668 7668 s GETSTDOUTNULL:
7668 7668 d 110000
7668 7668 s         ld      de,$0000
766b 766b d cd1978
766b 766b s         call    RECVDATABLOCK
766e 766e d c9
766e 766e s         ret
766f 766f s 
766f 766f s ;-----------------------
766f 766f s ; call GETPOINTERS      |
766f 766f s ;-----------------------
766f 766f s ; Return in hl the Entry address of th routine indexed in A
766f 766f s ; Input:
766f 766f s ;  A = Routine index
766f 766f s ; Output:
766f 766f s ;  A =  slot id for this ROM (to-do)
766f 766f s ;  hl = CAll address of the given routine
766f 766f s ; Modify: af,hl
766f 766f s ;
766f 766f s GETPOINTERS:
766f 766f d d5
766f 766f s         push    de
7670 7670 d 218176
7670 7670 s         ld      hl,BIOSENTRYADDR
7673 7673 s 
7673 7673 s GETPOINTERS1:
7673 7673 d b7
7673 7673 s         or		a
7674 7674 d 2805
7674 7674 s         jr		z,GETPOINTERSEXIT
7676 7676 d 3d
7676 7676 s         dec		a
7677 7677 d 23
7677 7677 s         inc     hl
7678 7678 d 23
7678 7678 s         inc     hl
7679 7679 d 18f8
7679 7679 s         jr		GETPOINTERS1
767b 767b s 
767b 767b s GETPOINTERSEXIT:
767b 767b d 5e
767b 767b s         ld		e,(hl)
767c 767c d 23
767c 767c s         inc     hl
767d 767d d 66
767d 767d s         ld		h,(hl)
767e 767e d 6b
767e 767e s         ld		l,e
767f 767f d d1
767f 767f s         pop     de
7680 7680 d c9
7680 7680 s         ret
7681 7681 s 
7681 7681 s BIOSENTRYADDR:  EQU     $
7681 7681 d f875
7681 7681 s         DW      MSXPIVER
7683 7683 d fe75
7683 7683 s         DW      MSXPISTATUS
7685 7685 d 2676
7685 7685 s         DW      MSXPILOAD
7687 7687 d 1978
7687 7687 s         DW      RECVDATABLOCK
7689 7689 d 4378
7689 7689 s         DW      SENDDATABLOCK
768b 768b d 7378
768b 768b s         DW      SECRECVDATA
768d 768d d 9e78
768d 768d s         DW      SECSENDDATA
768f 768f d ca78
768f 768f s         DW      READDATASIZE
7691 7691 d d778
7691 7691 s         DW      SENDDATASIZE
7693 7693 d 2f7a
7693 7693 s         DW      CHKPIRDY
7695 7695 d 407a
7695 7695 s         DW      PIREADBYTE
7697 7697 d 4e7a
7697 7697 s         DW      PIWRITEBYTE
7699 7699 d 567a
7699 7699 s         DW      PIEXCHANGEBYTE
769b 769b d 2c7a
769b 769b s         DW      SENDIFCMD
769d 769d d 1578
769d 769d s         DW      SENDPICMD
769f 769f d 9579
769f 769f s         DW      CHECKBUSY
76a1 76a1 d 2d79
76a1 76a1 s         DW      LOADBINPROG
76a3 76a3 d af79
76a3 76a3 s         DW      PRINT
76a5 76a5 d cd79
76a5 76a5 s         DW      PRINTNLINE
76a7 76a7 d d879
76a7 76a7 s         DW      PRINTNUMBER
76a9 76a9 d ed79
76a9 76a9 s         DW      PRINTDIGIT
76ab 76ab d fc79
76ab 76ab s         DW      PRINTPISTDOUT
76ad 76ad s 
76ad 76ad s ;-----------------------------------------------------------------------------
76ad 76ad s ;
76ad 76ad s ; Read the keyboard matrix to see if ESC is pressed
76ad 76ad s ; Output: Cy = 1 if pressed, 0 otherwise
76ad 76ad s 
76ad 76ad s CHECK_ESC:
76ad 76ad d 0607
76ad 76ad s         ld		b,7
76af 76af d dbaa
76af 76af s         in		a,(0AAh)
76b1 76b1 d e6f0
76b1 76b1 s         and		11110000b
76b3 76b3 d b0
76b3 76b3 s         or		b
76b4 76b4 d d3aa
76b4 76b4 s         out		(0AAh),a
76b6 76b6 d dba9
76b6 76b6 s         in		a,(0A9h)
76b8 76b8 d 37
76b8 76b8 s         scf
76b9 76b9 d cb57
76b9 76b9 s         bit		2,a
76bb 76bb d c8
76bb 76bb s         ret		z
76bc 76bc d b7
76bc 76bc s         or		a
76bd 76bd d c9
76bd 76bd s         ret
76be 76be s 
76be 76be s CHECK_CTRL:
76be 76be d 0606
76be 76be s         ld		b,6
76c0 76c0 d dbaa
76c0 76c0 s         in		a,(0AAh)
76c2 76c2 d e6f0
76c2 76c2 s         and		11110000b
76c4 76c4 d b0
76c4 76c4 s         or		b
76c5 76c5 d d3aa
76c5 76c5 s         out		(0AAh),a
76c7 76c7 d dba9
76c7 76c7 s         in		a,(0A9h)
76c9 76c9 d 37
76c9 76c9 s         scf
76ca 76ca d cb4f
76ca 76ca s         bit		1,a
76cc 76cc d c8
76cc 76cc s         ret		z
76cd 76cd d b7
76cd 76cd s         or		a
76ce 76ce d c9
76ce 76ce s         ret
76cf 76cf s ; ================================================================
76cf 76cf s ; Text messages used in the loader
76cf 76cf s ; ================================================================
76cf 76cf s 
76cf 76cf s MSXPIVERSION:
76cf 76cf d 0d0a4d5358506920486172647761726520496e746572666163652076302e370d0a
76cf 76cf s         DB      13,10,"MSXPi Hardware Interface v0.7",13,10
76f0 76f0 d 4d5358506920524f4d2076302e382e310d0a
76f0 76f0 s         DB      "MSXPi ROM v0.8.1",13,10
7702 7702 d 28632920526f6e69766f6e20436f7374612c323031370d0a0a
7702 7702 s         DB      "(c) Ronivon Costa,2017",13,10,10
771b 771b d 436f6d6d616e647320617661696c61626c653a0d0a
771b 771b s         DB      "Commands available:",13,10
7730 7730 d 4d535850494c4f4144204d53585049535441545553204d535850495645520d0a
7730 7730 s         DB      "MSXPILOAD MSXPISTATUS MSXPIVER",13,10
7750 7750 d 00
7750 7750 s         DB      00
7751 7751 s 
7751 7751 s MSXPILOADING:
7751 7751 d 4c6f6164696e67204d5358506920436c69656e740d0a00
7751 7751 s         DB      "Loading MSXPi Client",13,10,0
7768 7768 s 
7768 7768 s PIOFFLINE:
7768 7768 d 436f6d6d756e69636174696f6e204572726f720d0a00
7768 7768 s         DB      "Communication Error",13,10,0
777e 777e s 
777e 777e s PIONLINE:
777e 777e d 5261737065727279205049206973206f6e6c696e650d0a00
777e 777e s         DB      "Rasperry PI is online",13,10,0
7796 7796 s 
7796 7796 s PIWAITMSG:
7796 7796 d 0d0a57616974696e6720506920626f6f742e2045534320746f20736b69700d0a00
7796 7796 s         DB      13,10,"Waiting Pi boot. ESC to skip",13,10,0
77b7 77b7 s 
77b7 77b7 s ; ================================================================
77b7 77b7 s ; Table of Commands available/implemented
77b7 77b7 s ; ================================================================
77b7 77b7 s 
77b7 77b7 s STR_CALL_CMD:
77b7 77b7 s 
77b7 77b7 d 4d5358504956455200
77b7 77b7 s         DB      "MSXPIVER",0
77c0 77c0 d f875
77c0 77c0 s         DW      MSXPIVER
77c2 77c2 s 
77c2 77c2 d 4d535850494c4f414400
77c2 77c2 s         DB      "MSXPILOAD",0
77cc 77cc d 2676
77cc 77cc s         DW      MSXPILOAD
77ce 77ce s 
77ce 77ce d 4d5358504953544154555300
77ce 77ce s         DB      "MSXPISTATUS",0
77da 77da d fe75
77da 77da s         DW      MSXPISTATUS
77dc 77dc s 
77dc 77dc d 474554504f494e5445525300
77dc 77dc s         DB      "GETPOINTERS",0
77e8 77e8 d 6f76
77e8 77e8 s         DW      GETPOINTERS
77ea 77ea s 
77ea 77ea s ENDOFCMDS:
77ea 77ea d 00
77ea 77ea s         DB      00
77eb 77eb s 
77eb 77eb s INCLUDE include.asm
77eb 77eb f include.asm
77eb 77eb s BUSYRETRIES:    EQU 2
77eb 77eb s GLOBALRETRIES:  EQU 5
77eb 77eb s RESET:          EQU $FF
77eb 77eb s 
77eb 77eb s STARTTRANSFER:  EQU $A0
77eb 77eb s SENDNEXT:       EQU $A1
77eb 77eb s ENDTRANSFER:    EQU $A2
77eb 77eb s READY:          EQU $AA
77eb 77eb s ABORT:          EQU $AD
77eb 77eb s BUSY:           EQU $AE
77eb 77eb s 
77eb 77eb s RC_SUCCESS:     EQU $E0
77eb 77eb s RC_CRCERROR:    EQU $E2
77eb 77eb s RC_OUTOFSYNC:   EQU $E5
77eb 77eb s RC_FILENOTFOUND:EQU $E6
77eb 77eb s 
77eb 77eb s CALLSTAT:       EQU     $55A8
77eb 77eb s INLINBUF:       EQU     $F55E
77eb 77eb s INLIN:          EQU     $00B1
77eb 77eb s CHPUT:          EQU     $00A2
77eb 77eb s CHGET:          EQU     $009F
77eb 77eb s INITXT:         EQU     $006C
77eb 77eb s EXPTBL:         EQU     $FCC1
77eb 77eb s RDSLT:          EQU     $000C
77eb 77eb s WRSLT:          EQU     $0014
77eb 77eb s CALSLT:         EQU     $001C
77eb 77eb s ENASLT:         EQU     $0024
77eb 77eb s CSRY:           EQU     $F3DC
77eb 77eb s CSRX:           EQU     $F3DD
77eb 77eb s ERAFNK:         EQU     $00CC
77eb 77eb s DSPFNK:         EQU     $00CF
77eb 77eb s PROCNM:         EQU     $FD89
77eb 77eb s XF365:          EQU     $F365                  ; routine read primary slotregister
77eb 77eb s 
77eb 77eb s CONTROL_PORT:   EQU $06
77eb 77eb s CONTROL_PORT2:  EQU $08
77eb 77eb s DATA_PORT:      EQU $07
77eb 77eb s 
77eb 77eb s BDOS:           EQU 5
77eb 77eb s 
77eb 77eb f msxpi-driver.mac
77eb 77eb s INCLUDE msxpi_bios.asm
77eb 77eb f msxpi_bios.asm
77eb 77eb s ;|===========================================================================|
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| MSXPi Interface                                                           |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| Version : 0.8                                                             |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| Copyright (c) 2015-2016 Ronivon Candido Costa (ronivon@outlook.com)       |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| All rights reserved                                                       |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| Redistribution and use in source and compiled forms, with or without      |
77eb 77eb s ;| modification, are permitted under GPL license.                            |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;|===========================================================================|
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| This file is part of MSXPi Interface project.                             |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| MSX PI Interface is free software: you can redistribute it and/or modify  |
77eb 77eb s ;| it under the terms of the GNU General Public License as published by      |
77eb 77eb s ;| the Free Software Foundation, either version 3 of the License, or         |
77eb 77eb s ;| (at your option) any later version.                                       |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| MSX PI Interface is distributed in the hope that it will be useful,       |
77eb 77eb s ;| but WITHOUT ANY WARRANTY; without even the implied warranty of            |
77eb 77eb s ;| MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             |
77eb 77eb s ;| GNU General Public License for more details.                              |
77eb 77eb s ;|                                                                           |
77eb 77eb s ;| You should have received a copy of the GNU General Public License         |
77eb 77eb s ;| along with MSX PI Interface.  If not, see <http://www.gnu.org/licenses/>. |
77eb 77eb s ;|===========================================================================|
77eb 77eb s ;
77eb 77eb s ; File history :
77eb 77eb s ; 0.8    : Re-worked protocol as protocol-v2:
77eb 77eb s ;          RECVDATABLOCK, SENDDATABLOCK, SECRECVDATA, SECSENDDATA,CHKBUSY
77eb 77eb s ;          Moved to here various routines from msxpi_api.asm
77eb 77eb s ; 0.7    : Replaced CHKPIRDY retries to $FFFF
77eb 77eb s ;          Removed the RESET when PI is not responding. This is now responsability
77eb 77eb s ;           of the calling function, which might opt to do something else.
77eb 77eb s ; 0.6c   : Initial version commited to git
77eb 77eb s ;
77eb 77eb s 
77eb 77eb s ; Inlude file for other sources in the project
77eb 77eb s 
77eb 77eb s ;-----------------------
77eb 77eb s ; SYNCH                |
77eb 77eb s ;-----------------------
77eb 77eb s SYNCH:
77eb 77eb d c5
77eb 77eb s             push    bc
77ec 77ec d d5
77ec 77ec s             push    de
77ed 77ed d 3eff
77ed 77ed s             ld      a,RESET
77ef 77ef d cd2c7a
77ef 77ef s             call    SENDIFCMD
77f2 77f2 d cd2f7a
77f2 77f2 s             call    CHKPIRDY
77f5 77f5 d 010300
77f5 77f5 s             ld      bc,3
77f8 77f8 d 111178
77f8 77f8 s             ld      de,CHKPICMD
77fb 77fb d cd1578
77fb 77fb s             call    SENDPICMD
77fe 77fe d d1
77fe 77fe s             pop     de
77ff 77ff d c1
77ff 77ff s             pop     bc
7800 7800 d d8
7800 7800 s             ret     c
7801 7801 d cd567a
7801 7801 s             call    PIEXCHANGEBYTE
7804 7804 d d8
7804 7804 s             ret     c
7805 7805 d feaa
7805 7805 s             cp      READY
7807 7807 d c8
7807 7807 s             ret     z
7808 7808 d fead
7808 7808 s             cp      ABORT
780a 780a d 37
780a 780a s             scf
780b 780b d c8
780b 780b s             ret     z
780c 780c d fea1
780c 780c s             cp      SENDNEXT
780e 780e d 20db
780e 780e s             jr      nz, SYNCH
7810 7810 d c9
7810 7810 s             ret
7811 7811 s 
7811 7811 d 53594e00
7811 7811 s CHKPICMD:   DB      "SYN",0
7815 7815 s 
7815 7815 s ;-----------------------
7815 7815 s ; SENDPICMD            |
7815 7815 s ;-----------------------
7815 7815 s ; Send a command to Raspberry Pi
7815 7815 s ; Input:
7815 7815 s ;   de = should contain the command string
7815 7815 s ;   bc = number of bytes in the command string
7815 7815 s ; Output:
7815 7815 s ;   Flag C set if there was a communication error
7815 7815 s SENDPICMD:
7815 7815 s ; Save flag C which tells if extra error information is required
7815 7815 d cd4378
7815 7815 s 		call    SENDDATABLOCK
7818 7818 d c9
7818 7818 s         ret
7819 7819 s 
7819 7819 s ;-----------------------
7819 7819 s ; RECVDATABLOCK        |
7819 7819 s ;-----------------------
7819 7819 s ; 21/03/2017
7819 7819 s ; Receive a number of bytes from PI
7819 7819 s ; This routine expects PI to send SENDNEXT control byte
7819 7819 s ; Input:
7819 7819 s ;   de = memory address to write the received data
7819 7819 s ; Output:
7819 7819 s ;   Flag C set if error
7819 7819 s ;   A = error code
7819 7819 s ;   de = Original address if routine finished in error,
7819 7819 s ;   de = Next current address to read if finished successfully
7819 7819 s ; -------------------------------------------------------------
7819 7819 s RECVDATABLOCK:
7819 7819 d cd9579
7819 7819 s         call    CHECKBUSY
781c 781c d d8
781c 781c s         ret     c
781d 781d s 
781d 781d s ;Get number of bytes to transfer
781d 781d d cdca78
781d 781d s         call    READDATASIZE
7820 7820 s 
7820 7820 s ; CLEAR CRC and save block size
7820 7820 d 2600
7820 7820 s         ld      h,0
7822 7822 d c5
7822 7822 s         push    bc
7823 7823 d d5
7823 7823 s         push    de
7824 7824 s 
7824 7824 s RECVDATABLOCK1:
7824 7824 s ; send info that msx is in transfer mode
7824 7824 d 3ea1
7824 7824 s         ld      a,SENDNEXT
7826 7826 d cd567a
7826 7826 s         call    PIEXCHANGEBYTE
7829 7829 d 12
7829 7829 s         ld      (de),a
782a 782a d ac
782a 782a s         xor     h
782b 782b d 67
782b 782b s         ld      h,a
782c 782c d 13
782c 782c s         inc     de
782d 782d d 0b
782d 782d s 		dec     bc
782e 782e d 78
782e 782e s         ld      a,b
782f 782f d b1
782f 782f s         or      c
7830 7830 d 20f2
7830 7830 s         jr      nz,RECVDATABLOCK1
7832 7832 s 
7832 7832 s ; Now exchange CRC
7832 7832 s 
7832 7832 d 7c
7832 7832 s         ld      a,h
7833 7833 d cd567a
7833 7833 s         call    PIEXCHANGEBYTE
7836 7836 s 
7836 7836 s ; Compare CRC received with CRC calcualted
7836 7836 s 
7836 7836 d bc
7836 7836 s         cp      h
7837 7837 d 2004
7837 7837 s         jr      nz,RECVDATABLOCK_CRCERROR
7839 7839 s 
7839 7839 s ; Discard de, because we want to return current memory address
7839 7839 s 
7839 7839 d f1
7839 7839 s         pop     af
783a 783a s 
783a 783a s ;Return number of bytes read
783a 783a s 
783a 783a d c1
783a 783a s         pop     bc
783b 783b d b7
783b 783b s         or      a
783c 783c d c9
783c 783c s         ret
783d 783d s 
783d 783d s ; Return de to original value and flag error
783d 783d s RECVDATABLOCK_CRCERROR:
783d 783d d d1
783d 783d s         pop     de
783e 783e d c1
783e 783e s         pop     bc
783f 783f d 3ee2
783f 783f s         ld      a,RC_CRCERROR
7841 7841 d 37
7841 7841 s         scf
7842 7842 d c9
7842 7842 s         ret
7843 7843 s 
7843 7843 s ;-------------------
7843 7843 s ; SENDDATABLOCK    |
7843 7843 s ;-------------------
7843 7843 s ; 21/03/2017
7843 7843 s ; Send a number of bytes to MSX
7843 7843 s ; This routine expects PI to send SENDNEXT control byte
7843 7843 s ; Input:
7843 7843 s ;   bc = number of byets to send
7843 7843 s ;   de = memory to start reading data
7843 7843 s ; Output:
7843 7843 s ;   Flag C set if error
7843 7843 s ;   A = error code
7843 7843 s ;   de = Original address if routine finished in error,
7843 7843 s ;   de = Next current address to read if finished successfully
7843 7843 s ; -------------------------------------------------------------
7843 7843 s SENDDATABLOCK:
7843 7843 d cd9579
7843 7843 s         call    CHECKBUSY
7846 7846 d d8
7846 7846 s         ret     c
7847 7847 s 
7847 7847 s ; MSX is synced with PI, then send size of block to transfer
7847 7847 d 79
7847 7847 s         ld      a,c
7848 7848 d cd4e7a
7848 7848 s         call    PIWRITEBYTE
784b 784b d 78
784b 784b s         ld      a,b
784c 784c d cd4e7a
784c 784c s         call    PIWRITEBYTE
784f 784f s 
784f 784f s ; clear H to calculate CRC using simple xor oepration
784f 784f d 2600
784f 784f s         ld      h,0
7851 7851 d d5
7851 7851 s         push    de
7852 7852 s 
7852 7852 s ; loop sending bytes until bc is zero
7852 7852 s SENDDATABLOCK1:
7852 7852 d 1a
7852 7852 s         ld      a,(de)
7853 7853 d 6f
7853 7853 s         ld      l,a
7854 7854 d ac
7854 7854 s         xor     h
7855 7855 d 67
7855 7855 s         ld      h,a
7856 7856 d 7d
7856 7856 s         ld      a,l
7857 7857 d cd4e7a
7857 7857 s         call    PIWRITEBYTE
785a 785a d 13
785a 785a s         inc     de
785b 785b d 0b
785b 785b s         dec     bc
785c 785c d 78
785c 785c s         ld      a,b
785d 785d d b1
785d 785d s         or      c
785e 785e d 20f2
785e 785e s         jr      nz,SENDDATABLOCK1
7860 7860 s 
7860 7860 s ; Finished sending block of data
7860 7860 s ; Now exchange CRC
7860 7860 s 
7860 7860 d 7c
7860 7860 s         ld      a,h
7861 7861 d cd567a
7861 7861 s         call    PIEXCHANGEBYTE
7864 7864 s 
7864 7864 s ; Compare CRC received with CRC calcualted
7864 7864 s 
7864 7864 d bc
7864 7864 s         cp      h
7865 7865 d 2003
7865 7865 s         jr      nz,SENDDATABLOCK_CRCERROR
7867 7867 s 
7867 7867 s ; Discard de, because we want to return current memory address
7867 7867 d f1
7867 7867 s         pop     af
7868 7868 d b7
7868 7868 s         or      a
7869 7869 d c9
7869 7869 s         ret
786a 786a s 
786a 786a s ; Return de to original value and flag error
786a 786a s SENDDATABLOCK_CRCERROR:
786a 786a d d1
786a 786a s         pop     de
786b 786b d 3ee2
786b 786b s         ld      a,RC_CRCERROR
786d 786d d 37
786d 786d s         scf
786e 786e d c9
786e 786e s         ret
786f 786f s 
786f 786f s ; Return de to original value and flag error
786f 786f s SENDDATABLOCK_OFFSYNC:
786f 786f d 3ee5
786f 786f s         ld      a,RC_OUTOFSYNC
7871 7871 d 37
7871 7871 s         scf
7872 7872 d c9
7872 7872 s         ret
7873 7873 s 
7873 7873 s ;-------------------
7873 7873 s ; SECRECVDATA      |
7873 7873 s ;-------------------
7873 7873 s ; 21/03/2017
7873 7873 s ; Read data in 512 bytes blocks
7873 7873 s ; This routine expects PI to send SENDNEXT control byte
7873 7873 s ; Input:
7873 7873 s ;   de = memory address to store data
7873 7873 s ; Output:
7873 7873 s ;   Flag C set if error
7873 7873 s ; -------------------------------------------------------------
7873 7873 s SECRECVDATA:
7873 7873 d cd9579
7873 7873 s         call    CHECKBUSY
7876 7876 d d8
7876 7876 s         ret     c
7877 7877 s 
7877 7877 s ;Get number of bytes to transfer
7877 7877 d cdca78
7877 7877 s         call    READDATASIZE
787a 787a s 
787a 787a s SECRECVDATA0:
787a 787a s ; save remaining bytes qty
787a 787a d c5
787a 787a s         push    bc
787b 787b d 3e05
787b 787b s         ld      a,GLOBALRETRIES
787d 787d s SECRECVDATARETRY:
787d 787d s ; retries
787d 787d d f5
787d 787d s         push    af
787e 787e d d5
787e 787e s         push    de
787f 787f d cd1978
787f 787f s         call    RECVDATABLOCK
7882 7882 d 3008
7882 7882 s         jr      nc,SECRECVDATA1
7884 7884 d d1
7884 7884 s         pop     de
7885 7885 d f1
7885 7885 s         pop     af
7886 7886 d 3d
7886 7886 s         dec     a
7887 7887 d 20f4
7887 7887 s         jr      nz,SECRECVDATARETRY
7889 7889 s 
7889 7889 s SECRECVDATAERR:
7889 7889 d f1
7889 7889 s         pop     af
788a 788a d 37
788a 788a s         scf
788b 788b d c9
788b 788b s         ret
788c 788c s 
788c 788c s SECRECVDATA1:
788c 788c d f1
788c 788c s         pop     af
788d 788d d f1
788d 788d s         pop     af
788e 788e s ;get remaining bytes to transfer
788e 788e d e1
788e 788e s         pop     hl
788f 788f d 010002
788f 788f s         ld      bc,512
7892 7892 d ed42
7892 7892 s         sbc     hl,bc
7894 7894 d 3806
7894 7894 s         jr      c,SECRECVDATAEND
7896 7896 d 2804
7896 7896 s         jr      z,SECRECVDATAEND
7898 7898 d 44
7898 7898 s         ld      b,h
7899 7899 d 4d
7899 7899 s         ld      c,l
789a 789a d 18de
789a 789a s         jr      SECRECVDATA0
789c 789c s 
789c 789c s ; File load successfully.
789c 789c s ; Return C reseted, and A = filetype
789c 789c s SECRECVDATAEND:
789c 789c d b7
789c 789c s         or      a               ;reset c flag
789d 789d d c9
789d 789d s         ret
789e 789e s 
789e 789e s ;-------------------
789e 789e s ; SECSENDDATA      |
789e 789e s ;-------------------
789e 789e s ; 21/03/2017
789e 789e s ; Read data in 512 bytes blocks
789e 789e s ; This routine expects PI to send SENDNEXT control byte
789e 789e s ; Input:
789e 789e s ;   bc = total number of bytes to send
789e 789e s ;   de = memory address to read data
789e 789e s ; Output:
789e 789e s ;   Flag C set if error
789e 789e s ; -------------------------------------------------------------
789e 789e s SECSENDDATA:
789e 789e d cd9579
789e 789e s         call    CHECKBUSY
78a1 78a1 d d8
78a1 78a1 s         ret     c
78a2 78a2 s 
78a2 78a2 s ;Get number of bytes to transfer
78a2 78a2 d cdd778
78a2 78a2 s         call    SENDDATASIZE
78a5 78a5 d d8
78a5 78a5 s         ret     c
78a6 78a6 s 
78a6 78a6 s SECSENDDATA0:
78a6 78a6 s ; save remaining bytes qty
78a6 78a6 d c5
78a6 78a6 s         push    bc
78a7 78a7 d 3e05
78a7 78a7 s         ld      a,GLOBALRETRIES
78a9 78a9 s SECSENDDATARETRY:
78a9 78a9 s ; retries
78a9 78a9 d f5
78a9 78a9 s         push    af
78aa 78aa d d5
78aa 78aa s         push    de
78ab 78ab d cd4378
78ab 78ab s         call    SENDDATABLOCK
78ae 78ae d 3008
78ae 78ae s         jr      nc,SECSENDDATA1
78b0 78b0 d d1
78b0 78b0 s         pop     de
78b1 78b1 d f1
78b1 78b1 s         pop     af
78b2 78b2 d 3d
78b2 78b2 s         dec     a
78b3 78b3 d 20f4
78b3 78b3 s         jr      nz,SECSENDDATARETRY
78b5 78b5 s 
78b5 78b5 s SECSENDDATAERR:
78b5 78b5 d f1
78b5 78b5 s         pop     af
78b6 78b6 d 37
78b6 78b6 s         scf
78b7 78b7 d c9
78b7 78b7 s         ret
78b8 78b8 s 
78b8 78b8 s SECSENDDATA1:
78b8 78b8 d f1
78b8 78b8 s         pop     af
78b9 78b9 d f1
78b9 78b9 s         pop     af
78ba 78ba s ;get remaining bytes to transfer
78ba 78ba d e1
78ba 78ba s         pop     hl
78bb 78bb d 010002
78bb 78bb s         ld      bc,512
78be 78be d ed42
78be 78be s         sbc     hl,bc
78c0 78c0 d 3806
78c0 78c0 s         jr      c,SECSENDDATAEND
78c2 78c2 d 2804
78c2 78c2 s         jr      z,SECSENDDATAEND
78c4 78c4 d 44
78c4 78c4 s         ld      b,h
78c5 78c5 d 4d
78c5 78c5 s         ld      c,l
78c6 78c6 d 18de
78c6 78c6 s         jr      SECSENDDATA0
78c8 78c8 s 
78c8 78c8 s ; File load successfully.
78c8 78c8 s ; Return C reseted, and A = filetype
78c8 78c8 s SECSENDDATAEND:
78c8 78c8 d b7
78c8 78c8 s         or      a               ;reset c flag
78c9 78c9 d c9
78c9 78c9 s         ret
78ca 78ca s 
78ca 78ca s READDATASIZE:
78ca 78ca d 3ea1
78ca 78ca s         ld      a,SENDNEXT
78cc 78cc d cd567a
78cc 78cc s         call    PIEXCHANGEBYTE
78cf 78cf d 4f
78cf 78cf s         ld      c,a
78d0 78d0 d 3ea1
78d0 78d0 s         ld      a,SENDNEXT
78d2 78d2 d cd567a
78d2 78d2 s         call    PIEXCHANGEBYTE
78d5 78d5 d 47
78d5 78d5 s         ld      b,a
78d6 78d6 d c9
78d6 78d6 s         ret
78d7 78d7 s 
78d7 78d7 s SENDDATASIZE:
78d7 78d7 d 79
78d7 78d7 s         ld      a,c
78d8 78d8 d cd567a
78d8 78d8 s         call    PIEXCHANGEBYTE
78db 78db d 78
78db 78db s         ld      a,b
78dc 78dc d cd567a
78dc 78dc s         call    PIEXCHANGEBYTE
78df 78df d c9
78df 78df s         ret
78e0 78e0 s 
78e0 78e0 s 
78e0 78e0 s ;-------------------
78e0 78e0 s ; DOWNLOADDATA     |
78e0 78e0 s ;-------------------
78e0 78e0 s ; Load data using configurable block size.
78e0 78e0 s ; Every call will read next block until data ends.
78e0 78e0 s ; Input:
78e0 78e0 s ;   A  = 1 to show dots for every 256 bytes
78e0 78e0 s ;   BC = block size to transfer
78e0 78e0 s ;   DE = Buffer to store data
78e0 78e0 s ; Output:
78e0 78e0 s ;   Flag C: Set if occurred and error during transfer,such as CRC
78e0 78e0 s ;        Z: Set if end of data
78e0 78e0 s ;           Unset if there is still data
78e0 78e0 s ;        A: Error code
78e0 78e0 s ;           A = error code, or
78e0 78e0 s ;           A = RC_SUCCESS - block transfered, there is more data
78e0 78e0 s ;           A = ENDTRANSFER - end of transfer, no more data.
78e0 78e0 s ;
78e0 78e0 s ; Modifies: AF,BC,DE,HL
78e0 78e0 s ;
78e0 78e0 s DOWNLOADDATA:
78e0 78e0 s ; save option to show dots
78e0 78e0 d 6f
78e0 78e0 s         ld      l,a
78e1 78e1 s 
78e1 78e1 s ; Synch start of transfer
78e1 78e1 d 3ea0
78e1 78e1 s         ld      a,STARTTRANSFER
78e3 78e3 d cd567a
78e3 78e3 s         call    PIEXCHANGEBYTE
78e6 78e6 d d8
78e6 78e6 s         ret     c
78e7 78e7 d fea2
78e7 78e7 s         cp      ENDTRANSFER
78e9 78e9 d c8
78e9 78e9 s         ret     z
78ea 78ea d fea0
78ea 78ea s         cp      STARTTRANSFER
78ec 78ec s ; Inexpected control code received.
78ec 78ec d c0
78ec 78ec s         ret     nz
78ed 78ed s ; Pi was not expecting this, then error
78ed 78ed s 
78ed 78ed s ; now send block size
78ed 78ed d 79
78ed 78ed s         ld      a,c
78ee 78ee d cd567a
78ee 78ee s         call    PIEXCHANGEBYTE
78f1 78f1 d 78
78f1 78f1 s         ld      a,b
78f2 78f2 d cd567a
78f2 78f2 s         call    PIEXCHANGEBYTE
78f5 78f5 s 
78f5 78f5 s ; And received Pi info if there is still data or if data has ended
78f5 78f5 d 3ea1
78f5 78f5 s         ld      a,SENDNEXT
78f7 78f7 d cd567a
78f7 78f7 s         call    PIEXCHANGEBYTE
78fa 78fa d fea2
78fa 78fa s         cp      ENDTRANSFER
78fc 78fc d c8
78fc 78fc s         ret     z
78fd 78fd s 
78fd 78fd s ; Maybe the remaining data size is smaller than a block.
78fd 78fd s ; Because of that, we now read back the actual block size that should be read
78fd 78fd s 
78fd 78fd d cdca78
78fd 78fd s         call    READDATASIZE
7900 7900 s ;       call    DBGBC
7900 7900 s 
7900 7900 s ; Initialize crc checker
7900 7900 d 2600
7900 7900 s         ld      h,0
7902 7902 s 
7902 7902 s ; start rading the data
7902 7902 s READDLOOP:
7902 7902 d 7d
7902 7902 s         ld      a,l
7903 7903 d b7
7903 7903 s         or      a
7904 7904 d 280e
7904 7904 s         jr      z,READDLOOP2
7906 7906 d 3c
7906 7906 s         inc     a
7907 7907 d b7
7907 7907 s         or      a
7908 7908 d 2009
7908 7908 s         jr      nz,READDLOOP1
790a 790a d 3c
790a 790a s         inc     a
790b 790b d 6f
790b 790b s         ld      l,a
790c 790c d 3e2e
790c 790c s         ld      a,"."
790e 790e d cd297a
790e 790e s         call    PUTCHAR
7911 7911 d 1801
7911 7911 s         jr      READDLOOP2
7913 7913 s READDLOOP1:
7913 7913 d 6f
7913 7913 s         ld      l,a
7914 7914 s READDLOOP2:
7914 7914 d 3ea1
7914 7914 s         ld      a,SENDNEXT
7916 7916 d cd567a
7916 7916 s         call    PIEXCHANGEBYTE
7919 7919 d 12
7919 7919 s         ld      (de),a
791a 791a d ac
791a 791a s         xor     h
791b 791b d 67
791b 791b s         ld      h,a
791c 791c d 13
791c 791c s         inc     de
791d 791d d 0b
791d 791d s         dec     bc
791e 791e d 78
791e 791e s         ld      a,b
791f 791f d b1
791f 791f s         or      c
7920 7920 d 20e0
7920 7920 s         jr      nz,READDLOOP
7922 7922 s ; now exchange CRC with Pi
7922 7922 d 7c
7922 7922 s         ld      a,h
7923 7923 d cd567a
7923 7923 s         call    PIEXCHANGEBYTE
7926 7926 d bc
7926 7926 s         cp      h
7927 7927 d 3ee0
7927 7927 s         ld      a,RC_SUCCESS
7929 7929 d c8
7929 7929 s         ret     z
792a 792a d 3ee2
792a 792a s         ld      a,RC_CRCERROR
792c 792c d c9
792c 792c s         ret
792d 792d s 
792d 792d s ;-------------------
792d 792d s ; LOADBINPROG      |
792d 792d s ;-------------------
792d 792d s ; Load a .bin program in BASIC environment
792d 792d s LOADBINPROG:
792d 792d d 3ea0
792d 792d s         ld      a,STARTTRANSFER
792f 792f d cd567a
792f 792f s         call    PIEXCHANGEBYTE
7932 7932 d fea0
7932 7932 s         cp      STARTTRANSFER
7934 7934 d 37
7934 7934 s         scf
7935 7935 d 3f
7935 7935 s         ccf
7936 7936 d c0
7936 7936 s         ret     nz
7937 7937 s 
7937 7937 s ; get filesize from PI and put in bc
7937 7937 d cdca78
7937 7937 s         call    READDATASIZE
793a 793a s 
793a 793a s ; Read file header and check if it is BASIC binary program
793a 793a d 3ea1
793a 793a s         ld      a,SENDNEXT
793c 793c d cd567a
793c 793c s        	call    PIEXCHANGEBYTE
793f 793f s 
793f 793f s ; Read start address
793f 793f d 3ea1
793f 793f s         ld      a,SENDNEXT
7941 7941 d cd567a
7941 7941 s         call    PIEXCHANGEBYTE
7944 7944 d 5f
7944 7944 s         ld      e,a
7945 7945 d 3ea1
7945 7945 s         ld      a,SENDNEXT
7947 7947 d cd567a
7947 7947 s         call    PIEXCHANGEBYTE
794a 794a d 57
794a 794a s         ld      d,a
794b 794b s 
794b 794b s ; Discard END address
794b 794b d 3ea1
794b 794b s         ld      a,SENDNEXT
794d 794d d cd567a
794d 794d s         call    PIEXCHANGEBYTE
7950 7950 d 3ea1
7950 7950 s         ld      a,SENDNEXT
7952 7952 d cd567a
7952 7952 s         call    PIEXCHANGEBYTE
7955 7955 s 
7955 7955 s ; Read EXEC address
7955 7955 d 3ea1
7955 7955 s         ld      a,SENDNEXT
7957 7957 d cd567a
7957 7957 s         call    PIEXCHANGEBYTE
795a 795a d 6f
795a 795a s         ld      l,a
795b 795b d 3ea1
795b 795b s         ld      a,SENDNEXT
795d 795d d cd567a
795d 795d s         call    PIEXCHANGEBYTE
7960 7960 d 67
7960 7960 s         ld      h,a
7961 7961 d e5
7961 7961 s         push    hl
7962 7962 d cd6779
7962 7962 s         call    LOADBINBLOCKS
7965 7965 d e1
7965 7965 s         pop     hl
7966 7966 d c9
7966 7966 s         ret
7967 7967 s 
7967 7967 s ;Read 512 bytes at a time
7967 7967 s LOADBINBLOCKS:
7967 7967 d c5
7967 7967 s         push    bc
7968 7968 d 3e05
7968 7968 s         ld      a,GLOBALRETRIES
796a 796a s LOADBINRETRY:
796a 796a d f5
796a 796a s         push    af
796b 796b d cd1978
796b 796b s         call    RECVDATABLOCK
796e 796e d 3008
796e 796e s         jr      nc,LOADBIN1
7970 7970 d f1
7970 7970 s         pop     af
7971 7971 d 3d
7971 7971 s         dec     a
7972 7972 d 20f6
7972 7972 s         jr      nz,LOADBINRETRY
7974 7974 d c1
7974 7974 s         pop     bc
7975 7975 d 3ee2
7975 7975 s         ld      a,RC_CRCERROR
7977 7977 d c9
7977 7977 s         ret
7978 7978 s 
7978 7978 s LOADBIN1:
7978 7978 d 3e2e
7978 7978 s 		ld      a,'.'
797a 797a d cd297a
797a 797a s         call    PUTCHAR
797d 797d d f1
797d 797d s         pop     af
797e 797e s 
797e 797e s ; Restore number of bytes left
797e 797e d e1
797e 797e s         pop     hl
797f 797f s 
797f 797f d ed42
797f 797f s         sbc     hl,bc
7981 7981 d 3806
7981 7981 s         jr      c,LOADBINEND
7983 7983 d 2804
7983 7983 s         jr      z,LOADBINEND
7985 7985 d 44
7985 7985 s         ld      b,h
7986 7986 d 4d
7986 7986 s         ld      c,l
7987 7987 d 18de
7987 7987 s         jr      LOADBINBLOCKS
7989 7989 s LOADBINEND:
7989 7989 d 3ea2
7989 7989 s         ld      a,ENDTRANSFER
798b 798b d cd567a
798b 798b s         call    PIEXCHANGEBYTE
798e 798e d fea2
798e 798e s         cp      ENDTRANSFER
7990 7990 d c8
7990 7990 s         ret     z
7991 7991 d 3ee5
7991 7991 s         ld      a,RC_OUTOFSYNC
7993 7993 d 37
7993 7993 s         SCF
7994 7994 d c9
7994 7994 s         ret
7995 7995 s 
7995 7995 s CHECKBUSY:
7995 7995 d c5
7995 7995 s         push    bc
7996 7996 d 0602
7996 7996 s         ld      b,BUSYRETRIES
7998 7998 s CHECKBUSY1:
7998 7998 d 3ea1
7998 7998 s         ld      a,SENDNEXT
799a 799a d cd567a
799a 799a s         call    PIEXCHANGEBYTE
799d 799d d fea1
799d 799d s         cp      SENDNEXT
799f 799f d 280c
799f 799f s         jr      z,CHECKBUSY3
79a1 79a1 d fead
79a1 79a1 s         cp      ABORT
79a3 79a3 d 2807
79a3 79a3 s         jr      z,CHECKBUSY2
79a5 79a5 d 3eff
79a5 79a5 s         ld      a,RESET
79a7 79a7 d cd2c7a
79a7 79a7 s         call    SENDIFCMD
79aa 79aa d 10ec
79aa 79aa s         djnz    CHECKBUSY1
79ac 79ac s CHECKBUSY2:
79ac 79ac d 37
79ac 79ac s         SCF
79ad 79ad s CHECKBUSY3:
79ad 79ad d c1
79ad 79ad s         pop     bc
79ae 79ae d c9
79ae 79ae s         ret
79af 79af s 
79af 79af s ;-----------------------
79af 79af s ; PRINT                |
79af 79af s ;-----------------------
79af 79af s PRINT:
79af 79af d f5
79af 79af s         push    af
79b0 79b0 d 7e
79b0 79b0 s         ld      a,(hl)		;get a character to print
79b1 79b1 d fe00
79b1 79b1 s         cp      TEXTTERMINATOR
79b3 79b3 d 2816
79b3 79b3 s         jr      Z,PRINTEXIT
79b5 79b5 d fe0a
79b5 79b5 s         cp      10
79b7 79b7 d 200b
79b7 79b7 s         jr      nz,PRINT1
79b9 79b9 d f1
79b9 79b9 s         pop     af
79ba 79ba d f5
79ba 79ba s         push    af
79bb 79bb d 3e0a
79bb 79bb s         ld      a,10
79bd 79bd d 3005
79bd 79bd s         jr      nc,PRINT1
79bf 79bf d cd297a
79bf 79bf s         call    PUTCHAR
79c2 79c2 d 3e0d
79c2 79c2 s         ld      a,13
79c4 79c4 s PRINT1:
79c4 79c4 d cd297a
79c4 79c4 s         call	PUTCHAR		;put a character
79c7 79c7 d 23
79c7 79c7 s         INC     hl
79c8 79c8 d f1
79c8 79c8 s         pop     af
79c9 79c9 d 18e4
79c9 79c9 s         jr      PRINT
79cb 79cb s PRINTEXIT:
79cb 79cb d f1
79cb 79cb s         pop     af
79cc 79cc d c9
79cc 79cc s         ret
79cd 79cd s 
79cd 79cd s PRINTNLINE:
79cd 79cd d 3e0d
79cd 79cd s         ld      a,13
79cf 79cf d cd297a
79cf 79cf s         call    PUTCHAR
79d2 79d2 d 3e0a
79d2 79d2 s         ld      a,10
79d4 79d4 d cd297a
79d4 79d4 s         call    PUTCHAR
79d7 79d7 d c9
79d7 79d7 s         ret
79d8 79d8 s 
79d8 79d8 s ;-----------------------
79d8 79d8 s ; PRINTNUMBER          |
79d8 79d8 s ;-----------------------
79d8 79d8 s PRINTNUMBER:
79d8 79d8 d d5
79d8 79d8 s         push    de
79d9 79d9 d 5f
79d9 79d9 s         ld      e,a
79da 79da d d5
79da 79da s         push    de
79db 79db d e6f0
79db 79db s         AND     0F0H
79dd 79dd d 1f
79dd 79dd s         rra
79de 79de d 1f
79de 79de s         rra
79df 79df d 1f
79df 79df s         rra
79e0 79e0 d 1f
79e0 79e0 s         rra
79e1 79e1 d cded79
79e1 79e1 s         call    PRINTDIGIT
79e4 79e4 d d1
79e4 79e4 s         pop     de
79e5 79e5 d 7b
79e5 79e5 s         ld      a,e
79e6 79e6 d e60f
79e6 79e6 s         AND     0FH
79e8 79e8 d cded79
79e8 79e8 s         call    PRINTDIGIT
79eb 79eb d d1
79eb 79eb s         pop     de
79ec 79ec d c9
79ec 79ec s         ret
79ed 79ed s 
79ed 79ed s PRINTDIGIT:
79ed 79ed d fe0a
79ed 79ed s         cp      0AH
79ef 79ef d 3804
79ef 79ef s         jr      c,PRINTNUMERIC
79f1 79f1 s PRINTALFA:
79f1 79f1 d 1637
79f1 79f1 s         ld      d,37H
79f3 79f3 d 1802
79f3 79f3 s         jr      PRINTNUM1
79f5 79f5 s 
79f5 79f5 s PRINTNUMERIC:
79f5 79f5 d 1630
79f5 79f5 s         ld      d,30H
79f7 79f7 s PRINTNUM1:
79f7 79f7 d 82
79f7 79f7 s         add     a,d
79f8 79f8 d cd297a
79f8 79f8 s         call    PUTCHAR
79fb 79fb d c9
79fb 79fb s         ret
79fc 79fc s 
79fc 79fc s PRINTPISTDOUT:
79fc 79fc d f5
79fc 79fc s         push    af
79fd 79fd d 3ea1
79fd 79fd s         ld      a,SENDNEXT
79ff 79ff d cd567a
79ff 79ff s         call    PIEXCHANGEBYTE
7a02 7a02 d cdca78
7a02 7a02 s         call    READDATASIZE
7a05 7a05 d f1
7a05 7a05 s         pop     af
7a06 7a06 d e5
7a06 7a06 s         push    hl
7a07 7a07 d 2600
7a07 7a07 s         ld      h,0
7a09 7a09 s PRINTPI1:
7a09 7a09 d 3ea1
7a09 7a09 s         ld      a,SENDNEXT
7a0b 7a0b d cd567a
7a0b 7a0b s         call    PIEXCHANGEBYTE
7a0e 7a0e d 6f
7a0e 7a0e s         ld      l,a
7a0f 7a0f d ac
7a0f 7a0f s         xor     h
7a10 7a10 d 67
7a10 7a10 s         ld      h,a
7a11 7a11 d 7d
7a11 7a11 s         ld      a,l
7a12 7a12 d fe0a
7a12 7a12 s         cp      10
7a14 7a14 d 2005
7a14 7a14 s         jr      nz,PRINTPI2
7a16 7a16 d cd297a
7a16 7a16 s         call    PUTCHAR
7a19 7a19 d 3e0d
7a19 7a19 s         ld      a,13
7a1b 7a1b s PRINTPI2:
7a1b 7a1b d cd297a
7a1b 7a1b s         call    PUTCHAR
7a1e 7a1e d 0b
7a1e 7a1e s         dec     bc
7a1f 7a1f d 78
7a1f 7a1f s         ld      a,b
7a20 7a20 d b1
7a20 7a20 s         or      c
7a21 7a21 d 20e6
7a21 7a21 s         jr      nz,PRINTPI1
7a23 7a23 d 7c
7a23 7a23 s         ld      a,h
7a24 7a24 d cd567a
7a24 7a24 s         call    PIEXCHANGEBYTE
7a27 7a27 d e1
7a27 7a27 s         pop     hl
7a28 7a28 d c9
7a28 7a28 s         ret
7a29 7a29 f msxpi-driver.mac
7a29 7a29 s INCLUDE basic_stdio.asm
7a29 7a29 f basic_stdio.asm
7a29 7a29 s ;|===========================================================================|
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| MSXPi Interface                                                           |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| Version : 0.8                                                             |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| Copyright (c) 2015-2016 Ronivon Candido Costa (ronivon@outlook.com)       |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| All rights reserved                                                       |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| Redistribution and use in source and compiled forms, with or without      |
7a29 7a29 s ;| modification, are permitted under GPL license.                            |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;|===========================================================================|
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| This file is part of MSXPi Interface project.                             |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| MSX PI Interface is free software: you can redistribute it and/or modify  |
7a29 7a29 s ;| it under the terms of the GNU General Public License as published by      |
7a29 7a29 s ;| the Free Software Foundation, either version 3 of the License, or         |
7a29 7a29 s ;| (at your option) any later version.                                       |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| MSX PI Interface is distributed in the hope that it will be useful,       |
7a29 7a29 s ;| but WITHOUT ANY WARRANTY; without even the implied warranty of            |
7a29 7a29 s ;| MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             |
7a29 7a29 s ;| GNU General Public License for more details.                              |
7a29 7a29 s ;|                                                                           |
7a29 7a29 s ;| You should have received a copy of the GNU General Public License         |
7a29 7a29 s ;| along with MSX PI Interface.  If not, see <http://www.gnu.org/licenses/>. |
7a29 7a29 s ;|===========================================================================|
7a29 7a29 s ;
7a29 7a29 s ; File history :
7a29 7a29 s ; 0.1    : initial version
7a29 7a29 s 
7a29 7a29 d c3a200
7a29 7a29 s PUTCHAR:    jp      CHPUT
7a2c 7a2c f msxpi-driver.mac
7a2c 7a2c s INCLUDE msxpi_io.asm
7a2c 7a2c f msxpi_io.asm
7a2c 7a2c s ;|===========================================================================|
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| MSXPi Interface                                                           |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| Version : 0.8                                                             |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| Copyright (c) 2015-2016 Ronivon Candido Costa (ronivon@outlook.com)       |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| All rights reserved                                                       |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| Redistribution and use in source and compiled forms, with or without      |
7a2c 7a2c s ;| modification, are permitted under GPL license.                            |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;|===========================================================================|
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| This file is part of MSXPi Interface project.                             |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| MSX PI Interface is free software: you can redistribute it and/or modify  |
7a2c 7a2c s ;| it under the terms of the GNU General Public License as published by      |
7a2c 7a2c s ;| the Free Software Foundation, either version 3 of the License, or         |
7a2c 7a2c s ;| (at your option) any later version.                                       |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| MSX PI Interface is distributed in the hope that it will be useful,       |
7a2c 7a2c s ;| but WITHOUT ANY WARRANTY; without even the implied warranty of            |
7a2c 7a2c s ;| MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             |
7a2c 7a2c s ;| GNU General Public License for more details.                              |
7a2c 7a2c s ;|                                                                           |
7a2c 7a2c s ;| You should have received a copy of the GNU General Public License         |
7a2c 7a2c s ;| along with MSX PI Interface.  If not, see <http://www.gnu.org/licenses/>. |
7a2c 7a2c s ;|===========================================================================|
7a2c 7a2c s ;
7a2c 7a2c s ; File history :
7a2c 7a2c s ; 0.8    : Re-worked protocol as protocol-v2:
7a2c 7a2c s ;          RECVDATABLOCK, SENDDATABLOCK, SECRECVDATA, SECSENDDATA,CHKBUSY
7a2c 7a2c s ;          Moved to here various routines from msxpi_api.asm
7a2c 7a2c s ; 0.7    : Replaced CHKPIRDY retries to $FFFF
7a2c 7a2c s ;          Removed the RESET when PI is not responding. This is now responsability
7a2c 7a2c s ;           of the calling function, which might opt to do something else.
7a2c 7a2c s ; 0.6c   : Initial version commited to git
7a2c 7a2c s ;
7a2c 7a2c s 
7a2c 7a2c s ; Inlude file for other sources in the project
7a2c 7a2c s ;
7a2c 7a2c s ; ==================================================================
7a2c 7a2c s ; BASIC I/O FUNCTIONS STARTS HERE.
7a2c 7a2c s ; These are the lower level I/O routines available, and must match
7a2c 7a2c s ; the I/O functions implemented in the CPLD.
7a2c 7a2c s ; Other than using these functions you will have to create your
7a2c 7a2c s ; own commands, using OUT/IN directly to the I/O ports.
7a2c 7a2c s ; ==================================================================
7a2c 7a2c s 
7a2c 7a2c s ;-----------------------
7a2c 7a2c s ; SENDIFCMD            |
7a2c 7a2c s ;-----------------------
7a2c 7a2c s SENDIFCMD:
7a2c 7a2c d d306
7a2c 7a2c s             out     (CONTROL_PORT),a       ; Send data, or command
7a2e 7a2e d c9
7a2e 7a2e s             ret
7a2f 7a2f s 
7a2f 7a2f s ;-----------------------
7a2f 7a2f s ; CHKPIRDY             |
7a2f 7a2f s ;-----------------------
7a2f 7a2f s CHKPIRDY:
7a2f 7a2f d c5
7a2f 7a2f s             push    bc
7a30 7a30 d 01ffff
7a30 7a30 s             ld      bc,0ffffh
7a33 7a33 s CHKPIRDY0:
7a33 7a33 d db06
7a33 7a33 s             in      a,(CONTROL_PORT); verify spirdy register on the msxinterface
7a35 7a35 d b7
7a35 7a35 s             or	    a
7a36 7a36 d 2806
7a36 7a36 s             jr      z,CHKPIRDYOK    ; rdy signal is zero, pi app fsm is ready
7a38 7a38 s                                     ; for next command/byte
7a38 7a38 d 0b
7a38 7a38 s             dec     bc              ; pi not ready, wait a little bit
7a39 7a39 d 78
7a39 7a39 s             ld      a,b
7a3a 7a3a d b1
7a3a 7a3a s             or      c
7a3b 7a3b d 20f6
7a3b 7a3b s             jr      nz,CHKPIRDY0
7a3d 7a3d s CHKPIRDYNOTOK:
7a3d 7a3d d 37
7a3d 7a3d s             scf
7a3e 7a3e s CHKPIRDYOK:
7a3e 7a3e d c1
7a3e 7a3e s             pop     bc
7a3f 7a3f d c9
7a3f 7a3f s             ret
7a40 7a40 s 
7a40 7a40 s ;-----------------------
7a40 7a40 s ; PIREADBYTE           |
7a40 7a40 s ;-----------------------
7a40 7a40 s PIREADBYTE:
7a40 7a40 d cd2f7a
7a40 7a40 s             call    CHKPIRDY
7a43 7a43 d 3806
7a43 7a43 s             jr      c,PIREADBYTE1
7a45 7a45 d af
7a45 7a45 s             xor     a                   ; do not use xor to preserve c flag state
7a46 7a46 d d306
7a46 7a46 s             out     (CONTROL_PORT),a    ; send read command to the interface
7a48 7a48 d cd2f7a
7a48 7a48 s             call    CHKPIRDY            ;wait interface transfer data to pi and
7a4b 7a4b s                                         ; pi app processing
7a4b 7a4b s                                         ; no ret c is required here, because in a,(7) does not reset c flag
7a4b 7a4b s PIREADBYTE1:
7a4b 7a4b d db07
7a4b 7a4b s             in      a,(DATA_PORT)       ; read byte
7a4d 7a4d d c9
7a4d 7a4d s             ret                         ; return in a the byte received
7a4e 7a4e s 
7a4e 7a4e s ;-----------------------
7a4e 7a4e s ; PIWRITEBYTE          |
7a4e 7a4e s ;-----------------------
7a4e 7a4e s PIWRITEBYTE:
7a4e 7a4e d f5
7a4e 7a4e s             push    af
7a4f 7a4f d cd2f7a
7a4f 7a4f s             call    CHKPIRDY
7a52 7a52 d f1
7a52 7a52 s             pop     af
7a53 7a53 d d307
7a53 7a53 s             out     (DATA_PORT),a       ; send data, or command
7a55 7a55 d c9
7a55 7a55 s             ret
7a56 7a56 s 
7a56 7a56 s ;-----------------------
7a56 7a56 s ; PIEXCHANGEBYTE       |
7a56 7a56 s ;-----------------------
7a56 7a56 s PIEXCHANGEBYTE:
7a56 7a56 d cd4e7a
7a56 7a56 s             call    PIWRITEBYTE
7a59 7a59 d cd2f7a
7a59 7a59 s             call    CHKPIRDY
7a5c 7a5c d db07
7a5c 7a5c s             in      a,(DATA_PORT)       ; read byte
7a5e 7a5e d c9
7a5e 7a5e s             ret
7a5f 7a5f s 
7a5f 7a5f f msxpi-driver.mac
7a5f 7a5f s 
7a5f 7a5f f ./ROM/src/MSX-DOS/msx-dos.mac
7a5f 7a5f s 
7a5f 7a5f s 	DEFS	08000H-$,0
7a5f 7a5f d 00000000000000000000000000000000
7a6f 7a6f d 00000000000000000000000000000000
7a7f 7a7f d 00000000000000000000000000000000
7a8f 7a8f d 00000000000000000000000000000000
7a9f 7a9f d 00000000000000000000000000000000
7aaf 7aaf d 00000000000000000000000000000000
7abf 7abf d 00000000000000000000000000000000
7acf 7acf d 00000000000000000000000000000000
7adf 7adf d 00000000000000000000000000000000
7aef 7aef d 00000000000000000000000000000000
7aff 7aff d 00000000000000000000000000000000
7b0f 7b0f d 00000000000000000000000000000000
7b1f 7b1f d 00000000000000000000000000000000
7b2f 7b2f d 00000000000000000000000000000000
7b3f 7b3f d 00000000000000000000000000000000
7b4f 7b4f d 00000000000000000000000000000000
7b5f 7b5f d 00000000000000000000000000000000
7b6f 7b6f d 00000000000000000000000000000000
7b7f 7b7f d 00000000000000000000000000000000
7b8f 7b8f d 00000000000000000000000000000000
7b9f 7b9f d 00000000000000000000000000000000
7baf 7baf d 00000000000000000000000000000000
7bbf 7bbf d 00000000000000000000000000000000
7bcf 7bcf d 00000000000000000000000000000000
7bdf 7bdf d 00000000000000000000000000000000
7bef 7bef d 00000000000000000000000000000000
7bff 7bff d 00000000000000000000000000000000
7c0f 7c0f d 00000000000000000000000000000000
7c1f 7c1f d 00000000000000000000000000000000
7c2f 7c2f d 00000000000000000000000000000000
7c3f 7c3f d 00000000000000000000000000000000
7c4f 7c4f d 00000000000000000000000000000000
7c5f 7c5f d 00000000000000000000000000000000
7c6f 7c6f d 00000000000000000000000000000000
7c7f 7c7f d 00000000000000000000000000000000
7c8f 7c8f d 00000000000000000000000000000000
7c9f 7c9f d 00000000000000000000000000000000
7caf 7caf d 00000000000000000000000000000000
7cbf 7cbf d 00000000000000000000000000000000
7ccf 7ccf d 00000000000000000000000000000000
7cdf 7cdf d 00000000000000000000000000000000
7cef 7cef d 00000000000000000000000000000000
7cff 7cff d 00000000000000000000000000000000
7d0f 7d0f d 00000000000000000000000000000000
7d1f 7d1f d 00000000000000000000000000000000
7d2f 7d2f d 00000000000000000000000000000000
7d3f 7d3f d 00000000000000000000000000000000
7d4f 7d4f d 00000000000000000000000000000000
7d5f 7d5f d 00000000000000000000000000000000
7d6f 7d6f d 00000000000000000000000000000000
7d7f 7d7f d 00000000000000000000000000000000
7d8f 7d8f d 00000000000000000000000000000000
7d9f 7d9f d 00000000000000000000000000000000
7daf 7daf d 00000000000000000000000000000000
7dbf 7dbf d 00000000000000000000000000000000
7dcf 7dcf d 00000000000000000000000000000000
7ddf 7ddf d 00000000000000000000000000000000
7def 7def d 00000000000000000000000000000000
7dff 7dff d 00000000000000000000000000000000
7e0f 7e0f d 00000000000000000000000000000000
7e1f 7e1f d 00000000000000000000000000000000
7e2f 7e2f d 00000000000000000000000000000000
7e3f 7e3f d 00000000000000000000000000000000
7e4f 7e4f d 00000000000000000000000000000000
7e5f 7e5f d 00000000000000000000000000000000
7e6f 7e6f d 00000000000000000000000000000000
7e7f 7e7f d 00000000000000000000000000000000
7e8f 7e8f d 00000000000000000000000000000000
7e9f 7e9f d 00000000000000000000000000000000
7eaf 7eaf d 00000000000000000000000000000000
7ebf 7ebf d 00000000000000000000000000000000
7ecf 7ecf d 00000000000000000000000000000000
7edf 7edf d 00000000000000000000000000000000
7eef 7eef d 00000000000000000000000000000000
7eff 7eff d 00000000000000000000000000000000
7f0f 7f0f d 00000000000000000000000000000000
7f1f 7f1f d 00000000000000000000000000000000
7f2f 7f2f d 00000000000000000000000000000000
7f3f 7f3f d 00000000000000000000000000000000
7f4f 7f4f d 00000000000000000000000000000000
7f5f 7f5f d 00000000000000000000000000000000
7f6f 7f6f d 00000000000000000000000000000000
7f7f 7f7f d 00000000000000000000000000000000
7f8f 7f8f d 00000000000000000000000000000000
7f9f 7f9f d 00000000000000000000000000000000
7faf 7faf d 00000000000000000000000000000000
7fbf 7fbf d 00000000000000000000000000000000
7fcf 7fcf d 00000000000000000000000000000000
7fdf 7fdf d 00000000000000000000000000000000
7fef 7fef d 00000000000000000000000000000000
7fff 7fff d 00
8000 8000 s 
8000 8000 s 
8000 8000 s 	end
5000 a a5000
f7f6 v dac
4022 a a4022
4030 a a4030
4130 a a4130
4025 a a4025
4034 a a4034
4115 a a4115
4142 a a4142
4029 a a4029
4160 a a4160
4156 a a4156
4163 a a4163
4078 a a4078
4159 a a4159
4171 a a4171
4179 a a4179
5523 a a5523
658b a a6576
f847 v arg
4010 a t4010
4013 a t4013
f55e v buf
4221 a a4221
4016 a t4016
4247 a a4247
4252 a a4252
0046 v x0046
4019 a t4019
4262 a a4262
4298 a a4298
5496 a a5496
4348 a a4348
4308 a a4308
4367 a a4367
4317 a a4317
4331 a a4331
4342 a a4342
4743 a a4743
4376 a a4376
4403 a a4403
4392 a a4392
4408 a a4408
4427 a a4427
4435 a a4435
4439 a a4439
4457 a a4457
4462 a a4462
410a a a410a
4471 a a4471
421a a a421a
60c6 a a60b1
402d a a402d
6222 a a620d
404b a a404b
40a7 a a40a7
409b a a409b
40b8 a a40b8
40c5 a a40c5
408f a a408f
3042 v m.3042
40f8 a a40f8
414e a a414e
41b5 a a41b5
41f4 a a41f4
576f a a576f
4173 v m.4173
424f a a424f
c000 v yc000
003b v x003b
004b v x004b
401c a t401c
401f a t401f
425a a a425a
f300 v yf300
426b a a426b
f302 v yf302
f331 v xf331
f241 v yf241
f242 v yf242
f243 v yf243
f252 v xf252
f245 v yf245
f237 v yf237
f238 v yf238
f239 v yf239
f246 v yf246
f247 v yf247
f248 v yf248
f249 v yf249
f255 v xf255
f258 v xf258
f261 v xf261
f264 v xf264
f267 v xf267
f270 v xf270
f273 v xf273
f276 v xf276
f279 v xf279
f282 v xf282
f285 v xf285
f288 v xf288
f291 v xf291
f294 v xf294
f297 v xf297
f306 v yf306
f307 v yf307
f309 v yf309
f323 v yf323
f325 v yf325
f327 v xf327
f336 v yf336
f337 v yf337
f338 v yf338
f339 v yf339
f340 v yf340
f345 v yf345
f346 v yf346
f347 v yf347
f348 v yf348
f349 v yf349
f2a0 v xf2a0
f351 v yf351
f20b v yf20b
f2a3 v xf2a3
f22b v yf22b
f1e2 v xf1e2
f23a v yf23a
f23b v yf23b
f1f4 v xf1f4
f23c v yf23c
f1c9 v xf1c9
f1d9 v xf1d9
f1e8 v xf1e8
f1f7 v yf1f7
f23d v yf23d
f23f v yf23f
f24a v yf24a
f24c v yf24c
f24e v yf24e
f24f v xf24f
f25b v xf25b
f25e v xf25e
f26a v xf26a
f26d v xf26d
f27c v xf27c
f27f v xf27f
f28b v xf28b
f28e v xf28e
f29a v xf29a
f29d v xf29d
f2a6 v xf2a6
f2a9 v xf2a9
f2b2 v xf2b2
f2b5 v xf2b5
f2b8 v yf2b8
f2b9 v yf2b9
f2c4 v yf2c4
f2c5 v yf2c5
f2d0 v yf2d0
f2e0 v yf2e0
f2e1 v yf2e1
f2e2 v yf2e2
f2e4 v yf2e4
f2e8 v yf2e8
f2f0 v yf2f0
f2f2 v yf2f2
f2f4 v yf2f4
f2f8 v yf2f8
f30b v yf30b
f30c v yf30c
f30e v yf30e
f2ac v xf2ac
f30f v yf30f
f32c v xf32c
f2af v xf2af
f2dc v yf2dc
f2dd v yf2dd
f2de v yf2de
f2df v yf2df
f2ea v yf2ea
f2ec v yf2ec
f2ee v yf2ee
f2fa v yf2fa
f2fc v yf2fc
f2fe v yf2fe
f2ff v yf2ff
f33b v yf33b
f33d v yf33d
f33f v yf33f
f34b v yf34b
f34f v yf34f
f353 v yf353
f355 v yf355
f365 v xf365
f368 v xf368
f36b v xf36b
f36e v xfer
f371 v xf371
f374 v xf374
f377 v xf377
f37a v xf37a
f37d v xf37d
fb21 v yfb21
fb29 v yfb29
f41f v kbuf
fe3a v h.mkd$
fe3f v h.cvi
fe44 v h.cvs
fe49 v h.cvd
fe99 v h.loc
fe30 v h.mki$
fe9e v h.lof
fea3 v h.eof
2f10 v m.2f10
2f99 v m.2f99
30d1 v m.30d1
325c v m.325c
0030 v callf
46ff v csng
6e41 v m.6e41
fe35 v h.mks$
5b3a a a5b3a
5fc8 a a5fb3
40ab a a40ab
41ad a a41ad
41ef a a41ef
009f v chget
41fa a a41fa
42a3 a a42a3
42a5 a a42a5
42b1 a a42b1
fc4a v himem
ffff v yffff
542f v evadr
440e a a440e
42b5 a a42b5
44d3 a a44d3
42bc a a42bc
430e a a430e
42c3 a a42c3
42fc a a42fc
74a5 a dskio
42d1 a a42d1
75ef a mtoff
42dc a a42dc
42f5 a a42f5
009c v chsns
42f6 a a42f6
46a4 a a46a4
436c a a436c
4f9b a a4f9b
00a2 v chput
45cf a a45cf
440b a a440b
43b3 a a43b3
43bb a a43bb
000c v rdslt
406f v error
0000 v wboot
fed0 v h.clea
2ef3 v vmove
54f7 v ptoln
43c3 a a43c3
445e a a445e
4488 a a4488
7328 v outnl
44ae a a44ae
44ca a a44ca
f341 v ramad0
f342 v ramad1
f343 v ramad2
f344 v ramad3
fdf9 v h.name
fe2b v h.fiel
fe76 v h.binl
0014 v wrslt
fe7b v h.file
fe12 v h.dskf
fe80 v h.dget
fe85 v h.filo
fe17 v h.dski
fdfe v h.kill
fe71 v h.bins
fe8a v h.inds
fead v h.baku
fe4e v h.getp
fdef v h.dsko
fe58 v h.nofo
fd9f v h.timi
fe62 v h.ntfl
feb2 v h.pard
002b v idbyt0
feb7 v h.node
fe21 v h.lset
f398 v clprm1
febc v h.posd
fe08 v h.copy
fecb v h.runc
fed5 v h.lopd
fe26 v h.rset
fe5d v h.nulo
feda v h.stke
fefd v h.errp
ffa7 v h.phyd
ffac v h.form
269a v decadd
470a a a470a
44db a a44db
4555 a a4555
607c a a6067
4533 a a4536
450a a a450a
4513 a a4516
6ec6 v calbld
45fa a a45fa
451f a a4522
46d7 a a46d7
0159 v calbas
453e a a4541
4526 a a4529
6084 a a606f
4563 a a4563
756d a choice
4544 a a4547
46c5 a a46c5
456f a a456f
289f v decdiv
fd99 v device
6f0b v badres
f860 v filtab
fcae v flbmem
517a v cnvdac
f3de v cnsdfg
00bd v ckcntc
00cc v erafnk
f866 v filnam
268c v decsub
6c1c v aclose
6b24 v clochn
409b v exebas
00b7 v breakx
0156 v kilbuf
ffd4 v enaint
f6c2 v vartab
f85f v maxfil
f3b0 v linlen
001c v calslt
f30d v rawflg
f87d v savend
4601 v execlp
0024 v enaslt
f38c v clprim
fb20 v hokvld
5ea4 v getvar
f698 v dsctmp
f862 v nulbuf
0144 v phydio
0059 v ldirmv
005c v ldirvm
f380 v rdprim
f416 v prtflg
f41c v curlin
f69b v fretop
0038 v keyint
f672 v memsiz
0141 v snsmat
f676 v txttab
f6ab v autlin
f6c6 v strend
f678 v temppt
f864 v ptrfil
f34d v $secbuf
f67a v tempst
f6b1 v savstk
f87c v nlonly
f663 v valtyp
f385 v wrprim
f415 v lptpos
fc48 v bottom
fcbe v runbnf
f674 v stktop
fcbf v savent
fcc1 v exptbl
00a5 v lptout
00d2 v totext
fcc5 v slttbl
fcc9 v sltatr
fd09 v sltwrk
fd89 v procnm
ffca v extbio
ffcf v disint
2f08 v vmovfm
5597 v getypr
67d0 v fretmp
f661 v ttypos
6a0e v evfspc
5432 v cnvadr
4756 v evword
521b v nevbyt
521c v evbyte
521f v cnvbyt
4253 v mkptrs
6afa v opnchn
4aff v scrout
4c64 v evexpr
6a6d v gtchnp
4c5f v evlexp
668e v alsspc
6627 v altstr
7323 v coutnl
4666 v chrgtr
739a v quitld
6f1d v skpchk
7d2f v basscr
7d17 v skprom
7e14 v rstclr
7d31 v txtini
6e92 v calbsv
6ef4 v exebld
f38b v retrtn
7543 a dskchg
7548 a getdpb
75a4 a dskfmt
472d a a472d
45ee a a45ee
4748 a a4748
45c4 a a45c4
45d9 a a45d9
4755 a a4755
45e9 a a45e9
460d a a460d
4617 a a4617
461d a a461d
461e a t461e
464d a a464d
4651 a a4651
4669 a a4669
4647 a a4647
469d a a469d
467c a a467c
4682 a a4682
4696 a a4696
46ba a a46ba
46e8 a a46e8
6067 a a6052
4916 a a4916
4720 a a4720
6069 a a6054
4775 a a4775
4ef8 a a4ef8
4b23 a a4b23
4783 a a4783
477d a a477d
4ca3 a a4ca3
486a a a486a
479c a a479c
4788 a a4788
4857 a a4857
4799 a a4799
4790 a a4790
4793 a a4793
4844 a a4844
47b2 a a47b2
485a a a485a
47c8 a a47c8
47be a a47be
47d1 a a47d1
47f0 a a47f0
4813 a a4813
482d a a482d
4871 a a4871
487d a a487d
48a8 a a48a8
48b1 a a48b1
48b5 a a48b5
491c a a491c
4932 a a4932
4906 a a4906
490f a a490f
4928 a a4928
4921 a a4921
4924 a a4924
492f a div16
492f a a492f
493b a a493b
494e a a494e
4946 a a4946
4947 a a4947
4953 a a4953
4972 a a4972
4989 a a4989
49cf a a49cf
49b0 a a49b0
49b1 a a49b1
49c7 a a49c7
49cc a a49cc
49d2 a a49d2
4edb a a4edb
49f0 a a49f0
4a1b a a4a1b
4a0d a a4a0d
4a36 a a4a36
4a46 a a4a46
4a6b a a4a6b
4a7b a a4a7b
4aa2 a a4aa2
4aa8 a a4aa8
4ab1 a a4ab1
4aca a a4aca
4ab9 a a4ab9
4abc a a4abc
4be2 a a4be2
53a8 a a53a8
4af9 a a4af9
4ad7 a a4ad7
4af2 a a4af2
4ae1 a a4ae1
546e a a546e
4b05 a a4b05
50e0 a a50e0
4c97 a a4c97
4b56 a a4b56
4bdc a a4bdc
4b8e a a4b8e
4e48 a a4e48
4bc1 a a4bc1
4c00 a a4c00
4c17 a a4c17
4c0f a a4c0f
4c22 a a4c22
4c37 a a4c37
4c47 a a4c47
4c73 a a4c73
4c63 a a4c63
4c53 a a4c53
4c81 a a4c81
5466 a a5466
5475 a a5475
4c87 a a4c87
4d41 a a4d41
4f12 a a4f12
4ddd a a4ddd
4cd6 a a4cd6
4cf0 a a4cf0
4cea a a4cea
4d05 a a4d05
4d8c a a4d8c
4d65 a a4d65
4d73 a a4d73
4dab a a4dab
4dd6 a a4dd6
4dc6 a a4dc6
4e32 a a4e32
4dfa a a4dfa
4e03 a a4e03
4e26 a a4e26
4e10 a a4e10
4f9e a a4f9e
4e2c a a4e2c
4e53 a a4e53
4e5e a a4e5e
4e78 a a4e78
4eca a a4eca
4ec7 a a4ec7
4ed2 a a4ed2
4eed a a4eed
4ee7 a a4ee7
4f2d a a4f2d
4f31 a a4f31
4f4e a a4f4e
4f56 a a4f56
4f94 a a4f94
4f5e a a4f5e
4fb8 a a4fb8
4fbb a a4fbb
4fc4 a a4fc4
4fdc a a4fdc
4fef a a4fef
5006 a a5006
501e a a501e
5043 a a5043
504e a a504e
5053 a a5053
5058 a a5058
505d a a505d
5081 a a5081
508b a a508b
509f a a509f
50b2 a a50b2
50c4 a a50c4
50c8 a a50c8
50d5 a a50d5
5101 a a5101
5104 a a5104
5103 a a5103
544e a a544e
510a a a510a
5374 a t5374
0011 v nkeynt
511e a a511e
515e a a515e
535d a a535d
513b a a513b
5166 a a5166
5177 a a5177
5172 a a5172
534f a a534f
517a a a517a
5183 a a5183
5181 a a5181
518d a a518d
518e a a518e
51a3 a a51a3
51a9 a a51a9
51ab a a51ab
5244 a a5244
51dc a a51dc
51ce a a51ce
51fb a a51fb
521a a a521a
5208 a a5208
5218 a a5218
522a a a522a
5226 a a5226
5221 a a5221
5232 a a5232
523e a a523e
547d a t547d
5251 a a5251
5265 a a5265
5278 a a5278
5280 a a5280
52b5 a a52b5
5284 a a5284
52e3 a a52e3
5295 a a5295
529d a a529d
52ae a a52ae
52df a a52df
52cd a a52cd
531f a a531f
52fc a a52fc
531a a a531a
534b a a534b
5336 a a5336
533f a a533f
534c a a534c
53a7 a a53a7
53e8 a a53e8
53d5 a a53d5
53f0 a a53f0
53f8 a a53f8
5412 a a5412
5405 a a5405
541d a a541d
5431 a a5431
5437 a a5437
543c a a543c
5445 a a5445
5454 a a5454
5462 a a5462
5465 a a5465
5474 a a5474
54c0 a a54c0
550b a a550b
5534 a t5534
5515 a a5515
54f2 a a54f2
5505 a a5505
5588 a a5588
559d a a559d
5521 a a5521
5529 a a5529
5530 a a5530
553c a a553c
5552 a a5552
559a a a559a
5579 a a5579
55d2 a a55d2
55db a a55db
55e6 a a55e6
55ff a a55ff
5604 a a5604
5622 a a5622
5681 a a5681
5631 a a5631
5667 a a5667
564c a a564c
5696 a t5696
5656 a a5656
5677 a t5677
5694 a a5694
56d0 a a56d0
56d3 a a56d3
56e6 a a56e6
56ed a a56ed
5700 a t5700
570d a t570d
570b a a570b
741a a inihrd
580c a a580c
578e a a578e
5789 a a5789
57a3 a a57a3
57a9 a a57a9
0001 v mysize
5efd a a5ee8
57b6 a a57b6
57bd a a57bd
57cd a a57cd
57d6 a a57d6
5807 a t5807
5825 a a5825
5897 a a5897
5812 a a5812
5ee1 a a5ecc
5fe2 a a5fcd
0200 v seclen
5838 a a5838
583e a a583e
584b a a584b
5850 a a5850
747d a drives
585c a a585c
5edd a a5ec8
587e a a587e
755a v defdpb
749c a inienv
589c a a589c
58a8 a a58a8
6242 a a622d
73ac a a7397
58f0 a a58f0
5916 a a5916
592c a a592c
5967 a a5967
5c83 a a5c6e
5fad a a5f98
5faa a a5f95
5e67 a a5e52
59c1 a a59c1
59cb a a59cb
59db a a59db
59ed a a59ed
59e0 a a59e0
59e9 a a59e9
59f3 a a59f3
5c2b a a5c16
6503 a aboot
5a7e a a5adb
5a11 a a5a11
60af a a609a
5aa7 a a5ae7
6436 a a649c
5a31 a a5a36
64e9 a a655c
019c v ldosr
5ec2 a a5ead
634d a a6336
6339 a t632e
631b a a6306
5a8a a t5b0f
5a5d a a5a84
5a76 a a5a98
6392 a a63f4
63ad a a6415
63dc a a6443
63ee a a6455
64ac a a63a1
64b2 a a63a3
64c3 a a637b
5b1a a t5b1a
5b27 a t5b27
5b38 a t5b38
5b92 a a5b92
5c75 a a5c60
5b6e a a5b6e
5ba0 a a5ba0
5b9c a a5b9c
5b7d a a5b7d
5b87 a a5b87
5d54 a a5d3f
5f9b a a5f86
72c3 a t72ae
5c81 a t5c6c
5ecd a a5eb8
6302 a t62ed
5f74 a a5f5f
5c77 a a5c62
62fd a t62e8
5cab a t5c96
5c91 a a5c7c
6bab a a6b96
6b8a a a6b75
6f35 a a6f20
6f15 a a6f00
7090 a a707b
7076 a a7061
6cec a a6cd7
6ceb a a6cd6
6c5e a a6c49
6dc4 a a6daf
6dc7 a a6db2
6dca a a6db5
6dec a a6dd7
6def a a6dda
6df2 a a6ddd
66b9 a a66a4
66c8 a a66b3
6711 a a66fc
68e5 a a68d0
6923 a a690e
694e a a6939
6e9d a a6e88
6bef a a6bda
68a3 a a688e
682e a a6819
7022 a a700d
701e a a7009
6e85 a a6e70
688a a a6875
7338 a a7323
7391 a a737c
71e8 a a71d3
606a a a6055
60c5 a a60b0
5d39 a t5d24
5d44 a t5d2f
5d4c a t5d37
5d5d a a5d48
5d86 a a5d71
5fa1 a a5f8c
5e60 a t5e4b
5db4 a a5d9f
5e22 a a5e0d
5dfe a a5de9
5de0 a a5dcb
5e0d a a5df8
5dce a a5db9
5dc6 a a5db1
5dcd a a5db8
5dd8 a a5dc3
5e56 a a5e41
5e41 a a5e2c
5e50 a a5e3b
5e62 a a5e4d
5e68 a a5e5e
5e6a a a5e60
5e9a a ardsl
5ea0 a awrsl
5e98 a a5e9a
5e94 a a5e96
5ed6 a a5ec1
5ee0 a a5ecb
5ee5 a t5ed0
5f50 a a5f3b
5f5d a a5f48
5f60 a a5f4b
5fb3 a a5f9e
6001 a a5fec
5fc3 a a5fae
5fd3 a a5fbe
5fc8 a getslt
5ffc a a5fe7
5fd7 a getwrk
5fd7 a a5fc2
6008 a a5ff3
6006 a a5ff1
600b a setint
600b a a5ff6
6027 a a6012
603c a prvint
603c a a6027
6048 a a6033
6054 a a603f
6052 a a603d
609b a a6086
6090 a a607b
608a a a6075
6385 a a636e
60a1 a a608c
60a8 a a6093
62eb a a62d6
6116 a a6101
60d5 a a60c0
60fa a a60e5
60f3 a a60de
61aa a a6195
62db a a62c6
6153 a a613e
612d a a6118
613b a a6126
6142 a a612d
614d a a6138
6189 a a6174
61f5 a t61e0
6172 a a615d
625d a t6248
62de a a62c9
617b a a6166
61c2 a t61ad
61d2 a t61bd
61dc a t61c7
61e7 a t61d2
6206 a a61f1
6211 a a61fc
730c a a72f7
6227 a a6212
6239 a a6224
6247 a a6232
625a a a6245
6249 a a6234
7307 a t72f2
626f a prompt
626f a l625a
62d2 a a62bd
62e9 a a62d4
6abc a a6aa7
69fc a a69e7
6359 a r0000
636a a r0001
636e a r0002
637c a r0003
6392 a r0100
6395 a r0101
63a3 a r0102
63a8 a r0103
63ae a r0200
63b1 a r0201
63bf a r0202
63c5 a r0203
63f6 a r0300
63f9 a r0301
6405 a r0302
641b a r0303
6436 a r0400
6439 a r0401
6444 a r0402
6375 a d635e
638c a a6375
6380 a a6369
6456 a a64c2
63a2 a a6404
6479 a a64e7
63c8 a a6436
63bd a a6425
63d6 a ardwr
6405 a a646c
642f a acall
6443 a a64a9
643c a a64a2
6443 a a64af
645e a a64dd
646c a a64cd
6482 a a64ff
64a7 a assec
64b6 a a63ad
64fc a a656f
655f a aincp
0008 v lincp
6514 a anxbt
6547 a adpth
6538 a anpth
6553 a aepth
65c2 a a65ad
65c6 a t65b1
659f a a658a
65a2 a a658d
65b8 a a65a3
72ef a a72da
65b6 a a65a1
75c4 a oemsta
65d9 a a65c4
65f1 a a65dc
732a a a7315
7333 a a731e
65f8 a a65e3
65f9 a a65e4
65ff a a65ea
660c a a65f7
6643 a a662e
6633 a a661e
663b a a6626
66b5 a a66a0
664b a a6636
666c a a6657
665a a a6645
6667 a d6652
666f a a665a
6678 a a6663
6688 a a6673
66a2 a a668d
6696 a a6681
6699 a a6684
66ad a a6698
66b4 a a669f
66e2 a a66cd
732d a a7318
72e5 a a72d0
6fbe a a6fa9
731e a a7309
6736 a a6721
7321 a a730c
678d a a6778
7327 a a7312
6776 a a6761
71c0 a a71ab
6813 a a67fe
678a a a6775
67d6 a a67c1
683f a a682a
67d4 a a67bf
67ef a a67da
6801 a a67ec
680e a a67f9
6828 a a6813
71ae a a7199
687b a a6866
6876 a a6861
6897 a a6882
68bc a a68a7
68ca a a68b5
68e0 a a68cb
71a4 a a718f
6909 a a68f4
7395 a a7380
69dc a a69c7
71a0 a a718b
7312 a a72fd
69e5 a a69d0
69ce a t69b9
69d3 a a69be
69e0 a a69cb
69e8 a a69d3
69f7 a a69e2
6b7f a a6b6a
6a30 a a6a1b
6a28 a a6a13
72f0 a a72db
6b83 a a6b6e
6a38 a a6a23
6a82 a a6a6d
6a72 a a6a5d
6f0d a a6ef8
717a a a7165
6a85 a a6a70
6ab3 a a6a9e
6ae5 a a6ad0
6ad4 a a6abf
6ae0 a a6acb
6b71 a a6b5c
6b2f a a6b1a
6b26 a a6b11
6b32 a a6b1d
6b63 a a6b4e
6bda a a6bc5
6bb6 a a6ba1
71b1 a a719c
6c3e a a6c29
6e10 a a6dfb
6c2b a a6c16
7318 a a7303
6c54 a a6c3f
71bd a a71a8
7315 a a7300
6ca0 a a6c8b
730f a a72fa
731b a a7306
6d7f a a6d6a
6d5d a a6d48
6d92 a a6d7d
6d3f a a6d2a
6d6f a a6d5a
6d89 a a6d74
6d76 a a6d61
6d84 a a6d6f
6d8c a a6d77
6dbe a a6da9
6e7d a t6e68
6e92 a a6e7d
6eaa a a6e95
6f95 a a6f80
6eae a a6e99
7013 a a6ffe
6f78 a a6f63
6ec3 a a6eae
6ec8 a a6eb3
6ed8 a a6ec3
6ed7 a a6ec2
6eed a a6ed8
6eff a a6eea
6ef8 a a6ee3
6fab a a6f96
71b7 a a71a2
6f66 a a6f51
71cc a a71b7
71ba a a71a5
6f87 a a6f72
6f9e a a6f89
6faf a a6f9a
700a a a6ff5
6fc7 a a6fb2
6fe1 a t6fcc
6fd2 a a6fbd
7007 a a6ff2
6fee a a6fd9
6ffa a a6fe5
7001 a a6fec
7324 a a730f
7018 a a7003
7089 a a7074
70d8 a a70c3
70df a a70ca
70ed a a70d8
70f4 a a70df
7104 a a70ef
710f a a70fa
7181 a a716c
713d a a7128
7151 a a713c
7194 a a717f
719b a a7186
71ab a a7196
71c3 a a71ae
71c6 a a71b1
71c9 a a71b4
720a a t71f5
71f5 a a71e0
72c5 a a72b0
72d7 a t72c2
72d2 a a72bd
72f9 a a72e4
72fb a a72e6
7346 a a7331
735f a a734a
7365 a a7350
7362 a a734d
7389 a a7374
73a3 a a738e
741a a dskdrv
0005 v bdos
0002 v busyretries
0006 v control_port
0007 v data_port
00ff v reset
00a0 v starttransfer
00a1 v sendnext
00a2 v endoftransfer
00aa v ready
00ad v abort
00ae v busy
00e0 v rc_success
00e2 v rc_crcerror
00e5 v rc_outofsync
f34d v d.f34d
76cf a msxpiversion
79af a print
7796 a piwaitmsg
7462 a pi_waitboot
7458 a inihrd_pi
76be a check_ctrl
7452 a inihrdmsg
7815 a sendpicmd
7464 a pi_waitboot1
77eb a synch
76ad a check_esc
7477 a drivesmsg
7498 a drives2
7497 a drives1
749d a dos_rsec
74a1 a dos_wsec
74cf a dskio_read
74a7 a dskio_write
74f1 a dskio_err1
74ef a dskio_err
74c0 a dskio_write1
789e a secsenddata
7873 a secrecvdata
74f6 a dos_secinfo
7530 a dskiordmsg
7547 a dskchgdpb
7549 a dpbtable
7571 a choicestr
75a0 a dskfmtcmd
77b7 a str_call_cmd
75c8 a call_check
75cb a checkcmd
75e0 a checknext
75ed a mycommand
75f0 a getprevchar
75ef a dskstp
7a56 a piexchangebyte
75f8 a msxpiver
75fe a msxpistatus
7a2f a chkpirdy
74fa a dskio_sectinfo
7768 a pioffline
777e a pionline
760c a loadclientcmd
7626 a msxpiload
7751 a msxpiloading
7a2c a sendifcmd
792d a loadbinprog
7668 a getstdoutnull
764d a loaderrmsg
7819 a recvdatablock
766f a getpointers
7681 v biosentryaddr
7673 a getpointers1
7843 a senddatablock
78ca a readdatasize
78d7 a senddatasize
7a40 a pireadbyte
7a4e a piwritebyte
7995 a checkbusy
79cd a printnline
79d8 a printnumber
79ed a printdigit
79fc a printpistdout
77ea a endofcmds
0005 v globalretries
00a2 v endtransfer
55a8 v callstat
f55e v inlinbuf
00b1 v inlin
006c v initxt
f3dc v csry
f3dd v csrx
00cf v dspfnk
0008 v control_port2
7811 a chkpicmd
7824 a recvdatablock1
7852 a senddatablock1
787a a secrecvdata0
7662 a msxpiloaderror
788c a secrecvdata1
7889 a secrecvdataerr
789c a secrecvdataend
78a6 a secsenddata0
78b8 a secsenddata1
78b5 a secsenddataerr
78c8 a secsenddataend
78e0 a downloaddata
7902 a readdloop
750f a dskio_sectinfo1
751b a dskio_sectinfo2
7914 a readdloop2
7913 a readdloop1
7a29 a putchar
0000 v textterminator
7967 a loadbinblocks
796a a loadbinretry
7978 a loadbin1
7989 a loadbinend
7998 a checkbusy1
79ad a checkbusy3
79ac a checkbusy2
79cb a printexit
79c4 a print1
79f5 a printnumeric
79f1 a printalfa
79f7 a printnum1
7a09 a printpi1
7609 a printstatusmsg
7a1b a printpi2
7a33 a chkpirdy0
7a3e a chkpirdyok
7a3d a chkpirdynotok
7a4b a pireadbyte1
00e6 v rc_filenotfound
767b a getpointersexit
78a9 a secsenddataretry
787d a secrecvdataretry
786f a senddatablock_offsync
786a a senddatablock_crcerror
783d a recvdatablock_crcerror
